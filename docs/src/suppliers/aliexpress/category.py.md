# Модуль для управления категориями Aliexpress

## Обзор

Модуль `category.py` предназначен для управления категориями на сайте Aliexpress. Он включает в себя функции для сбора URL товаров из категорий, обновления категорий в файле сценария, получения списка категорий с сайта и адаптер для работы с базой данных категорий.

## Подробнее

Модуль предоставляет инструменты для автоматизации работы с категориями товаров на Aliexpress, такие как сбор ссылок на товары, сравнение и обновление категорий в файлах сценариев, а также взаимодействие с базой данных для хранения и управления категориями.

## Функции

### `get_list_products_in_category`

```python
def get_list_products_in_category(s) -> list[str, str]:
    """  
     Считывает URL товаров со страницы категории.

    Args:
        s: Экземпляр поставщика.
        run_async (bool): Устанавливает синхронность/асинхронность исполнения функции `async_get_list_products_in_category()`.

    Returns:
        list: Список собранных URL. Может быть пустым, если в исследуемой категории нет товаров.
    """
    ...
```

**Назначение**: Считывает URL товаров со страницы категории. Если есть несколько страниц с товарами в одной категории, пролистывает их все. Важно, что к этому моменту веб-драйвер уже должен открыть страницу категорий.

**Параметры**:
- `s`: Экземпляр класса `Supplier`, представляющий поставщика.

**Возвращает**:
- `list`: Список URL товаров в категории. Может быть пустым, если товаров в категории нет.

**Как работает функция**:

1. Функция вызывает `get_prod_urls_from_pagination(s)` для получения списка URL товаров.

**Примеры**:

```python
# Пример вызова функции get_list_products_in_category
# Предполагается, что экземпляр класса Supplier уже создан и передан в функцию
# result = get_list_products_in_category(supplier_instance)
```

### `get_prod_urls_from_pagination`

```python
def get_prod_urls_from_pagination(s) -> list[str]:
    """   Функция собирает ссылки на товары со страницы категории с перелистыванием страниц 
    Args:
        s: Supplier
    Returns:
        list:  Список ссылок, собранных со страницы категории
    """
    ...
```

**Назначение**: Функция собирает ссылки на товары со страницы категории, перелистывая страницы.

**Параметры**:
- `s`: Экземпляр класса `Supplier`.

**Возвращает**:
- `list`: Список ссылок на товары, собранных со страницы категории.

**Как работает функция**:

1.  **Инициализация**:
    - Получает драйвер (`_d`) из объекта поставщика `s`.
    - Получает локаторы ссылок на товары (`_l`) из объекта поставщика `s`.
    - Инициализирует пустой список `list_products_in_category` для хранения ссылок на товары.

2.  **Поиск ссылок на товары**:
    - Использует `_d.execute_locator(_l)` для извлечения ссылок на товары с текущей страницы.
    - Если `list_products_in_category` пуст, возвращает пустой список (в категории нет товаров).

3.  **Перелистывание страниц и сбор ссылок**:
    - Запускает бесконечный цикл `while True`.
    - Проверяет наличие кнопки "следующая страница" с помощью `_d.execute_locator(s.locators['category']['pagination']['->'])`.
    - Если кнопки "следующая страница" нет, выходит из цикла.
    - Если кнопка "следующая страница" есть, добавляет ссылки на товары с текущей страницы в `list_products_in_category`.
    - Повторяет цикл, переходя на следующую страницу.

4.  **Возврат результата**:
    - Возвращает список `list_products_in_category`, содержащий все собранные ссылки на товары.

**Примеры**:

```python
# Пример вызова функции get_prod_urls_from_pagination
# Предполагается, что экземпляр класса Supplier уже создан и передан в функцию
# result = get_prod_urls_from_pagination(supplier_instance)
```

### `update_categories_in_scenario_file`

```python
def update_categories_in_scenario_file(s, scenario_filename: str) -> bool:
    """  Проверка изменений категорий на сайте 
    Args:
        s: Supplier
        scenario_filename (str): Имя файла сценария.
    Returns:
        bool: True если выполнено
    """
    ...
```

**Назначение**: Проверяет изменения категорий на сайте и обновляет файл сценария.

**Параметры**:
- `s`: Экземпляр класса `Supplier`.
- `scenario_filename`: Имя файла сценария.

**Возвращает**:
- `bool`: `True`, если обновление выполнено успешно.

**Как работает функция**:

1.  **Загрузка данных из файла сценария**:
    - Загружает JSON из файла сценария, используя `j_loads(Path(gs.dir_scenarios, f'{scenario_filename}'))`.
    - Извлекает список сценариев из загруженного JSON.

2.  **Получение списка категорий с сайта**:
    - Вызывает `get_list_categories_from_site()` для получения списка категорий с сайта.

3.  **Обновление идентификаторов категорий в файле**:
    - Определяет внутреннюю функцию `_update_all_ids_in_file()`, которая итерируется по категориям в файле сценария.
    - Если `category ID on site` больше 0, добавляет его в список `all_ids_in_file`.
    - Если `category ID on site` не определен, извлекает его из URL категории и добавляет в список.
4. **Получение категорий из JSON файла магазина**:
    - Отправляет GET запрос по URL, указанному в `scenario_json['store']['shop categories json file']`.
    - Если запрос успешен (status_code == 200), сохраняет JSON ответ в `categories_from_aliexpress_shop_json`.
    - В случае ошибки логирует её с помощью `logger.error` и возвращает `None`.

5.  **Сравнение списков идентификаторов категорий**:
    - Извлекает список групп категорий из `categories_from_aliexpress_shop_json['groups']`.
    - Создает списки `all_ids_on_site` и `all_categories_on_site` для хранения идентификаторов и данных категорий с сайта.
    - Заполняет эти списки, итерируясь по группам и подгруппам категорий.
    - Определяет `removed_categories` как категории, которые есть в файле сценария, но отсутствуют на сайте.
    - Определяет `added_categories` как категории, которые есть на сайте, но отсутствуют в файле сценария.

6.  **Обновление файла сценария**:
    - Если есть добавленные категории, добавляет их в файл сценария.
    - Если есть удаленные категории, отключает их в файле сценария.

7.  **Отправка уведомлений**:
    - Отправляет уведомления об добавленных и отключенных категориях, используя функцию `send()`.

8.  **Запись изменений в файл сценария**:
    - Записывает обновленный JSON в файл сценария, используя `json_dump()`.

9.  **Возврат результата**:
    - Возвращает `True`, если обновление выполнено успешно.

**ASCII flowchart функции**:

```
    Загрузка данных из файла сценария
    ↓
    Получение списка категорий с сайта
    ↓
    Обновление идентификаторов категорий в файле
    ↓
    Сравнение списков идентификаторов категорий
    ↓
    Обновление файла сценария
    ↓
    Отправка уведомлений
    ↓
    Запись изменений в файл сценария
    ↓
    Возврат True
```

**Примеры**:

```python
# Пример вызова функции update_categories_in_scenario_file
# Предполагается, что экземпляр класса Supplier и имя файла сценария уже определены
# result = update_categories_in_scenario_file(supplier_instance, "scenario.json")
```

### `get_list_categories_from_site`

```python
def get_list_categories_from_site(s,scenario_file,brand=''):
    _d = s.driver
    scenario_json = json_loads(Path(gs.dir_scenarios, f\'\'\'{scenario_file}\'\'\'))
    _d.get_url(scenario_json[\'store\'][\'shop categories page\'])\n
    ...
```

**Назначение**: Функция получает список категорий с сайта.

**Параметры**:
- `s`:  Supplier
- `scenario_file`:
- `brand`:

**Как работает функция**:

1.  Извлекает драйвер веб-браузера из объекта поставщика `s` и сохраняет его в переменной `_d`.
2.  Загружает JSON-конфигурацию из файла сценария `scenario_file` с использованием функции `json_loads` и сохраняет результат в переменной `scenario_json`. Путь к файлу формируется с использованием `gs.dir_scenarios`.
3.  Открывает страницу категорий магазина, используя URL, указанный в поле `'shop categories page'` объекта `scenario_json`, с помощью метода `_d.get_url()`.

**Примеры**:

```python
# Пример вызова функции get_list_categories_from_site
# Предполагается, что экземпляр класса Supplier и имя файла сценария уже определены
# categories = get_list_categories_from_site(supplier_instance, "scenario.json", "SomeBrand")
```

## Классы

### `DBAdaptor`

**Описание**: Адаптер для взаимодействия с базой данных категорий Aliexpress.

**Методы**:

-   `select(cat_id: int = None, parent_id: int = None, project_cat_id: int = None)`

    ```python
    def select(cat_id:int = None, parent_id:int = None, project_cat_id:int = None ):
        """         
        """
        ...
    ```

    **Назначение**: Выбор записей из таблицы `AliexpressCategory`.

    **Параметры**:

    -   `cat_id` (int, optional): ID категории.
    -   `parent_id` (int, optional): ID родительской категории.
    -   `project_cat_id` (int, optional): ID категории проекта.

    **Как работает функция**:

    1.  Вызывает метод `select_record` у менеджера категорий, передавая класс модели `AliexpressCategory` и параметры для выборки.

    **Примеры**:

    ```python
    # Пример вызова метода select
    #DBAdaptor.select(parent_id=123)
    ```

-   `insert()`

    ```python
    def insert():  
        """         
        """
        ...
    ```

    **Назначение**: Вставка новой записи в таблицу `AliexpressCategory`.

    **Как работает функция**:

    1.  Определяет словарь `fields` с данными для новой записи.
    2.  Вызывает метод `insert_record` у менеджера категорий, передавая класс модели `AliexpressCategory` и словарь с данными.

    **Примеры**:

    ```python
    # Пример вызова метода insert
    #DBAdaptor.insert()
    ```

-   `update()`

    ```python
    def update(): 
        """         
        """
        ...
    ```

    **Назначение**: Обновление записи в таблице `AliexpressCategory`.

    **Как работает функция**:

    1.  Вызывает метод `update_record` у менеджера категорий, передавая класс модели `AliexpressCategory`, идентификатор записи и параметры для обновления.

    **Примеры**:

    ```python
    # Пример вызова метода update
    #DBAdaptor.update()
    ```

-   `delete()`

    ```python
    def delete():
        """         
        """
        ...
    ```

    **Назначение**: Удаление записи из таблицы `AliexpressCategory`.

    **Как работает функция**:

    1.  Вызывает метод `delete_record` у менеджера категорий, передавая класс модели `AliexpressCategory` и идентификатор записи для удаления.

    **Примеры**:

    ```python
    # Пример вызова метода delete
    #DBAdaptor.delete()
    ```