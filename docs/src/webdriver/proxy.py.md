# Модуль для работы с прокси

## Обзор

Модуль предназначен для загрузки, парсинга и проверки списка прокси-серверов. Он предоставляет функции для загрузки списка прокси из удаленного источника, парсинга этого списка и проверки работоспособности отдельных прокси-серверов.

## Подробнее

Этот модуль используется для автоматического получения и обработки списка прокси-серверов. Он может быть полезен в задачах, где требуется анонимизация трафика или обход географических ограничений. Модуль загружает список прокси из указанного URL, сохраняет его в локальный файл, а затем парсит этот файл, разделяя прокси по протоколам (HTTP, SOCKS4, SOCKS5). Также модуль предоставляет возможность проверить работоспособность каждого прокси-сервера.

## Функции

### `download_proxies_list`

```python
def download_proxies_list(url: str = url, save_path: Path = proxies_list_path) -> bool:
    """
    Загружает файл по указанному URL и сохраняет его в заданный путь.

    Args:
        url (str): URL файла для загрузки. По умолчанию используется глобальная переменная `url`.
        save_path (Path): Путь для сохранения загруженного файла. По умолчанию используется глобальная переменная `proxies_list_path`.

    Returns:
        bool: `True`, если файл успешно загружен и сохранен, `False` в случае ошибки.

    Raises:
        Exception: В случае возникновения ошибки при загрузке файла.

    Example:
        >>> download_proxies_list(url='https://example.com/proxies.txt', save_path=Path('/tmp/proxies.txt'))
        True
    """
```

**Назначение**: Загружает файл со списком прокси-серверов по указанному URL и сохраняет его в локальный файл.

**Параметры**:
- `url` (str): URL-адрес, по которому находится файл со списком прокси.
- `save_path` (Path): Путь к файлу, в который будет сохранен список прокси.

**Возвращает**:
- `bool`: `True`, если загрузка и сохранение прошли успешно, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Возникает при ошибках, связанных с HTTP-запросами или файловой системой.

**Как работает функция**:
1. Функция отправляет HTTP-запрос к указанному URL-адресу.
2. Если запрос успешен, функция начинает читать содержимое ответа по частям (chunks).
3. Каждая часть записывается в указанный файл.
4. Если в процессе возникают какие-либо исключения (например, ошибка HTTP или ошибка записи в файл), функция логирует ошибку и возвращает `False`.

**ASCII flowchart**:

```
A [Запрос к URL]
|
B [Получение ответа]
|
C [Чтение по частям]
|
D [Запись в файл]
|
E [Успешно] ----> Возврат True
|
F [Ошибка] ----> Логирование ошибки ----> Возврат False
```

**Примеры**:

- Загрузка списка прокси с использованием URL и пути по умолчанию:

```python
download_proxies_list()
```

- Загрузка списка прокси с указанием пользовательского URL и пути:

```python
from pathlib import Path
download_proxies_list(url='https://example.com/proxies.txt', save_path=Path('/tmp/proxies.txt'))
```

### `get_proxies_dict`

```python
def get_proxies_dict(file_path: Path = proxies_list_path) -> Dict[str, List[Dict[str, Any]]]:
    """
    Парсит файл с прокси-адресами и распределяет их по категориям.

    Args:
        file_path (Path): Путь к файлу с прокси. По умолчанию используется глобальная переменная `proxies_list_path`.

    Returns:
        Dict[str, List[Dict[str, Any]]]: Словарь с распределёнными по типам прокси. Ключи словаря - типы прокси ('http', 'socks4', 'socks5'),
                                        значения - списки словарей, где каждый словарь содержит информацию об одном прокси
                                        (ключи: 'protocol', 'host', 'port').

    Raises:
        FileNotFoundError: Если указанный файл не найден.
        Exception: В случае возникновения ошибки при парсинге файла.

    Example:
        >>> proxies = get_proxies_dict(file_path=Path('/tmp/proxies.txt'))
        >>> print(proxies['http'][0])
        {'protocol': 'http', 'host': '127.0.0.1', 'port': '8080'}
    """
```

**Назначение**: Читает файл со списком прокси-серверов, парсит его и возвращает словарь, где прокси сгруппированы по типам (http, socks4, socks5).

**Параметры**:
- `file_path` (Path): Путь к файлу со списком прокси.

**Возвращает**:
- `Dict[str, List[Dict[str, Any]]]`: Словарь, где ключи - типы прокси (`http`, `socks4`, `socks5`), а значения - списки словарей, представляющих прокси. Каждый словарь в списке содержит ключи `protocol`, `host` и `port`.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл по указанному пути не найден.
- `Exception`: Если возникает ошибка при чтении или парсинге файла.

**Как работает функция**:
1. Функция вызывает `download_proxies_list()` для загрузки актуального списка прокси.
2. Функция пытается открыть и прочитать файл, указанный в `file_path`.
3. Для каждой строки в файле функция пытается применить регулярное выражение для извлечения протокола, хоста и порта прокси.
4. Если строка соответствует формату прокси, функция добавляет информацию о прокси в соответствующий список в словаре `proxies`.
5. Если в процессе возникают какие-либо исключения (например, файл не найден, ошибка парсинга), функция логирует ошибку.

**ASCII flowchart**:

```
A [download_proxies_list()]
|
B [Открытие файла]
|
C [Чтение строки]
|
D [Применение регулярного выражения]
|
E [Соответствует формату прокси?]
|
  Yes --> F [Добавление в словарь proxies]
  No  --> C
|
G [Файл прочитан?]
|
 Yes --> Возврат proxies
 No  --> Обработка исключений, логирование
```

**Примеры**:

- Получение словаря прокси из файла по умолчанию:

```python
proxies = get_proxies_dict()
print(proxies['http'][0])
```

- Получение словаря прокси из пользовательского файла:

```python
from pathlib import Path
proxies = get_proxies_dict(file_path=Path('/tmp/proxies.txt'))
print(proxies['socks5'])
```

### `check_proxy`

```python
def check_proxy(proxy: dict) -> bool:
    """
    Проверяет работоспособность прокси-сервера.
    
    Args:
        proxy (dict): Словарь с данными прокси (host, port, protocol).

    Returns:
        bool: True, если прокси работает, иначе False.

    Raises:
        Не вызывает исключений, но перехватывает ProxyError и RequestException.

    Example:
        >>> proxy = {'protocol': 'http', 'host': '127.0.0.1', 'port': '8080'}
        >>> check_proxy(proxy)
        False
    """
```

**Назначение**: Проверяет, является ли прокси-сервер работоспособным, отправляя HTTP-запрос через него.

**Параметры**:
- `proxy` (dict): Словарь, содержащий информацию о прокси-сервере, включая протокол (`protocol`), хост (`host`) и порт (`port`).

**Возвращает**:
- `bool`: `True`, если прокси-сервер успешно отвечает на запрос, `False` в противном случае.

**Вызывает исключения**:
- Функция не вызывает исключений, но перехватывает `ProxyError` и `RequestException`, которые могут возникнуть при попытке подключения к прокси-серверу.

**Как работает функция**:
1. Функция пытается отправить HTTP-запрос к `https://httpbin.org/ip` через указанный прокси-сервер.
2. Если прокси-сервер отвечает с кодом состояния 200, функция считает, что прокси-сервер работает, и возвращает `True`.
3. Если прокси-сервер отвечает с другим кодом состояния, функция логирует предупреждение и возвращает `False`.
4. Если во время запроса возникают исключения `ProxyError` или `RequestException`, функция логирует ошибку и возвращает `False`.

**ASCII flowchart**:

```
A [Попытка запроса через прокси]
|
B [Получен ответ?]
|
   Yes --> C [Код состояния 200?]
   |       |
   |       Yes --> Возврат True
   |       No  --> Логирование, Возврат False
|
No --> Перехват исключений (ProxyError, RequestException)
|
Логирование, Возврат False
```

**Примеры**:

- Проверка работоспособности прокси-сервера:

```python
proxy = {'protocol': 'http', 'host': '127.0.0.1', 'port': '8080'}
if check_proxy(proxy):
    print("Прокси работает")
else:
    print("Прокси не работает")
```

## Главный блок `if __name__ == '__main__'`

В главном блоке происходит следующее:
1. Вызывается функция `download_proxies_list()` для загрузки списка прокси.
2. Если загрузка прошла успешно, вызывается функция `parse_proxies()` для парсинга списка прокси.
3. Количество обработанных прокси выводится в лог.