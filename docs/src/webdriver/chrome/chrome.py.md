# Модуль для работы с WebDriver Chrome

## Обзор

Модуль `chrome.py` предназначен для управления браузером Google Chrome через WebDriver. Он расширяет возможности стандартного `webdriver.Chrome` из библиотеки Selenium, добавляя функциональность для управления профилем пользователя, прокси, пользовательским агентом и другими параметрами запуска браузера. Модуль позволяет автоматизировать взаимодействие с веб-страницами, выполнять JavaScript-код и обрабатывать локаторы элементов на странице.

## Подробней

Модуль предоставляет класс `Chrome`, который является оберткой над `selenium.webdriver.Chrome`. Он позволяет настраивать различные параметры запуска браузера, такие как:

-   Профиль пользователя Chrome
-   Версия ChromeDriver
-   User-Agent
-   Прокси
-   Режим окна (kiosk, windowless, full_window)
-   Дополнительные опции Chrome

Класс `Chrome` также предоставляет методы для выполнения JavaScript-кода и обработки локаторов элементов на странице.

## Классы

### `Chrome`

**Описание**: Расширение для класса `webdriver.Chrome` с дополнительной функциональностью.

**Наследует**:

-   `selenium.webdriver.Chrome`

**Атрибуты**:

-   `driver_name` (str): Имя драйвера, по умолчанию `'chrome'`.

**Методы**:

-   `__init__`: Инициализирует экземпляр класса `Chrome`, настраивает параметры запуска браузера и запускает WebDriver.
-   `set_proxy`: Настраивает прокси для Chrome из словаря, возвращаемого функцией `get_proxies_dict`.
-   `_payload`: Загружает исполнителей для локаторов и JavaScript сценариев.

#### `__init__`

```python
def __init__(self, profile_name: Optional[str] = None,
             chromedriver_version: Optional[str] = None,
             user_agent: Optional[str] = None,
             proxy_file_path: Optional[str] = None,
             options: Optional[List[str]] = None,
             window_mode: Optional[str] = None,
             *args, **kwargs) -> None:
    """
    Инициализирует экземпляр класса `Chrome`, настраивает параметры запуска браузера и запускает WebDriver.

    Args:
        profile_name (Optional[str], optional): Имя пользовательского профиля Chrome. По умолчанию `None`.
        chromedriver_version (Optional[str], optional): Версия chromedriver. По умолчанию `None`.
        user_agent (Optional[str], optional): Пользовательский агент в формате строки. По умолчанию `None`.
        proxy_file_path (Optional[str], optional): Путь к файлу с прокси. По умолчанию `None`.
        options (Optional[List[str]], optional): Список опций для Chrome. По умолчанию `None`.
        window_mode (Optional[str], optional): Режим окна браузера (`windowless`, `kiosk`, `full_window` и т.д.). По умолчанию `None`.

    Raises:
        WebDriverException: Если возникает ошибка при запуске WebDriver.
        Exception: Если возникает ошибка во время работы Chrome WebDriver.

    """
    ...
```

**Как работает функция**:

1.  **Объявление переменных**: Инициализируются переменные `service` и `options_obj` для дальнейшей настройки.
2.  **Загрузка настроек Chrome**: Загружаются параметры из файла `chrome.json`, расположенного в директории `src/webdriver/chrome`. Используется функция `j_loads_ns` для загрузки JSON с поддержкой namespace.
3.  **Определение пути к ChromeDriver**: Формируется путь к исполняемому файлу ChromeDriver на основе конфигурации.
4.  **Инициализация сервиса**: Создается экземпляр сервиса ChromeDriver с указанным путем.
5.  **Настройка опций Chrome**: Создается объект `Options` для настройки параметров Chrome.
6.  **Добавление опций из файла настроек**: Если в конфигурационном файле указаны опции, они добавляются в объект `options_obj`.
7.  **Установка режима окна**: Устанавливается режим окна браузера из конфигурации или переданных параметров (`window_mode`). Поддерживаются режимы `kiosk`, `windowless` и `full_window`.
8.  **Добавление дополнительных опций**: Если при инициализации класса были переданы дополнительные опции, они добавляются в объект `options_obj`.
9.  **Установка User-Agent**: Устанавливается User-Agent, либо случайный из библиотеки `fake_useragent`.
10. **Установка прокси**: Если в конфигурации включена поддержка прокси, вызывается метод `set_proxy` для настройки прокси.
11. **Настройка директории профиля**: Определяется директория профиля пользователя Chrome на основе конфигурации и переданного имени профиля.
12. **Запуск Chrome WebDriver**: Создается экземпляр `webdriver.Chrome` с настроенными опциями и сервисом, после чего вызывается метод `_payload`.
13. **Обработка исключений**: В случае возникновения ошибок при запуске WebDriver или во время работы, регистрируются соответствующие сообщения в лог.

**ASCII flowchart**:

```
Загрузка конфига (chrome.json)
    │
    ├───→ Определение пути к ChromeDriver
    │
    ├───→ Инициализация сервиса ChromeDriver
    │
    ├───→ Создание объекта Options()
    │
    ├───→ Добавление опций из конфига
    │
    ├───→ Установка режима окна
    │
    ├───→ Добавление доп. опций
    │
    ├───→ Установка User-Agent
    │
    ├───→ Установка прокси (set_proxy)
    │
    ├───→ Настройка директории профиля
    │
    └───→ Запуск Chrome WebDriver
            │
            └───→ Обработка исключений
```

**Примеры**:

```python
# Запуск Chrome с профилем пользователя и в полноэкранном режиме
driver = Chrome(profile_name='my_profile', window_mode='full_window')

# Запуск Chrome с указанным User-Agent и дополнительными опциями
driver = Chrome(user_agent='My Custom Agent', options=['--disable-gpu', '--disable-extensions'])
```

#### `set_proxy`

```python
def set_proxy(self, options: Options) -> None:
    """
    Настраивает прокси для Chrome из словаря, возвращаемого функцией `get_proxies_dict`.

    Args:
        options (Options): Опции Chrome, в которые добавляются настройки прокси.

    """
    ...
```

**Как работает функция**:

1.  **Получение списка прокси**: Вызывается функция `get_proxies_dict` для получения словаря прокси.
2.  **Объединение прокси**: Создается список `all_proxies`, содержащий все прокси из словаря (socks4 и socks5).
3.  **Поиск рабочего прокси**: Перебираются прокси из списка в случайном порядке. Для каждого прокси вызывается функция `check_proxy` для проверки его работоспособности.
4.  **Настройка прокси**: Если найден рабочий прокси, в зависимости от протокола (http, socks4, socks5) добавляется соответствующая опция в объект `options`.
5.  **Логирование**: В процессе настройки прокси регистрируются информационные сообщения о настройке прокси или предупреждения об отсутствии доступных прокси.

**ASCII flowchart**:

```
Получение словаря прокси (get_proxies_dict)
    │
    ├───→ Объединение прокси в список
    │
    ├───→ Перебор прокси в случайном порядке
    │   │
    │   └───→ Проверка прокси (check_proxy)
    │       │
    │       └───→ Если прокси рабочий:
    │           │
    │           └───→ Определение протокола
    │               │
    │               └───→ Настройка опций Chrome в зависимости от протокола
    │
    └───→ Логирование
```

**Примеры**:

```python
# Создание объекта Options и передача его в set_proxy
from selenium.webdriver.chrome.options import Options
options = Options()
driver = Chrome()
driver.set_proxy(options)
```

#### `_payload`

```python
def _payload(self) -> None:
    """
    Загружает исполнителей для локаторов и JavaScript сценариев.
    """
    ...
```

**Как работает функция**:

1.  **Создание экземпляра `JavaScript`**: Создается экземпляр класса `JavaScript`, который предоставляет методы для выполнения JavaScript-кода в браузере.
2.  **Присвоение методов `JavaScript`**: Методы экземпляра `JavaScript` (например, `get_page_lang`, `ready_state`) присваиваются текущему экземпляру класса `Chrome`, чтобы их можно было вызывать непосредственно из экземпляра `Chrome`.
3.  **Создание экземпляра `ExecuteLocator`**: Создается экземпляр класса `ExecuteLocator`, который предоставляет методы для выполнения локаторов элементов на странице.
4.  **Присвоение методов `ExecuteLocator`**: Методы экземпляра `ExecuteLocator` (например, `execute_locator`, `get_webelement_as_screenshot`) присваиваются текущему экземпляру класса `Chrome`, чтобы их можно было вызывать непосредственно из экземпляра `Chrome`.

**ASCII flowchart**:

```
Создание экземпляра JavaScript
    │
    ├───→ Присвоение методов JavaScript экземпляру Chrome
    │
    ├───→ Создание экземпляра ExecuteLocator
    │
    └───→ Присвоение методов ExecuteLocator экземпляру Chrome
```

**Примеры**:

```python
# После инициализации драйвера, можно вызывать методы для выполнения JavaScript и локаторов
driver = Chrome()
page_lang = driver.get_page_lang()
element = driver.execute_locator({"by": "id", "selector": "my_element"})
```

## Функции

В данном модуле нет отдельных функций, не относящихся к классам.

## Примеры

```python
if __name__ == "__main__":
    driver = Chrome(window_mode='full_window')
    driver.get("https://google.com")
```