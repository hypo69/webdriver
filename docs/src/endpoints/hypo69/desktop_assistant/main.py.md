# Модуль `main.py`

## Обзор

Модуль `main.py` является основным файлом приложения FastAPI, предназначенного для работы с ассистентом программиста. Он содержит настройки сервера, маршруты для обработки запросов чата и получения локализаций, а также логику для взаимодействия с AI-моделью Google Gemini.

## Подробней

Данный модуль определяет FastAPI приложение, настраивает CORS для обеспечения возможности кросс-доменных запросов, монтирует статические файлы (шаблоны), определяет маршруты для корневого пути (`/`) и API чата (`/api/chat`). Он также содержит функции для загрузки файлов локализации и запуска Uvicorn сервера.
В модуле используются глобальные переменные `model`, `api_key`, `system_instruction`, которые инициализируются при старте приложения.

## Классы

### `ChatRequest`

**Описание**: Pydantic модель для запросов чата.

**Аттрибуты**:
- `message` (str): Сообщение пользователя.

## Функции

### `root`

```python
async def root():
    """
    Отображает HTML-страницу по корневому пути.

    Returns:
        HTMLResponse: HTML-контент главной страницы.

    Raises:
        HTTPException: Если не удается найти или прочитать файл `index.html`.
    """
```

**Назначение**: Функция `root` обрабатывает GET-запросы к корневому пути (`/`) и возвращает HTML-контент главной страницы.

**Как работает функция**:
1. **Определяет путь к файлу `index.html`**
2. **Проверяет существование файла**: Проверяет, существует ли файл `index.html` по указанному пути. Если файл не найден, выбрасывается исключение `FileNotFoundError`.
3. **Читает содержимое файла**: Если файл существует, его содержимое считывается в кодировке UTF-8.
4. **Возвращает HTML-ответ**: Возвращает HTML-ответ с содержимым файла `index.html`.
5. **Обработка исключений**: Если в процессе чтения файла возникает исключение, оно логируется, и выбрасывается исключение `HTTPException` с кодом состояния 500.

**Примеры**:

```python
# Запрос к корневому пути вернет HTML-страницу
# GET /
```

### `chat`

```python
async def chat(request: ChatRequest):
    """
    Обрабатывает запросы чата, отправляя сообщения в AI-модель и возвращая ответы.

    Args:
        request (ChatRequest): Объект запроса чата, содержащий сообщение пользователя.

    Returns:
        dict: Ответ от AI-модели в формате JSON.

    Raises:
        HTTPException: Если возникает ошибка при взаимодействии с AI-моделью.
    """
```

**Назначение**: Функция `chat` обрабатывает POST-запросы к пути `/api/chat`, отправляет сообщения в AI-модель Google Gemini и возвращает ответы.

**Параметры**:
- `request` (ChatRequest): Объект запроса чата, содержащий сообщение пользователя.

**Возвращает**:
- `dict`: Ответ от AI-модели в формате JSON.

**Вызывает исключения**:
- `HTTPException`: Если возникает ошибка при взаимодействии с AI-моделью.

**Как работает функция**:
1. **Проверяет инициализацию модели**: Проверяет, инициализирована ли глобальная переменная `model`. Если модель не инициализирована, создается новый экземпляр `GoogleGenerativeAI` с использованием API-ключа из `gs.credentials.gemini.games` и модели `gemini-2.0-flash-exp`.
2. **Отправляет сообщение в модель**: Отправляет сообщение пользователя из объекта `request` в AI-модель с помощью метода `chat`.
3. **Возвращает ответ**: Возвращает ответ от AI-модели в формате JSON.
4. **Обработка исключений**: Если в процессе взаимодействия с AI-моделью возникает исключение, оно логируется, и выбрасывается исключение `HTTPException` с кодом состояния 500.

**Примеры**:

```python
# POST /api/chat с JSON-телом {"message": "Hello, AI!"} вернет {"response": "AI response"}
```

### `get_locale_file`

```python
def get_locale_file(lang: str):
    """
    Получает файл локализации для указанного языка.

    Args:
        lang (str): Код языка (например, "en", "ru").

    Returns:
        dict: Содержимое файла локализации в формате JSON.

    Raises:
        HTTPException: Если файл локализации не найден, содержит ошибки JSON или не может быть прочитан.
    """
```

**Назначение**: Функция `get_locale_file` получает файл локализации для указанного языка.

**Параметры**:
- `lang` (str): Код языка (например, "en", "ru").

**Возвращает**:
- `dict`: Содержимое файла локализации в формате JSON.

**Вызывает исключения**:
- `HTTPException`: Если файл локализации не найден, содержит ошибки JSON или не может быть прочитан.

**Как работает функция**:
1. **Определяет путь к файлу локализации**: Формирует путь к файлу локализации на основе кода языка.
2. **Открывает и читает файл**: Открывает файл локализации в режиме чтения с кодировкой UTF-8 и загружает его содержимое с использованием `json.load`.
3. **Обрабатывает исключения**:
   - Если файл не найден, логируется ошибка, и выбрасывается исключение `HTTPException` с кодом состояния 404.
   - Если файл содержит ошибки JSON, логируется ошибка, и выбрасывается исключение `HTTPException` с кодом состояния 500.
   - Если возникает другая ошибка при чтении файла, логируется ошибка, и выбрасывается исключение `HTTPException` с кодом состояния 500.

**Примеры**:

```python
# get_locale_file("ru") вернет словарь с русскими локализациями
# get_locale_file("en") вернет словарь с английскими локализациями
```

### `locales`

```python
async def locales(lang:str):
    """
    Обрабатывает запросы на получение файлов локализации для указанного языка.

    Args:
        lang (str): Код языка (например, "en", "ru").

    Returns:
        dict: Содержимое файла локализации в формате JSON.

    Raises:
        HTTPException: Если файл локализации не найден, содержит ошибки JSON или не может быть прочитан.
    """
```

**Назначение**: Функция `locales` обрабатывает GET-запросы к пути `/locales/{lang}.json` и возвращает содержимое файла локализации для указанного языка.

**Параметры**:
- `lang` (str): Код языка (например, "en", "ru").

**Возвращает**:
- `dict`: Содержимое файла локализации в формате JSON.

**Вызывает исключения**:
- `HTTPException`: Если файл локализации не найден, содержит ошибки JSON или не может быть прочитан.

**Как работает функция**:
1. **Вызывает функцию `get_locale_file`**: Вызывает функцию `get_locale_file` с указанным кодом языка для получения содержимого файла локализации.
2. **Возвращает содержимое файла**: Возвращает содержимое файла локализации, полученное от функции `get_locale_file`.

**Примеры**:

```python
# GET /locales/ru.json вернет словарь с русскими локализациями
# GET /locales/en.json вернет словарь с английскими локализациями
```

## Локальный запуск сервера

```python
if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=8000)
```

**Назначение**: Этот блок кода запускает Uvicorn сервер, если скрипт выполняется напрямую (а не импортируется как модуль).

**Как работает**:
- `uvicorn.run(app, host="127.0.0.1", port=8000)`: Запускает Uvicorn сервер с приложением `app` на хосте "127.0.0.1" (localhost) и порту 8000.

**Примеры**:

```python
# Запуск сервера: python main.py
```