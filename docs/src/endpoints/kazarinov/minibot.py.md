# Модуль для работы с мини-ботом для Казаринова
=================================================

Модуль содержит классы и функции для создания и управления Telegram-ботом, предназначенным для обработки запросов, связанных с созданием прайс-листов.
Бот умеет обрабатывать текстовые команды, URL-адреса, голосовые сообщения и документы.

[Документация](https://github.com/hypo69/hypo/blob/master/docs/ru/src/endpoints/kazarinov/minibot.py.md)

## Оглавление
- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [Config](#config)
    - [BotHandler](#bothandler)
- [Функции](#функции)
    - [command_start](#command_start)
    - [command_help](#command_help)
    - [command_info](#command_info)
    - [command_time](#command_time)
    - [command_photo](#command_photo)
    - [handle_voice_message](#handle_voice_message)
    - [handle_document_message](#handle_document_message)
    - [handle_text_message](#handle_text_message)
    - [handle_unknown_command](#handle_unknown_command)
    - [main](#main)

## Обзор

Модуль предоставляет функциональность для создания Telegram-бота, который может обрабатывать различные типы сообщений, включая текстовые команды, URL-адреса, голосовые сообщения и документы.
Бот интегрирован с Google Gemini для обработки текстовых запросов и выполняет сценарии для получения информации о товарах по URL-адресам.

## Подробнее

Данный модуль является частью проекта `hypotez` и предназначен для обслуживания запросов, связанных с формированием прайс-листов для конкретного пользователя (Казаринова).
Он использует библиотеку `telebot` для взаимодействия с Telegram API, а также включает в себя интеграцию с AI-моделями Google Gemini для обработки текстовых запросов.

Модуль содержит классы `Config` и `BotHandler`, а также набор функций для обработки различных команд и типов сообщений, отправляемых боту.

## Классы

### `Config`

**Описание**: Класс, предназначенный для хранения конфигурационных параметров бота.

**Принцип работы**:
Класс определяет различные настройки, такие как токен бота, идентификатор канала, каталоги для хранения фотографий, сообщения для различных команд и режимы работы (PRODUCTION или DEV).
В зависимости от режима работы, выбирается соответствующий токен бота (боевой или тестовый).

**Атрибуты**:
- `ENDPOINT` (str): Имя endpoint.
- `MODE` (str): Режим работы бота (`PRODUCTION` или `DEV`).
- `BOT_TOKEN` (str): Токен Telegram-бота.
- `CHANNEL_ID` (str): Идентификатор канала Telegram.
- `PHOTO_DIR` (Path): Путь к директории с фотографиями.
- `COMMAND_INFO` (str): Информация о боте.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение об неизвестной команде.
- `START_MESSAGE` (str): Приветственное сообщение при старте бота.
- `HELP_MESSAGE` (str): Справка по доступным командам.

**Примеры**:
```python
config = Config()
print(config.BOT_TOKEN)
print(config.MODE)
```

### `BotHandler`

**Описание**: Класс, предназначенный для обработки команд и сообщений, получаемых от Telegram-бота.

**Принцип работы**:
Класс инициализируется со списком вопросов (`questions_list`) и моделью Google Gemini для обработки текстовых запросов.
Он содержит методы для обработки различных типов сообщений, таких как текстовые команды, URL-адреса, голосовые сообщения и документы.
При получении URL-адреса, содержащего ссылку на `one-tab.com`, класс извлекает данные о товарах и запускает сценарий для получения дополнительной информации.

**Атрибуты**:
- `base_dir` (Path): Базовая директория модуля.
- `questions_list` (List[str]): Список вопросов для обработки команды `--next`.
- `model` (GoogleGenerativeAI): Инстанс модели Google Gemini для обработки текста.
- `scenario` (Scenario): Сценарий выполнения действий (например, парсинг URL).

**Методы**:
- `__init__`: Инициализация обработчика событий телеграм-бота.
- `handle_message`: Обработка текстовых сообщений.
- `_send_user_flowchart`: Отправка схемы user_flowchart.
- `_handle_url`: Обработка URL, присланного пользователем.
- `_handle_next_command`: Обработка команды '--next' и её аналогов.
- `help_command`: Обработка команды /help.
- `send_pdf`: Обработка команды /sendpdf для отправки PDF.
- `handle_voice`: Обработка голосовых сообщений.
- `_transcribe_voice`: Транскрибирование голосового сообщения (заглушка).
- `handle_document`: Обработка полученных документов.

## Функции

### `command_start`

```python
def command_start(message:'telebot.types.Message'):
    """
    Обрабатывает команду /start, отправляет приветственное сообщение пользователю.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка команды `/start`, отправка приветственного сообщения пользователю.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения команды `/start` от пользователя.
2. Отправляет приветственное сообщение из конфигурации (`config.START_MESSAGE`) пользователю в чат.

```
Получение команды /start от пользователя
  │
  └── Отправка приветственного сообщения пользователю
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(commands=['start'])
def command_start(message):
    command_start(message)
```

### `command_help`

```python
def command_help(message:'telebot.types.Message'):
    """
    Обрабатывает команду /help, отображает справочное сообщение с доступными командами.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка команды `/help`, отображение справочного сообщения с доступными командами.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения команды `/help` от пользователя.
2. Вызывает метод `help_command` у обработчика `handler` для отправки справочного сообщения пользователю.

```
Получение команды /help от пользователя
  │
  └── Вызов метода help_command у обработчика для отправки справки
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(commands=['help'])
def command_help(message):
    command_help(message)
```

### `command_info`

```python
def command_info(message:'telebot.types.Message'):
    """
    Обрабатывает команду /info, отображает информацию о боте.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка команды `/info`, отображение информации о боте.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения команды `/info` от пользователя.
2. Отправляет информационное сообщение о боте (`config.COMMAND_INFO`) пользователю в чат.

```
Получение команды /info от пользователя
  │
  └── Отправка информационного сообщения о боте пользователю
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(commands=['info'])
def command_info(message):
    command_info(message)
```

### `command_time`

```python
def command_time(message:'telebot.types.Message'):
    """
    Обрабатывает команду /time, отображает текущее время.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка команды `/time`, отображение текущего времени.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения команды `/time` от пользователя.
2. Получает текущее время с помощью `datetime.datetime.now()`.
3. Форматирует текущее время в строку.
4. Отправляет сообщение с текущим временем пользователю в чат.

```
Получение команды /time от пользователя
  │
  ├── Получение текущего времени
  │
  ├── Форматирование времени в строку
  │
  └── Отправка сообщения с текущим временем пользователю
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(commands=['time'])
def command_time(message):
    command_time(message)
```

### `command_photo`

```python
def command_photo(message:'telebot.types.Message'):
    """
    Обрабатывает команду /photo, отправляет случайное фото из заданной директории.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка команды `/photo`, отправка случайной фотографии из указанной директории.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения команды `/photo` от пользователя.
2. Пытается получить список файлов из директории с фотографиями (`config.PHOTO_DIR`).
3. Если список файлов не пуст, выбирает случайный файл.
4. Открывает файл и отправляет фотографию пользователю.
5. Обрабатывает исключения, если директория не найдена или в ней нет файлов.

```
Получение команды /photo от пользователя
  │
  ├── Получение списка файлов из директории с фотографиями
  │
  ├── Если список файлов не пуст:
  │   ├── Выбор случайного файла
  │   ├── Открытие файла
  │   └── Отправка фотографии пользователю
  │
  └── Обработка исключений (директория не найдена, нет файлов)
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(commands=['photo'])
def command_photo(message):
    command_photo(message)
```

### `handle_voice_message`

```python
def handle_voice_message(message:'telebot.types.Message'):
    """
    Обрабатывает голосовое сообщение, полученное от пользователя.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка голосового сообщения, полученного от пользователя.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения голосового сообщения от пользователя.
2. Вызывает метод `handle_voice` у обработчика `handler` для обработки голосового сообщения.

```
Получение голосового сообщения от пользователя
  │
  └── Вызов метода handle_voice у обработчика для обработки сообщения
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    handle_voice_message(message)
```

### `handle_document_message`

```python
def handle_document_message(message:'telebot.types.Message'):
    """
    Обрабатывает документ, полученный от пользователя.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка документа, полученного от пользователя.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения документа от пользователя.
2. Вызывает метод `handle_document` у обработчика `handler` для обработки документа.

```
Получение документа от пользователя
  │
  └── Вызов метода handle_document у обработчика для обработки документа
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(content_types=['document'])
def handle_document_message(message):
    handle_document_message(message)
```

### `handle_text_message`

```python
def handle_text_message(message:'telebot.types.Message'):
    """
    Обрабатывает текстовое сообщение, полученное от пользователя.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка текстового сообщения, полученного от пользователя.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения текстового сообщения от пользователя.
2. Вызывает метод `handle_message` у обработчика `handler` для обработки текстового сообщения.

```
Получение текстового сообщения от пользователя
  │
  └── Вызов метода handle_message у обработчика для обработки сообщения
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message):
    handle_text_message(message)
```

### `handle_unknown_command`

```python
def handle_unknown_command(message:'telebot.types.Message'):
    """
    Обрабатывает неизвестную команду, полученную от пользователя.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обработка неизвестной команды, полученной от пользователя.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт получения неизвестной команды от пользователя.
2. Отправляет сообщение об неизвестной команде (`config.UNKNOWN_COMMAND_MESSAGE`) пользователю в чат.

```
Получение неизвестной команды от пользователя
  │
  └── Отправка сообщения об неизвестной команде пользователю
```

**Примеры**:

```python
# Пример использования в коде бота:
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message):
    handle_unknown_command(message)
```

### `main`

```python
def main(restarts: int = 5):
    """
    Основная функция для запуска бота.

    Args:
        restarts (int, optional): Количество попыток перезапуска бота в случае ошибки. По умолчанию 5.

    Returns:
        None

    """
```

**Назначение**: Запуск Telegram-бота в бесконечном цикле с обработкой возможных ошибок и перезапусками.

**Параметры**:
- `restarts` (int): Количество попыток перезапуска бота в случае ошибки. По умолчанию 5.

**Возвращает**:
- `None`

**Как работает функция**:
1. Логирует факт запуска бота в определенном режиме (`Config.MODE`).
2. Запускает бота в режиме опроса (`bot.polling(none_stop=True)`), что позволяет боту непрерывно получать и обрабатывать сообщения.
3. В случае возникновения ошибки (исключения), логирует ошибку и пытается перезапустить бота.
4. Если количество попыток перезапуска превышено, завершает работу.

**Внутренние функции**:
- Отсутствуют

```
Запуск бота
  │
  ├── Запуск бота в режиме опроса
  │
  ├── В случае ошибки:
  │   ├── Логирование ошибки
  │   ├── Попытка остановить бота
  │   ├── Повторный запуск бота через 10 секунд (если количество попыток не превышено)
  │
  └── Если количество попыток перезапуска превышено:
      └── Завершение работы
```

**Примеры**:

```python
# Пример использования:
if __name__ == '__main__':
    main(restarts=5)