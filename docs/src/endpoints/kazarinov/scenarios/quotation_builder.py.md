# Модуль для создания коммерческих предложений
## Обзор

Модуль `quotation_builder.py` предназначен для автоматизации процесса извлечения, обработки и сохранения данных о товарах от различных поставщиков. Он включает в себя функциональность для подготовки данных, обработки с использованием AI, а также интеграцию с Facebook для публикации рекламных объявлений. Модуль обеспечивает гибкость в настройке и управлении данными о товарах, облегчая создание коммерческих предложений и рекламных материалов.

## Подробнее

Модуль предназначен для автоматизации процесса формирования коммерческих предложений (мехироним) на основе данных о товарах, полученных от различных поставщиков. Он включает в себя функциональность для парсинга данных, обработки с использованием моделей искусственного интеллекта (AI), сохранения результатов и публикации в социальных сетях, таких как Facebook. Модуль обеспечивает гибкость в настройке и управлении данными о товарах, облегчая создание коммерческих предложений и рекламных материалов. Расположение модуля в структуре проекта указывает на его роль в обработке данных и формировании контента для рекламных кампаний.

## Классы

### `QuotationBuilder`

**Описание**: Класс `QuotationBuilder` предназначен для извлечения, разбора и сохранения данных о товарах поставщиков. Он управляет процессами обработки данных, взаимодействия с AI-моделями и публикации контента.

**Принцип работы**:

1.  **Инициализация**: Класс инициализируется с именем процесса (`mexiron_name`), экземпляром веб-драйвера (`driver`) и другими параметрами. Он загружает конфигурацию из JSON-файла и настраивает пути для экспорта данных.
2.  **Обработка данных**: Методы класса позволяют конвертировать данные о товарах в формат, пригодный для обработки AI-моделями, и сохранять обработанные данные в файлы.
3.  **Взаимодействие с AI**: Класс использует модель Google Gemini для обработки текстовых данных о товарах, генерируя описания и рекламные материалы на разных языках.
4.  **Публикация в Facebook**: Класс автоматизирует процесс публикации рекламных объявлений в Facebook, включая загрузку медиафайлов и публикацию текста объявления.

**Аттрибуты**:

*   `base_path` (Path): Базовый путь к каталогу модуля.
*   `config` (SimpleNamespace): Объект, содержащий конфигурацию, загруженную из JSON-файла.
*   `html_path` (str | Path): Путь к HTML-файлу.
*   `pdf_path` (str | Path): Путь к PDF-файлу.
*   `docx_path` (str | Path): Путь к DOCX-файлу.
*   `driver` (Driver): Экземпляр Selenium WebDriver для управления браузером.
*   `export_path` (Path): Путь для экспорта данных.
*   `mexiron_name` (str): Имя процесса Mexiron.
*   `price` (float): Цена товара.
*   `timestamp` (str): Временная метка.
*   `products_list` (List): Список обработанных данных о продуктах.
*   `model` (GoogleGenerativeAI): Экземпляр AI-модели Google Gemini.
*   `translations` (SimpleNamespace): Объект, содержащий переводы, загруженные из JSON-файла.
*   `required_fields` (tuple): Кортеж необходимых полей товара.

**Методы**:

*   `__init__`: Инициализирует экземпляр класса `QuotationBuilder`.
*   `convert_product_fields`: Преобразует поля продукта в словарь.
*   `process_ai`: Обрабатывает список продуктов с использованием AI-модели.
*   `process_ai_async`: Асинхронно обрабатывает список продуктов с использованием AI-модели.
*   `save_product_data`: Сохраняет данные о продукте в файл.
*   `post_facebook_async`: Исполняет сценарий рекламного модуля `facebook`.

### `__init__`

```python
def __init__(self, mexiron_name:Optional[str] = gs.now, driver:Optional[Firefox | Playwrid | str] = None,  **kwards):
    """
    Initializes Mexiron class with required components.

    Args:
        driver (Driver): Selenium WebDriver instance.
        mexiron_name (Optional[str]): Custom name for the Mexiron process.
        webdriver_name (Optional[str]): Name of the WebDriver to use. Defaults to 'firefox'. call to Firefox or Playwrid
        window_mode (Optional[str]): Оконный режим вебдрайвера. Может быть 'maximized', 'headless', 'minimized', 'fullscreen', 'normal', 'hidden', 'kiosk'

    """
```

**Назначение**: Инициализирует класс `QuotationBuilder` с необходимыми компонентами, такими как веб-драйвер и модель AI.

**Параметры**:

*   `mexiron_name` (Optional[str]): Имя процесса Mexiron. По умолчанию используется текущее время.
*   `driver` (Optional[Firefox | Playwrid | str]): Экземпляр веб-драйвера (Firefox или Playwright) или его название. По умолчанию используется Firefox.
*   `kwards` (dict): Дополнительные параметры для инициализации веб-драйвера.

**Как работает функция**:

1.  **Инициализация имени и пути экспорта**: Функция инициализирует имя процесса `mexiron_name` и строит путь для экспорта данных, используя имя процесса и базовый путь для хранения.

2.  **Инициализация веб-драйвера**: Функция инициализирует веб-драйвер в зависимости от переданного параметра `driver`. Если передан экземпляр `Driver`, он используется напрямую. Если передан класс `Firefox` или `Playwrid`, создается экземпляр `Driver` с этим классом. Если передана строка (например, `'firefox'` или `'playwright'`), создается соответствующий экземпляр `Driver`. Если `driver` не передан, используется `Firefox` по умолчанию.

3.  **Инициализация AI-модели**: Функция инициализирует модель Google Gemini, загружая системные инструкции и API-ключ.

**Примеры**:

```python
quotation = QuotationBuilder(mexiron_name='test_mexiron', driver='firefox', window_mode='maximized')
quotation = QuotationBuilder(mexiron_name='test_mexiron', driver=Firefox(), window_mode='headless')
```

### `convert_product_fields`

```python
def convert_product_fields(self, f: ProductFields) -> dict:
    """
    Converts product fields into a dictionary. 
    Функция конвертирует поля из объекта `ProductFields` в простой словарь для модели ии.


    Args:
        f (ProductFields): Object containing parsed product data.

    Returns:
        dict: Formatted product data dictionary.

    .. note:: Правила построения полей определяются в `ProductFields`
    """
```

**Назначение**: Преобразует поля продукта из объекта `ProductFields` в словарь.

**Параметры**:

*   `f` (ProductFields): Объект, содержащий данные о продукте.

**Возвращает**:

*   `dict`: Словарь с данными о продукте.

**Как работает функция**:

1.  **Проверка наличия ID продукта**: Функция проверяет, получен ли `id_product`. Если `id_product` отсутствует, функция логирует ошибку и возвращает пустой словарь. Это необходимо, так как отсутствие `id_product` может указывать на то, что вместо страницы товара была получена страница категории.
2.  **Извлечение значений полей**: Функция извлекает значения полей `name`, `description`, `description_short` и `specification` из объекта `ProductFields`. Если какое-либо из этих полей отсутствует, используется пустая строка.
3.  **Формирование словаря**: Функция формирует словарь с данными о продукте, включая `product_name`, `product_id`, `description_short`, `description`, `specification` и `local_image_path`. Если `product_name` отсутствует, возвращается пустой словарь.

**Примеры**:

```python
product_data = quotation.convert_product_fields(product_fields)
```

### `process_ai`

```python
def process_ai(self, products_list: List[str], lang:str,  attempts: int = 3) -> tuple | bool:
    """
    Processes the product list through the AI model.

    Args:
        products_list (str): List of product data dictionaries as a string.
        attempts (int, optional): Number of attempts to retry in case of failure. Defaults to 3.

    Returns:
        tuple: Processed response in `ru` and `he` formats.
        bool: False if unable to get a valid response after retries.

    .. note::
        Модель может возвращать невалидный результат.
        В таком случае я переспрашиваю модель разумное количество раз.
    """
```

**Назначение**: Обрабатывает список продуктов с использованием AI-модели для генерации контента на указанном языке.

**Параметры**:

*   `products_list` (List[str]): Список данных о продуктах в формате строки.
*   `lang` (str): Язык, на котором необходимо сгенерировать контент.
*   `attempts` (int): Количество попыток повторной обработки в случае неудачи. По умолчанию 3.

**Возвращает**:

*   `dict`: Обработанный ответ от AI-модели в формате словаря.
*   `{}` (dict): Пустой словарь, если не удалось получить валидный ответ после всех попыток.

**Как работает функция**:

1.  **Проверка количества попыток**: Функция проверяет, остались ли доступные попытки для обработки. Если `attempts` меньше 1, функция логирует ошибку и возвращает пустой словарь.
2.  **Загрузка командной инструкции**: Функция загружает командную инструкцию для AI-модели из файла, соответствующего указанному языку.
3.  **Формирование запроса к AI-модели**: Функция формирует запрос к AI-модели, объединяя командную инструкцию и список данных о продуктах.
4.  **Отправка запроса к AI-модели**: Функция отправляет запрос к AI-модели и получает ответ.
5.  **Обработка ответа от AI-модели**: Функция пытается распарсить ответ от AI-модели в формат словаря. Если парсинг не удался, функция логирует ошибку и, если остались доступные попытки, рекурсивно вызывает себя для повторной обработки.
6.  **Возврат результата**: Функция возвращает обработанный ответ от AI-модели в формате словаря. Если после всех попыток не удалось получить валидный ответ, возвращается пустой словарь.

**Примеры**:

```python
response = quotation.process_ai(products_list, lang='ru', attempts=3)
```

### `process_ai_async`

```python
async def process_ai_async(self, products_list: List[str], lang:str,  attempts: int = 3) -> tuple | bool:
    """
    Processes the product list through the AI model.

    Args:
        products_list (str): List of product data dictionaries as a string.
        attempts (int, optional): Number of attempts to retry in case of failure. Defaults to 3.

    Returns:
        tuple: Processed response in `ru` and `he` formats.
        bool: False if unable to get a valid response after retries.

    .. note::
        Модель может возвращать невалидный результат.
        В таком случае я переспрашиваю модель разумное количество раз.
    """
```

**Назначение**: Асинхронно обрабатывает список продуктов с использованием AI-модели для генерации контента на указанном языке.

**Параметры**:

*   `products_list` (List[str]): Список данных о продуктах в формате строки.
*   `lang` (str): Язык, на котором необходимо сгенерировать контент.
*   `attempts` (int): Количество попыток повторной обработки в случае неудачи. По умолчанию 3.

**Возвращает**:

*   `dict`: Обработанный ответ от AI-модели в формате словаря.
*   `{}` (dict): Пустой словарь, если не удалось получить валидный ответ после всех попыток.

**Как работает функция**:

1.  **Проверка количества попыток**: Функция проверяет, остались ли доступные попытки для обработки. Если `attempts` меньше 1, функция логирует ошибку и возвращает пустой словарь.
2.  **Загрузка командной инструкции**: Функция загружает командную инструкцию для AI-модели из файла, соответствующего указанному языку.
3.  **Формирование запроса к AI-модели**: Функция формирует запрос к AI-модели, объединяя командную инструкцию и список данных о продуктах.
4.  **Отправка запроса к AI-модели**: Функция асинхронно отправляет запрос к AI-модели и получает ответ.
5.  **Обработка ответа от AI-модели**: Функция пытается распарсить ответ от AI-модели в формат словаря. Если парсинг не удался, функция логирует ошибку и, если остались доступные попытки, рекурсивно вызывает себя для повторной обработки.
6.  **Возврат результата**: Функция возвращает обработанный ответ от AI-модели в формате словаря. Если после всех попыток не удалось получить валидный ответ, возвращается пустой словарь.

**Примеры**:

```python
response = await quotation.process_ai_async(products_list, lang='ru', attempts=3)
```

### `save_product_data`

```python
async def save_product_data(self, product_data: dict) -> bool:
    """
    Saves individual product data to a file.

    Args:
        product_data (dict): Formatted product data.
    """
```

**Назначение**: Сохраняет данные о продукте в файл.

**Параметры**:

*   `product_data` (dict): Словарь с данными о продукте.

**Возвращает**:

*   `True` (bool): В случае успешного сохранения данных.
*   `None`: В случае ошибки при сохранении данных.

**Как работает функция**:

1.  **Определение пути к файлу**: Функция определяет путь к файлу, в котором будут сохранены данные о продукте. Путь формируется на основе `export_path` и `product_id`.
2.  **Сохранение данных в файл**: Функция использует `j_dumps` для сохранения данных о продукте в файл в формате JSON. Если сохранение не удалось, функция логирует ошибку.

**Примеры**:

```python
await quotation.save_product_data(product_data)
```

### `post_facebook_async`

```python
async def post_facebook_async(self, mexiron:SimpleNamespace) -> bool:
    """Функция исполняет сценарий рекламного модуля `facvebook`."""
    ...
```

**Назначение**: Выполняет сценарий рекламного модуля `facebook` для публикации рекламного объявления в Facebook.

**Параметры**:

*   `mexiron` (SimpleNamespace): Объект, содержащий данные для публикации в Facebook, такие как заголовок, описание, цена и медиафайлы.

**Возвращает**:

*   `True` (bool): В случае успешной публикации объявления.
*   `None`: В случае ошибки при публикации объявления.

**Как работает функция**:

1.  **Авторизация в Facebook**: Функция переходит по URL-адресу профиля Facebook.
2.  **Формирование заголовка объявления**: Функция формирует заголовок объявления, объединяя заголовок, описание и цену из объекта `mexiron`.
3.  **Публикация заголовка**: Функция публикует заголовок объявления в Facebook. Если публикация не удалась, функция логирует предупреждение.
4.  **Загрузка медиафайлов**: Функция загружает медиафайлы (изображения) для объявления в Facebook. Если загрузка не удалась, функция логирует предупреждение.
5.  **Публикация объявления**: Функция публикует объявление в Facebook. Если публикация не удалась, функция логирует предупреждение.

**Примеры**:

```python
await quotation.post_facebook_async(mexiron)
```

## Функции

### `main`

```python
def main():
    """"""
    ...
```

**Назначение**: Главная функция, выполняющая основные операции по созданию отчетов на основе данных о товарах.

**Как работает функция**:

1.  **Определение параметров**: Функция задает язык (`lang`), имя мехирона (`mexiron_name`) и пути к файлам для экспорта данных.
2.  **Загрузка данных**: Функция загружает данные о товарах из JSON-файла.
3.  **Создание отчетов**: Функция создает экземпляр класса `QuotationBuilder` и вызывает метод `create_reports` для генерации отчетов в форматах HTML, PDF и DOCX.

### Блок-схема функции `main`

```
Начало
│
├───> Определение параметров (язык, имя мехирона, пути к файлам)
│
├───> Загрузка данных о товарах из JSON-файла
│
├───> Создание экземпляра класса QuotationBuilder
│
├───> Вызов метода create_reports для генерации отчетов
│
Конец