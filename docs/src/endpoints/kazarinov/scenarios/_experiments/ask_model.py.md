# Модуль для проверки ответов от модели

## Обзор

Модуль предназначен для взаимодействия с AI-моделями (в частности, Google Gemini) и проверки валидности их ответов на основе заданных инструкций и списка продуктов. Он загружает инструкции на разных языках, отправляет запросы к модели и сохраняет полученные ответы в формате JSON.

## Подробнее

Модуль выполняет следующие основные задачи:

1.  Загрузка необходимых инструкций для модели на русском и иврите.
2.  Инициализация AI-модели Google Gemini с использованием API-ключа и системной инструкции.
3.  Формирование запросов к модели на основе инструкций и списка продуктов.
4.  Отправка запросов к модели и обработка полученных ответов.
5.  Сохранение ответов модели в формате JSON.

## Функции

### `model_ask`

```python
def model_ask(lang: str, attempts: int = 3) -> dict:
    """
    Запрашивает у модели ответ на основе заданного языка и обрабатывает его.

    Args:
        lang (str): Язык запроса ('ru' для русского, 'he' для иврита).
        attempts (int, optional): Количество попыток запроса к модели в случае неудачи. По умолчанию 3.

    Returns:
        dict: Словарь с ответом от модели. Возвращает пустой словарь в случае ошибки.

    Raises:
        Exception: Если возникает ошибка при парсинге ответа от модели.

    Example:
        >>> response = model_ask('ru')
        >>> if response:
        ...     print(response.keys())
        dict_keys(['ключ1', 'ключ2', ...])
    """
```

**Как работает функция**:

1.  **Инициализация**:
    *   Функция `model_ask` принимает язык запроса (`lang`) и количество попыток (`attempts`) в качестве аргументов.
    *   Определяются глобальные переменные `model`, `q_ru`, `q_he`, используемые для взаимодействия с моделью и формирования запросов.

2.  **Формирование запроса**:
    *   В зависимости от языка (`lang`) выбирается соответствующий запрос (`q_ru` для русского, `q_he` для иврита).

3.  **Отправка запроса и получение ответа**:
    *   Функция отправляет запрос к модели с помощью метода `model.ask()`.

4.  **Обработка ответа**:

    *   Если ответ от модели отсутствует, регистрируется ошибка, и функция возвращает пустой словарь.
    *   Если ответ получен, он парсится с использованием `j_loads()`.
    *   Если парсинг не удался, регистрируется ошибка, и функция повторяет запрос, если количество попыток (`attempts`) больше 1.

5.  **Возврат результата**:
    *   Функция возвращает словарь с ответом от модели.

```
       Начало
         |
         | Параметры: lang, attempts
         |
       Запрос к модели (model.ask)
         |
         | response = model.ask(q_ru if lang == 'ru' else q_he)
         |
       Проверка ответа
         |
         | Если response пустой
         | -- Да: Лог ошибки -> Возврат {}
         | -- Нет: Парсинг ответа (j_loads)
         |
       Проверка парсинга
         |
         | Если парсинг не удался
         | -- Да: Лог ошибки
         |    |
         |    Попытки > 1?
         |    -- Да: Рекурсивный вызов model_ask(lang, attempts - 1)
         |    -- Нет: Возврат {}
         | -- Нет: Возврат response_dict
         |
         Конец
```

**Примеры**:

```python
response_ru = model_ask('ru')
if response_ru:
    print(f"Ответ на русском: {response_ru.keys()}")

response_he = model_ask('he', attempts=2)
if response_he:
    print(f"Ответ на иврите: {response_he.get('ключ', 'Нет данных')}")