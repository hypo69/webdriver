# Модуль `Ails.py`

## Обзор

Модуль предоставляет функциональность для взаимодействия с провайдером Ails, используя модель `gpt-3.5-turbo`. Он включает в себя функции для создания запросов к API и обработки ответов. Модуль предназначен для использования в рамках проекта `hypotez` для обеспечения работы с языковыми моделями через указанный API.

## Подробней

Модуль содержит функции для форматирования запросов, вычисления хешей и отправки запросов к API `ai.ls`. Он также обрабатывает потоковые ответы от API, извлекая полезный контент.

## Переменные модуля

- `url` (str): URL для доступа к API `ai.ls`. Значение: `'https://ai.ls'`.
- `model` (str): Используемая модель. Значение: `'gpt-3.5-turbo'`.
- `supports_stream` (bool): Поддержка потоковой передачи данных. Значение: `True`.
- `needs_auth` (bool): Требуется ли аутентификация. Значение: `False`.
- `params` (str): Строка, содержащая информацию о поддержке параметров функцией `_create_completion`.

## Классы

### `Utils`

Класс `Utils` предоставляет статические методы для выполнения вспомогательных задач, таких как вычисление хешей и форматирование временных меток.

**Методы:**

- `hash(json_data: Dict[str, str]) -> sha256`: Вычисляет SHA256 хеш на основе предоставленных JSON-данных.
- `format_timestamp(timestamp: int) -> str`: Форматирует временную метку.

#### `hash`

```python
    def hash(json_data: Dict[str, str]) -> sha256:
        """
        Вычисляет SHA256 хеш на основе предоставленных JSON-данных.

        Args:
            json_data (Dict[str, str]): Словарь с данными для хеширования, содержащий ключи 't' и 'm'.

        Returns:
            sha256: SHA256 хеш, представленный в виде шестнадцатеричной строки.

        Как работает функция:
        1. Определяет секретный ключ в виде массива байтов.
        2. Формирует строку base_string, объединяя значения 't', 'm' из json_data, константу и длину 'm'.
        3. Вычисляет SHA256 хеш от base_string и возвращает его в виде шестнадцатеричной строки.
        """
```

**Пример**

```python
json_data = {'t': '1678886400000', 'm': 'hello'}
hash_value = Utils.hash(json_data)
print(hash_value)
```

ASCII схема работы функции:

```
JSON Data (t, m)
|
V
Создание base_string
|
V
Вычисление SHA256
|
V
Шестнадцатеричное представление
```

#### `format_timestamp`

```python
    def format_timestamp(timestamp: int) -> str:
        """
        Форматирует временную метку.

        Args:
            timestamp (int): Временная метка в миллисекундах.

        Returns:
            str: Отформатированная временная метка в виде строки.

        Как работает функция:
        1. Получает последнюю цифру временной метки.
        2. Если последняя цифра четная, прибавляет 1, иначе оставляет как есть.
        3. Вычитает исходную последнюю цифру из временной метки и прибавляет новую последнюю цифру.
        4. Преобразует результат в строку.
        """
```

**Пример**

```python
timestamp = 1678886405000
formatted_timestamp = Utils.format_timestamp(timestamp)
print(formatted_timestamp)
```

ASCII схема работы функции:

```
Timestamp
|
V
Определение последней цифры
|
V
Корректировка последней цифры
|
V
Форматирование
```

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, temperature: float = 0.6, stream: bool = False, **kwargs):
    """
    Создает запрос к API для генерации текста на основе предоставленных сообщений.

    Args:
        model (str): Идентификатор используемой модели.
        messages (list): Список сообщений для отправки в API.
        temperature (float, optional): Параметр температуры для управления случайностью генерации. По умолчанию 0.6.
        stream (bool, optional): Флаг, указывающий, следует ли использовать потоковый режим. По умолчанию False.
        **kwargs: Дополнительные параметры.

    Yields:
        str: Часть сгенерированного текста из потокового ответа API.

    Как работает функция:
    1. Определяет заголовки запроса, включая параметры авторизации и идентификаторы клиента.
    2. Формирует параметры запроса, включая флаг full.
    3. Генерирует временную метку и подпись (sig) на основе сообщений и временной метки.
    4. Преобразует данные в формат JSON и отправляет POST-запрос к API.
    5. Итерирует по потоковым ответам, извлекая и передавая части сгенерированного текста.

    Внутренние функции:
        Нет внутренних функций
    """
```

**Примеры**

```python
messages = [{"role": "user", "content": "Напиши приветствие."}]
for token in _create_completion(model='gpt-3.5-turbo', messages=messages, stream=True):
    print(token, end="")
```

ASCII схема работы функции:

```
Messages, Model, Temperature, Stream
|
V
Формирование заголовков запроса
|
V
Создание JSON-данных с подписью
|
V
Отправка POST-запроса
|
V
Обработка потоковых ответов
|
V
Извлечение и передача текста