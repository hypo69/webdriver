# Модуль для автоматического обновления и тестирования прокси-серверов

## Обзор

Модуль `auto_proxy.py` предназначен для автоматического получения, тестирования и обновления списка рабочих прокси-серверов. Он использует многопоточность для одновременной проверки нескольких прокси и периодически обновляет список рабочих прокси для обеспечения надежной работы. Этот модуль важен для обхода ограничений доступа и обеспечения стабильного соединения при работе с веб-сервисами, такими как OpenAI.

## Подробней

Модуль предназначен для работы с прокси серверами. 
Он выполняет следующие функции:

1.  Получение списка прокси-серверов из внешнего источника (`proxyscrape.com`).
2.  Проверка работоспособности каждого прокси-сервера с использованием тестового запроса.
3.  Добавление рабочих прокси в глобальный список `working_proxies`.
4.  Периодическое обновление списка рабочих прокси для поддержания актуальности.
5.  Предоставление случайного рабочего прокси-сервера из списка.

Этот модуль используется для обеспечения анонимности и обхода ограничений доступа при взаимодействии с различными веб-сервисами, такими как OpenAI. Он позволяет автоматически переключаться между различными прокси-серверами, если текущий прокси-сервер становится недоступным или не отвечает достаточно быстро.

## Функции

### `fetch_proxies`

```python
def fetch_proxies():
    """Fetch a list of proxy servers from proxyscrape.com.

    Returns:
        list: A list of proxy servers in the format "IP:Port".
    """
    ...
```

**Назначение**: Получает список прокси-серверов с сайта `proxyscrape.com`.

**Параметры**: Отсутствуют.

**Возвращает**:

*   `list`: Список прокси-серверов в формате `"IP:Port"`.

**Как работает функция**:

1.  Функция отправляет GET-запрос на URL `https://www.proxy-list.download/api/v1/get?type=http`.
2.  Если запрос успешен (код состояния 200), функция возвращает список прокси-серверов, полученных из ответа.
3.  В случае ошибки при запросе, функция выводит сообщение об ошибке и возвращает пустой список.

```
A: Отправка GET запроса на URL прокси-сервиса
|
B: Проверка статуса ответа
|
C: Разделение текста ответа на список прокси
|
D: Возврат списка прокси
```

**Примеры**:

```python
proxies = fetch_proxies()
if proxies:
    print(f"Получено {len(proxies)} прокси-серверов.")
else:
    print("Не удалось получить прокси-серверы.")
```

### `test_proxy`

```python
def test_proxy(proxy, prompt, timeout):
    """Test the given proxy server with a specified prompt and timeout.

    Args:
        proxy (str): The proxy server in the format "IP:Port".
        prompt (str): The test prompt to be used for testing.
        timeout (int): The maximum time in seconds allowed for the test.
    """
    ...
```

**Назначение**: Проверяет работоспособность заданного прокси-сервера с использованием указанного запроса и времени ожидания.

**Параметры**:

*   `proxy` (str): Прокси-сервер в формате `"IP:Port"`.
*   `prompt` (str): Тестовый запрос для проверки прокси.
*   `timeout` (int): Максимальное время ожидания в секундах.

**Как работает функция**:

1.  Измеряет время, затраченное на выполнение запроса через прокси-сервер.
2.  Если время ответа меньше заданного `timeout`, прокси считается рабочим и добавляется в список рабочих прокси-серверов.
3.  В случае возникновения исключения, функция ничего не делает (используется `pass`).

```
A: Измерение времени начала выполнения запроса
|
B: Выполнение запроса через прокси
|
C: Измерение времени окончания выполнения запроса
|
D: Проверка времени ответа
|
E: Добавление прокси в список рабочих прокси
```

**Примеры**:

```python
test_proxy("127.0.0.1:8080", "Test prompt", 5)
```

### `add_working_proxy`

```python
def add_working_proxy(proxy):
    """Add a working proxy server to the global working_proxies list.

    Args:
        proxy (str): The proxy server in the format "IP:Port".
    """
    ...
```

**Назначение**: Добавляет рабочий прокси-сервер в глобальный список `working_proxies`.

**Параметры**:

*   `proxy` (str): Прокси-сервер в формате `"IP:Port"`.

**Как работает функция**:

1.  Добавляет переданный прокси-сервер в глобальный список `working_proxies`.

```
A: Добавление прокси в глобальный список working_proxies
```

**Примеры**:

```python
add_working_proxy("127.0.0.1:8080")
```

### `remove_proxy`

```python
def remove_proxy(proxy):
    """Remove a proxy server from the global working_proxies list.

    Args:
        proxy (str): The proxy server in the format "IP:Port".
    """
    ...
```

**Назначение**: Удаляет прокси-сервер из глобального списка `working_proxies`.

**Параметры**:

*   `proxy` (str): Прокси-сервер в формате `"IP:Port"`.

**Как работает функция**:

1.  Проверяет, есть ли прокси-сервер в списке `working_proxies`.
2.  Если прокси-сервер присутствует, он удаляется из списка.

```
A: Проверка наличия прокси в списке working_proxies
|
B: Удаление прокси из списка
```

**Примеры**:

```python
remove_proxy("127.0.0.1:8080")
```

### `get_working_proxies`

```python
def get_working_proxies(prompt, timeout=5):
    """Fetch and test proxy servers, adding working proxies to the global working_proxies list.

    Args:
        prompt (str): The test prompt to be used for testing.
        timeout (int, optional): The maximum time in seconds allowed for testing. Defaults to 5.
    """
    ...
```

**Назначение**: Получает и тестирует прокси-серверы, добавляя рабочие прокси в глобальный список `working_proxies`.

**Параметры**:

*   `prompt` (str): Тестовый запрос для проверки прокси.
*   `timeout` (int, optional): Максимальное время ожидания в секундах. По умолчанию 5.

**Как работает функция**:

1.  Получает список прокси-серверов с помощью функции `fetch_proxies()`.
2.  Для каждого прокси-сервера создает отдельный поток, который выполняет проверку с помощью функции `test_proxy()`.
3.  Ожидает завершения всех потоков с заданным временем ожидания.

```
A: Получение списка прокси
|
B: Создание потоков для проверки каждого прокси
|
C: Запуск потоков
|
D: Ожидание завершения всех потоков
```

**Примеры**:

```python
get_working_proxies("What is the capital of France?", timeout=5)
```

### `update_working_proxies`

```python
def update_working_proxies():
    """Continuously update the global working_proxies list with working proxy servers."""
    ...
```

**Назначение**: Непрерывно обновляет глобальный список `working_proxies` рабочими прокси-серверами.

**Как работает функция**:

1.  Запускает бесконечный цикл, в котором выполняет следующие действия:
    *   Очищает список `working_proxies`.
    *   Получает и тестирует прокси-серверы с помощью функции `get_working_proxies()`.
    *   Засыпает на 30 минут (1800 секунд).

```
A: Запуск бесконечного цикла
|
B: Очистка списка working_proxies
|
C: Получение и тестирование прокси
|
D: Ожидание (30 минут)
```

**Примеры**:

```python
# Запуск в отдельном потоке для непрерывного обновления
import threading
thread = threading.Thread(target=update_working_proxies)
thread.start()
```

### `get_random_proxy`

```python
def get_random_proxy():
    """Get a random working proxy server from the global working_proxies list.

    Returns:
        str: A random working proxy server in the format "IP:Port".
    """
    ...
```

**Назначение**: Получает случайный рабочий прокси-сервер из глобального списка `working_proxies`.

**Параметры**: Отсутствуют.

**Возвращает**:

*   `str`: Случайный рабочий прокси-сервер в формате `"IP:Port"`.

**Как работает функция**:

1.  Выбирает случайный элемент из списка `working_proxies` с помощью функции `random.choice()`.

```
A: Выбор случайного прокси из списка working_proxies
|
B: Возврат случайного прокси
```

**Примеры**:

```python
proxy = get_random_proxy()
if proxy:
    print(f"Случайный прокси: {proxy}")
else:
    print("Нет доступных прокси-серверов.")