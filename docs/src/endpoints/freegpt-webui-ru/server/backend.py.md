# Модуль для обработки backend API
## Обзор

Модуль `backend.py` предназначен для обработки API-запросов, связанных с взаимодействием с различными языковыми моделями через `g4f`. Он включает в себя функциональность для создания бесед, получения ответов от моделей, обработки результатов поиска в интернете и применения инструкций для обхода ограничений (jailbreak). Также модуль содержит функции для определения языка ответа и управления прокси-серверами.

## Подробней

Данный код является частью backend API, который обрабатывает запросы на генерацию ответов от языковой модели. Он использует библиотеку `g4f` для взаимодействия с моделями, а также включает функции для обработки и форматирования запросов и ответов. Модуль также поддерживает использование прокси для обхода ограничений и получения доступа к моделям.
Реализована поддержка `jailbreak`-инструкций для изменения поведения модели.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` отвечает за обработку API-запросов и взаимодействие с языковой моделью.

**Принцип работы**: Класс инициализируется с Flask-приложением и конфигурацией, содержащей настройки, такие как использование автоматического прокси. Он определяет маршруты для API-запросов, в частности, для создания бесед.

**Атрибуты**:
- `app`: Flask-приложение.
- `use_auto_proxy`: Флаг, указывающий на использование автоматического прокси.
- `routes`: Словарь, содержащий маршруты API и соответствующие функции для их обработки.

**Методы**:
- `__init__(self, app, config: dict) -> None`: Инициализация класса `Backend_Api`.
- `_conversation(self)`: Обрабатывает запрос на создание беседы, генерирует ответ от языковой модели и возвращает его в виде потока событий.

### `Backend_Api.__init__(self, app, config: dict) -> None`

**Назначение**: Инициализация экземпляра класса `Backend_Api`.

**Параметры**:
- `app` (Flask): Flask-приложение, с которым будет связан API.
- `config` (dict): Словарь конфигурации, содержащий настройки API.

**Как работает функция**:
1. Сохраняет Flask-приложение в атрибуте `app`.
2. Сохраняет значение параметра `use_auto_proxy` из конфигурации в атрибуте `use_auto_proxy`.
3. Определяет маршруты API в атрибуте `routes`, связывая URL с соответствующими функциями обработки.
4. Если включено использование автоматического прокси (`use_auto_proxy` равно `True`), запускает поток для обновления списка рабочих прокси-серверов в фоновом режиме.

```
A: Инициализация класса
│
├── B: Сохранение Flask-приложения и конфигурации
│
├── C: Определение маршрутов API
│
└── D: Запуск потока обновления прокси (если необходимо)

```

**Примеры**:

```python
from flask import Flask

app = Flask(__name__)
config = {'use_auto_proxy': True}
api = Backend_Api(app, config)
```

### `Backend_Api._conversation(self)`

**Назначение**: Обработка запроса на создание беседы.

**Как работает функция**:
1. Извлекает параметры запроса из JSON-данных, такие как `stream`, `jailbreak` и `model`.
2. Вызывает функцию `build_messages` для создания списка сообщений для языковой модели.
3. Вызывает функцию `ChatCompletion.create` для генерации ответа от языковой модели.
4. Возвращает ответ в виде потока событий (`text/event-stream`), используя функцию `generate_stream`.
5. Обрабатывает возможные исключения, возвращая сообщение об ошибке и код состояния 400.

**Параметры**:
- Нет явных параметров, но использует `request.json` для получения данных из запроса.

**Возвращает**:
- Flask `response_class` с потоком данных (если успешно) или словарь с информацией об ошибке и кодом состояния 400 (если произошла ошибка).

**Вызывает исключения**:
- `Exception`: В случае возникновения ошибки при обработке запроса или генерации ответа.

```
A: Получение параметров запроса
│
├── B: Создание списка сообщений для модели
│
├── C: Генерация ответа от языковой модели
│
├── D: Возврат ответа в виде потока событий
│
└── E: Обработка исключений и возврат сообщения об ошибке
```

**Примеры**:

```python
from flask import Flask, request

app = Flask(__name__)

@app.route('/backend-api/v2/conversation', methods=['POST'])
def conversation():
    config = {'use_auto_proxy': False}
    api = Backend_Api(app, config)
    return api._conversation()

# Пример запроса (request.json):
# {
#     'stream': True,
#     'jailbreak': 'Default',
#     'model': 'gpt-3.5-turbo',
#     'meta': {
#         'content': {
#             'conversation': [],
#             'internet_access': False,
#             'parts': [{'role': 'user', 'content': 'Hello'}]
#         }
#     }
# }
```

## Функции

### `build_messages(jailbreak)`

**Назначение**: Функция создает список сообщений для языковой модели на основе данных из запроса.

**Как работает функция**:

1. **Извлечение данных из запроса**: Извлекает данные о беседе, доступе в интернет и промпте из JSON-данных запроса.
2. **Формирование системного сообщения**: Создает системное сообщение, содержащее информацию о текущей дате и языке ответа.
3. **Инициализация беседы**: Инициализирует беседу с системным сообщением.
4. **Добавление существующих сообщений**: Добавляет существующие сообщения в беседу.
5. **Добавление результатов поиска**: Если включен доступ в интернет, добавляет результаты поиска в беседу.
6. **Добавление инструкций jailbreak**: Если указаны инструкции jailbreak, добавляет их в беседу.
7. **Добавление промпта**: Добавляет промпт пользователя в беседу.
8. **Ограничение размера беседы**: Ограничивает размер беседы, чтобы избежать ошибок, связанных с количеством токенов API.

**Параметры**:
- `jailbreak` (str): Идентификатор jailbreak-инструкций.

**Возвращает**:
- `list`: Список сообщений для языковой модели.

```
A: Извлечение данных из запроса
│
├── B: Формирование системного сообщения
│
├── C: Инициализация беседы
│
├── D: Добавление существующих сообщений
│
├── E: Добавление результатов поиска (если необходимо)
│
├── F: Добавление инструкций jailbreak (если необходимо)
│
├── G: Добавление промпта пользователя
│
└── H: Ограничение размера беседы

```

**Примеры**:

```python
from flask import Flask, request

app = Flask(__name__)

@app.route('/test', methods=['POST'])
def test():
    request.json = {
        'jailbreak': 'Default',
        'meta': {
            'content': {
                'conversation': [],
                'internet_access': False,
                'parts': [{'role': 'user', 'content': 'Hello'}]
            }
        }
    }
    messages = build_messages('Default')
    return str(messages)
```

### `fetch_search_results(query)`

**Назначение**: Функция выполняет поиск в интернете и возвращает результаты в виде списка сообщений для языковой модели.

**Как работает функция**:

1. **Выполнение поиска**: Выполняет поиск с использованием API DuckDuckGo.
2. **Формирование результатов**: Формирует результаты поиска в виде списка сообщений, содержащих сниппеты и URL.

**Параметры**:
- `query` (str): Поисковый запрос.

**Возвращает**:
- `list`: Список сообщений с результатами поиска.

```
A: Выполнение поиска
│
└── B: Формирование результатов в виде списка сообщений
```

**Примеры**:

```python
results = fetch_search_results('OpenAI')
print(results)
```

### `generate_stream(response, jailbreak)`

**Назначение**: Функция генерирует поток данных на основе ответа языковой модели, учитывая наличие jailbreak-инструкций.

**Как работает функция**:

1. **Проверка наличия jailbreak**: Проверяет, используются ли jailbreak-инструкции.
2. **Обработка ответа с jailbreak**: Если используются jailbreak-инструкции, анализирует ответ модели и возвращает его частями, проверяя успешность применения jailbreak.
3. **Обработка ответа без jailbreak**: Если jailbreak-инструкции не используются, возвращает ответ модели в виде потока данных.

**Параметры**:
- `response` (generator): Ответ языковой модели.
- `jailbreak` (str): Идентификатор jailbreak-инструкций.

**Возвращает**:
- `generator`: Поток данных с ответом языковой модели.

```
A: Проверка наличия jailbreak
│
├── B: Обработка ответа с jailbreak
│
└── C: Обработка ответа без jailbreak
```

**Примеры**:

```python
def mock_response():
    yield "GPT: Hello"
    yield " world!"

stream = generate_stream(mock_response(), 'Default')
for message in stream:
    print(message)
```

### `response_jailbroken_success(response: str) -> bool`

**Назначение**: Функция проверяет, успешно ли применены jailbreak-инструкции к ответу языковой модели.

**Как работает функция**:
1. **Поиск маркера `ACT:`**: Ищет в ответе маркер `ACT:`, который указывает на успешное применение jailbreak-инструкций.

**Параметры**:
- `response` (str): Ответ языковой модели.

**Возвращает**:
- `bool`: `True`, если jailbreak-инструкции применены успешно, `False` в противном случае.

```
A: Поиск маркера "ACT:" в ответе
│
└── B: Возврат результата проверки
```

**Примеры**:

```python
response = "ACT: Hello world!"
success = response_jailbroken_success(response)
print(success)  # Вывод: True

response = "Hello world!"
success = response_jailbroken_success(response)
print(success)  # Вывод: False
```

### `response_jailbroken_failed(response)`

**Назначение**: Функция проверяет, не удалось ли применить jailbreak-инструкции к ответу языковой модели.

**Как работает функция**:

1. **Проверка длины ответа**: Проверяет, что длина ответа больше 4 символов.
2. **Проверка начала ответа**: Проверяет, что ответ не начинается с `GPT:` или `ACT:`.

**Параметры**:
- `response` (str): Ответ языковой модели.

**Возвращает**:
- `bool`: `False`, если jailbreak-инструкции не удалось применить, `True` в противном случае.

```
A: Проверка длины ответа
│
└── B: Проверка начала ответа
```

**Примеры**:

```python
response = "Hello world!"
failed = response_jailbroken_failed(response)
print(failed)  # Вывод: True

response = "GPT: Hello world!"
failed = response_jailbroken_failed(response)
print(failed)  # Вывод: False
```

### `set_response_language(prompt)`

**Назначение**: Функция определяет язык запроса и формирует инструкцию для языковой модели, чтобы она отвечала на этом языке.

**Как работает функция**:

1. **Определение языка**: Определяет язык запроса с использованием `googletrans.Translator`.
2. **Формирование инструкции**: Формирует инструкцию для языковой модели, чтобы она отвечала на определенном языке.

**Параметры**:
- `prompt` (dict): Словарь, содержащий текст запроса.

**Возвращает**:
- `str`: Инструкция для языковой модели.

```
A: Определение языка запроса
│
└── B: Формирование инструкции для языковой модели
```

**Примеры**:

```python
prompt = {'content': 'Привет мир!'}
instruction = set_response_language(prompt)
print(instruction)  # Вывод: You will respond in the language: ru.
```

### `isJailbreak(jailbreak)`

**Назначение**: Функция проверяет, является ли указанный идентификатор jailbreak допустимым, и возвращает соответствующие инструкции.

**Как работает функция**:

1. **Проверка идентификатора**: Проверяет, является ли идентификатор jailbreak отличным от "Default".
2. **Возврат инструкций**: Если идентификатор jailbreak допустимый, возвращает соответствующие инструкции из словаря `special_instructions`.
3. **Возврат `None`**: Если идентификатор jailbreak не является допустимым или отсутствует в словаре `special_instructions`, возвращает `None`.

**Параметры**:
- `jailbreak` (str): Идентификатор jailbreak-инструкций.

**Возвращает**:
- `list | None`: Список инструкций jailbreak или `None`, если jailbreak не используется.

```
A: Проверка идентификатора jailbreak
│
└── B: Возврат инструкций или None
```

**Примеры**:

```python
special_instructions = {'Test': ['Instruction 1', 'Instruction 2']}

jailbreak = 'Test'
instructions = isJailbreak(jailbreak)
print(instructions)  # Вывод: ['Instruction 1', 'Instruction 2']

jailbreak = 'Default'
instructions = isJailbreak(jailbreak)
print(instructions)  # Вывод: None

jailbreak = 'NonExistent'
instructions = isJailbreak(jailbreak)
print(instructions) # Вывод: None
```