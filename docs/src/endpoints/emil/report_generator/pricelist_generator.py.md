# Модуль `pricelist_generator.py`

## Обзор

Модуль предназначен для генерации HTML и PDF отчетов с прайс-листами для мехиронов Казаринова. Он включает в себя функциональность для загрузки данных из JSON, создания HTML на основе шаблонов Jinja2 и преобразования HTML в PDF. Модуль обеспечивает возможность настройки отчетов на разных языках.

## Подробнее

Модуль `pricelist_generator.py` предоставляет класс `ReportGenerator`, который отвечает за генерацию отчетов. Основной функциональностью модуля является создание HTML-страницы на основе данных из JSON-файла и последующее преобразование этой страницы в PDF-документ. Процесс включает в себя загрузку данных, применение шаблонов Jinja2 для форматирования данных в HTML и использование библиотеки `pdfkit` для создания PDF-файла. Модуль также предоставляет возможность настройки языка отчета.

## Классы

### `ReportGenerator`

**Описание**: Класс для генерации HTML- и PDF-отчётов на основе данных из JSON.

**Атрибуты**:

- `env` (Environment): Объект окружения Jinja2 для загрузки и обработки шаблонов. Инициализируется с использованием `FileSystemLoader`, указывающего на текущую директорию.

**Методы**:

- `generate_html`: Генерирует HTML-контент на основе шаблона и данных.
- `create_report`: Полный цикл генерации отчёта.

## Функции

### `generate_html`

```python
async def generate_html(self, data:dict, lang:str ) -> str:
    """
    Генерирует HTML-контент на основе шаблона и данных.

    Args:
        lang (str): Язык отчёта.

    Returns:
        str: HTML-контент.
    """
```

**Назначение**: Генерация HTML-контента на основе шаблона и данных.

**Параметры**:

- `data` (dict): Словарь с данными для заполнения шаблона.
- `lang` (str): Язык отчёта.

**Возвращает**:

- `str`: HTML-контент, сгенерированный на основе шаблона и данных.

**Как работает функция**:

1. Определяется имя шаблона в зависимости от языка отчёта. Если язык равен `'he'`, используется шаблон `'template_table_he.html'`, иначе используется шаблон `'template_table_ru.html'`.
2. Формируется полный путь к шаблону.
3. Считывается содержимое шаблона из файла.
4. Создается объект шаблона Jinja2 из строки.
5. Генерируется HTML-контент с использованием переданных данных и возвращается.

**Примеры**:

```python
report_generator = ReportGenerator()
data = {"ключ": "значение"}
lang = "ru"
html_content = await report_generator.generate_html(data, lang)
print(html_content)
```

### `create_report`

```python
async def create_report(self, data: dict, lang:str, html_file:str| Path, pdf_file:str |Path) -> bool:
    """
    Полный цикл генерации отчёта.

    Args:
        lang (str): Язык отчёта.
    """
```

**Назначение**: Полный цикл генерации отчёта, включающий добавление сервисной информации, генерацию HTML, сохранение HTML в файл и преобразование в PDF.

**Параметры**:

- `data` (dict): Словарь с данными для отчёта.
- `lang` (str): Язык отчёта.
- `html_file` (str | Path): Путь к файлу для сохранения HTML-контента.
- `pdf_file` (str | Path): Путь к файлу для сохранения PDF-контента.

**Возвращает**:

- `bool`: `True`, если отчёт успешно сгенерирован, `False` в противном случае.

**Как работает функция**:

1. Формируется словарь `service_dict`, содержащий информацию о сервисе (название продукта, спецификация), в зависимости от языка отчёта. Также генерируется случайное изображение для сервиса.
2. Сервисная информация добавляется в список продуктов в данных.
3. Генерируется HTML-контент с использованием метода `generate_html`.
4. HTML-контент сохраняется в файл.
5. Создается PDF из HTML-контента с использованием `PDFUtils`.
6. В случае ошибки при создании PDF, логируется сообщение об ошибке.
7. Возвращается `True`, если PDF успешно создан, `False` в противном случае.

```
      Начало
         ↓
  Формирование service_dict (язык)
         ↓
  Добавление service_dict к данным
         ↓
   Генерация HTML (generate_html)
         ↓
  Сохранение HTML в файл
         ↓
  Создание PDF (save_pdf_pdfkit)
         ↓
Успех? -- Да → Возврат True
         |
         Нет
         ↓
     Логирование ошибки
         ↓
     Возврат False
```

**Примеры**:

```python
report_generator = ReportGenerator()
data = {"products": []}
lang = "ru"
html_file = "report.html"
pdf_file = "report.pdf"
success = await report_generator.create_report(data, lang, html_file, pdf_file)
print(success)
```

### `main`

```python
def main(mexiron:str,lang:str) ->bool:
```

**Назначение**: Главная функция для запуска процесса генерации отчёта.

**Параметры**:

- `mexiron` (str): Идентификатор мехирона.
- `lang` (str): Язык отчёта.

**Возвращает**:

- `bool`: `True`, если отчет сгенерирован успешно, `False` в противном случае.

**Как работает функция**:

1. Формируется путь к директории с данными для указанного мехирона.
2. Загружаются данные из JSON-файла.
3. Формируются пути к HTML и PDF файлам.
4. Создается экземпляр класса `ReportGenerator`.
5. Запускается асинхронная задача для генерации отчёта.

**Примеры**:

```python
mexiron = "24_12_01_03_18_24_269"
lang = "ru"
main(mexiron, lang)
```
```
Начало
     ↓
Формирование пути к данным
     ↓
    Загрузка данных
     ↓
Формирование путей к HTML и PDF
     ↓
Создание ReportGenerator
     ↓
Запуск генерации отчёта (create_report)
     ↓
    Конец