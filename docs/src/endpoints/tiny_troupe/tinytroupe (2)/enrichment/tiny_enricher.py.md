# Модуль `tiny_enricher.py`

## Обзор

Модуль предназначен для обогащения контента с использованием OpenAI. Он содержит класс `TinyEnricher`, который позволяет обогащать текстовый контент, основываясь на заданных требованиях и контекстной информации. Модуль использует шаблоны Mustache для формирования запросов к языковой модели и извлекает результаты из ответов модели.

## Подробней

Модуль `tiny_enricher.py` предоставляет функциональность для улучшения контента путем взаимодействия с OpenAI. Класс `TinyEnricher` использует шаблоны для создания запросов к языковой модели и извлекает полезные результаты из ответов. Он также поддерживает использование предыдущих результатов в контексте для улучшения последующих запросов.

## Классы

### `TinyEnricher`

**Описание**: Класс для обогащения текстового контента с использованием OpenAI.

**Принцип работы**: Класс `TinyEnricher` инициализируется с флагом `use_past_results_in_context`, который определяет, следует ли использовать предыдущие результаты в контексте последующих запросов. Он использует метод `enrich_content` для отправки запросов к OpenAI и извлечения результатов.

**Аттрибуты**:

- `use_past_results_in_context` (bool): Флаг, определяющий, использовать ли предыдущие результаты в контексте. По умолчанию `False`.
- `context_cache` (list): Список для хранения контекстной информации.

**Методы**:

- `__init__(self, use_past_results_in_context=False)`: Инициализирует экземпляр класса `TinyEnricher`.
- `enrich_content(self, requirements: str, content: str, content_type: str = None, context_info: str = "", context_cache: list = None, verbose: bool = False)`: Обогащает контент на основе заданных требований, контента, типа контента, контекстной информации и кэша контекста.

## Функции

### `__init__(self, use_past_results_in_context=False)`

**Назначение**: Инициализирует экземпляр класса `TinyEnricher`.

**Параметры**:

- `use_past_results_in_context` (bool): Флаг, определяющий, следует ли использовать предыдущие результаты в контексте. По умолчанию `False`.

**Возвращает**:
- `None`

**Как работает функция**:
1. Инициализирует атрибут `use_past_results_in_context` значением входного параметра.
2. Инициализирует пустой список `context_cache` для хранения контекстной информации.

```
Инициализация параметров класса
│
└──→  Создание кэша контекста (context_cache)
```

**Примеры**:

```python
enricher = TinyEnricher(use_past_results_in_context=True)
enricher = TinyEnricher()
```

### `enrich_content(self, requirements: str, content: str, content_type: str = None, context_info: str = "", context_cache: list = None, verbose: bool = False)`

**Назначение**: Обогащает контент на основе заданных требований, контента, типа контента, контекстной информации и кэша контекста.

**Параметры**:

- `requirements` (str): Требования к обогащению контента.
- `content` (str): Контент, который необходимо обогатить.
- `content_type` (str, optional): Тип контента. По умолчанию `None`.
- `context_info` (str, optional): Контекстная информация. По умолчанию `""`.
- `context_cache` (list, optional): Кэш контекста. По умолчанию `None`.
- `verbose` (bool, optional): Флаг для вывода отладочных сообщений. По умолчанию `False`.

**Возвращает**:

- `str | None`: Обогащенный контент в виде строки или `None`, если не удалось получить результат.

**Как работает функция**:

1. **Формирование конфигураций для рендеринга**: Создается словарь `rendering_configs`, содержащий параметры, необходимые для рендеринга шаблонов сообщений. Эти параметры включают требования к обогащению, сам контент, тип контента, контекстную информацию и кэш контекста.

2. **Композиция сообщений для языковой модели**: Используется функция `utils.compose_initial_LLM_messages_with_templates` для создания списка сообщений, которые будут отправлены в языковую модель. Эта функция использует шаблоны Mustache для формирования системного и пользовательского сообщений, а также передает конфигурации для рендеринга этих шаблонов.

3. **Отправка сообщений в OpenAI**: Используется метод `openai_utils.client().send_message` для отправки сформированных сообщений в OpenAI. Параметры температуры, штрафов за частоту и присутствие устанавливаются для управления генерацией текста.

4. **Извлечение результата**: Если ответ от OpenAI получен, извлекается кодовый блок из содержимого сообщения с использованием функции `utils.extract_code_block`.

5. **Обработка отладочных сообщений**: Если установлен флаг `verbose`, выводится отладочное сообщение, содержащее результат обогащения.

```
Формирование конфигураций для рендеринга
│
└──→ Композиция сообщений для языковой модели с использованием шаблонов Mustache
│
└──→ Отправка сообщений в OpenAI
│
└──→ Извлечение кодового блока из ответа OpenAI
│
└──→ Вывод отладочных сообщений (если verbose=True)
```

**Примеры**:

```python
enricher = TinyEnricher()
requirements = "Добавь больше деталей о продукте"
content = "Это простой продукт"
enriched_content = enricher.enrich_content(requirements, content, verbose=True)

if enriched_content:
    print(f"Enriched content: {enriched_content}")
else:
    print("Failed to enrich content.")
```
```python
enricher = TinyEnricher()
requirements = "Сделай текст более интересным"
content = "Текст для обогащения"
context_info = "Информация о контексте"
enriched_content = enricher.enrich_content(requirements, content, context_info=context_info)