# Модуль тестирования сценариев рекламы

## Обзор

Этот модуль содержит тесты для оценки различных сценариев, связанных с рекламой, включая оценку рекламных объявлений, создание рекламных объявлений и профилирование потребителей. Он использует фреймворк `pytest` и включает в себя классы и функции для имитации взаимодействия агентов с рекламным контентом в различных контекстах.

## Подробнее

Модуль предназначен для проверки эффективности различных рекламных стратегий и понимания предпочтений потребителей. Он включает в себя создание виртуальных личностей (`TinyPerson`), моделирование социальной среды (`TinyWorld`, `TinySocialNetwork`) и извлечение результатов для анализа (`ResultsExtractor`).

## Классы

### `ResultsExtractor`

**Описание**: Класс для извлечения результатов из взаимодействий агентов.

**Методы**:

-   `extract_results_from_agent(person, extraction_objective, situation, fields)`: Извлекает результаты из агента на основе заданной цели, ситуации и полей.
-   `extract_results_from_world(focus_group, verbose=False)`: Извлекает результаты из мира, в котором находится фокус-группа.

### `TinyPerson`

**Описание**: Класс, представляющий виртуальную личность с определенными характеристиками и поведением.

**Методы**:

-   `change_context(situation)`: Изменяет контекст, в котором действует личность.
-   `listen_and_act(eval_request_msg)`: Заставляет личность прослушать сообщение и действовать в соответствии с ним.
-   `minibio()`: Предоставляет краткую биографию личности.

### `TinyWorld`

**Описание**: Класс, представляющий виртуальный мир, в котором живут и взаимодействуют виртуальные личности.

**Методы**:

-   `broadcast(message)`: Рассылает сообщение всем личностям в мире.
-   `run(steps)`: Запускает симуляцию на заданное количество шагов.

## Функции

### `test_ad_evaluation_scenario(setup)`

```python
def test_ad_evaluation_scenario(setup):
    """
    Тестирует сценарий оценки рекламных объявлений.

    Args:
        setup: Фикстура pytest для настройки тестовой среды.

    Raises:
        AssertionError: Если результаты не соответствуют ожидаемым.

    Как работает функция:
    1. Определяются четыре рекламных объявления (`travel_ad_1`, `travel_ad_2`, `travel_ad_3`, `travel_ad_4`), представляющие различные предложения по путешествиям.
    2. Формируется запрос на оценку (`eval_request_msg`), который содержит все четыре рекламных объявления и просит агента выбрать наиболее убедительное.
    3. Задается контекст (`situation`), описывающий, что пользователь планирует отпуск в Европе и ищет хорошие предложения.
    4. Определяется цель извлечения (`extraction_objective`), которая указывает, что нужно извлечь номер выбранного рекламного объявления, его заголовок и обоснование выбора.
    5. Создаются две виртуальные личности: Оскар-архитектор и Лиза-специалист по данным.
    6. Каждая личность меняет контекст, слушает запрос и действует в соответствии с ним.
    7. Извлекаются результаты для каждой личности.
    8. Проверяется, что результаты не равны `None`, содержат необходимые поля (`ad_id`, `ad_title`, `justification`) и что `ad_id` является одним из четырех вариантов.
    9. Проверяется, что было сделано два выбора.

    Внутренние функции:
    В данной функции нет внутренних функций.

    Примеры:
    >>> test_ad_evaluation_scenario(setup)
    """
```

**Назначение**: Тестирует сценарий, в котором виртуальные личности оценивают различные рекламные объявления и выбирают наиболее убедительное.

**Параметры**:

*   `setup`: Фикстура `pytest` для настройки тестовой среды.

**Возвращает**:

*   `None`

**Вызывает исключения**:

*   `AssertionError`: Если результаты не соответствуют ожидаемым.

**Как работает функция**:

1.  **Определение рекламных объявлений и запроса на оценку**: Функция определяет четыре рекламных объявления (`travel_ad_1` - `travel_ad_4`) и формирует запрос на оценку (`eval_request_msg`), который содержит эти объявления и просит агента выбрать наиболее убедительное.
2.  **Задание контекста и цели извлечения**: Задается контекст (`situation`), описывающий сценарий планирования отпуска, и цель извлечения (`extraction_objective`), указывающая, какую информацию нужно извлечь из ответа агента.
3.  **Создание и взаимодействие виртуальных личностей**: Создаются две виртуальные личности, которые меняют контекст, слушают запрос и действуют в соответствии с ним.
4.  **Извлечение и проверка результатов**: Извлекаются результаты для каждой личности и проверяется, что они соответствуют ожидаемым значениям.

```
Начало
|
Определение рекламных объявлений и запроса на оценку
|
Задание контекста и цели извлечения
|
Создание и взаимодействие виртуальных личностей
|
Извлечение и проверка результатов
|
Конец
```

**Примеры**:

```python
# Пример вызова функции
test_ad_evaluation_scenario(setup)
```

### `test_ad_creation_scenario(setup, focus_group_world)`

```python
def test_ad_creation_scenario(setup, focus_group_world):
    """
    Тестирует сценарий создания рекламного объявления.

    Args:
        setup: Фикстура pytest для настройки тестовой среды.
        focus_group_world: Виртуальный мир для фокус-группы.

    Raises:
        AssertionError: Если предложение не соответствует ожиданиям.

    Как работает функция:
    1. Задается контекст (`situation`), описывающий фокус-группу, цель которой - найти лучший способ рекламировать квартиру.
    2. Предоставляется описание квартиры (`apartment_description`).
    3. Задается задача (`task`) - обсудить лучший способ рекламировать квартиру.
    4. Фокус-группа транслирует контекст, описание и задачу.
    5. Запускается симуляция на два шага.
    6. Извлекаются результаты из мира фокус-группы.
    7. Проверяется, что результаты содержат идеи для рекламного объявления квартиры.

    Внутренние функции:
    В данной функции нет внутренних функций.

    Примеры:
    >>> test_ad_creation_scenario(setup, focus_group_world)
    """
```

**Назначение**: Тестирует сценарий, в котором фокус-группа обсуждает лучший способ рекламировать квартиру.

**Параметры**:

*   `setup`: Фикстура `pytest` для настройки тестовой среды.
*   `focus_group_world`: Виртуальный мир для фокус-группы.

**Возвращает**:

*   `None`

**Вызывает исключения**:

*   `AssertionError`: Если предложение не соответствует ожиданиям.

**Как работает функция**:

1.  **Задание контекста, описания и задачи**: Функция задает контекст (`situation`), описывающий фокус-группу, предоставляет описание квартиры (`apartment_description`) и ставит задачу (`task`) - обсудить лучший способ рекламировать квартиру.
2.  **Трансляция информации и запуск симуляции**: Фокус-группа транслирует контекст, описание и задачу, после чего запускается симуляция на два шага.
3.  **Извлечение и проверка результатов**: Извлекаются результаты из мира фокус-группы и проверяется, что они содержат идеи для рекламного объявления квартиры.

```
Начало
|
Задание контекста, описания и задачи
|
Трансляция информации и запуск симуляции
|
Извлечение и проверка результатов
|
Конец
```

**Примеры**:

```python
# Пример вызова функции
test_ad_creation_scenario(setup, focus_group_world)
```

### `test_consumer_profiling_scenario(setup)`

```python
def test_consumer_profiling_scenario(setup):
    """
    Тестирует сценарий профилирования потребителей.

    Args:
        setup: Фикстура pytest для настройки тестовой среды.

    Raises:
        AssertionError: Если файл кэша не создан.

    Как работает функция:
    1. Удаляется файл кэша, если он существует.
    2. Начинается контроль (`control.begin`) с указанием имени файла кэша.
    3. Задается общий контекст (`general_context`), описывающий исследование рынка и мнение американского населения.
    4. Создается фабрика потребителей (`TinyPersonFactory`) с общим контекстом.
    5. Определяется функция `interview_consumer_batch`, которая создает и опрашивает партию потребителей.
    6. Функция `interview_consumer_batch` генерирует случайного потребителя, запрашивает его представить себя и перечислить свои 10 главных интересов, а также спрашивает, купил бы он бутылочный гаспачо в супермаркете.
    7. Вызывается функция `interview_consumer_batch` для опроса 15 потребителей.
    8. Проверяется, что файл кэша был создан.
    9. Завершается контроль (`control.end`).

    Внутренние функции:
    - `interview_consumer_batch(n)`: Создает и опрашивает партию потребителей.
        Args:
            n (int): Количество потребителей для опроса.
        Как работает функция:
            1. Создает цикл от 0 до n.
            2. Генерирует случайного потребителя.
            3. Запрашивает у потребителя представиться и перечислить свои интересы.
            4. Спрашивает, купил бы потребитель бутылочный гаспачо.
            5. Добавляет потребителя в список `consumers`.
            6. Делает чекпойнт (`control.checkpoint`).

    Примеры:
    >>> test_consumer_profiling_scenario(setup)
    """
```

**Назначение**: Тестирует сценарий, в котором создаются профили потребителей на основе их ответов на вопросы о предпочтениях и покупательском поведении.

**Параметры**:

*   `setup`: Фикстура `pytest` для настройки тестовой среды.

**Возвращает**:

*   `None`

**Вызывает исключения**:

*   `AssertionError`: Если файл кэша не создан.

**Как работает функция**:

1.  **Подготовка кэша и начало контроля**: Функция удаляет файл кэша, если он существует, и начинает контроль (`control.begin`) с указанием имени файла кэша.
2.  **Создание контекста и фабрики потребителей**: Задается общий контекст (`general_context`), описывающий исследование рынка, и создается фабрика потребителей (`TinyPersonFactory`) с этим контекстом.
3.  **Опрос потребителей**: Определяется функция `interview_consumer_batch`, которая создает и опрашивает партию потребителей.
4.  **Проверка создания файла кэша и завершение контроля**: Вызывается функция `interview_consumer_batch` для опроса 15 потребителей, проверяется, что файл кэша был создан, и завершается контроль (`control.end`).

```
Начало
|
Подготовка кэша и начало контроля
|
Создание контекста и фабрики потребителей
|
Опрос потребителей
|
Проверка создания файла кэша и завершение контроля
|
Конец
```

**Примеры**:

```python
# Пример вызова функции
test_consumer_profiling_scenario(setup)