# Модуль тестирования `experimentation`

## Обзор

Модуль содержит юнит-тесты для проверки функциональности модулей `ABRandomizer` и `Proposition` из библиотеки `tinytroupe`, используемой для проведения A/B-тестирований и оценки утверждений (proposition) в контексте взаимодействия с виртуальными персонажами.

## Подробней

Этот модуль тестирует корректность работы рандомизации и дерандомизации вариантов, а также возможности проверки утверждений относительно поведения виртуальных персонажей и их взаимодействий в виртуальном мире.
Тесты охватывают различные аспекты: рандомизацию выбора, дерандомизацию выбора, проверку утверждений на основе действий отдельных персонажей и группы, а также использование утверждений как метода проверки гипотез о поведении системы.

## Классы

### `ABRandomizer`

**Описание**: Класс, предназначенный для проведения A/B-тестирования путем рандомизации вариантов.

**Принцип работы**:
Класс `ABRandomizer` инициализируется без параметров или с параметром `passtrough_name`, который позволяет задать имя варианта, всегда возвращаемого методом `derandomize_name`. Внутренне класс использует список `choices` для хранения результатов рандомизации, где каждый элемент представляет собой кортеж `(0, 1)` или `(1, 0)`, определяющий порядок вариантов A и B. Методы `randomize`, `derandomize` и `derandomize_name` используют этот список для обеспечения консистентности рандомизации и дерандомизации.

**Методы**:
- `randomize(i: int, option1: str, option2: str) -> tuple[str, str]`: Рандомизирует порядок двух вариантов на основе индекса `i`.
- `derandomize(i: int, a: str, b: str) -> tuple[str, str]`: Возвращает исходный порядок вариантов на основе индекса `i` и текущего порядка `a` и `b`.
- `derandomize_name(i: int, name: str) -> str`: Возвращает имя группы (control или treatment) на основе индекса `i` и выбранного варианта `name`. Если `name` совпадает с `passtrough_name`, возвращает `name`.

### `Proposition`

**Описание**: Класс для представления утверждений, которые могут быть проверены на соответствие определенному состоянию или поведению системы.

**Принцип работы**:
Класс `Proposition` инициализируется с указанием цели (`target`) и утверждения (`claim`). Целью может быть отдельный персонаж или группа персонажей. Утверждение представляет собой текстовое описание ожидаемого поведения или состояния. Метод `check` проверяет, соответствует ли текущее состояние системы утверждению, и возвращает `True` или `False`. Также сохраняет обоснование и уверенность в пропозиции.

**Аттрибуты**:
- `target`: Цель, к которой относится утверждение (виртуальный персонаж или мир).
- `claim`: Текст утверждения.
- `last_n`: Количество последних действий, которые учитываются при проверке утверждения.
- `justification`: Обоснование истинности или ложности утверждения.
- `confidence`: Уверенность в истинности утверждения (значение от 0.0 до 1.0).

**Методы**:
- `check() -> bool`: Проверяет, выполняется ли утверждение для указанной цели.

## Функции

### `test_randomize`

```python
def test_randomize():
    """Тест проверяет корректность рандомизации вариантов A и B с использованием класса `ABRandomizer`.

    Проверяет, что при многократном вызове метода `randomize` порядок вариантов меняется в соответствии с заданной логикой рандомизации.

    Как работает функция:
    1. Создается экземпляр класса `ABRandomizer`.
    2. Цикл выполняется 20 раз для многократной проверки рандомизации.
    3. На каждой итерации вызывается метод `randomize` с двумя вариантами ("option1", "option2") и индексом `i`.
    4. Проверяется, что возвращаемый порядок вариантов соответствует значению в списке `randomizer.choices`.
    5. Если порядок не соответствует ни одному из ожидаемых, вызывается исключение.

    A: Создание экземпляра ABRandomizer
    ↓
    B: Цикл 20 итераций
    │
    C: Вызов randomize(i, "option1", "option2")
    │
    D: Проверка соответствия порядка вариантов значению в randomizer.choices
    │
    E: Выброс исключения, если соответствие не найдено

    Примеры:
        >>> test_randomize()  # Запуск теста
    """
```

### `test_derandomize`

```python
def test_derandomize():
    """Тест проверяет корректность дерандомизации вариантов A и B с использованием класса `ABRandomizer`.

    Проверяет, что метод `derandomize` возвращает исходный порядок вариантов после их рандомизации.

    Как работает функция:
    1. Создается экземпляр класса `ABRandomizer`.
    2. Цикл выполняется 20 раз для многократной проверки дерандомизации.
    3. На каждой итерации вызывается метод `randomize` с двумя вариантами ("option1", "option2") и индексом `i`.
    4. Вызывается метод `derandomize` с полученными рандомизированными вариантами и индексом `i`.
    5. Проверяется, что возвращаемый порядок вариантов соответствует исходному ("option1", "option2").

    A: Создание экземпляра ABRandomizer
    ↓
    B: Цикл 20 итераций
    │
    C: Вызов randomize(i, "option1", "option2")
    │
    D: Вызов derandomize(i, a, b)
    │
    E: Проверка соответствия порядка вариантов ("option1", "option2")

    Примеры:
        >>> test_derandomize()  # Запуск теста
    """
```

### `test_derandomize_name`

```python
def test_derandomize_name():
    """Тест проверяет корректность определения имени группы (control или treatment) после рандомизации вариантов с использованием класса `ABRandomizer`.

    Проверяет, что метод `derandomize_name` возвращает правильное имя группы на основе результатов рандомизации.

    Как работает функция:
    1. Создается экземпляр класса `ABRandomizer`.
    2. Цикл выполняется 20 раз для многократной проверки дерандомизации имени.
    3. На каждой итерации вызывается метод `randomize` с двумя вариантами ("cats", "dogs") и индексом `i`.
    4. Вызывается метод `derandomize_name` с полученным рандомизированным вариантом "A" и индексом `i`.
    5. Проверяется, что возвращаемое имя группы ("control" или "treatment") соответствует значению в списке `randomizer.choices`.
    6. Если порядок не соответствует ни одному из ожидаемых, вызывается исключение.

    A: Создание экземпляра ABRandomizer
    ↓
    B: Цикл 20 итераций
    │
    C: Вызов randomize(i, "cats", "dogs")
    │
    D: Вызов derandomize_name(i, "A")
    │
    E: Проверка соответствия имени группы значению в randomizer.choices
    │
    F: Выброс исключения, если соответствие не найдено

    Примеры:
        >>> test_derandomize_name()  # Запуск теста
    """
```

### `test_passtrough_name`

```python
def test_passtrough_name():
    """Тест проверяет, что метод `derandomize_name` возвращает переданное имя, если оно совпадает с `passtrough_name`.

    Создается экземпляр `ABRandomizer` с `passtrough_name=["option3"]`. Проверяется, что при вызове `derandomize_name` с именем "option3" возвращается "option3".

    Как работает функция:
    1. Создается экземпляр класса `ABRandomizer` с параметром `passtrough_name=["option3"]`.
    2. Вызывается метод `randomize` с двумя вариантами ("option1", "option2") и индексом 0.
    3. Вызывается метод `derandomize_name` с именем "option3" и индексом 0.
    4. Проверяется, что возвращаемое имя соответствует "option3".

    A: Создание экземпляра ABRandomizer с passtrough_name=["option3"]
    ↓
    B: Вызов randomize(0, "option1", "option2")
    ↓
    C: Вызов derandomize_name(0, "option3")
    ↓
    D: Проверка соответствия имени "option3"

    Примеры:
        >>> test_passtrough_name()  # Запуск теста
    """
```

### `test_proposition_with_tinyperson`

```python
def test_proposition_with_tinyperson(setup):
    """Тест проверяет возможность проверки утверждений относительно поведения отдельного виртуального персонажа (TinyPerson).

    Создаются два утверждения: одно истинное (Oscar упоминает о своих предпочтениях в путешествиях) и одно ложное (Oscar пишет роман о том, что кошки лучше собак).
    Проверяется, что метод `check` возвращает `True` для истинного утверждения и `False` для ложного.

    Args:
        setup: Фикстура pytest, обеспечивающая начальную настройку тестовой среды.

    Как работает функция:
    1. Создается экземпляр виртуального персонажа Oscar с помощью функции `create_oscar_the_architect`.
    2. Oscar "слушает" и "действует", отвечая на вопрос о своих предпочтениях в путешествиях.
    3. Создается истинное утверждение `true_proposition` о том, что Oscar упоминает о своих предпочтениях в путешествиях.
    4. Создается ложное утверждение `false_proposition` о том, что Oscar пишет роман о кошках и собаках.
    5. Вызывается метод `check` для обоих утверждений и проверяется, что результаты соответствуют ожидаемым.

    A: Создание экземпляра Oscar
    ↓
    B: Oscar отвечает на вопрос о путешествиях
    ↓
    C: Создание true_proposition
    ↓
    D: Создание false_proposition
    ↓
    E: Проверка истинности true_proposition
    ↓
    F: Проверка ложности false_proposition

    Примеры:
        >>> test_proposition_with_tinyperson(setup)  # Запуск теста
    """
```

### `test_proposition_with_tinyperson_at_multiple_points`

```python
def test_proposition_with_tinyperson_at_multiple_points(setup):
    """Тест проверяет возможность проверки утверждений относительно поведения виртуального персонажа (TinyPerson) с учетом нескольких последних действий.

    Создается утверждение, которое проверяется после двух действий персонажа, и проверяется, что утверждение становится ложным после смены темы разговора.

    Args:
        setup: Фикстура pytest, обеспечивающая начальную настройку тестовой среды.

    Как работает функция:
    1. Создается экземпляр виртуального персонажа Oscar с помощью функции `create_oscar_the_architect`.
    2. Oscar "слушает" и "действует", отвечая на вопрос о своих предпочтениях в путешествиях.
    3. Создается утверждение `proposition` о том, что Oscar говорит о своих предпочтениях в путешествиях, с учетом последних 3 действий.
    4. Проверяется, что метод `check` возвращает `True` для данного утверждения.
    5. Выводятся обоснование и уверенность в истинности утверждения.
    6. Oscar "слушает" и "действует", отвечая на вопрос о своей работе.
    7. Проверяется, что метод `check` возвращает `False` для того же утверждения, так как Oscar сменил тему разговора.

    A: Создание экземпляра Oscar
    ↓
    B: Oscar отвечает на вопрос о путешествиях
    ↓
    C: Создание proposition с last_n=3
    ↓
    D: Проверка истинности proposition
    ↓
    E: Вывод обоснования и уверенности
    ↓
    F: Oscar отвечает на вопрос о работе
    ↓
    G: Проверка ложности proposition

    Примеры:
        >>> test_proposition_with_tinyperson_at_multiple_points(setup)  # Запуск теста
    """
```

### `test_proposition_with_tinyworld`

```python
def test_proposition_with_tinyworld(setup, focus_group_world):
    """Тест проверяет возможность проверки утверждений относительно поведения группы виртуальных персонажей (TinyWorld).

    Создаются два утверждения: одно истинное (происходит обсуждение собак и кошек) и одно ложное (происходит обсуждение портвейна и французского вина).
    Проверяется, что метод `check` возвращает `True` для истинного утверждения и `False` для ложного.

    Args:
        setup: Фикстура pytest, обеспечивающая начальную настройку тестовой среды.
        focus_group_world: Фикстура pytest, предоставляющая экземпляр виртуального мира с группой персонажей.

    Как работает функция:
    1. Получается экземпляр виртуального мира `world` с группой персонажей из фикстуры `focus_group_world`.
    2. Мир "транслирует" сообщение о необходимости обсудить сравнительные преимущества собак и кошек.
    3. Мир "запускается" на 2 шага.
    4. Создается истинное утверждение `true_proposition` о том, что происходит обсуждение собак и кошек.
    5. Создается ложное утверждение `false_proposition` о том, что происходит обсуждение портвейна и французского вина.
    6. Вызывается метод `check` для обоих утверждений и проверяется, что результаты соответствуют ожидаемым.

    A: Получение экземпляра world
    ↓
    B: Трансляция сообщения об обсуждении собак и кошек
    ↓
    C: Запуск мира на 2 шага
    ↓
    D: Создание true_proposition
    ↓
    E: Создание false_proposition
    ↓
    F: Проверка истинности true_proposition
    ↓
    G: Проверка ложности false_proposition

    Примеры:
        >>> test_proposition_with_tinyworld(setup, focus_group_world)  # Запуск теста
    """
```

### `test_proposition_with_multiple_targets`

```python
def test_proposition_with_multiple_targets(setup):
    """Тест проверяет возможность проверки утверждений относительно поведения нескольких виртуальных персонажей (TinyPerson).

    Создаются два персонажа: Oscar и Lisa. Oscar говорит о своих предпочтениях в путешествиях, а Lisa рассказывает о своих проектах в области data science.
    Создаются два утверждения: одно истинное (Oscar упоминает о своих предпочтениях в путешествиях, и Lisa рассказывает о проектах data science) и одно ложное (Oscar пишет роман о том, что кошки лучше собак).
    Проверяется, что метод `check` возвращает `True` для истинного утверждения и `False` для ложного.

    Args:
        setup: Фикстура pytest, обеспечивающая начальную настройку тестовой среды.

    Как работает функция:
    1. Создаются экземпляры виртуальных персонажей Oscar и Lisa с помощью функций `create_oscar_the_architect` и `create_lisa_the_data_scientist`.
    2. Oscar "слушает" и "действует", отвечая на вопрос о своих предпочтениях в путешествиях.
    3. Lisa "слушает" и "действует", рассказывая о своих проектах в области data science.
    4. Создается список `targets`, содержащий Oscar и Lisa.
    5. Создается истинное утверждение `true_proposition` о том, что Oscar упоминает о своих предпочтениях в путешествиях, и Lisa рассказывает о проектах data science.
    6. Создается ложное утверждение `false_proposition` о том, что Oscar пишет роман о кошках и собаках.
    7. Вызывается метод `check` для обоих утверждений и проверяется, что результаты соответствуют ожидаемым.

    A: Создание экземпляра Oscar
    ↓
    B: Создание экземпляра Lisa
    ↓
    C: Oscar отвечает на вопрос о путешествиях
    ↓
    D: Lisa отвечает на вопрос о проектах data science
    ↓
    E: Создание списка targets
    ↓
    F: Создание true_proposition
    ↓
    G: Создание false_proposition
    ↓
    H: Проверка истинности true_proposition
    ↓
    I: Проверка ложности false_proposition

    Примеры:
        >>> test_proposition_with_multiple_targets(setup)  # Запуск теста
    """
```

### `test_proposition_class_method`

```python
def test_proposition_class_method(setup):
    """Тест проверяет возможность использования статического метода `check_proposition` для проверки утверждений относительно поведения виртуального персонажа (TinyPerson).

    Создаются два утверждения: одно истинное (Oscar упоминает о своих предпочтениях в путешествиях) и одно ложное (Oscar пишет роман о том, что кошки лучше собак).
    Проверяется, что статический метод `check_proposition` возвращает `True` для истинного утверждения и `False` для ложного.

    Args:
        setup: Фикстура pytest, обеспечивающая начальную настройку тестовой среды.

    Как работает функция:
    1. Создается экземпляр виртуального персонажа Oscar с помощью функции `create_oscar_the_architect`.
    2. Oscar "слушает" и "действует", отвечая на вопрос о своих предпочтениях в путешествиях.
    3. Вызывается статический метод `check_proposition` с истинным утверждением и проверяется, что он возвращает `True`.
    4. Вызывается статический метод `check_proposition` с ложным утверждением и проверяется, что он возвращает `False`.

    A: Создание экземпляра Oscar
    ↓
    B: Oscar отвечает на вопрос о путешествиях
    ↓
    C: Проверка истинности утверждения с помощью check_proposition
    ↓
    D: Проверка ложности утверждения с помощью check_proposition

    Примеры:
        >>> test_proposition_class_method(setup)  # Запуск теста
    """