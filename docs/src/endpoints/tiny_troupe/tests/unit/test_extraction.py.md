# Модуль тестирования извлечения данных

## Обзор

Модуль `test_extraction.py` содержит unit-тесты для проверки корректности работы классов `ArtifactExporter` и `Normalizer` из модуля `tinytroupe.extraction`. Тесты охватывают экспорт артефактов в различных форматах (JSON, TXT, DOCX) и нормализацию текстовых концепций.

## Подробней

Этот модуль является частью набора тестов для библиотеки `tinytroupe`, предназначенной для извлечения и обработки данных. Тесты проверяют правильность экспорта данных в различные форматы и нормализацию концепций, что важно для обеспечения надежности и функциональности библиотеки. Расположение модуля в каталоге `hypotez/src/endpoints/tiny_troupe/tests/unit/` указывает на его принадлежность к модулю `tinytroupe`.

## Фикстуры

### `exporter`

```python
@pytest.fixture
def exporter():
    return ArtifactExporter(base_output_folder=EXPORT_BASE_FOLDER)
```

Фикстура `exporter` создает экземпляр класса `ArtifactExporter` с базовой папкой для экспорта, определенной как `EXPORT_BASE_FOLDER`.

## Функции

### `test_export_json`

```python
def test_export_json(exporter):
    """
    Тестирует экспорт артефактов в формате JSON.

    Args:
        exporter (ArtifactExporter): Экземпляр `ArtifactExporter`, предоставляемый фикстурой.

    Raises:
        AssertionError: Если JSON-файл не был экспортирован или содержимое не соответствует исходным данным.
    """
```

**Как работает функция**:
1. Определяются данные артефакта в формате словаря `artifact_data`.
2. Вызывается метод `exporter.export` для экспорта данных в формате JSON.
3. Проверяется, существует ли экспортированный JSON-файл.
4. Загружается экспортированный JSON-файл и сравнивается с исходными данными.
5. В случае неудачи любого из утверждений, тест завершается с ошибкой.

```
  Определение данных артефакта -> Экспорт данных в JSON -> Проверка существования файла -> Загрузка экспортированных данных -> Сравнение данных
```

**Примеры**:
```python
# Пример вызова функции в рамках тестового окружения pytest
# (fixture exporter уже предоставлена)
def test_example(exporter):
    artifact_data = {"name": "Test", "value": 123}
    exporter.export("test_artifact", artifact_data, content_type="record", target_format="json")
    assert os.path.exists(f"{EXPORT_BASE_FOLDER}/record/test_artifact.json")
```

### `test_export_text`

```python
def test_export_text(exporter):
    """
    Тестирует экспорт артефактов в формате TXT.

    Args:
        exporter (ArtifactExporter): Экземпляр `ArtifactExporter`, предоставляемый фикстурой.

    Raises:
        AssertionError: Если TXT-файл не был экспортирован или содержимое не соответствует исходным данным.
    """
```

**Как работает функция**:
1. Определяются данные артефакта в формате строки `artifact_data`.
2. Вызывается метод `exporter.export` для экспорта данных в формате TXT.
3. Проверяется, существует ли экспортированный TXT-файл.
4. Считывается содержимое экспортированного TXT-файла и сравнивается с исходными данными.
5. В случае неудачи любого из утверждений, тест завершается с ошибкой.

```
  Определение данных артефакта -> Экспорт данных в TXT -> Проверка существования файла -> Чтение экспортированных данных -> Сравнение данных
```

**Примеры**:
```python
# Пример вызова функции в рамках тестового окружения pytest
# (fixture exporter уже предоставлена)
def test_example(exporter):
    artifact_data = "Sample text data"
    exporter.export("test_artifact", artifact_data, content_type="text", target_format="txt")
    assert os.path.exists(f"{EXPORT_BASE_FOLDER}/text/test_artifact.txt")
```

### `test_export_docx`

```python
def test_export_docx(exporter):
    """
    Тестирует экспорт артефактов в формате DOCX с Markdown-форматированием.

    Args:
        exporter (ArtifactExporter): Экземпляр `ArtifactExporter`, предоставляемый фикстурой.

    Raises:
        AssertionError: Если DOCX-файл не был экспортирован или содержимое не содержит ожидаемые данные.
    """
```

**Как работает функция**:

1. Определяются данные артефакта в формате многострочной строки `artifact_data` с Markdown-форматированием.
2. Вызывается метод `exporter.export` для экспорта данных в формате DOCX, указав `content_format="markdown"`.
3. Проверяется, существует ли экспортированный DOCX-файл.
4. Считывается содержимое DOCX-файла с использованием библиотеки `docx`.
5. Проверяется, содержит ли экспортированный текст часть исходного содержимого и отсутствие Markdown-разметки.
6. В случае неудачи любого из утверждений, тест завершается с ошибкой.

```
  Определение данных артефакта (Markdown) -> Экспорт данных в DOCX -> Проверка существования файла -> Чтение данных из DOCX -> Проверка наличия контента и отсутствия Markdown
```

**Примеры**:
```python
# Пример вызова функции в рамках тестового окружения pytest
# (fixture exporter уже предоставлена)
def test_example(exporter):
    artifact_data = "# Sample markdown text"
    exporter.export("test_artifact", artifact_data, content_type="Document", content_format="markdown", target_format="docx")
    assert os.path.exists(f"{EXPORT_BASE_FOLDER}/Document/test_artifact.docx")
```

### `test_normalizer`

```python
def test_normalizer():
    """
    Тестирует класс `Normalizer` для нормализации концепций.

    Raises:
        AssertionError: Если количество нормализованных элементов не соответствует ожидаемому значению,
                        если карта нормализации пуста в начале,
                        если нормализованная концепция `None`,
                        если длина нормализованной концепции не соответствует входной,
                        если элементы нормализованной концепции отсутствуют в карте нормализации,
                        если размер кэша не увеличивается после нормализации.
    """
```

**Как работает функция**:

1. Определяется список концепций `concepts` для нормализации.
2. Инициализируется экземпляр класса `Normalizer` с заданным списком концепций и параметрами.
3. Проверяется, что количество нормализованных элементов соответствует ожидаемому значению (10).
4. Создается несколько "корзин" (`random_concepts_buckets`) со случайными выборками концепций.
5. В цикле для каждой "корзины":
   - Запоминается текущий размер карты нормализации.
   - Вызывается метод `normalizer.normalize` для нормализации концепций в "корзине".
   - Проверяется, что нормализованная концепция не равна `None`.
   - Проверяется, что длина нормализованной концепции соответствует длине входной "корзины".
   - Проверяется, что все элементы из нормализованной концепции присутствуют в ключах карты нормализации.
   - Проверяется, что размер кэша увеличился или остался прежним после нормализации.
6. В случае неудачи любого из утверждений, тест завершается с ошибкой.

```
  Определение списка концепций -> Инициализация Normalizer -> Проверка количества элементов -> Создание корзин концепций -> Цикл по корзинам: Запоминание размера кэша -> Нормализация концепций -> Проверки (None, длина, наличие в карте, размер кэша)
```

**Примеры**:
```python
# Пример вызова функции в рамках тестового окружения pytest
def test_example():
    concepts = ['A', 'B', 'C']
    normalizer = Normalizer(concepts, n=2)
    bucket = ['A', 'B']
    normalized = normalizer.normalize(bucket)
    assert normalized is not None