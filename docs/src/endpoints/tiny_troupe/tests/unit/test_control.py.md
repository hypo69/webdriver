# Модуль тестирования `test_control.py`

## Обзор

Модуль содержит юнит-тесты для проверки функциональности модуля `tinytroupe.control`, который управляет ходом симуляций с агентами, миром и фабрикой агентов.

## Подробнее

Этот модуль тестирует основные функции управления симуляцией, такие как запуск, создание контрольных точек и завершение симуляций. Тесты охватывают различные сценарии, включая работу с отдельными агентами, миром агентов и фабрикой для создания агентов. Файл проверяет правильность сохранения и восстановления состояния симуляции через контрольные точки, а также кэширование результатов для повышения эффективности.

## Функции

### `test_begin_checkpoint_end_with_agent_only`

```python
def test_begin_checkpoint_end_with_agent_only(setup):
    """
    Тест проверяет сценарий запуска, создания контрольной точки и завершения симуляции с использованием только агентов.

    Args:
        setup: Параметр `setup`, предоставляющий контекст и зависимости для тестовой среды.

    Raises:
        AssertionError: Если состояние симуляции или наличие файла контрольной точки не соответствует ожидаемому.
    """
```

**Как работает функция**:

1.  **Инициализация**: Удаляет существующий файл кэша и сбрасывает состояние системы управления.

2.  **Начало симуляции**: Запускает симуляцию с указанным файлом кэша (`control_test.cache.json`). Проверяет, что симуляция находится в состоянии `STATUS_STARTED`.

3.  **Создание агентов**: Создает двух агентов (`agent_1`, `agent_2`) с использованием функций `create_oscar_the_architect` и `create_lisa_the_data_scientist`. Агентам добавляются "ментальные факультеты" и определяются атрибуты (`age`, `nationality`).

4.  **Проверка состояния кэша**: Утверждает, что кеш трассировки и трассировка выполнения не равны `None`.

5.  **Создание контрольной точки**: Создает контрольную точку симуляции.

6.  **Действия агентов**: Агенты взаимодействуют, отправляя сообщения (`How are you doing?`, `What's up?`).

7.  **Проверка файла контрольной точки**: Проверяет, что файл контрольной точки был создан.

8.  **Завершение симуляции**: Завершает симуляцию и проверяет, что её статус изменен на `STATUS_STOPPED`.

9. **Удаление кэша**: Удаляет созданный файл кэша, чтобы избежать влияния на последующие тесты

**ASCII Flowchart**:

```
    Начало теста
    │
    Удаление файла кэша (если существует) - A
    │
    Сброс управления - B
    │
    Начало симуляции - C
    │
    Создание агентов и добавление атрибутов - D
    │
    Создание контрольной точки - E
    │
    Действия агентов - F
    │
    Проверка файла контрольной точки - G
    │
    Завершение симуляции - H
    │
    Конец теста
```

**Примеры**:

```python
def test_begin_checkpoint_end_with_agent_only(setup):
    # ... (код теста) ...
    pass  # Нет явного возврата
```

### `test_begin_checkpoint_end_with_world`

```python
def test_begin_checkpoint_end_with_world(setup):
    """
    Тест проверяет сценарий запуска, создания контрольной точки и завершения симуляции с использованием мира агентов.

    Args:
        setup: Параметр `setup`, предоставляющий контекст и зависимости для тестовой среды.

    Raises:
        AssertionError: Если состояние симуляции или наличие файла контрольной точки не соответствует ожидаемому.
    """
```

**Как работает функция**:

1.  **Инициализация**: Удаляет существующий файл кэша (`control_test_world.cache.json`) и сбрасывает состояние системы управления.
2.  **Начало симуляции**: Запускает симуляцию с указанным файлом кэша. Проверяет, что симуляция находится в состоянии `STATUS_STARTED`.
3.  **Создание мира**: Создает мир (`TinyWorld`) с двумя агентами (Oscar, Lisa).
4.  **Делает агентов доступными**: Функция `make_everyone_accessible` делает всех агентов в мире доступными друг для друга.
5.  **Запуск мира**: Запускает симуляцию мира на 2 шага.
6.  **Проверка состояния кэша**: Утверждает, что кеш трассировки и трассировка выполнения не равны `None`.
7.  **Создание контрольной точки**: Создает контрольную точку симуляции.
8.  **Проверка файла контрольной точки**: Проверяет, что файл контрольной точки был создан.
9.  **Завершение симуляции**: Завершает симуляцию и проверяет, что её статус изменен на `STATUS_STOPPED`.
10. **Удаление кэша**: Удаляет созданный файл кэша, чтобы избежать влияния на последующие тесты

**ASCII Flowchart**:

```
    Начало теста
    │
    Удаление файла кэша (если существует) - A
    │
    Сброс управления - B
    │
    Начало симуляции - C
    │
    Создание мира с агентами - D
    │
    Запуск мира - E
    │
    Создание контрольной точки - F
    │
    Проверка файла контрольной точки - G
    │
    Завершение симуляции - H
    │
    Конец теста
```

**Примеры**:

```python
def test_begin_checkpoint_end_with_world(setup):
    # ... (код теста) ...
    pass  # Нет явного возврата
```

### `test_begin_checkpoint_end_with_factory`

```python
def test_begin_checkpoint_end_with_factory(setup):
    """
    Тест проверяет сценарий запуска, создания контрольной точки и завершения симуляции с использованием фабрики агентов.

    Args:
        setup: Параметр `setup`, предоставляющий контекст и зависимости для тестовой среды.

    Raises:
        AssertionError: Если состояние симуляции, наличие файла контрольной точки или кэш-промахи не соответствуют ожидаемому.
    """
```

#### Внутренние функции

##### `aux_simulation_to_repeat`

```python
def aux_simulation_to_repeat(iteration, verbose=False):
    """
    Вспомогательная функция для повторения шагов симуляции.

    Args:
        iteration (int): Номер итерации симуляции.
        verbose (bool, optional): Флаг для включения детального логирования. По умолчанию `False`.

    Returns:
        agent (TinyPerson): Сгенерированный агент `TinyPerson`.
    """
```

**Как работает функция**:

1.  **Инициализация**: Сбрасывает состояние системы управления.

2.  **Начало симуляции**: Запускает симуляцию с указанным файлом кэша (`control_test_personfactory.cache.json`). Проверяет, что симуляция находится в состоянии `STATUS_STARTED`.

3.  **Создание фабрики**: Создает фабрику агентов (`TinyPersonFactory`), специализирующихся на экспертах по приготовлению супа Гаспачо.

4.  **Проверка состояния кэша**: Утверждает, что кеш трассировки и трассировка выполнения не равны `None`.

5.  **Генерация агента**: Генерирует агента с использованием фабрики (`factory.generate_person`), описывая его как бразильского туриста, узнавшего о Гаспачо в Испании.

6.  **Создание контрольной точки**: Создает контрольную точку симуляции.

7.  **Проверка файла контрольной точки**: Проверяет, что файл контрольной точки был создан.

8.  **Завершение симуляции**: Завершает симуляцию и проверяет, что её статус изменен на `STATUS_STOPPED`.

9.  **Логирование**: Если `verbose=True`, логирует номер итерации и конфигурацию персоны агента.

10. **Возврат агента**: Возвращает созданного агента.

**ASCII Flowchart**:

```
    Начало симуляции
    │
    Сброс управления - A
    │
    Начало симуляции - B
    │
    Создание фабрики агентов - C
    │
    Генерация агента фабрикой - D
    │
    Создание контрольной точки - E
    │
    Проверка файла контрольной точки - F
    │
    Завершение симуляции - G
    │
    Возврат агента - H
    │
    Конец симуляции
```

**Примеры**:

```python
def aux_simulation_to_repeat(iteration, verbose=False):
    # ... (код функции) ...
    return agent
```

**Как работает функция `test_begin_checkpoint_end_with_factory`**:

1.  **Инициализация**: Удаляет существующий файл кэша (`control_test_personfactory.cache.json`) и сбрасывает состояние системы управления.

2.  **Проверка кэша**: Утверждает, что изначально нет промахов и попаданий в кэш.

3.  **Первая симуляция**: Выполняет первую симуляцию с помощью `aux_simulation_to_repeat`. Сохраняет возраст, национальность и мини-биографию созданного агента.

4.  **Вторая симуляция**: Выполняет вторую симуляцию с помощью `aux_simulation_to_repeat`. Сохраняет возраст, национальность и мини-биографию созданного агента.

5.  **Проверка кэша**: Утверждает, что нет промахов кэша и есть попадания в кэш.

6.  **Сравнение агентов**: Утверждает, что возраст, национальность и мини-биография агентов из первой и второй симуляций совпадают (т.е. атрибуты должны быть одинаковы в обеих симуляциях).

7.  **Проверка содержимого кэш-файла**: Читает содержимое кэш-файла и проверяет наличие определенных вызовов функций (`_aux_model_call`, `_setup_agent`) и отсутствие вызовов, связанных с переопределением атрибутов (`define`, `define_several`).

**ASCII Flowchart**:

```
    Начало теста
    │
    Удаление файла кэша (если существует) - A
    │
    Сброс управления - B
    │
    Проверка состояния кэша (промахи/попадания) - C
    │
    Первая симуляция с фабрикой - D
    │
    Вторая симуляция с фабрикой - E
    │
    Проверка состояния кэша (промахи/попадания) - F
    │
    Сравнение агентов (возраст, национальность, биография) - G
    │
    Проверка содержимого кэш-файла - H
    │
    Конец теста
```

**Примеры**:

```python
def test_begin_checkpoint_end_with_factory(setup):
    # ... (код теста) ...
    pass  # Нет явного возврата