# Модуль `admin.py`

## Обзор

Модуль `admin.py` предназначен для реализации административной панели Telegram-бота, используемого в цифровом магазине. Он обеспечивает интерфейс для управления пользователями, товарами и статистикой. Модуль использует библиотеку `aiogram` для обработки входящих запросов от администраторов бота и `SQLAlchemy` для взаимодействия с базой данных.

## Подробнее

Этот модуль содержит обработчики callback-запросов и текстовых сообщений, позволяющие администраторам выполнять различные действия, такие как просмотр статистики, добавление и удаление товаров. Для управления состоянием используются классы `StatesGroup` и `State` из `aiogram.fsm`.

## Классы

### `AddProduct`

**Описание**:
Класс `AddProduct` представляет собой группу состояний (FSM - Finite State Machine), используемую для управления процессом добавления нового товара в базу данных.

**Наследует**:
- `StatesGroup` из библиотеки `aiogram.fsm.state`.

**Атрибуты**:
- `name` (State): Состояние для ввода имени товара.
- `description` (State): Состояние для ввода описания товара.
- `price` (State): Состояние для ввода цены товара.
- `file_id` (State): Состояние для загрузки файла товара.
- `category_id` (State): Состояние для выбора категории товара.
- `hidden_content` (State): Состояние для ввода скрытого контента товара.
- `confirm_add` (State): Состояние для подтверждения добавления товара.

## Функции

### `start_admin`

```python
async def start_admin(call: CallbackQuery) -> None:
    """
    Обрабатывает callback-запрос для входа в админ-панель.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.

    Raises:
        Exception: Если возникает ошибка при открытии админ-панели.

    """
```

**Назначение**:
Функция `start_admin` обрабатывает callback-запрос, возникающий при нажатии на кнопку "admin_panel" в Telegram-боте. Она проверяет, имеет ли пользователь доступ к админ-панели на основе его ID, указанного в настройках (`settings.ADMIN_IDS`).

**Как работает функция**:

1. **Проверка доступа**: Функция проверяет, входит ли ID пользователя, отправившего запрос, в список разрешенных ID администраторов.
2. **Ответ на запрос**: Бот отправляет подтверждение, что доступ разрешен.
3. **Редактирование сообщения**: Бот пытается отредактировать сообщение, вызвавшее callback, чтобы отобразить интерфейс админ-панели с доступными действиями.
4. **Обработка ошибок**: Если редактирование сообщения не удается (например, сообщение было удалено), бот пытается отправить новое сообщение с тем же содержимым. Если и это не удается, отправляется сообщение об ошибке.

**ASCII flowchart**:

```
A[Проверка доступа пользователя]
|
B[Отправка подтверждения доступа]
|
C[Попытка редактирования сообщения с интерфейсом админ-панели]
|
D[Если редактирование не удалось]
|
E[Попытка отправки нового сообщения с интерфейсом админ-панели]
|
F[Если отправка не удалась]
|
G[Отправка сообщения об ошибке]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await start_admin(callback_query)
```

### `admin_statistic`

```python
async def admin_statistic(call: CallbackQuery, session_without_commit: AsyncSession) -> None:
    """
    Получает и отображает статистику пользователей и заказов.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения запросов к базе данных.

    """
```

**Назначение**:
Функция `admin_statistic` обрабатывает callback-запрос для получения и отображения статистики пользователей и заказов в админ-панели Telegram-бота.

**Как работает функция**:

1. **Ответ на запрос**: Бот отправляет уведомление о начале сбора статистики.
2. **Получение статистики**: Функция запрашивает статистику пользователей (общее количество, новые за сегодня, неделю и месяц) и статистику по заказам (через `UserDAO` и `PurchaseDao`).
3. **Формирование сообщения**: На основе полученных данных формируется текстовое сообщение со статистикой.
4. **Редактирование сообщения**: Бот редактирует сообщение, вызвавшее callback, чтобы отобразить статистику.

**ASCII flowchart**:

```
A[Отправка уведомления о начале сбора статистики]
|
B[Получение статистики пользователей и заказов из БД]
|
C[Формирование текстового сообщения со статистикой]
|
D[Редактирование сообщения с отображением статистики]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_statistic(callback_query, session)
```

### `admin_process_cancel`

```python
async def admin_process_cancel(call: CallbackQuery, state: FSMContext) -> None:
    """
    Обрабатывает callback-запрос для отмены текущего сценария добавления товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.

    """
```

**Назначение**:
Функция `admin_process_cancel` обрабатывает callback-запрос для отмены текущего сценария добавления товара администратором.

**Как работает функция**:

1. **Очистка состояния**: Функция сбрасывает все данные, сохраненные в FSMContext для текущего пользователя, что приводит к отмене текущего сценария.
2. **Ответ на запрос**: Бот отправляет уведомление об отмене сценария.
3. **Удаление сообщения**: Бот удаляет сообщение, вызвавшее callback.
4. **Отправка сообщения об отмене**: Бот отправляет новое сообщение с подтверждением отмены добавления товара и предлагает вернуться в админ-панель.

**ASCII flowchart**:

```
A[Очистка состояния FSMContext пользователя]
|
B[Отправка уведомления об отмене сценария]
|
C[Удаление сообщения, вызвавшего callback]
|
D[Отправка сообщения об отмене добавления товара]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_cancel(callback_query, state)
```

### `admin_process_start_dell`

```python
async def admin_process_start_dell(call: CallbackQuery, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает callback-запрос для запуска процесса удаления товаров.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения запросов к базе данных.

    """
```

**Назначение**:
Функция `admin_process_start_dell` обрабатывает callback-запрос для запуска процесса удаления товаров из базы данных. Она получает список всех товаров и отображает их с кнопками для удаления.

**Как работает функция**:

1. **Ответ на запрос**: Бот отправляет уведомление о начале режима удаления товаров.
2. **Получение списка товаров**: Функция получает список всех товаров из базы данных.
3. **Отображение товаров**: Для каждого товара формируется текстовое описание, включающее название, описание, цену и скрытое описание. Если у товара есть файл, он отправляется как документ с описанием. Для каждого товара добавляется кнопка для удаления.

**ASCII flowchart**:

```
A[Отправка уведомления о начале режима удаления товаров]
|
B[Получение списка всех товаров из БД]
|
C[Для каждого товара:]
|   |- C1[Формирование текстового описания товара]
|   |- C2[Отправка товара (с файлом или без) с кнопкой удаления]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_start_dell(callback_query, session)
```

### `admin_process_start_dell` (с префиксом `dell_`)

```python
async def admin_process_start_dell(call: CallbackQuery, session_with_commit: AsyncSession) -> None:
    """
    Обрабатывает callback-запрос для удаления конкретного товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения запросов к базе данных с возможностью коммита изменений.

    """
```

**Назначение**:
Функция `admin_process_start_dell` (с префиксом `dell_` в `callback_query`) обрабатывает callback-запрос для удаления конкретного товара из базы данных по его ID.

**Как работает функция**:

1. **Извлечение ID товара**: Функция извлекает ID товара из данных callback-запроса.
2. **Удаление товара**: Функция удаляет товар из базы данных с указанным ID.
3. **Ответ на запрос**: Бот отправляет уведомление об успешном удалении товара.
4. **Удаление сообщения**: Бот удаляет сообщение с информацией о товаре.

**ASCII flowchart**:

```
A[Извлечение ID товара из данных callback]
|
B[Удаление товара из БД по ID]
|
C[Отправка уведомления об успешном удалении товара]
|
D[Удаление сообщения с информацией о товаре]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_start_dell(callback_query, session)
```

### `admin_process_products`

```python
async def admin_process_products(call: CallbackQuery, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает callback-запрос для отображения панели управления товарами.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения запросов к базе данных.

    """
```

**Назначение**:
Функция `admin_process_products` обрабатывает callback-запрос для отображения панели управления товарами в админ-панели.

**Как работает функция**:

1. **Ответ на запрос**: Бот отправляет уведомление о начале режима управления товарами.
2. **Получение количества товаров**: Функция получает общее количество товаров из базы данных.
3. **Редактирование сообщения**: Бот редактирует сообщение, вызвавшее callback, чтобы отобразить панель управления товарами с доступными действиями (например, добавление, удаление, редактирование).

**ASCII flowchart**:

```
A[Отправка уведомления о начале режима управления товарами]
|
B[Получение общего количества товаров из БД]
|
C[Редактирование сообщения с отображением панели управления товарами]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_products(callback_query, session)
```

### `admin_process_add_product`

```python
async def admin_process_add_product(call: CallbackQuery, state: FSMContext) -> None:
    """
    Обрабатывает callback-запрос для запуска сценария добавления нового товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.

    """
```

**Назначение**:
Функция `admin_process_add_product` обрабатывает callback-запрос для запуска сценария добавления нового товара в базу данных.

**Как работает функция**:

1. **Ответ на запрос**: Бот отправляет уведомление о начале сценария добавления товара.
2. **Удаление сообщения**: Бот удаляет сообщение, вызвавшее callback.
3. **Запрос имени товара**: Бот отправляет сообщение с запросом имени товара и устанавливает состояние `AddProduct.name`.

**ASCII flowchart**:

```
A[Отправка уведомления о начале сценария добавления товара]
|
B[Удаление сообщения, вызвавшего callback]
|
C[Отправка сообщения с запросом имени товара]
|
D[Установка состояния AddProduct.name]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_add_product(callback_query, state)
```

### `admin_process_name`

```python
async def admin_process_name(message: Message, state: FSMContext) -> None:
    """
    Обрабатывает сообщение с именем товара.

    Args:
        message (Message): Объект сообщения от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.

    """
```

**Назначение**:
Функция `admin_process_name` обрабатывает сообщение, содержащее имя товара, введенное администратором.

**Как работает функция**:

1. **Сохранение имени товара**: Функция сохраняет введенное имя товара в FSMContext.
2. **Удаление предыдущего сообщения**: Вызывает `process_dell_text_msg` для удаления предыдущего сообщения.
3. **Запрос описания товара**: Бот отправляет сообщение с запросом краткого описания товара и устанавливает состояние `AddProduct.description`.

**ASCII flowchart**:

```
A[Сохранение имени товара в FSMContext]
|
B[Удаление предыдущего сообщения]
|
C[Отправка сообщения с запросом описания товара]
|
D[Установка состояния AddProduct.description]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_name(message, state)
```

### `admin_process_description`

```python
async def admin_process_description(message: Message, state: FSMContext, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает сообщение с описанием товара.

    Args:
        message (Message): Объект сообщения от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения запросов к базе данных.

    """
```

**Назначение**:
Функция `admin_process_description` обрабатывает сообщение, содержащее описание товара, введенное администратором.

**Как работает функция**:

1. **Сохранение описания товара**: Функция сохраняет введенное описание товара (в формате HTML) в FSMContext.
2. **Удаление предыдущего сообщения**: Вызывает `process_dell_text_msg` для удаления предыдущего сообщения.
3. **Запрос категории товара**: Функция получает список категорий из базы данных и отправляет сообщение с кнопками для выбора категории товара. Устанавливает состояние `AddProduct.category_id`.

**ASCII flowchart**:

```
A[Сохранение описания товара в FSMContext]
|
B[Удаление предыдущего сообщения]
|
C[Получение списка категорий из БД]
|
D[Отправка сообщения с кнопками для выбора категории товара]
|
E[Установка состояния AddProduct.category_id]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_description(message, state, session)
```

### `admin_process_category`

```python
async def admin_process_category(call: CallbackQuery, state: FSMContext) -> None:
    """
    Обрабатывает выбор категории товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.

    """
```

**Назначение**:
Функция `admin_process_category` обрабатывает callback-запрос, возникающий при выборе категории товара администратором.

**Как работает функция**:

1. **Извлечение ID категории**: Функция извлекает ID выбранной категории из данных callback-запроса.
2. **Сохранение ID категории**: Функция сохраняет ID выбранной категории в FSMContext.
3. **Ответ на запрос**: Бот отправляет подтверждение выбора категории.
4. **Запрос цены товара**: Бот редактирует сообщение с запросом цены товара и устанавливает состояние `AddProduct.price`.

**ASCII flowchart**:

```
A[Извлечение ID категории из данных callback]
|
B[Сохранение ID категории в FSMContext]
|
C[Отправка подтверждения выбора категории]
|
D[Редактирование сообщения с запросом цены товара]
|
E[Установка состояния AddProduct.price]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_category(call, state)
```

### `admin_process_price`

```python
async def admin_process_price(message: Message, state: FSMContext) -> None:
    """
    Обрабатывает сообщение с ценой товара.

    Args:
        message (Message): Объект сообщения от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.

    """
```

**Назначение**:
Функция `admin_process_price` обрабатывает сообщение, содержащее цену товара, введенную администратором.

**Как работает функция**:

1. **Проверка формата цены**: Функция пытается преобразовать введенный текст в целое число. Если преобразование не удается, отправляется сообщение об ошибке.
2. **Сохранение цены товара**: Функция сохраняет цену товара в FSMContext.
3. **Удаление предыдущего сообщения**: Вызывает `process_dell_text_msg` для удаления предыдущего сообщения.
4. **Запрос файла товара**: Бот отправляет сообщение с запросом файла товара (или выбора опции "без файла") и устанавливает состояние `AddProduct.file_id`.

**ASCII flowchart**:

```
A[Попытка преобразования введенного текста в число]
|
B[Если преобразование не удалось]
|   |- B1[Отправка сообщения об ошибке]
|   |- B2[Выход из функции]
|
C[Сохранение цены товара в FSMContext]
|
D[Удаление предыдущего сообщения]
|
E[Отправка сообщения с запросом файла товара]
|
F[Установка состояния AddProduct.file_id]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_price(message, state)
```

### `admin_process_without_file` (callback_query)

```python
async def admin_process_without_file(call: CallbackQuery, state: FSMContext) -> None:
    """
    Обрабатывает выбор опции "без файла" при добавлении товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.

    """
```

**Назначение**:
Функция `admin_process_without_file` (с `callback_query`) обрабатывает callback-запрос, возникающий при выборе администратором опции "без файла" при добавлении товара.

**Как работает функция**:

1. **Сохранение информации об отсутствии файла**: Функция сохраняет `None` в FSMContext в качестве file_id.
2. **Ответ на запрос**: Бот отправляет подтверждение, что файл не выбран.
3. **Запрос скрытого контента**: Бот редактирует сообщение с запросом скрытого контента, который будет отображаться после покупки товара, и устанавливает состояние `AddProduct.hidden_content`.

**ASCII flowchart**:

```
A[Сохранение None в FSMContext в качестве file_id]
|
B[Отправка подтверждения, что файл не выбран]
|
C[Редактирование сообщения с запросом скрытого контента]
|
D[Установка состояния AddProduct.hidden_content]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_without_file(call, state)
```

### `admin_process_without_file` (message)

```python
async def admin_process_without_file(message: Message, state: FSMContext) -> None:
    """
    Обрабатывает сообщение с файлом товара.

    Args:
        message (Message): Объект сообщения от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.

    """
```

**Назначение**:
Функция `admin_process_without_file` (с `message`) обрабатывает сообщение, содержащее файл товара, отправленный администратором.

**Как работает функция**:

1. **Сохранение file_id**: Функция сохраняет ID файла (document.file_id) в FSMContext.
2. **Удаление предыдущего сообщения**: Вызывает `process_dell_text_msg` для удаления предыдущего сообщения.
3. **Запрос скрытого контента**: Бот отправляет сообщение с запросом скрытого контента, который будет отображаться после покупки товара, и устанавливает состояние `AddProduct.hidden_content`.

**ASCII flowchart**:

```
A[Сохранение file_id в FSMContext]
|
B[Удаление предыдущего сообщения]
|
C[Отправка сообщения с запросом скрытого контента]
|
D[Установка состояния AddProduct.hidden_content]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_without_file(message, state)
```

### `admin_process_hidden_content`

```python
async def admin_process_hidden_content(message: Message, state: FSMContext, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает сообщение со скрытым контентом товара.

    Args:
        message (Message): Объект сообщения от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения запросов к базе данных.

    """
```

**Назначение**:
Функция `admin_process_hidden_content` обрабатывает сообщение, содержащее скрытый контент товара, введенный администратором.

**Как работает функция**:

1. **Сохранение скрытого контента**: Функция сохраняет введенный скрытый контент (в формате HTML) в FSMContext.
2. **Получение данных о товаре**: Функция извлекает все данные о товаре, накопленные в FSMContext.
3. **Получение информации о категории**: Функция получает информацию о категории товара из базы данных.
4. **Формирование текста предпросмотра**: На основе полученных данных формируется текст предпросмотра товара.
5. **Удаление предыдущего сообщения**: Вызывает `process_dell_text_msg` для удаления предыдущего сообщения.
6. **Отправка предпросмотра**: Бот отправляет сообщение с предпросмотром товара и кнопками подтверждения/отмены. Устанавливает состояние `AddProduct.confirm_add`.

**ASCII flowchart**:

```
A[Сохранение скрытого контента в FSMContext]
|
B[Получение данных о товаре из FSMContext]
|
C[Получение информации о категории из БД]
|
D[Формирование текста предпросмотра товара]
|
E[Удаление предыдущего сообщения]
|
F[Отправка предпросмотра товара с кнопками подтверждения/отмены]
|
G[Установка состояния AddProduct.confirm_add]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_hidden_content(message, state, session)
```

### `admin_process_confirm_add`

```python
async def admin_process_confirm_add(call: CallbackQuery, state: FSMContext, session_with_commit: AsyncSession) -> None:
    """
    Обрабатывает подтверждение добавления товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        state (FSMContext): Объект FSMContext для управления состоянием пользователя.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения запросов к базе данных с возможностью коммита изменений.

    """
```

**Назначение**:
Функция `admin_process_confirm_add` обрабатывает callback-запрос, возникающий при подтверждении добавления товара администратором.

**Как работает функция**:

1. **Ответ на запрос**: Бот отправляет уведомление о начале сохранения товара.
2. **Получение данных о товаре**: Функция извлекает все данные о товаре, накопленные в FSMContext.
3. **Удаление сообщения предпросмотра**: Бот удаляет сообщение с предпросмотром товара.
4. **Добавление товара в базу данных**: Функция добавляет товар в базу данных.
5. **Отправка сообщения об успехе**: Бот отправляет сообщение об успешном добавлении товара и предлагает вернуться в админ-панель.

**ASCII flowchart**:

```
A[Отправка уведомления о начале сохранения товара]
|
B[Получение данных о товаре из FSMContext]
|
C[Удаление сообщения предпросмотра]
|
D[Добавление товара в БД]
|
E[Отправка сообщения об успехе добавления товара]
```

**Примеры**:

```python
# Пример вызова (в контексте aiogram)
# await admin_process_confirm_add(call, state, session)