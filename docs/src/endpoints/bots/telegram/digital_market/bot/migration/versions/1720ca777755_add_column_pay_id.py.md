# Модуль миграции Alembic для добавления столбца `payment_id` в таблицу `purchases`

## Обзор

Этот модуль содержит скрипт миграции Alembic, который добавляет столбец `payment_id` в таблицу `purchases`, если он еще не существует, и удаляет его, если он существует при откате миграции.

## Подробнее

Этот скрипт Alembic используется для управления изменениями схемы базы данных. Он содержит функции `upgrade` и `downgrade`, которые определяют, как применить и откатить изменения соответственно. Скрипт проверяет наличие столбца `payment_id` перед его добавлением или удалением, чтобы избежать ошибок.

## Функции

### `upgrade`

```python
def upgrade() -> None:
    """Добавляет столбец `payment_id` в таблицу `purchases`, если он еще не существует."""
```

**Назначение**: Добавление столбца `payment_id` в таблицу `purchases`.

**Параметры**:
- Нет

**Возвращает**:
- `None`

**Вызывает исключения**:
- Нет

**Как работает функция**:

1. Получает соединение с базой данных, используя `op.get_bind()`.
2. Выполняет запрос `PRAGMA table_info('purchases')` для получения информации о столбцах таблицы `purchases`.
3. Извлекает имена столбцов из результатов запроса.
4. Проверяет, существует ли столбец `payment_id` в таблице `purchases`.
5. Если столбец `payment_id` не существует, добавляет его с использованием `op.add_column()`, устанавливая тип `sa.String()` и атрибут `nullable=False`.
6. Создает уникальное ограничение `uq_purchases_payment_id` для столбца `payment_id` с использованием `op.create_unique_constraint()`.
7. Если столбец `payment_id` уже существует, выводит сообщение в консоль, что добавление пропускается.

**ASCII flowchart**:

```
A [Получение соединения с БД]
|
B [Получение информации о столбцах таблицы purchases]
|
C [Проверка существования столбца payment_id]
|
D [Добавление столбца payment_id (если не существует)]
|
E [Создание уникального ограничения для столбца payment_id]
|
F [Вывод сообщения о пропуске добавления (если существует)]
```

**Примеры**:

```python
# Пример выполнения upgrade (обычно вызывается Alembic)
upgrade()
```

### `downgrade`

```python
def downgrade() -> None:
    """Удаляет столбец `payment_id` из таблицы `purchases`, если он существует."""
```

**Назначение**: Удаление столбца `payment_id` из таблицы `purchases`.

**Параметры**:
- Нет

**Возвращает**:
- `None`

**Вызывает исключения**:
- Нет

**Как работает функция**:

1. Получает соединение с базой данных, используя `op.get_bind()`.
2. Выполняет запрос `PRAGMA table_info('purchases')` для получения информации о столбцах таблицы `purchases`.
3. Извлекает имена столбцов из результатов запроса.
4. Проверяет, существует ли столбец `payment_id` в таблице `purchases`.
5. Если столбец `payment_id` существует, удаляет уникальное ограничение `uq_purchases_payment_id` с использованием `op.drop_constraint()`.
6. Удаляет столбец `payment_id` с использованием `op.drop_column()`.
7. Если столбец `payment_id` не существует, выводит сообщение в консоль, что удаление пропускается.

**ASCII flowchart**:

```
A [Получение соединения с БД]
|
B [Получение информации о столбцах таблицы purchases]
|
C [Проверка существования столбца payment_id]
|
D [Удаление уникального ограничения для столбца payment_id (если существует)]
|
E [Удаление столбца payment_id]
|
F [Вывод сообщения о пропуске удаления (если не существует)]
```

**Примеры**:

```python
# Пример выполнения downgrade (обычно вызывается Alembic)
downgrade()
```