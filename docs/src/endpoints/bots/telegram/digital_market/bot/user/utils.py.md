# Модуль `utils.py` для обработки успешных платежей в Telegram боте

## Обзор

Модуль содержит функцию `successful_payment_logic`, которая обрабатывает логику успешной оплаты товара пользователем через Telegram бот. Она включает в себя добавление информации о покупке в базу данных, отправку уведомлений администраторам и пользователю, а также возврат звезд (если оплата была произведена звездами).

## Подробней

Этот модуль является ключевым компонентом для обработки финансовых операций в боте. Он обеспечивает взаимодействие с базой данных для сохранения информации о покупках, уведомляет заинтересованных лиц о транзакциях и предоставляет пользователю информацию о приобретенном товаре. Расположение модуля `hypotez/src/endpoints/bots/telegram/digital_market/bot/user/utils.py` указывает на его принадлежность к пользовательской части бота цифрового рынка в Telegram.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """ Обрабатывает логику успешной оплаты товара пользователем.

    Args:
        session (AsyncSession): Сессия базы данных SQLAlchemy.
        payment_data (dict): Данные о платеже.
        currency (str): Валюта платежа.
        user_tg_id (int): Telegram ID пользователя.
        bot (Bot): Экземпляр Telegram бота.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при отправке уведомления администраторам.

    **Внутренние функции**:
    В данной функции отсутствуют внутренние функции.
    """
```

**Параметры**:

*   `session` (`AsyncSession`): Асинхронная сессия для взаимодействия с базой данных.
*   `payment_data` (`dict`): Словарь с данными о платеже, содержащий `product_id`, `price`, `payment_type`, `payment_id` и `user_id`.
*   `currency` (`str`): Строка, представляющая валюту платежа.
*   `user_tg_id` (`int`): Целочисленный Telegram ID пользователя, совершившего покупку.
*   `bot` (`Bot`): Объект бота aiogram для отправки сообщений.

**Возвращает**:

*   `None`: Функция ничего не возвращает явно.

**Вызывает исключения**:

*   `Exception`: Возникает, если происходит ошибка при отправке уведомлений администраторам.

**Как работает функция**:

1.  Извлекает данные о платеже (`product_id`, `price`, `payment_type`, `payment_id`, `user_id`) из словаря `payment_data`.
2.  Добавляет информацию о покупке в базу данных через `PurchaseDao.add`.
3.  Получает информацию о продукте из базы данных по `product_id` через `ProductDao.find_one_or_none_by_id`.
4.  Отправляет уведомления всем администраторам (ID которых указаны в `settings.ADMIN_IDS`) о новой покупке.  В случае ошибки логирует её с помощью `logger.error`.
5.  Формирует текст сообщения для пользователя, содержащий информацию о товаре.
6.  Отправляет пользователю сообщение с информацией о покупке и товаре, а также прикрепляет файл, если он есть в данных о продукте. Использует клавиатуру `main_user_kb` для навигации.
7.  Если тип оплаты - "звезды", инициирует возврат звезд пользователю через `bot.refund_star_payment`.

**Flowchart работы функции:**

```
Начало --> Извлечение данных о платеже
↓
Добавление информации о покупке в БД (PurchaseDao.add)
↓
Получение информации о продукте из БД (ProductDao.find_one_or_none_by_id)
↓
Отправка уведомлений администраторам
│
└── Ошибка при отправке --> Логирование ошибки (logger.error)
↓
Формирование текста сообщения для пользователя
↓
Отправка сообщения пользователю (с файлом или без)
↓
Проверка типа оплаты == "звезды"
│
└── Да --> Возврат звезд пользователю (bot.refund_star_payment)
↓
Конец
```

**Примеры**:

Предположим, у нас есть следующие данные:

```python
payment_data = {
    "product_id": "123",
    "price": "10.00",
    "payment_type": "credit_card",
    "payment_id": "payment_123",
    "user_id": "456"
}
```

1.  Вызов функции с этими данными:

```python
await successful_payment_logic(
    session=session,
    payment_data=payment_data,
    currency="USD",
    user_tg_id=456,
    bot=bot
)
```

В этом случае, функция добавит информацию о покупке в БД, отправит уведомления администраторам и пользователю с ID 456 сообщение о покупке товара с ID 123 за 10.00 USD.

2.  Вызов функции, когда `payment_type` равен `stars`:

```python
payment_data = {
    "product_id": "123",
    "price": "10.00",
    "payment_type": "stars",
    "payment_id": "payment_123",
    "user_id": "456"
}

await successful_payment_logic(
    session=session,
    payment_data=payment_data,
    currency="USD",
    user_tg_id=456,
    bot=bot
)
```

В этом случае, дополнительно будет инициирован возврат звезд пользователю с ID 456.