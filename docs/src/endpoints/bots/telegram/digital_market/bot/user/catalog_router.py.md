# Модуль catalog_router

## Обзор

Модуль `catalog_router` предназначен для обработки запросов, связанных с каталогом товаров в Telegram-боте. Он содержит набор обработчиков (handlers) для отображения категорий товаров, списка товаров в категории, а также для организации процесса покупки товаров через различные платежные системы (ЮKassa, Stars, Robocassa).

## Подробнее

Этот модуль является частью логики Telegram-бота для цифрового рынка. Он использует библиотеку `aiogram` для обработки входящих запросов и взаимодействует с базой данных через асинхронные DAO (Data Access Objects).

## Классы

В данном модуле нет классов.

## Функции

### `page_catalog`

```python
async def page_catalog(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обработчик callback-запроса для отображения каталога категорий товаров.

    Args:
        call (CallbackQuery): Объект callback-запроса от Telegram.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без коммита.

    Returns:
        None

    Raises:
        Exception: Если не удается удалить предыдущее сообщение.

    Как работает функция:
    1. Отвечает на callback-запрос с сообщением "Загрузка каталога...".
    2. Пытается удалить предыдущее сообщение, чтобы интерфейс был чище.
    3. Извлекает все категории товаров из базы данных с помощью `CategoryDao.find_all`.
    4. Отправляет сообщение с клавиатурой, содержащей список категорий.

    Схема работы функции:
    A (Ответ на callback)
    ↓
    B (Удаление предыдущего сообщения)
    ↓
    C (Извлечение категорий из БД)
    ↓
    D (Отправка сообщения с категориями)

    Примеры:
        Предположим, что в базе данных есть категории "Электроника", "Одежда" и "Книги".
        После вызова этой функции пользователь увидит сообщение с кнопками для каждой из этих категорий.
    """
```

### `page_catalog_products`

```python
async def page_catalog_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обработчик callback-запроса для отображения списка товаров в выбранной категории.

    Args:
        call (CallbackQuery): Объект callback-запроса от Telegram.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без коммита.

    Returns:
        None

    Как работает функция:
    1. Извлекает ID категории из callback-данных.
    2. Получает список товаров, принадлежащих к данной категории, из базы данных с помощью `ProductDao.find_all`.
    3. Если товары в категории есть, отвечает на callback-запрос с указанием количества товаров.
    4. Для каждого товара формирует текстовое описание и отправляет сообщение с кнопкой для покупки.
    5. Если товаров в категории нет, отвечает на callback-запрос сообщением "В данной категории нет товаров".

    Схема работы функции:
    A (Извлечение ID категории)
    ↓
    B (Получение товаров из БД)
    ↓
    C (Проверка наличия товаров)
    ├── Да → D (Отправка товаров)
    └── Нет → E (Ответ об отсутствии товаров)

    Примеры:
        Предположим, пользователь выбирает категорию "Электроника", в которой есть 2 товара: "Телефон" и "Планшет".
        После вызова этой функции пользователь увидит описание каждого товара с кнопкой "Купить".
    """
```

### `process_about`

```python
async def process_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обработчик callback-запроса для начала процесса покупки товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от Telegram.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без коммита.

    Returns:
        None

    Как работает функция:
    1. Получает информацию о пользователе из базы данных с помощью `UserDAO.find_one_or_none`.
    2. Извлекает тип платежа, ID продукта и цену из callback-данных.
    3. В зависимости от типа платежа вызывает соответствующую функцию для формирования инвойса (счета) и отправки его пользователю:
        - `yukassa`: `send_yukassa_invoice`
        - `stars`: `send_stars_invoice`
        - `robocassa`: `send_robocassa_invoice`
    4. Удаляет исходное сообщение с товаром.

    Схема работы функции:
    A (Получение информации о пользователе)
    ↓
    B (Извлечение данных из callback)
    ↓
    C (Выбор метода оплаты)
    ├── yukassa → D1 (Отправка инвойса ЮKassa)
    ├── stars → D2 (Отправка инвойса Stars)
    └── robocassa → D3 (Отправка инвойса Robocassa)
    ↓
    E (Удаление сообщения)

    Примеры:
        Пользователь нажимает кнопку "Купить" под товаром с ID 123 и выбирает оплату через ЮKassa.
        В этом случае будет вызвана функция `send_yukassa_invoice` с соответствующими параметрами.
    """
```

### `send_yukassa_invoice`

```python
async def send_yukassa_invoice(call, user_info, product_id, price):
    """
    Отправляет инвойс (счет) для оплаты через ЮKassa.

    Args:
        call (CallbackQuery): Объект callback-запроса от Telegram.
        user_info: Информация о пользователе из базы данных.
        product_id: ID товара.
        price: Цена товара.

    Returns:
        None

    Как работает функция:
    1. Отправляет инвойс пользователю через `bot.send_invoice`.
    2. Формирует параметры инвойса, такие как заголовок, описание, payload (полезная нагрузка), токен провайдера, валюта и цены.
    3. В payload передается информация о типе платежа, ID пользователя и ID продукта.
    4. Использует `get_product_buy_youkassa` для формирования клавиатуры с кнопкой оплаты.

    Схема работы функции:
    A (Формирование параметров инвойса)
    ↓
    B (Отправка инвойса пользователю)

    Примеры:
        Пример вызова с параметрами: call, user_info, product_id=456, price=100.
        Пользователю будет отправлен инвойс на сумму 100₽ с возможностью оплаты через ЮKassa.
    """
```

### `send_robocassa_invoice`

```python
async def send_robocassa_invoice(call, user_info, product_id, price, session: AsyncSession):
    """
    Отправляет инвойс для оплаты через Robocassa.

    Args:
        call (CallbackQuery): Объект callback-запроса от Telegram.
        user_info: Информация о пользователе из базы данных.
        product_id: ID товара.
        price: Цена товара.
        session (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных.

    Returns:
        None

    Как работает функция:
    1. Получает следующий доступный ID для покупки из базы данных с помощью `PurchaseDao.get_next_id`.
    2. Формирует описание платежа.
    3. Генерирует платежную ссылку с помощью `generate_payment_link`.
    4. Формирует клавиатуру с кнопкой оплаты, используя `get_product_buy_robocassa`.
    5. Отправляет сообщение с текстом и клавиатурой пользователю.

    Схема работы функции:
    A (Получение ID покупки)
    ↓
    B (Формирование описания)
    ↓
    C (Генерация ссылки)
    ↓
    D (Формирование клавиатуры)
    ↓
    E (Отправка сообщения)

    Примеры:
        Пример вызова с параметрами: call, user_info, product_id=789, price=200, session.
        Пользователю будет отправлено сообщение со ссылкой для оплаты 200₽ через Robocassa.
    """
```

### `send_stars_invoice`

```python
async def send_stars_invoice(call, user_info, product_id, stars_price):
    """
    Отправляет инвойс для оплаты через "звезды" (внутренняя валюта).

    Args:
        call (CallbackQuery): Объект callback-запроса от Telegram.
        user_info: Информация о пользователе из базы данных.
        product_id: ID товара.
        stars_price: Цена товара в "звездах".

    Returns:
        None

    Как работает функция:
    1. Отправляет инвойс пользователю через `bot.send_invoice`.
    2. Формирует параметры инвойса, такие как заголовок, описание, payload, токен провайдера (пустой), валюта (XTR) и цены.
    3. В payload передается информация о типе платежа, ID пользователя и ID продукта.
    4. Использует `get_product_buy_stars` для формирования клавиатуры с кнопкой оплаты.

    Схема работы функции:
    A (Формирование параметров инвойса)
    ↓
    B (Отправка инвойса пользователю)

    Примеры:
        Пример вызова с параметрами: call, user_info, product_id=101, stars_price=50.
        Пользователю будет отправлен инвойс на сумму 50 ⭐ с возможностью оплаты "звездами".
    """
```

### `pre_checkout_query`

```python
async def pre_checkout_query(pre_checkout_q: PreCheckoutQuery):
    """
    Обработчик предварительного запроса перед подтверждением оплаты.

    Args:
        pre_checkout_q (PreCheckoutQuery): Объект предварительного запроса от Telegram.

    Returns:
        None

    Как работает функция:
    1. Отвечает на предварительный запрос с подтверждением (`ok=True`).

    Схема работы функции:
    A (Ответ на предварительный запрос)

    Примеры:
        Любой предварительный запрос будет подтвержден.
    """
```

### `successful_payment`

```python
async def successful_payment(message: Message, session_with_commit: AsyncSession):
    """
    Обработчик события успешной оплаты.

    Args:
        message (Message): Объект сообщения от Telegram.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных с коммитом.

    Returns:
        None

    Как работает функция:
    1. Извлекает информацию о платеже из сообщения.
    2. Определяет тип платежа, ID пользователя и ID продукта из payload инвойса.
    3. Определяет цену и валюту платежа в зависимости от типа платежа.
    4. Формирует словарь с данными о платеже.
    5. Вызывает функцию `successful_payment_logic` для обработки логики успешной оплаты.

    Схема работы функции:
    A (Извлечение информации о платеже)
    ↓
    B (Определение данных платежа)
    ↓
    C (Вызов логики успешной оплаты)

    Примеры:
        Пользователь успешно оплатил товар через ЮKassa.
        В этом случае будет вызвана функция `successful_payment_logic` с информацией о платеже.
    """