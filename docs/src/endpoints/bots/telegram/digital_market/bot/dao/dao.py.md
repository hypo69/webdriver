# Модуль для работы с DAO (Data Access Objects) для взаимодействия с базой данных.
=========================================================================================

Модуль содержит классы DAO для работы с моделями `User`, `Purchase`, `Category` и `Product`.
Он предоставляет методы для получения статистики, информации о покупках и других данных из базы данных.

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [UserDAO](#userdao)
        - [get_purchase_statistics](#get_purchase_statistics)
        - [get_purchased_products](#get_purchased_products)
        - [get_statistics](#get_statistics)
    - [PurchaseDao](#purchasedao)
        - [get_payment_stats](#get_payment_stats)
        - [get_full_summ](#get_full_summ)
        - [get_next_id](#get_next_id)
    - [CategoryDao](#categorydao)
    - [ProductDao](#productdao)

## Обзор

Модуль предоставляет классы DAO (Data Access Objects) для упрощения взаимодействия с базой данных.
Каждый класс DAO отвечает за работу с определенной моделью базы данных и предоставляет методы для выполнения операций CRUD (Create, Read, Update, Delete) и других запросов.

## Подробнее

Этот модуль является частью системы для работы с базой данных и предоставляет удобный интерфейс для выполнения запросов к базе данных.
Он использует SQLAlchemy для взаимодействия с базой данных и предоставляет асинхронные методы для выполнения запросов.
Модуль содержит классы DAO для работы с пользователями, покупками, категориями и продуктами.

## Классы

### `UserDAO`

**Описание**: Класс DAO для работы с моделью `User`.
Предоставляет методы для получения статистики о покупках пользователя, информации о купленных продуктах и общей статистики по пользователям.

**Наследует**:

- `BaseDAO[User]`: Базовый класс DAO, предоставляющий общие методы для работы с моделями базы данных.

**Методы**:

- `get_purchase_statistics`: Получает статистику о покупках пользователя.
- `get_purchased_products`: Получает информацию о купленных продуктах пользователя.
- `get_statistics`: Получает общую статистику по пользователям.

#### `get_purchase_statistics`

```python
@classmethod
async def get_purchase_statistics(cls, session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]:
    """
    Args:
        session (AsyncSession): Асинхронная сессия базы данных.
        telegram_id (int): Telegram ID пользователя.

    Returns:
        Optional[Dict[str, int]]: Словарь со статистикой покупок пользователя или `None` в случае ошибки.
            Словарь содержит ключи:
                - 'total_purchases': Общее число покупок пользователя.
                - 'total_amount': Общая сумма покупок пользователя.
    """
```

**Назначение**: Получает статистику о покупках пользователя, включая общее число покупок и общую сумму покупок.

**Параметры**:

- `session` (AsyncSession): Асинхронная сессия базы данных.
- `telegram_id` (int): Telegram ID пользователя.

**Возвращает**:

- `Optional[Dict[str, int]]`: Словарь со статистикой покупок пользователя или `None` в случае ошибки.
  Словарь содержит ключи:
    - `'total_purchases'`: Общее число покупок пользователя.
    - `'total_amount'`: Общая сумма покупок пользователя.

**Вызывает исключения**:

- `SQLAlchemyError`: Если возникает ошибка при работе с базой данных.

**Как работает функция**:

1.  Формирует запрос к базе данных для получения общего числа покупок и общей суммы покупок для заданного пользователя.
2.  Выполняет запрос с использованием асинхронной сессии базы данных.
3.  Обрабатывает результат запроса, возвращая словарь со статистикой покупок пользователя.
4.  В случае ошибки при работе с базой данных, логирует ошибку и возвращает `None`.

```
    Начало
     ↓
    Запрос к БД (общее число покупок, общая сумма)
     ↓
    Обработка результата запроса
     ↓
    Возврат словаря со статистикой
     ↓
    Конец
```

**Примеры**:

```python
# Пример вызова функции
statistics = await UserDAO.get_purchase_statistics(session, telegram_id=123456789)
if statistics:
    print(f"Общее число покупок: {statistics['total_purchases']}")
    print(f"Общая сумма покупок: {statistics['total_amount']}")
else:
    print("Не удалось получить статистику покупок пользователя.")
```

#### `get_purchased_products`

```python
@classmethod
async def get_purchased_products(cls, session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]:
    """
    Args:
        session (AsyncSession): Асинхронная сессия базы данных.
        telegram_id (int): Telegram ID пользователя.

    Returns:
        Optional[List[Purchase]]: Список покупок пользователя или `None` в случае ошибки.
    """
```

**Назначение**: Получает информацию о купленных продуктах пользователя.

**Параметры**:

- `session` (AsyncSession): Асинхронная сессия базы данных.
- `telegram_id` (int): Telegram ID пользователя.

**Возвращает**:

- `Optional[List[Purchase]]`: Список покупок пользователя или `None` в случае ошибки.

**Вызывает исключения**:

- `SQLAlchemyError`: Если возникает ошибка при работе с базой данных.

**Как работает функция**:

1.  Формирует запрос к базе данных для получения пользователя с его покупками и связанными продуктами.
2.  Выполняет запрос с использованием асинхронной сессии базы данных.
3.  Обрабатывает результат запроса, возвращая список покупок пользователя.
4.  В случае ошибки при работе с базой данных, логирует ошибку и возвращает `None`.

```
    Начало
     ↓
    Запрос к БД (пользователь, покупки, продукты)
     ↓
    Обработка результата запроса
     ↓
    Возврат списка покупок
     ↓
    Конец
```

**Примеры**:

```python
# Пример вызова функции
purchases = await UserDAO.get_purchased_products(session, telegram_id=123456789)
if purchases:
    for purchase in purchases:
        print(f"Продукт: {purchase.product.name}, Цена: {purchase.price}")
else:
    print("Не удалось получить информацию о покупках пользователя.")
```

#### `get_statistics`

```python
    @classmethod
    async def get_statistics(cls, session: AsyncSession):
        """
        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            dict: Словарь со статистикой пользователей.

        Raises:
            SQLAlchemyError: Если возникает ошибка при получении статистики.

        """
```

**Назначение**: Получает общую статистику по пользователям, включая общее количество пользователей, количество новых пользователей за сегодня, за неделю и за месяц.

**Параметры**:

- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:

- `dict`: Словарь со статистикой пользователей.
  Словарь содержит ключи:
    - `'total_users'`: Общее количество пользователей.
    - `'new_today'`: Количество новых пользователей за сегодня.
    - `'new_week'`: Количество новых пользователей за неделю.
    - `'new_month'`: Количество новых пользователей за месяц.

**Вызывает исключения**:

- `SQLAlchemyError`: Если возникает ошибка при получении статистики.

**Как работает функция**:

1.  Формирует запрос к базе данных для получения общей статистики по пользователям.
2.  Выполняет запрос с использованием асинхронной сессии базы данных.
3.  Обрабатывает результат запроса, возвращая словарь со статистикой пользователей.
4.  В случае ошибки при работе с базой данных, логирует ошибку и пробрасывает исключение.

```
    Начало
     ↓
    Определение текущей даты и времени
     ↓
    Запрос к БД (статистика пользователей)
     ↓
    Обработка результата запроса
     ↓
    Возврат словаря со статистикой
     ↓
    Конец
```

**Примеры**:

```python
# Пример вызова функции
statistics = await UserDAO.get_statistics(session)
print(f"Общее количество пользователей: {statistics['total_users']}")
print(f"Новых пользователей за сегодня: {statistics['new_today']}")
print(f"Новых пользователей за неделю: {statistics['new_week']}")
print(f"Новых пользователей за месяц: {statistics['new_month']}")
```

### `PurchaseDao`

**Описание**: Класс DAO для работы с моделью `Purchase`.
Предоставляет методы для получения статистики по типам оплат, общей суммы покупок и следующего свободного ID для новой записи.

**Наследует**:

- `BaseDAO[Purchase]`: Базовый класс DAO, предоставляющий общие методы для работы с моделями базы данных.

**Методы**:

- `get_payment_stats`: Получает статистику по типам оплат.
- `get_full_summ`: Получает общую сумму покупок.
- `get_next_id`: Получает следующий свободный ID для новой записи.

#### `get_payment_stats`

```python
    @classmethod
    async def get_payment_stats(cls, session: AsyncSession) -> str:
        """

        Args:
            session (AsyncSession):  Асинхронная сессия базы данных

        Returns:
            str: Статистика по типам оплат

        """
```

**Назначение**: Получает статистику по типам оплат, включая суммы оплат через Юкассу, Робокассу и STARS.

**Параметры**:

- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:

- `str`: Строка со статистикой по типам оплат.

**Вызывает исключения**:

- Отсутствуют явные обработки исключений.

**Как работает функция**:

1.  Формирует запрос к базе данных для получения статистики по типам оплат.
2.  Выполняет запрос с использованием асинхронной сессии базы данных.
3.  Обрабатывает результат запроса, формируя словарь со статистикой по типам оплат.
4.  Форматирует результат в виде строки и возвращает его.

```
    Начало
     ↓
    Запрос к БД (статистика по типам оплат)
     ↓
    Обработка результата запроса
     ↓
    Форматирование результата в строку
     ↓
    Возврат строки со статистикой
     ↓
    Конец
```

**Примеры**:

```python
# Пример вызова функции
payment_stats = await PurchaseDao.get_payment_stats(session)
print(payment_stats)
```

#### `get_full_summ`

```python
    @classmethod
    async def get_full_summ(cls, session: AsyncSession) -> int:
        """

        Args:
            session (AsyncSession):  Асинхронная сессия базы данных

        Returns:
            int: Общая сумма покупок

        """
```

**Назначение**: Получает общую сумму всех покупок.

**Параметры**:

- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:

- `int`: Общая сумма покупок.

**Вызывает исключения**:

- Отсутствуют явные обработки исключений.

**Как работает функция**:

1.  Формирует запрос к базе данных для получения общей суммы всех покупок.
2.  Выполняет запрос с использованием асинхронной сессии базы данных.
3.  Обрабатывает результат запроса, возвращая общую сумму покупок.

```
    Начало
     ↓
    Запрос к БД (общая сумма покупок)
     ↓
    Обработка результата запроса
     ↓
    Возврат общей суммы покупок
     ↓
    Конец
```

**Примеры**:

```python
# Пример вызова функции
total_sum = await PurchaseDao.get_full_summ(session)
print(f"Общая сумма покупок: {total_sum}")
```

#### `get_next_id`

```python
    @classmethod
    async def get_next_id(cls, session: AsyncSession) -> int:
        """
        Возвращает следующий свободный ID для новой записи.

        :param session: Асинхронная сессия базы данных
        :return: Следующий свободный ID
        """
```

**Назначение**: Возвращает следующий свободный ID для новой записи в таблице покупок.

**Параметры**:

- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:

- `int`: Следующий свободный ID.

**Вызывает исключения**:

- Отсутствуют явные обработки исключений.

**Как работает функция**:

1.  Формирует запрос к базе данных для получения максимального ID в таблице покупок и прибавляет к нему 1. Если таблица пуста, возвращает 1.
2.  Выполняет запрос с использованием асинхронной сессии базы данных.
3.  Обрабатывает результат запроса, возвращая следующий свободный ID.

```
    Начало
     ↓
    Запрос к БД (максимальный ID + 1 или 1)
     ↓
    Обработка результата запроса
     ↓
    Возврат следующего свободного ID
     ↓
    Конец
```

**Примеры**:

```python
# Пример вызова функции
next_id = await PurchaseDao.get_next_id(session)
print(f"Следующий свободный ID: {next_id}")
```

### `CategoryDao`

**Описание**: Класс DAO для работы с моделью `Category`.
Предоставляет базовые методы для работы с категориями.

**Наследует**:

- `BaseDAO[Category]`: Базовый класс DAO, предоставляющий общие методы для работы с моделями базы данных.

### `ProductDao`

**Описание**: Класс DAO для работы с моделью `Product`.
Предоставляет базовые методы для работы с продуктами.

**Наследует**:

- `BaseDAO[Product]`: Базовый класс DAO, предоставляющий общие методы для работы с моделями базы данных.