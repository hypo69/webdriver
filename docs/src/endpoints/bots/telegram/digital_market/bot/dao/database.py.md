# Модуль для работы с базой данных
=======================================

Модуль содержит базовый класс `Base` для моделей SQLAlchemy, настройки для асинхронной работы с базой данных, включая создание движка и сессии.

## Обзор

Модуль `database.py` предназначен для настройки и управления взаимодействием с базой данных в асинхронном режиме. Он определяет базовый класс `Base` для всех моделей базы данных, а также предоставляет инструменты для создания асинхронного движка и сессии для работы с базой данных. Это упрощает определение структуры таблиц базы данных и обеспечивает удобный интерфейс для выполнения операций CRUD (Create, Read, Update, Delete).

## Подробнее

Этот модуль играет ключевую роль в обеспечении доступа к базе данных и управлении ею в проекте `hypotez`. Он абстрагирует детали реализации SQLAlchemy, предоставляя простой и удобный интерфейс для работы с базой данных. Использование асинхронного движка и сессий позволяет эффективно обрабатывать запросы к базе данных, не блокируя основной поток выполнения программы.

## Классы

### `Base`

**Описание**: Базовый класс для моделей SQLAlchemy, который предоставляет общие атрибуты, такие как `id`, `created_at` и `updated_at`, а также методы для преобразования объектов в словари.

**Принцип работы**:
1.  Определяет абстрактный класс `Base`, который наследуется от `AsyncAttrs` и `DeclarativeBase` из SQLAlchemy.
2.  Устанавливает атрибут `__abstract__ = True`, чтобы избежать создания отдельной таблицы для базового класса.
3.  Определяет общие столбцы `id` (первичный ключ, автоинкремент), `created_at` (время создания записи) и `updated_at` (время последнего обновления записи).
4.  Предоставляет метод `to_dict` для преобразования объекта модели в словарь.

**Атрибуты**:
-   `id` (int): Первичный ключ, автоматически увеличивающееся целое число.
-   `created_at` (datetime): Дата и время создания записи, устанавливается автоматически при создании.
-   `updated_at` (datetime): Дата и время последнего обновления записи, обновляется автоматически при каждом изменении.

**Методы**:
-   `to_dict()`: Преобразует объект модели в словарь, где ключами являются названия столбцов, а значениями - значения соответствующих атрибутов.
-   `__tablename__()`: Возвращает имя таблицы в нижнем регистре с добавлением суффикса 's'.

## Функции

### `__tablename__`

```python
    @classmethod
    @property
    def __tablename__(cls) -> str:
        return cls.__name__.lower() + 's'
```

**Назначение**: Динамически определяет имя таблицы в базе данных на основе имени класса модели, приводя его к нижнему регистру и добавляя суффикс "s".

**Параметры**:
-   `cls` (class): Ссылка на класс, для которого определяется имя таблицы.

**Возвращает**:
-   `str`: Имя таблицы в нижнем регистре с добавлением суффикса "s".

**Как работает функция**:

1.  Получает имя класса (`cls.__name__`).
2.  Приводит имя класса к нижнему регистру (`.lower()`).
3.  Добавляет суффикс "s" к имени класса.
4.  Возвращает полученное имя таблицы.

```
Получить имя класса -> Привести к нижнему регистру -> Добавить суффикс "s" -> Вернуть имя таблицы
```

**Примеры**:

```python
class User(Base):
    pass

print(User.__tablename__)  # Вывод: users

class Product(Base):
    pass

print(Product.__tablename__)  # Вывод: products
```

### `to_dict`

```python
    def to_dict(self) -> dict:
        # Метод для преобразования объекта в словарь
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}
```

**Назначение**: Преобразует объект модели в словарь, где ключами являются имена столбцов, а значениями - соответствующие значения атрибутов.

**Параметры**:
-   `self` (object): Объект модели, который нужно преобразовать в словарь.

**Возвращает**:
-   `dict`: Словарь, представляющий объект модели.

**Как работает функция**:

1.  Получает список столбцов таблицы (`self.__table__.columns`).
2.  Проходит по каждому столбцу в списке.
3.  Для каждого столбца получает имя столбца (`c.name`) и значение соответствующего атрибута объекта (`getattr(self, c.name)`).
4.  Формирует словарь, где ключами являются имена столбцов, а значениями - значения атрибутов.
5.  Возвращает полученный словарь.

```
Получить список столбцов -> Пройти по каждому столбцу -> Получить имя столбца и значение атрибута -> Сформировать словарь -> Вернуть словарь
```

**Примеры**:

```python
from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String)
    age = Column(Integer)

    def __repr__(self):
        return f"<User(name='{self.name}', age={self.age})>"

    def to_dict(self):
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}

# Пример использования
user = User(name='John', age=30)
user_dict = user.to_dict()
print(user_dict)