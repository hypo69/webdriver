# Модуль ToolBox_requests.py

## Обзор

Модуль `ToolBox_requests.py` содержит класс `ToolBox`, который предоставляет набор функций для взаимодействия с Telegram ботом. Класс включает в себя обработку текстовых и графических запросов, управление тарифами и выполнение различных команд через нейронные сети.

## Подробней

Этот модуль является ключевым компонентом Telegram-бота, отвечающим за обработку пользовательских запросов и взаимодействие с различными сервисами, включая нейронные сети для генерации текста и изображений. Он использует библиотеку `telebot` для управления ботом и предоставляет интерфейс для выполнения различных задач, таких как создание текстов различных типов, генерация изображений и управление тарифами.

## Классы

### `ToolBox`

**Описание**:
Класс `ToolBox` предназначен для управления Telegram ботом и обработки запросов пользователей. Он включает в себя методы для работы с текстом, изображениями, тарифами и свободным режимом.

**Наследует**:
- `keyboards`: Предоставляет методы для создания различных типов клавиатур.
- `neural_networks`: Предоставляет методы для взаимодействия с нейронными сетями.

**Аттрибуты**:
- `name` (list[str]): Список названий кнопок главного меню.
- `data` (list[str]): Список данных, связанных с кнопками главного меню.
- `prompts_text` (dict): Словарь, содержащий текстовые подсказки и сообщения для бота.
- `bot` (telebot.TeleBot): Экземпляр Telegram бота.
- `keyboard_blank` (function): Лямбда-функция для создания встроенных клавиатур.
- `reply_keyboard` (function): Лямбда-функция для создания клавиатур с ответами.
- `__delay` (function): Лямбда-функция для отправки сообщения о задержке.
- `start_request` (function): Лямбда-функция для отправки стартового сообщения.
- `restart` (function): Лямбда-функция для отправки сообщения о перезапуске.
- `restart_markup` (function): Лямбда-функция для редактирования сообщения о перезапуске.
- `OneTextArea` (function): Лямбда-функция для отправки текстового запроса.
- `SomeTextsArea` (function): Лямбда-функция для отправки запроса на несколько текстов.
- `ImageSize` (function): Лямбда-функция для выбора размера изображения.
- `ImageArea` (function): Лямбда-функция для отправки запроса на создание изображения.
- `ImageChange` (function): Лямбда-функция для выбора действия с изображением.
- `BeforeUpscale` (function): Лямбда-функция для выбора действия перед увеличением изображения.
- `FreeArea` (function): Лямбда-функция для отправки запроса в свободном режиме.
- `TariffArea` (function): Лямбда-функция для отображения информации о тарифах.
- `TariffExit` (function): Лямбда-функция для выхода из меню тарифов.
- `TarrifEnd` (function): Лямбда-функция для отправки сообщения об окончании тарифа.
- `FreeTariffEnd` (function): Лямбда-функция для отправки сообщения об окончании бесплатного тарифа.
- `SomeTexts` (function): Лямбда-функция для выбора количества текстов.

**Методы**:
- `__gpt_4o_mini(prompt: list[dict], message) -> tuple[dict[str, str], int, int]`: Приватный метод для обработки запросов с использованием GPT-4o mini.
- `__FLUX_schnell(prompt: str, size: list[int], message, seed: int, num_inference_steps: int) -> None`: Приватный метод для генерации изображений с использованием FLUX schnell.
- `Text_types(message)`: Метод для выбора типа текста.
- `Basic_tariff(message)`: Метод для отображения информации о базовом тарифе.
- `Pro_tariff(message)`: Метод для отображения информации о профессиональном тарифе.
- `TextCommands(message, ind: int)`: Метод для обработки текстовых команд.
- `SomeTextsCommand(message, ind: int, tokens: dict[str, int])`: Метод для обработки запросов на несколько текстов.
- `ImageCommand(message, prompt: str, size: list[int])`: Метод для обработки запросов на создание изображений.
- `Image_Regen_And_Upscale(message, prompt: str, size: list[int], seed, num_inference_steps=4)`: Метод для регенерации и увеличения изображений.
- `FreeCommand(message, prompts: list[str])`: Метод для обработки запросов в свободном режиме.

## Функции

### `__init__`

```python
def __init__(self):
    """
    Инициализирует класс ToolBox, настраивает кнопки старта, загружает текстовые подсказки,
    инициализирует Telegram бот, а также определяет лямбда-функции для различных запросов и действий.

    Args:
        self: Экземпляр класса ToolBox.

    Returns:
        None

    Raises:
        OSError: Если не удается получить доступ к переменной окружения 'TOKEN'.
        json.JSONDecodeError: Если файл 'ToolBox/BaseSettings/prompts.json' не содержит валидный JSON.

    Принцип работы:
    1. Инициализирует атрибуты `name` и `data` для кнопок главного меню.
    2. Загружает текстовые подсказки из файла `prompts.json`.
    3. Инициализирует Telegram бот с использованием токена из переменной окружения `TOKEN`.
    4. Определяет лямбда-функции для различных действий, таких как отправка сообщений, редактирование сообщений и отображение клавиатур.

    """
```

**Как работает функция**:

1.  **Инициализация атрибутов**: Устанавливает основные атрибуты класса, такие как названия кнопок и соответствующие им данные.
2.  **Загрузка текстовых подсказок**: Загружает текстовые подсказки и сообщения из JSON-файла.
3.  **Инициализация Telegram бота**: Создает экземпляр Telegram бота с использованием токена, хранящегося в переменной окружения.
4.  **Определение лямбда-функций**: Определяет лямбда-функции для упрощения отправки и редактирования сообщений, а также для отображения различных клавиатур.

```
   Инициализация атрибутов (name, data)
   │
   ├── Загрузка текстовых подсказок (prompts_text)
   │
   ├── Инициализация Telegram бота (bot)
   │
   └── Определение лямбда-функций (keyboard_blank, reply_keyboard, и т.д.)
```

**Примеры**:

```python
# Пример инициализации класса ToolBox
toolbox = ToolBox()
```

### `__gpt_4o_mini`

```python
def __gpt_4o_mini(self, prompt: list[dict], message) -> tuple[dict[str, str], int, int]:
    """
    Отправляет запрос в GPT-4o mini и возвращает ответ, а также количество входящих и исходящих токенов.

    Args:
        prompt (list[dict]): Список словарей, содержащих запросы для GPT-4o mini.
        message: Объект сообщения Telegram.

    Returns:
        tuple[dict[str, str], int, int]: Кортеж, содержащий ответ от GPT-4o mini, количество входящих токенов и количество исходящих токенов.

    Raises:
        Exception: Если возникает ошибка при обработке запроса.

    """
```

**Как работает функция**:

1.  **Отправка сообщения о задержке**: Отправляет пользователю сообщение о том, что выполнение запроса может занять некоторое время.
2.  **Вызов GPT-4o mini**: Вызывает метод `_free_gpt_4o_mini` для отправки запроса в GPT-4o mini.
3.  **Редактирование сообщения с ответом**: Редактирует сообщение о задержке, заменяя его ответом от GPT-4o mini.
4.  **Возврат результата**: Возвращает ответ, количество входящих и исходящих токенов.

```
   Отправка сообщения о задержке
   │
   ├── Вызов GPT-4o mini (_free_gpt_4o_mini)
   │
   └── Редактирование сообщения с ответом
   │
   └── Возврат результата (response, incoming_tokens, outgoing_tokens)
```

**Примеры**:

```python
# Пример вызова функции __gpt_4o_mini
toolbox = ToolBox()
prompt = [{"role": "user", "content": "Напиши короткое приветствие"}]
message = ...  # Объект сообщения Telegram
response, incoming_tokens, outgoing_tokens = toolbox.__gpt_4o_mini(prompt, message)
print(response['content'])
```

### `__FLUX_schnell`

```python
def __FLUX_schnell(self, prompt: str, size: list[int], message, seed: int, num_inference_steps: int)-> None:
    """
    Генерирует изображение с использованием FLUX schnell и отправляет его пользователю.

    Args:
        prompt (str): Текстовое описание изображения для генерации.
        size (list[int]): Список, содержащий ширину и высоту изображения.
        message: Объект сообщения Telegram.
        seed (int): Зерно для генерации случайных чисел.
        num_inference_steps (int): Количество шагов для генерации изображения.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при генерации изображения.

    """
```

**Как работает функция**:

1.  **Отправка сообщения о задержке**: Отправляет пользователю сообщение о том, что выполнение запроса может занять некоторое время.
2.  **Генерация изображения**: Вызывает метод `_FLUX_schnell` для генерации изображения.
3.  **Отправка изображения**: Отправляет сгенерированное изображение пользователю.
4.  **Удаление сообщения о задержке**: Удаляет сообщение о задержке.
5.  **Обработка ошибок**: Если возникает ошибка при генерации изображения, отправляет пользователю сообщение об ошибке.

```
   Отправка сообщения о задержке
   │
   ├── Генерация изображения (_FLUX_schnell)
   │
   ├── Отправка изображения
   │
   ├── Удаление сообщения о задержке
   │
   └── Обработка ошибок
```

**Примеры**:

```python
# Пример вызова функции __FLUX_schnell
toolbox = ToolBox()
prompt = "Собака в космосе"
size = [1024, 1024]
message = ...  # Объект сообщения Telegram
seed = 12345
num_inference_steps = 4
toolbox.__FLUX_schnell(prompt, size, message, seed, num_inference_steps)
```

### `Text_types`

```python
def Text_types(self, message):
    """
    Отправляет пользователю сообщение с вариантами типов текстов для выбора.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при отправке сообщения.

    """
```

**Как работает функция**:

1.  **Определение типов текста**: Определяет список названий и данных для различных типов текстов.
2.  **Отправка сообщения с вариантами**: Отправляет пользователю сообщение с вариантами типов текстов для выбора, используя встроенную клавиатуру.

```
   Определение типов текста
   │
   └── Отправка сообщения с вариантами
```

**Примеры**:

```python
# Пример вызова функции Text_types
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
toolbox.Text_types(message)
```

### `Basic_tariff`

```python
def Basic_tariff(self, message):
    """
    Отправляет пользователю информацию о базовом тарифе и предлагает подключить его.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при отправке сообщения.

    """
```

**Как работает функция**:

1.  **Создание клавиатуры**: Создает встроенную клавиатуру с кнопками для подключения тарифа и выхода в меню тарифов.
2.  **Определение цены**: Определяет цену базового тарифа.
3.  **Удаление предыдущего сообщения**: Удаляет предыдущее сообщение пользователя.
4.  **Отправка инвойса**: Отправляет пользователю инвойс с информацией о базовом тарифе.

```
   Создание клавиатуры
   │
   ├── Определение цены
   │
   ├── Удаление предыдущего сообщения
   │
   └── Отправка инвойса
```

**Примеры**:

```python
# Пример вызова функции Basic_tariff
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
toolbox.Basic_tariff(message)
```

### `Pro_tariff`

```python
def Pro_tariff(self, message):
    """
    Отправляет пользователю информацию о профессиональном тарифе и предлагает подключить его.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при отправке сообщения.

    """
```

**Как работает функция**:

1.  **Создание клавиатуры**: Создает встроенную клавиатуру с кнопками для подключения тарифа и выхода в меню тарифов.
2.  **Определение цены**: Определяет цену профессионального тарифа.
3.  **Удаление предыдущего сообщения**: Удаляет предыдущее сообщение пользователя.
4.  **Отправка инвойса**: Отправляет пользователю инвойс с информацией о профессиональном тарифе.

```
   Создание клавиатуры
   │
   ├── Определение цены
   │
   ├── Удаление предыдущего сообщения
   │
   └── Отправка инвойса
```

**Примеры**:

```python
# Пример вызова функции Pro_tariff
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
toolbox.Pro_tariff(message)
```

### `TextCommands`

```python
def TextCommands(self, message, ind: int):
    """
    Обрабатывает текстовые команды в зависимости от индекса и запрашивает дополнительную информацию, если необходимо.

    Args:
        message: Объект сообщения Telegram.
        ind (int): Индекс команды.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и 1.

    Raises:
        Exception: Если возникает ошибка при обработке команды.

    """
```

**Как работает функция**:

1.  **Проверка наличия TEXT в commands_size**: Проверяет, содержит ли `pc.commands_size[ind]` значение "TEXT".
2.  **Если TEXT присутствует**:
    - Добавляет текст сообщения в список `info`.
    - Отправляет пользователю запрос на ввод дополнительной информации.
    - Регистрирует следующий шаг для получения дополнительной информации.
    - Формирует запрос на основе полученной информации.
    - Отправляет запрос в GPT-4o mini.
    - Перезапускает бота.
    - Возвращает количество входящих и исходящих токенов и 1.
3.  **Если TEXT отсутствует**:
    - Разделяет текст сообщения на части и добавляет их в список `info`.
    - Формирует запрос на основе полученной информации.
    - Отправляет запрос в GPT-4o mini.
    - Перезапускает бота.
    - Возвращает количество входящих и исходящих токенов и 1.

```
   Проверка наличия TEXT в commands_size
   │
   ├── Если TEXT присутствует:
   │   ├── Добавление текста сообщения в список info
   │   ├── Отправка запроса на ввод дополнительной информации
   │   ├── Регистрация следующего шага для получения дополнительной информации
   │   ├── Формирование запроса на основе полученной информации
   │   ├── Отправка запроса в GPT-4o mini
   │   ├── Перезапуск бота
   │   └── Возврат результата
   │
   └── Если TEXT отсутствует:
       ├── Разделение текста сообщения на части и добавление их в список info
       ├── Формирование запроса на основе полученной информации
       ├── Отправка запроса в GPT-4o mini
       ├── Перезапуск бота
       └── Возврат результата
```

**Примеры**:

```python
# Пример вызова функции TextCommands
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
ind = 0
incoming_tokens, outgoing_tokens, _ = toolbox.TextCommands(message, ind)
print(f"Входящие токены: {incoming_tokens}, Исходящие токены: {outgoing_tokens}")
```

### `SomeTextsCommand`

```python
def SomeTextsCommand(self, message, ind: int, tokens: dict[str, int]):
    """
    Обрабатывает команды для генерации нескольких текстов на основе введенных пользователем данных.

    Args:
        message: Объект сообщения Telegram.
        ind (int): Индекс команды.
        tokens (dict[str, int]): Словарь с информацией о доступных токенах.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и количество сгенерированных текстов.

    Raises:
        Exception: Если возникает ошибка при обработке команды.

    """
```

**Как работает функция**:

1.  **Получение количества текстов**: Получает от пользователя количество текстов, которые необходимо сгенерировать.
2.  **Запрос текста источника**: Если в `pc.commands_size[ind]` содержится "TEXT", запрашивает у пользователя текст источника для каждого текста.
3.  **Запрос дополнительных параметров**: Запрашивает у пользователя дополнительные параметры для каждого текста.
4.  **Формирование запросов**: Формирует запросы для каждого текста на основе полученной информации.
5.  **Отправка запросов в GPT-4o mini**: Отправляет запросы в GPT-4o mini параллельно, используя `ThreadPoolExecutor`.
6.  **Суммирование токенов**: Суммирует количество входящих и исходящих токенов для всех запросов.
7.  **Перезапуск бота**: Перезапускает бота.
8.  **Возврат результата**: Возвращает количество входящих токенов, количество исходящих токенов и количество сгенерированных текстов.

```
   Получение количества текстов
   │
   ├── Запрос текста источника (если необходимо)
   │
   ├── Запрос дополнительных параметров
   │
   ├── Формирование запросов
   │
   ├── Отправка запросов в GPT-4o mini (параллельно)
   │
   ├── Суммирование токенов
   │
   ├── Перезапуск бота
   │
   └── Возврат результата
```

**Примеры**:

```python
# Пример вызова функции SomeTextsCommand
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
ind = 0
tokens = {"incoming_tokens": 1000, "outgoing_tokens": 1000, "free_requests": 10}
incoming_tokens, outgoing_tokens, n = toolbox.SomeTextsCommand(message, ind, tokens)
print(f"Сгенерировано текстов: {n}, Входящие токены: {incoming_tokens}, Исходящие токены: {outgoing_tokens}")
```

### `ImageCommand`

```python
def ImageCommand(self, message, prompt: str, size: list[int]):
    """
    Обрабатывает команду для генерации изображения на основе заданного описания и размера.

    Args:
        message: Объект сообщения Telegram.
        prompt (str): Текстовое описание изображения для генерации.
        size (list[int]): Список, содержащий ширину и высоту изображения.

    Returns:
        int: Зерно для генерации случайных чисел.

    Raises:
        Exception: Если возникает ошибка при обработке команды.

    """
```

**Как работает функция**:

1.  **Генерация случайного зерна**: Генерирует случайное зерно для генерации изображения.
2.  **Вызов __FLUX_schnell**: Вызывает метод `__FLUX_schnell` для генерации изображения.
3.  **Вызов ImageChange**: Вызывает метод `ImageChange` для отображения вариантов действий с изображением.
4.  **Возврат зерна**: Возвращает зерно, использованное для генерации изображения.

```
   Генерация случайного зерна
   │
   ├── Вызов __FLUX_schnell
   │
   ├── Вызов ImageChange
   │
   └── Возврат зерна
```

**Примеры**:

```python
# Пример вызова функции ImageCommand
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
prompt = "Собака в космосе"
size = [1024, 1024]
seed = toolbox.ImageCommand(message, prompt, size)
print(f"Зерно для генерации: {seed}")
```

### `Image_Regen_And_Upscale`

```python
def Image_Regen_And_Upscale(self, message, prompt: str, size: list[int], seed, num_inference_steps=4):
    """
    Регенерирует или увеличивает изображение на основе заданных параметров.

    Args:
        message: Объект сообщения Telegram.
        prompt (str): Текстовое описание изображения для генерации.
        size (list[int]): Список, содержащий ширину и высоту изображения.
        seed (int): Зерно для генерации случайных чисел.
        num_inference_steps (int, optional): Количество шагов для генерации изображения. По умолчанию 4.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при обработке команды.

    """
```

**Как работает функция**:

1.  **Вызов __FLUX_schnell**: Вызывает метод `__FLUX_schnell` для регенерации или увеличения изображения.

```
   Вызов __FLUX_schnell
   │
   └── (Функция __FLUX_schnell выполняет генерацию и отправку изображения)
```

**Примеры**:

```python
# Пример вызова функции Image_Regen_And_Upscale
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
prompt = "Собака в космосе"
size = [1024, 1024]
seed = 12345
toolbox.Image_Regen_And_Upscale(message, prompt, size, seed)
```

### `FreeCommand`

```python
def FreeCommand(self, message, prompts: list[str]):
    """
    Обрабатывает команду для свободного режима, отправляя запрос в GPT-4o mini и возвращая обновленный список подсказок.

    Args:
        message: Объект сообщения Telegram.
        prompts (list[str]): Список подсказок для GPT-4o mini.

    Returns:
        tuple[int, int, list[str]]: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и обновленный список подсказок.

    Raises:
        Exception: Если возникает ошибка при обработке команды.

    """
```

**Как работает функция**:

1.  **Добавление сообщения пользователя в prompts**: Добавляет сообщение пользователя в список `prompts`.
2.  **Отправка запроса в GPT-4o mini**: Отправляет запрос в GPT-4o mini.
3.  **Добавление ответа в prompts**: Добавляет ответ от GPT-4o mini в список `prompts`.
4.  **Возврат результата**: Возвращает количество входящих токенов, количество исходящих токенов и обновленный список подсказок.

```
   Добавление сообщения пользователя в prompts
   │
   ├── Отправка запроса в GPT-4o mini
   │
   ├── Добавление ответа в prompts
   │
   └── Возврат результата
```

**Примеры**:

```python
# Пример вызова функции FreeCommand
toolbox = ToolBox()
message = ...  # Объект сообщения Telegram
prompts = []
incoming_tokens, outgoing_tokens, prompts = toolbox.FreeCommand(message, prompts)
print(f"Входящие токены: {incoming_tokens}, Исходящие токены: {outgoing_tokens}, Подсказки: {prompts}")