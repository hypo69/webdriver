# Модуль для работы с сервисом Mega.nz

## Обзор

Модуль `mega.py` предоставляет класс `Mega` для взаимодействия с сервисом Mega.nz. Он включает в себя функциональность для входа в систему, получения списка файлов, скачивания и загрузки файлов. Модуль использует различные криптографические методы для обеспечения безопасности данных, передаваемых между клиентом и сервером Mega.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения интеграции с облачным хранилищем Mega.nz. Он позволяет пользователям автоматизировать процессы, связанные с загрузкой и скачиванием файлов, а также управлять файлами в своем аккаунте Mega.

## Классы

### `Mega`

**Описание**: Класс для взаимодействия с API сервиса Mega.

**Как работает класс**:
Класс `Mega` предоставляет методы для аутентификации, получения списка файлов, скачивания и загрузки файлов. Он использует криптографические функции для защиты данных и обеспечивает безопасную передачу данных между клиентом и сервером Mega.

**Методы**:
- `__init__`: Инициализирует объект класса `Mega`.
- `from_credentials`: Создает экземпляр класса `Mega` на основе предоставленных учетных данных (email и пароль).
- `from_ephemeral`: Создает экземпляр класса `Mega` для временного (ephemeral) подключения.
- `api_req`: Выполняет API-запрос к серверу Mega.
- `login_user`: Аутентифицирует пользователя с использованием email и пароля.
- `login_ephemeral`: Выполняет временную аутентификацию.
- `_login_common`: Общая логика для завершения процесса аутентификации.
- `get_files`: Получает список файлов и папок из аккаунта Mega.
- `download_from_url`: Скачивает файл по публичной ссылке Mega.
- `download_file`: Скачивает файл из аккаунта Mega.
- `get_public_url`: Генерирует публичную ссылку на файл.
- `uploadfile`: Загружает файл в аккаунт Mega.

#### `__init__`

```python
def __init__(self):
    """
    Инициализирует объект класса Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    """
```

**Описание**: Инициализирует объект класса `Mega`.

**Как работает функция**:
При создании экземпляра класса `Mega`, эта функция инициализирует номер последовательности запросов (`seqno`) случайным числом и устанавливает идентификатор сессии (`sid`) в `None`.

- `self.seqno`: Инициализируется случайным целым числом в диапазоне от 0 до 0xFFFFFFFF.
- `self.sid`: Устанавливается в `None`.

#### `from_credentials`

```python
@classmethod
def from_credentials(cls, email: str, password: str) -> 'Mega':
    """
    Создает экземпляр класса Mega на основе предоставленных учетных данных (email и пароль).

    Args:
        cls (type): Ссылка на класс Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Новый экземпляр класса Mega.

    """
```

**Описание**: Создает экземпляр класса `Mega` на основе предоставленных учетных данных (email и пароль).

**Как работает функция**:
Создает экземпляр класса `Mega` и вызывает метод `login_user` для аутентификации пользователя с предоставленным email и паролем.

- Создается экземпляр класса `Mega`.
- Вызывается метод `login_user` для аутентификации пользователя.
- Возвращается созданный экземпляр класса `Mega`.

#### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls) -> 'Mega':
    """
    Создает экземпляр класса Mega для временного (ephemeral) подключения.

    Args:
        cls (type): Ссылка на класс Mega.

    Returns:
        Mega: Новый экземпляр класса Mega.

    """
```

**Описание**: Создает экземпляр класса `Mega` для временного (ephemeral) подключения.

**Как работает функция**:
Создает экземпляр класса `Mega` и вызывает метод `login_ephemeral` для выполнения временной аутентификации.

- Создается экземпляр класса `Mega`.
- Вызывается метод `login_ephemeral` для временной аутентификации.
- Возвращается созданный экземпляр класса `Mega`.

#### `api_req`

```python
def api_req(self, data: dict) -> dict:
    """
    Выполняет API-запрос к серверу Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        data (dict): Словарь с данными для отправки в запросе.

    Returns:
        dict: Ответ от сервера Mega в виде словаря.

    Raises:
        MegaRequestException: Если сервер возвращает код ошибки.

    """
```

**Описание**: Выполняет API-запрос к серверу Mega.

**Как работает функция**:
Функция отправляет POST-запрос к API Mega с указанными данными и параметрами. Она обрабатывает ответ сервера и возвращает данные в формате JSON.

- Формируются параметры запроса, включающие идентификатор запроса (`id`) и идентификатор сессии (`sid`), если он существует.
- Данные запроса преобразуются в формат JSON.
- Отправляется POST-запрос к API Mega.
- Обрабатывается ответ сервера:
  - Если ответ является целым числом, вызывается исключение `MegaRequestException`.
  - Иначе, возвращаются данные ответа в формате JSON.

#### `login_user`

```python
def login_user(self, email: str, password: str) -> None:
    """
    Аутентифицирует пользователя с использованием email и пароля.

    Args:
        self (Mega): Экземпляр класса Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        None

    """
```

**Описание**: Аутентифицирует пользователя с использованием email и пароля.

**Как работает функция**:
Функция выполняет аутентификацию пользователя, подготавливая ключ шифрования на основе пароля и отправляя запрос на сервер Mega.

- Подготавливается ключ шифрования пароля с использованием функции `prepare_key`.
- Вычисляется хеш email и пароля с использованием функции `stringhash`.
- Отправляется API-запрос с email и хешем пароля.
- Вызывается метод `_login_common` для завершения процесса аутентификации.

#### `login_ephemeral`

```python
def login_ephemeral(self) -> None:
    """
    Выполняет временную аутентификацию.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    """
```

**Описание**: Выполняет временную аутентификацию.

**Как работает функция**:
Функция выполняет временную аутентификацию, генерируя случайные ключи и отправляя запрос на сервер Mega.

- Генерируются случайные ключи: `random_master_key`, `random_password_key`, `random_session_self_challenge`.
- Отправляется API-запрос с зашифрованными ключами.
- Получается user_handle.
- Отправляется API-запрос с user_handle.
- Вызывается метод `_login_common` для завершения процесса аутентификации.

#### `_login_common`

```python
def _login_common(self, res: dict, password: list[int]) -> None:
    """
    Общая логика для завершения процесса аутентификации.

    Args:
        self (Mega): Экземпляр класса Mega.
        res (dict): Ответ от сервера Mega.
        password (list[int]): Ключ шифрования пароля.

    Returns:
        None

    Raises:
        MegaIncorrectPasswordExcetion: Если email или пароль указаны неверно.

    """
```

**Описание**: Общая логика для завершения процесса аутентификации.

**Как работает функция**:
Функция обрабатывает ответ сервера после аутентификации, расшифровывает мастер-ключ и устанавливает идентификатор сессии.

- Проверяется, не является ли ответ кодом ошибки (-2 или -9), и вызывается исключение `MegaIncorrectPasswordExcetion`, если это так.
- Расшифровывается мастер-ключ с использованием предоставленного пароля.
- Устанавливается идентификатор сессии (`sid`) на основе данных из ответа сервера.

#### `get_files`

```python
def get_files(self) -> dict:
    """
    Получает список файлов и папок из аккаунта Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        dict: Данные о файлах и папках в аккаунте Mega.

    """
```

**Описание**: Получает список файлов и папок из аккаунта Mega.

**Как работает функция**:
Функция отправляет API-запрос для получения списка файлов и папок из аккаунта Mega. Затем она расшифровывает ключи и атрибуты файлов и сохраняет информацию о корневой папке, папке входящих и корзине.

- Отправляется API-запрос для получения списка файлов.
- Для каждого файла в ответе:
  - Если файл является файлом или папкой:
    - Расшифровывается ключ файла.
    - Расшифровываются атрибуты файла.
    - Сохраняются расшифрованные атрибуты и ключ в данных файла.
  - Если файл является корневой папкой, папкой входящих или корзиной, сохраняется его идентификатор.
- Возвращаются данные о файлах.

#### `download_from_url`

```python
def download_from_url(self, url: str) -> str:
    """
    Скачивает файл по публичной ссылке Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        url (str): Публичная ссылка на файл Mega.

    Returns:
        str: Имя скачанного файла.

    """
```

**Описание**: Скачивает файл по публичной ссылке Mega.

**Как работает функция**:
Функция извлекает идентификатор файла и ключ из URL, а затем вызывает метод `download_file` для скачивания файла.

- Создается объект URL из предоставленной ссылки.
- Извлекаются идентификатор файла и ключ из фрагмента URL.
- Вызывается метод `download_file` для скачивания файла.
- Возвращается имя скачанного файла.

#### `download_file`

```python
def download_file(self, file_id: str, file_key: str, public: bool = False, store_path: Optional[str] = None) -> str:
    """
    Скачивает файл из аккаунта Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (str): Ключ файла.
        public (bool, optional): Флаг, указывающий, является ли файл публичным. По умолчанию False.
        store_path (Optional[str], optional): Путь для сохранения файла. Если не указан, файл сохраняется в текущей директории. По умолчанию None.

    Returns:
        str: Имя скачанного файла.

    Raises:
        ValueError: Если MAC не совпадает.

    """
```

**Описание**: Скачивает файл из аккаунта Mega.

**Как работает функция**:
Функция скачивает файл из аккаунта Mega, используя предоставленные идентификатор файла и ключ. Она выполняет API-запрос для получения информации о файле, расшифровывает его и сохраняет на диск.

- Отправляется API-запрос для получения информации о файле.
- Расшифровывается ключ файла.
- Извлекается URL файла, размер и атрибуты.
- Создается объект для скачивания файла.
- Расшифровываются чанки файла и записываются на диск.
- Выполняется проверка целостности файла с использованием MAC.
- Возвращается имя скачанного файла.

#### `get_public_url`

```python
def get_public_url(self, file_id: str, file_key: list[int]) -> str:
    """
    Генерирует публичную ссылку на файл.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (list[int]): Ключ файла.

    Returns:
        str: Публичная ссылка на файл.

    """
```

**Описание**: Генерирует публичную ссылку на файл.

**Как работает функция**:
Функция генерирует публичную ссылку на файл, используя предоставленные идентификатор файла и ключ.

- Отправляется API-запрос для получения public handle файла.
- Шифруется ключ файла.
- Формируется публичная ссылка на файл.
- Возвращается публичная ссылка на файл.

#### `uploadfile`

```python
def uploadfile(self, filename: str, dst: Optional[str] = None) -> dict:
    """
    Загружает файл в аккаунт Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        filename (str): Путь к файлу для загрузки.
        dst (Optional[str], optional): Идентификатор папки назначения. Если не указан, файл загружается в корневую папку. По умолчанию None.

    Returns:
        dict: Данные о загруженном файле.

    """
```

**Описание**: Загружает файл в аккаунт Mega.

**Как работает функция**:
Функция загружает файл в аккаунт Mega, используя предоставленный путь к файлу и идентификатор папки назначения. Она выполняет API-запросы для получения URL загрузки, шифрует файл и отправляет его на сервер.

- Открывается файл для чтения.
- Определяется размер файла.
- Отправляется API-запрос для получения URL загрузки.
- Генерируются ключи для шифрования файла.
- Шифруются чанки файла и отправляются на сервер.
- Формируются метаданные файла и отправляются API-запрос для завершения загрузки.
- Возвращаются данные о загруженном файле.

## Функции

### `aes_cbc_encrypt_a32`

```python
def aes_cbc_encrypt_a32(data: list[int], key: list[int]) -> list[int]:
    """
    Выполняет AES CBC шифрование для списка 32-битных целых чисел.

    Args:
        data (list[int]): Список 32-битных целых чисел для шифрования.
        key (list[int]): Ключ шифрования.

    Returns:
        list[int]: Зашифрованный список 32-битных целых чисел.
    """
```

**Описание**: Выполняет AES CBC шифрование для списка 32-битных целых чисел.

**Как работает функция**:
Шифрует данные с использованием алгоритма AES в режиме CBC. Функция принимает список 32-битных целых чисел и ключ шифрования.

### `enc_attr`

```python
def enc_attr(attributes: dict, key: list[int]) -> bytes:
    """
    Шифрует атрибуты файла.

    Args:
        attributes (dict): Словарь с атрибутами файла.
        key (list[int]): Ключ шифрования.

    Returns:
        bytes: Зашифрованные атрибуты файла.
    """
```

**Описание**: Шифрует атрибуты файла.

**Как работает функция**:
Шифрует атрибуты файла с использованием предоставленного ключа.

### `dec_attr`

```python
def dec_attr(attributes: bytes, key: list[int]) -> dict:
    """
    Дешифрует атрибуты файла.

    Args:
        attributes (bytes): Зашифрованные атрибуты файла.
        key (list[int]): Ключ шифрования.

    Returns:
        dict: Дешифрованные атрибуты файла.
    """
```

**Описание**: Дешифрует атрибуты файла.

**Как работает функция**:
Дешифрует атрибуты файла с использованием предоставленного ключа.

### `prepare_key`

```python
def prepare_key(password: list[int]) -> list[int]:
    """
    Подготавливает ключ шифрования на основе пароля.

    Args:
        password (list[int]): Пароль пользователя в виде списка 32-битных целых чисел.

    Returns:
        list[int]: Ключ шифрования.
    """
```

**Описание**: Подготавливает ключ шифрования на основе пароля.

**Как работает функция**:
Генерирует ключ шифрования на основе предоставленного пароля.

### `stringhash`

```python
def stringhash(email: str, password_aes: list[int]) -> str:
    """
    Вычисляет хеш email и пароля.

    Args:
        email (str): Email пользователя.
        password_aes (list[int]): Ключ шифрования пароля.

    Returns:
        str: Хеш email и пароля.
    """
```

**Описание**: Вычисляет хеш email и пароля.

**Как работает функция**:
Вычисляет хеш email и пароля с использованием предоставленного ключа шифрования пароля.

### `encrypt_key`

```python
def encrypt_key(key: list[int], master_key: list[int]) -> list[int]:
    """
    Шифрует ключ с использованием мастер-ключа.

    Args:
        key (list[int]): Ключ для шифрования.
        master_key (list[int]): Мастер-ключ.

    Returns:
        list[int]: Зашифрованный ключ.
    """
```

**Описание**: Шифрует ключ с использованием мастер-ключа.

**Как работает функция**:
Шифрует предоставленный ключ с использованием мастер-ключа.

### `decrypt_key`

```python
def decrypt_key(key: list[int], master_key: list[int]) -> list[int]:
    """
    Дешифрует ключ с использованием мастер-ключа.

    Args:
        key (list[int]): Ключ для дешифрования.
        master_key (list[int]): Мастер-ключ.

    Returns:
        list[int]: Дешифрованный ключ.
    """
```

**Описание**: Дешифрует ключ с использованием мастер-ключа.

**Как работает функция**:
Дешифрует предоставленный ключ с использованием мастер-ключа.

### `a32_to_str`

```python
def a32_to_str(a: list[int]) -> str:
    """
    Преобразует список 32-битных целых чисел в строку.

    Args:
        a (list[int]): Список 32-битных целых чисел.

    Returns:
        str: Строка.
    """
```

**Описание**: Преобразует список 32-битных целых чисел в строку.

**Как работает функция**:
Преобразует список 32-битных целых чисел в строку.

### `str_to_a32`

```python
def str_to_a32(s: str) -> list[int]:
    """
    Преобразует строку в список 32-битных целых чисел.

    Args:
        s (str): Строка.

    Returns:
        list[int]: Список 32-битных целых чисел.
    """
```

**Описание**: Преобразует строку в список 32-битных целых чисел.

**Как работает функция**:
Преобразует строку в список 32-битных целых чисел.

### `a32_to_base64`

```python
def a32_to_base64(a: list[int]) -> str:
    """
    Преобразует список 32-битных целых чисел в строку Base64.

    Args:
        a (list[int]): Список 32-битных целых чисел.

    Returns:
        str: Строка Base64.
    """
```

**Описание**: Преобразует список 32-битных целых чисел в строку Base64.

**Как работает функция**:
Преобразует список 32-битных целых чисел в строку Base64.

### `base64_to_a32`

```python
def base64_to_a32(s: str) -> list[int]:
    """
    Преобразует строку Base64 в список 32-битных целых чисел.

    Args:
        s (str): Строка Base64.

    Returns:
        list[int]: Список 32-битных целых чисел.
    """
```

**Описание**: Преобразует строку Base64 в список 32-битных целых чисел.

**Как работает функция**:
Преобразует строку Base64 в список 32-битных целых чисел.

### `mpi2int`

```python
def mpi2int(s: bytes) -> int:
    """
    Преобразует строку MPI в целое число.

    Args:
        s (bytes): Строка MPI.

    Returns:
        int: Целое число.
    """
```

**Описание**: Преобразует строку MPI в целое число.

**Как работает функция**:
Преобразует строку MPI (Multi-Precision Integer) в целое число.

### `base64urlencode`

```python
def base64urlencode(data: bytes) -> str:
    """
    Кодирует данные в Base64 URL-safe строку.

    Args:
        data (bytes): Данные для кодирования.

    Returns:
        str: Base64 URL-safe строка.
    """
```

**Описание**: Кодирует данные в Base64 URL-safe строку.

**Как работает функция**:
Кодирует предоставленные данные в строку, используя кодировку Base64 URL-safe.

### `base64urldecode`

```python
def base64urldecode(data: str) -> bytes:
    """
    Декодирует Base64 URL-safe строку в байты.

    Args:
        data (str): Base64 URL-safe строка.

    Returns:
        bytes: Декодированные байты.
    """
```

**Описание**: Декодирует Base64 URL-safe строку в байты.

**Как работает функция**:
Декодирует предоставленную Base64 URL-safe строку в байты.

### `get_chunks`

```python
def get_chunks(file_size: int) -> dict:
    """
    Разбивает файл на чанки для загрузки/скачивания.

    Args:
        file_size (int): Размер файла в байтах.

    Returns:
        dict: Словарь с информацией о чанках. Ключи - начальные позиции чанков, значения - размеры чанков.
    """
```

**Описание**: Разбивает файл на чанки для загрузки/скачивания.

**Как работает функция**:
Определяет размер каждого чанка, на которые будет разбит файл для загрузки или скачивания.

## Исключения

### `MegaRequestException`

**Описание**: Исключение, выбрасываемое при ошибке запроса к API Mega.

### `MegaIncorrectPasswordExcetion`

**Описание**: Исключение, выбрасываемое при неверном email или пароле.