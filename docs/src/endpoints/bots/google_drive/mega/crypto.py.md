# Модуль для криптографических операций

## Обзор

Модуль `crypto.py` предоставляет набор функций для выполнения криптографических операций, используемых в контексте работы с Mega (облачное хранилище). Он включает в себя функции шифрования и дешифрования с использованием AES в режиме CBC, а также функции для подготовки и обработки ключей.

## Подробней

Этот модуль содержит функции для шифрования, дешифрования, хеширования строк и подготовки ключей, используя алгоритм AES (Advanced Encryption Standard) в режиме CBC (Cipher Block Chaining). Он также включает функции для шифрования и дешифрования атрибутов, что может быть полезно для защиты данных, передаваемых или хранящихся в Mega. Все функции модуля принимают и возвращают данные в различных форматах, таких как строки, массивы 32-битных целых чисел и base64.

## Функции

### `aes_cbc_encrypt`

```python
def aes_cbc_encrypt(data, key):
    """
    Шифрует данные с использованием AES в режиме CBC.

    Args:
        data (bytes): Данные для шифрования.
        key (bytes): Ключ шифрования.

    Returns:
        bytes: Зашифрованные данные.
    """
```

**Назначение**: Шифрует входные данные, используя алгоритм AES в режиме CBC с заданным ключом.

**Параметры**:
- `data` (bytes): Данные, которые необходимо зашифровать.
- `key` (bytes): Ключ, используемый для шифрования данных.

**Возвращает**:
- `bytes`: Зашифрованные данные.

**Как работает функция**:

1. Создает объект шифрования AES в режиме CBC с использованием предоставленного ключа и нулевого вектора инициализации (IV).
2. Выполняет шифрование предоставленных данных с использованием созданного объекта шифрования.
   ```
   A[Создание объекта шифрования AES]
   ↓
   B[Шифрование данных]
   ↓
   C[Возврат зашифрованных данных]
   ```

**Примеры**:

```python
from Crypto.Cipher import AES

data = b'This is a secret message.'
key = b'Sixteen byte key'

encrypted_data = aes_cbc_encrypt(data, key)
print(encrypted_data)
```

### `aes_cbc_decrypt`

```python
def aes_cbc_decrypt(data, key):
    """
    Дешифрует данные, зашифрованные с использованием AES в режиме CBC.

    Args:
        data (bytes): Зашифрованные данные.
        key (bytes): Ключ дешифрования.

    Returns:
        bytes: Дешифрованные данные.
    """
```

**Назначение**: Дешифрует входные данные, которые были зашифрованы с использованием алгоритма AES в режиме CBC с заданным ключом.

**Параметры**:
- `data` (bytes): Зашифрованные данные, которые необходимо дешифровать.
- `key` (bytes): Ключ, используемый для дешифрования данных.

**Возвращает**:
- `bytes`: Дешифрованные данные.

**Как работает функция**:

1. Создает объект дешифрования AES в режиме CBC с использованием предоставленного ключа и нулевого вектора инициализации (IV).
2. Выполняет дешифрование предоставленных данных с использованием созданного объекта дешифрования.

```
   A[Создание объекта дешифрования AES]
   ↓
   B[Дешифрование данных]
   ↓
   C[Возврат дешифрованных данных]
```

**Примеры**:

```python
from Crypto.Cipher import AES

encrypted_data = b'...'  # Зашифрованные данные
key = b'Sixteen byte key'

decrypted_data = aes_cbc_decrypt(encrypted_data, key)
print(decrypted_data)
```

### `aes_cbc_encrypt_a32`

```python
def aes_cbc_encrypt_a32(data, key):
    """
    Шифрует данные в формате массива 32-битных целых чисел с использованием AES в режиме CBC.

    Args:
        data (list[int]): Данные для шифрования в формате массива 32-битных целых чисел.
        key (list[int]): Ключ шифрования в формате массива 32-битных целых чисел.

    Returns:
        list[int]: Зашифрованные данные в формате массива 32-битных целых чисел.
    """
```

**Назначение**: Шифрует данные, представленные в виде массива 32-битных целых чисел, используя алгоритм AES в режиме CBC с заданным ключом, также представленным в виде массива 32-битных целых чисел.

**Параметры**:
- `data` (list[int]): Данные для шифрования в формате массива 32-битных целых чисел.
- `key` (list[int]): Ключ шифрования в формате массива 32-битных целых чисел.

**Возвращает**:
- `list[int]`: Зашифрованные данные в формате массива 32-битных целых чисел.

**Как работает функция**:

1. Преобразует входные данные и ключ из формата массива 32-битных целых чисел в строковый формат.
2. Вызывает функцию `aes_cbc_encrypt` для шифрования строковых данных с использованием строкового ключа.
3. Преобразует зашифрованные строковые данные обратно в формат массива 32-битных целых чисел.

```
   A[Преобразование данных и ключа в строковый формат]
   ↓
   B[Шифрование данных с использованием aes_cbc_encrypt]
   ↓
   C[Преобразование зашифрованных данных в формат массива 32-битных целых чисел]
   ↓
   D[Возврат зашифрованных данных]
```

**Примеры**:

```python
data = [1, 2, 3, 4]
key = [5, 6, 7, 8]

encrypted_data = aes_cbc_encrypt_a32(data, key)
print(encrypted_data)
```

### `aes_cbc_decrypt_a32`

```python
def aes_cbc_decrypt_a32(data, key):
    """
    Дешифрует данные в формате массива 32-битных целых чисел, зашифрованные с использованием AES в режиме CBC.

    Args:
        data (list[int]): Зашифрованные данные в формате массива 32-битных целых чисел.
        key (list[int]): Ключ дешифрования в формате массива 32-битных целых чисел.

    Returns:
        list[int]: Дешифрованные данные в формате массива 32-битных целых чисел.
    """
```

**Назначение**: Дешифрует данные, представленные в виде массива 32-битных целых чисел, которые были зашифрованы с использованием алгоритма AES в режиме CBC с заданным ключом, также представленным в виде массива 32-битных целых чисел.

**Параметры**:
- `data` (list[int]): Зашифрованные данные в формате массива 32-битных целых чисел.
- `key` (list[int]): Ключ дешифрования в формате массива 32-битных целых чисел.

**Возвращает**:
- `list[int]`: Дешифрованные данные в формате массива 32-битных целых чисел.

**Как работает функция**:

1. Преобразует входные данные и ключ из формата массива 32-битных целых чисел в строковый формат.
2. Вызывает функцию `aes_cbc_decrypt` для дешифрования строковых данных с использованием строкового ключа.
3. Преобразует дешифрованные строковые данные обратно в формат массива 32-битных целых чисел.

```
   A[Преобразование данных и ключа в строковый формат]
   ↓
   B[Дешифрование данных с использованием aes_cbc_decrypt]
   ↓
   C[Преобразование дешифрованных данных в формат массива 32-битных целых чисел]
   ↓
   D[Возврат дешифрованных данных]
```

**Примеры**:

```python
data = [1, 2, 3, 4]
key = [5, 6, 7, 8]

decrypted_data = aes_cbc_decrypt_a32(data, key)
print(decrypted_data)
```

### `stringhash`

```python
def stringhash(s, aeskey):
    """
    Вычисляет хеш строки с использованием AES в режиме CBC.

    Args:
        s (str): Строка для вычисления хеша.
        aeskey (list[int]): Ключ AES в формате массива 32-битных целых чисел.

    Returns:
        str: Хеш строки в формате base64.
    """
```

**Назначение**: Вычисляет хеш строки `s` с использованием алгоритма AES в режиме CBC и ключа `aeskey`.

**Параметры**:
- `s` (str): Строка, для которой вычисляется хеш.
- `aeskey` (list[int]): Ключ AES в формате массива 32-битных целых чисел.

**Возвращает**:
- `str`: Хеш строки в формате base64.

**Как работает функция**:

1. Преобразует входную строку `s` в массив 32-битных целых чисел.
2. Инициализирует массив `h32` нулями.
3. Выполняет XOR-операцию между элементами массива `s32` и `h32`.
4. Выполняет 0x4000 итераций шифрования AES в режиме CBC с использованием ключа `aeskey`.
5. Преобразует результат в формат base64 и возвращает его.

```
   A[Преобразование строки в массив 32-битных целых чисел]
   ↓
   B[Инициализация массива h32]
   ↓
   C[XOR-операция между элементами массива s32 и h32]
   ↓
   D[Выполнение 0x4000 итераций шифрования AES в режиме CBC]
   ↓
   E[Преобразование результата в формат base64]
   ↓
   F[Возврат хеша строки]
```

**Примеры**:

```python
s = 'example_string'
aeskey = [1, 2, 3, 4]

string_hash = stringhash(s, aeskey)
print(string_hash)
```

### `prepare_key`

```python
def prepare_key(a):
    """
    Подготавливает ключ для шифрования.

    Args:
        a (list[int]): Исходный ключ в формате массива 32-битных целых чисел.

    Returns:
        list[int]: Подготовленный ключ в формате массива 32-битных целых чисел.
    """
```

**Назначение**: Подготавливает ключ шифрования на основе предоставленного исходного ключа `a`.

**Параметры**:
- `a` (list[int]): Исходный ключ в формате массива 32-битных целых чисел.

**Возвращает**:
- `list[int]`: Подготовленный ключ в формате массива 32-битных целых чисел.

**Как работает функция**:

1. Инициализирует `pkey` фиксированным массивом 32-битных целых чисел.
2. Выполняет 0x10000 итераций шифрования AES в режиме CBC, используя части исходного ключа `a`.
3. Возвращает подготовленный ключ `pkey`.

```
   A[Инициализация pkey]
   ↓
   B[Выполнение 0x10000 итераций шифрования AES в режиме CBC]
   ↓
   C[Возврат подготовленного ключа]
```

**Примеры**:

```python
a = [1, 2, 3, 4, 5, 6, 7, 8]

prepared_key = prepare_key(a)
print(prepared_key)
```

### `encrypt_key`

```python
def encrypt_key(a, key):
    """
    Шифрует ключ a с использованием ключа key.

    Args:
        a (list[int]): Ключ для шифрования в формате массива 32-битных целых чисел.
        key (list[int]): Ключ шифрования в формате массива 32-битных целых чисел.

    Returns:
        list[int]: Зашифрованный ключ в формате массива 32-битных целых чисел.
    """
```

**Назначение**: Шифрует ключ `a` с использованием ключа `key` посредством AES в режиме CBC.

**Параметры**:
- `a` (list[int]): Ключ, который необходимо зашифровать.
- `key` (list[int]): Ключ, используемый для шифрования.

**Возвращает**:
- `list[int]`: Зашифрованный ключ.

**Как работает функция**:

1. Разделяет ключ `a` на блоки по 4 элемента.
2. Шифрует каждый блок с использованием функции `aes_cbc_encrypt_a32` и ключа `key`.
3. Объединяет зашифрованные блоки в один массив.
4. Возвращает зашифрованный ключ.

```
   A[Разделение ключа a на блоки]
   ↓
   B[Шифрование каждого блока с использованием aes_cbc_encrypt_a32]
   ↓
   C[Объединение зашифрованных блоков]
   ↓
   D[Возврат зашифрованного ключа]
```

**Примеры**:

```python
a = [1, 2, 3, 4, 5, 6, 7, 8]
key = [9, 10, 11, 12]

encrypted_key = encrypt_key(a, key)
print(encrypted_key)
```

### `decrypt_key`

```python
def decrypt_key(a, key):
    """
    Дешифрует ключ a с использованием ключа key.

    Args:
        a (list[int]): Зашифрованный ключ в формате массива 32-битных целых чисел.
        key (list[int]): Ключ дешифрования в формате массива 32-битных целых чисел.

    Returns:
        list[int]: Дешифрованный ключ в формате массива 32-битных целых чисел.
    """
```

**Назначение**: Дешифрует ключ `a`, используя ключ `key` посредством AES в режиме CBC.

**Параметры**:
- `a` (list[int]): Зашифрованный ключ, который необходимо дешифровать.
- `key` (list[int]): Ключ, используемый для дешифрования.

**Возвращает**:
- `list[int]`: Дешифрованный ключ.

**Как работает функция**:

1. Разделяет зашифрованный ключ `a` на блоки по 4 элемента.
2. Дешифрует каждый блок с использованием функции `aes_cbc_decrypt_a32` и ключа `key`.
3. Объединяет дешифрованные блоки в один массив.
4. Возвращает дешифрованный ключ.

```
   A[Разделение ключа a на блоки]
   ↓
   B[Дешифрование каждого блока с использованием aes_cbc_decrypt_a32]
   ↓
   C[Объединение дешифрованных блоков]
   ↓
   D[Возврат дешифрованного ключа]
```

**Примеры**:

```python
a = [1, 2, 3, 4, 5, 6, 7, 8]
key = [9, 10, 11, 12]

decrypted_key = decrypt_key(a, key)
print(decrypted_key)
```

### `enc_attr`

```python
def enc_attr(attr, key):
    """
    Шифрует атрибуты с использованием AES в режиме CBC.

    Args:
        attr (dict): Атрибуты для шифрования.
        key (list[int]): Ключ шифрования в формате массива 32-битных целых чисел.

    Returns:
        bytes: Зашифрованные атрибуты.
    """
```

**Назначение**: Шифрует атрибуты `attr` с использованием AES в режиме CBC и ключа `key`.

**Параметры**:
- `attr` (dict): Атрибуты для шифрования.
- `key` (list[int]): Ключ шифрования в формате массива 32-битных целых чисел.

**Возвращает**:
- `bytes`: Зашифрованные атрибуты.

**Как работает функция**:

1. Преобразует атрибуты `attr` в JSON-строку и добавляет префикс 'MEGA'.
2. Дополняет строку нулями до кратной длины 16 байт.
3. Шифрует строку с использованием AES в режиме CBC и ключа `key`.
4. Возвращает зашифрованные атрибуты.

```
   A[Преобразование атрибутов в JSON-строку и добавление префикса]
   ↓
   B[Дополнение строки нулями до кратной длины 16 байт]
   ↓
   C[Шифрование строки с использованием AES в режиме CBC]
   ↓
   D[Возврат зашифрованных атрибутов]
```

**Примеры**:

```python
attr = {'name': 'example', 'size': 1024}
key = [1, 2, 3, 4]

encrypted_attr = enc_attr(attr, key)
print(encrypted_attr)
```

### `dec_attr`

```python
def dec_attr(attr, key):
    """
    Дешифрует атрибуты, зашифрованные с использованием AES в режиме CBC.

    Args:
        attr (bytes): Зашифрованные атрибуты.
        key (list[int]): Ключ дешифрования в формате массива 32-битных целых чисел.

    Returns:
        dict: Дешифрованные атрибуты.
    """
```

**Назначение**: Дешифрует атрибуты `attr`, которые были зашифрованы с использованием AES в режиме CBC и ключа `key`.

**Параметры**:
- `attr` (bytes): Зашифрованные атрибуты.
- `key` (list[int]): Ключ дешифрования в формате массива 32-битных целых чисел.

**Возвращает**:
- `dict`: Дешифрованные атрибуты.

**Как работает функция**:

1. Дешифрует атрибуты с использованием AES в режиме CBC и ключа `key`.
2. Удаляет префикс 'MEGA' и отсекает завершающие нули.
3. Преобразует JSON-строку в словарь.
4. Возвращает дешифрованные атрибуты.

```
   A[Дешифрование атрибутов с использованием AES в режиме CBC]
   ↓
   B[Удаление префикса и отсечение завершающих нулей]
   ↓
   C[Преобразование JSON-строки в словарь]
   ↓
   D[Возврат дешифрованных атрибутов]
```

**Примеры**:

```python
attr = b'...'  # Зашифрованные атрибуты
key = [1, 2, 3, 4]

decrypted_attr = dec_attr(attr, key)
print(decrypted_attr)