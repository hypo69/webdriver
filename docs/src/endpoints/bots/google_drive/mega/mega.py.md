# Модуль `mega.py` для работы с сервисом Mega.nz
==================================================

Модуль предоставляет класс `Mega` для взаимодействия с сервисом Mega.nz.
Он позволяет выполнять такие операции, как аутентификация, скачивание и загрузка файлов.

## Обзор

Этот модуль предоставляет интерфейс для взаимодействия с сервисом Mega.nz, позволяя пользователям аутентифицироваться, скачивать и загружать файлы. Он включает в себя функции для обработки ключей шифрования, выполнения API-запросов и управления файлами.

## Подробнее

Модуль содержит класс `Mega`, который инкапсулирует логику взаимодействия с API Mega.nz. Класс предоставляет методы для аутентификации пользователя, получения списка файлов, скачивания и загрузки файлов. Для шифрования и дешифрования данных используются криптографические функции из модуля `mega.crypto`.

## Классы

### `Mega`

**Описание**: Класс для взаимодействия с сервисом Mega.nz.

**Принцип работы**:
Класс `Mega` предоставляет методы для аутентификации, скачивания и загрузки файлов. Он использует API Mega.nz для выполнения этих операций. Для шифрования и дешифрования данных используются криптографические функции из модуля `mega.crypto`.

**Атрибуты**:
- `seqno` (int): Последовательный номер для API-запросов.
- `sid` (str | None): Идентификатор сессии.
- `master_key` (list[int]): Главный ключ шифрования.
- `rsa_priv_key` (list[int]): Приватный ключ RSA.
- `root_id` (str | None): Идентификатор корневой папки ("Cloud Drive").
- `inbox_id` (str | None): Идентификатор папки "Inbox".
- `trashbin_id` (str | None): Идентификатор корзины.

**Методы**:
- `__init__()`: Инициализирует объект класса `Mega`.
- `from_credentials(email: str, password: str) -> Mega`: Создает экземпляр класса `Mega` с использованием email и пароля.
- `from_ephemeral() -> Mega`: Создает экземпляр класса `Mega` для анонимного доступа.
- `api_req(data: dict) -> dict`: Выполняет API-запрос к сервису Mega.nz.
- `login_user(email: str, password: str) -> None`: Аутентифицирует пользователя по email и паролю.
- `login_ephemeral() -> None`: Аутентифицирует пользователя для анонимного доступа.
- `_login_common(res: dict, password: list[int]) -> None`: Общая логика для аутентификации.
- `get_files() -> dict`: Получает список файлов и папок.
- `download_from_url(url: str) -> str`: Скачивает файл по публичной ссылке.
- `download_file(file_id: str, file_key: str, public: bool = False, store_path: str | None = None) -> str`: Скачивает файл по его идентификатору и ключу.
- `get_public_url(file_id: str, file_key: list[int]) -> str`: Получает публичную ссылку на файл.
- `uploadfile(filename: str, dst: str | None = None) -> dict`: Загружает файл на сервис Mega.nz.

## Функции

### `__init__`

```python
def __init__(self):
    """
    Инициализирует объект класса Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    Описание:
        Инициализирует атрибуты `seqno` случайным целым числом, а `sid` устанавливает в `None`.
        Атрибут `seqno` используется для идентификации последовательности запросов к API Mega.
        Атрибут `sid` предназначен для хранения идентификатора сессии пользователя после успешной аутентификации.
    """
    ...
```

**Как работает функция**:

1.  Инициализирует атрибут `seqno` случайным целым числом в диапазоне от 0 до 0xFFFFFFFF.
2.  Устанавливает атрибут `sid` в `None`.

### `from_credentials`

```python
@classmethod
def from_credentials(cls, email: str, password: str) -> 'Mega':
    """
    Создает экземпляр класса Mega с использованием email и пароля.

    Args:
        cls (Mega): Класс Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Экземпляр класса Mega, аутентифицированный с использованием предоставленных учетных данных.

    Описание:
        Этот метод создает экземпляр класса `Mega`, выполняет вход пользователя в систему с использованием
        предоставленных учетных данных (email и пароль) и возвращает аутентифицированный экземпляр класса `Mega`.
    """
    ...
```

**Как работает функция**:

1.  Создает экземпляр класса `Mega`.
2.  Вызывает метод `login_user` для аутентификации пользователя с использованием предоставленных email и пароля.
3.  Возвращает созданный экземпляр класса `Mega`.

### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls) -> 'Mega':
    """
    Создает экземпляр класса Mega для анонимного доступа.

    Args:
        cls (Mega): Класс Mega.

    Returns:
        Mega: Экземпляр класса Mega, настроенный для анонимного доступа.

    Описание:
        Этот метод создает экземпляр класса `Mega` и выполняет анонимный вход в систему,
        используя метод `login_ephemeral`. Возвращает экземпляр класса `Mega`, настроенный для анонимного доступа.
    """
    ...
```

**Как работает функция**:

1.  Создает экземпляр класса `Mega`.
2.  Вызывает метод `login_ephemeral` для аутентификации пользователя для анонимного доступа.
3.  Возвращает созданный экземпляр класса `Mega`.

### `api_req`

```python
def api_req(self, data: dict) -> dict:
    """
    Выполняет API-запрос к сервису Mega.nz.

    Args:
        self (Mega): Экземпляр класса Mega.
        data (dict): Словарь с данными для отправки в API-запросе.

    Returns:
        dict: Ответ от API в формате словаря.

    Raises:
        MegaRequestException: Если API возвращает код ошибки.

    Описание:
        Этот метод отправляет POST-запрос к API Mega.nz с предоставленными данными.
        Он добавляет параметры `id` (порядковый номер запроса) и `sid` (идентификатор сессии, если доступен)
        к запросу. Если API возвращает код ошибки, метод вызывает исключение `MegaRequestException`.
    """
    ...
```

**Как работает функция**:

1.  Определяет параметры запроса, включая `id` (порядковый номер запроса) и `sid` (идентификатор сессии, если доступен).
2.  Преобразует данные в формат JSON.
3.  Отправляет POST-запрос к API Mega.nz.
4.  Обрабатывает ответ от API.
5.  Если API возвращает код ошибки, вызывает исключение `MegaRequestException`.
6.  Возвращает ответ от API в формате словаря.

```
     Начало
     │
     ├──► Определение параметров запроса (params) {id, sid}
     │
     ├──► Преобразование данных в формат JSON (data)
     │
     ├──► Отправка POST-запроса к API Mega.nz
     │
     ├──► Обработка ответа от API
     │   │
     │   ├──► Если API возвращает код ошибки:
     │   │   │
     │   │   └──► Вызов исключения MegaRequestException
     │   │
     │   └──► Иначе:
     │       │
     │       └──► Возврат ответа от API в формате словаря
     │
     └──► Конец
```

**Примеры**:

```python
mega = Mega()
data = {'a': 'us', 'user': 'example@example.com', 'uh': 'hash'}
response = mega.api_req(data)
print(response)
```

### `login_user`

```python
def login_user(self, email: str, password: str) -> None:
    """
    Аутентифицирует пользователя по email и паролю.

    Args:
        self (Mega): Экземпляр класса Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        None

    Описание:
        Этот метод аутентифицирует пользователя, подготавливая ключ AES из пароля,
        вычисляет хеш строки, используя email и подготовленный ключ AES,
        затем отправляет API-запрос с email и хешем строки для аутентификации.
        После успешной аутентификации вызывается метод `_login_common` для
        обработки общих параметров входа в систему.
    """
    ...
```

**Как работает функция**:

1.  Подготавливает ключ AES из пароля, используя функцию `prepare_key`.
2.  Вычисляет хеш строки, используя email и подготовленный ключ AES, с помощью функции `stringhash`.
3.  Отправляет API-запрос с email и хешем строки для аутентификации.
4.  Вызывает метод `_login_common` для обработки общих параметров входа в систему.

```
     Начало
     │
     ├──► Подготовка ключа AES из пароля
     │
     ├──► Вычисление хеша строки (email + ключ AES)
     │
     ├──► Отправка API-запроса (email, хеш)
     │
     └──► Вызов _login_common()
     │
     └──► Конец
```

**Примеры**:

```python
mega = Mega()
mega.login_user('example@example.com', 'password')
```

### `login_ephemeral`

```python
def login_ephemeral(self) -> None:
    """
    Аутентифицирует пользователя для анонимного доступа.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    Описание:
        Этот метод выполняет вход пользователя в систему для анонимного доступа.
        Он генерирует случайные ключи и вызывает API-запрос с этими ключами
        для получения user handle. Затем вызывает метод `_login_common` для
        обработки общих параметров входа в систему.
    """
    ...
```

**Как работает функция**:

1.  Генерирует случайные ключи: `random_master_key`, `random_password_key` и `random_session_self_challenge`.
2.  Отправляет API-запрос с этими ключами для получения `user_handle`.
3.  Вызывает метод `_login_common` для обработки общих параметров входа в систему.

```
     Начало
     │
     ├──► Генерация случайных ключей (master, password, session)
     │
     ├──► Отправка API-запроса с ключами
     │
     └──► Вызов _login_common()
     │
     └──► Конец
```

### `_login_common`

```python
def _login_common(self, res: dict, password: list[int]) -> None:
    """
    Общая логика для аутентификации.

    Args:
        self (Mega): Экземпляр класса Mega.
        res (dict): Ответ от API.
        password (list[int]): Ключ пароля.

    Returns:
        None

    Raises:
        MegaIncorrectPasswordExcetion: Если email и/или пароль неверны.

    Описание:
        Этот метод содержит общую логику для аутентификации.
        Он дешифрует главный ключ, используя предоставленный пароль,
        и устанавливает идентификатор сессии (`sid`), если он присутствует в ответе API.
    """
    ...
```

**Как работает функция**:

1.  Проверяет, не вернул ли API код ошибки, указывающий на неверный email или пароль.
2.  Дешифрует главный ключ, используя предоставленный пароль.
3.  Устанавливает идентификатор сессии (`sid`), если он присутствует в ответе API.

```
     Начало
     │
     ├──► Проверка на ошибки аутентификации
     │
     ├──► Дешифрование главного ключа
     │
     └──► Установка идентификатора сессии (sid)
     │
     └──► Конец
```

### `get_files`

```python
def get_files(self) -> dict:
    """
    Получает список файлов и папок.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        dict: Словарь с информацией о файлах и папках.

    Описание:
        Этот метод получает список файлов и папок из аккаунта Mega.nz пользователя.
        Он отправляет API-запрос для получения данных о файлах, а затем дешифрует
        ключи и атрибуты файлов. Также устанавливает идентификаторы для корневой папки,
        папки "Входящие" и корзины.
    """
    ...
```

**Как работает функция**:

1.  Отправляет API-запрос для получения данных о файлах.
2.  Перебирает файлы и папки в полученных данных.
3.  Дешифрует ключи и атрибуты файлов.
4.  Устанавливает идентификаторы для корневой папки, папки "Входящие" и корзины.
5.  Возвращает словарь с информацией о файлах и папках.

```
     Начало
     │
     ├──► Отправка API-запроса для получения данных о файлах
     │
     ├──► Перебор файлов и папок
     │   │
     │   ├──► Дешифрование ключей файлов
     │   │
     │   └──► Дешифрование атрибутов файлов
     │
     ├──► Установка идентификаторов (root, inbox, trashbin)
     │
     └──► Возврат словаря с информацией о файлах
     │
     └──► Конец
```

### `download_from_url`

```python
def download_from_url(self, url: str) -> str:
    """
    Скачивает файл по публичной ссылке.

    Args:
        self (Mega): Экземпляр класса Mega.
        url (str): Публичная ссылка на файл.

    Returns:
        str: Имя скачанного файла.

    Описание:
        Этот метод скачивает файл по предоставленной публичной ссылке Mega.nz.
        Он извлекает идентификатор файла и ключ файла из URL,
        а затем вызывает метод `download_file` для скачивания файла.
    """
    ...
```

**Как работает функция**:

1.  Извлекает идентификатор файла и ключ файла из URL.
2.  Вызывает метод `download_file` для скачивания файла.
3.  Возвращает имя скачанного файла.

```
     Начало
     │
     ├──► Извлечение ID и ключа файла из URL
     │
     └──► Вызов download_file()
     │
     └──► Возврат имени скачанного файла
     │
     └──► Конец
```

### `download_file`

```python
def download_file(self, file_id: str, file_key: str, public: bool = False, store_path: str | None = None) -> str:
    """
    Скачивает файл по его идентификатору и ключу.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (str): Ключ файла.
        public (bool): Указывает, является ли файл публичным. По умолчанию `False`.
        store_path (str | None): Путь для сохранения файла. По умолчанию `None`.

    Returns:
        str: Имя скачанного файла.

    Raises:
        ValueError: Если MAC не совпадает.

    Описание:
        Этот метод скачивает файл из Mega.nz по предоставленному идентификатору файла и ключу файла.
        Он выполняет API-запрос для получения данных о файле, дешифрует атрибуты файла,
        скачивает содержимое файла, дешифрует его и проверяет целостность данных с использованием MAC.
    """
    ...
```

**Как работает функция**:

1.  Выполняет API-запрос для получения данных о файле.
2.  Дешифрует атрибуты файла.
3.  Создает объекты для скачивания и дешифрования файла.
4.  Скачивает файл по частям, дешифрует каждую часть и записывает в выходной файл.
5.  Вычисляет MAC файла и сравнивает с ожидаемым значением.
6.  Возвращает имя скачанного файла.

```
     Начало
     │
     ├──► Отправка API-запроса для получения данных о файле
     │
     ├──► Дешифрование атрибутов файла
     │
     ├──► Создание объектов для скачивания и дешифрования
     │
     ├──► Скачивание и дешифрование файла по частям
     │
     ├──► Вычисление MAC файла и проверка целостности
     │
     └──► Возврат имени скачанного файла
     │
     └──► Конец
```

### `get_public_url`

```python
def get_public_url(self, file_id: str, file_key: list[int]) -> str:
    """
    Получает публичную ссылку на файл.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (list[int]): Ключ файла.

    Returns:
        str: Публичная ссылка на файл.

    Описание:
        Этот метод получает публичную ссылку на файл по его идентификатору и ключу.
        Он выполняет API-запрос для получения public handle,
        а затем формирует URL с использованием идентификатора файла, public handle и ключа.
    """
    ...
```

**Как работает функция**:

1.  Выполняет API-запрос для получения `public_handle`.
2.  Формирует URL с использованием `file_id`, `public_handle` и `decrypted_key`.
3.  Возвращает публичную ссылку на файл.

```
     Начало
     │
     ├──► Отправка API-запроса для получения public_handle
     │
     └──► Формирование URL (file_id, public_handle, decrypted_key)
     │
     └──► Возврат публичной ссылки
     │
     └──► Конец
```

### `uploadfile`

```python
def uploadfile(self, filename: str, dst: str | None = None) -> dict:
    """
    Загружает файл на сервис Mega.nz.

    Args:
        self (Mega): Экземпляр класса Mega.
        filename (str): Имя файла для загрузки.
        dst (str | None): Идентификатор целевой папки. По умолчанию `None`.

    Returns:
        dict: Данные об загруженном файле.

    Описание:
        Этот метод загружает файл на сервис Mega.nz.
        Он открывает файл, вычисляет его размер, выполняет API-запрос
        для получения URL загрузки, шифрует файл и отправляет его на сервер.
        Затем создает метаданные файла и отправляет API-запрос для завершения процесса загрузки.
    """
    ...
```

**Как работает функция**:

1.  Открывает файл и вычисляет его размер.
2.  Выполняет API-запрос для получения URL загрузки.
3.  Шифрует файл.
4.  Отправляет файл на сервер.
5.  Создает метаданные файла.
6.  Отправляет API-запрос для завершения процесса загрузки.
7.  Возвращает данные об загруженном файле.

```
     Начало
     │
     ├──► Открытие файла и вычисление размера
     │
     ├──► Отправка API-запроса для получения URL загрузки
     │
     ├──► Шифрование файла
     │
     ├──► Отправка файла на сервер
     │
     ├──► Создание метаданных файла
     │
     ├──► Отправка API-запроса для завершения загрузки
     │
     └──► Возврат данных об загруженном файле
     │
     └──► Конец