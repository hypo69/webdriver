# Модуль `utils.py`

## Обзор

Модуль `utils.py` содержит набор вспомогательных функций, используемых для работы с шифрованием, кодированием и структурированием данных, необходимых для взаимодействия с API Mega. Эти функции обеспечивают преобразование данных между различными форматами (например, из массива 32-битных целых чисел в строку и обратно), а также выполняют операции шифрования и дешифрования с использованием алгоритма AES в режиме CBC. Кроме того, модуль содержит функции для кодирования и декодирования данных в формате Base64 URL, а также для разбиения размера файла на чанки.

## Подробней

Этот модуль предоставляет инструменты, необходимые для безопасной передачи и обработки данных при работе с Mega API. Функции модуля позволяют выполнять шифрование и дешифрование данных, а также преобразовывать их в форматы, подходящие для передачи по сети. Также модуль предоставляет фунцкии разбития размера файла на части.

## Функции

### `a32_to_str`

```python
def a32_to_str(a):
    """Преобразует массив 32-битных целых чисел в строку байтов.

    Args:
        a (list[int]): Массив 32-битных целых чисел.

    Returns:
        bytes: Строка байтов, полученная из массива целых чисел.

    Как работает функция:
     1. Функция принимает на вход массив 32-битных целых чисел.
     2. Использует `struct.pack` для преобразования каждого целого числа в 4 байта в формате big-endian (`>`).
     3. Объединяет полученные байты в одну строку.

    ASCII flowchart:
    Массив целых чисел
    ↓
    Преобразование каждого числа в 4 байта (big-endian)
    ↓
    Объединение байтов в строку

    Примеры:
        >>> a32_to_str([1, 2, 3])
        b'\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x03'
    """
    ...
```

### `aes_cbc_encrypt`

```python
def aes_cbc_encrypt(data, key):
    """Шифрует данные с использованием алгоритма AES в режиме CBC.

    Args:
        data (bytes): Данные для шифрования.
        key (bytes): Ключ шифрования.

    Returns:
        bytes: Зашифрованные данные.

    Как работает функция:
     1. Функция принимает на вход данные и ключ шифрования.
     2. Создает объект шифрования AES в режиме CBC с нулевым вектором инициализации (IV).
     3. Шифрует данные с использованием созданного объекта шифрования.

    ASCII flowchart:
    Данные, Ключ
    ↓
    Создание объекта шифрования AES (CBC, IV=0)
    ↓
    Шифрование данных

    Примеры:
        >>> key = b'\\x00' * 16
        >>> data = b'test data here'
        >>> encrypted_data = aes_cbc_encrypt(data, key)
        >>> type(encrypted_data)
        <class 'bytes'>
    """
    ...
```

### `aes_cbc_encrypt_a32`

```python
def aes_cbc_encrypt_a32(data, key):
    """Шифрует данные, представленные в виде массива 32-битных целых чисел, с использованием AES в режиме CBC.

    Args:
        data (list[int]): Данные для шифрования в виде массива 32-битных целых чисел.
        key (list[int]): Ключ шифрования в виде массива 32-битных целых чисел.

    Returns:
        tuple[int]: Зашифрованные данные в виде массива 32-битных целых чисел.

    Как работает функция:
    1.  Преобразует входные массивы 32-битных целых чисел `data` и `key` в строки байтов с использованием функции `a32_to_str`.
    2.  Шифрует полученную строку байтов с помощью функции `aes_cbc_encrypt`, используя преобразованный ключ.
    3.  Преобразует зашифрованную строку байтов обратно в массив 32-битных целых чисел с использованием функции `str_to_a32`.

    ASCII flowchart:
    data: list[int], key: list[int]
    ↓
    a32_to_str(data), a32_to_str(key)
    ↓
    aes_cbc_encrypt(data, key)
    ↓
    str_to_a32(encrypted_data)
    ↓
    return encrypted_data: tuple[int]

    Примеры:
        >>> data = [1, 2, 3]
        >>> key = [4, 5, 6]
        >>> encrypted_data = aes_cbc_encrypt_a32(data, key)
        >>> type(encrypted_data)
        <class 'tuple'>
    """
    ...
```

### `str_to_a32`

```python
def str_to_a32(b):
    """Преобразует строку байтов в массив 32-битных целых чисел.

    Args:
        b (bytes): Строка байтов для преобразования.

    Returns:
        tuple[int]: Массив 32-битных целых чисел.

    Как работает функция:
     1. Функция принимает на вход строку байтов.
     2. Дополняет строку нулевыми байтами до тех пор, пока длина строки не станет кратной 4.
     3. Использует `struct.unpack` для преобразования строки в массив 32-битных целых чисел.

    ASCII flowchart:
    Строка байтов
    ↓
    Дополнение до кратности 4
    ↓
    Преобразование в массив 32-битных целых чисел

    Примеры:
        >>> str_to_a32(b'\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x02')
        (1, 2)
    """
    ...
```

### `mpi2int`

```python
def mpi2int(s):
    """Преобразует строку, представляющую число MPI, в целое число.

    Args:
        s (bytes): Строка, представляющая число MPI.

    Returns:
        int: Целое число, полученное из строки MPI.

    Как работает функция:
     1. Функция принимает на вход строку, представляющую число MPI.
     2. Извлекает из строки данные, начиная с третьего байта.
     3. Преобразует полученные данные в шестнадцатеричный формат.
     4. Преобразует шестнадцатеричное представление в целое число.

    ASCII flowchart:
    Строка MPI
    ↓
    Извлечение данных (с 3-го байта)
    ↓
    Преобразование в шестнадцатеричный формат
    ↓
    Преобразование в целое число

    Примеры:
        >>> mpi2int(b'\\x00\\x02\\x01\\x02')
        258
    """
    ...
```

### `aes_cbc_decrypt`

```python
def aes_cbc_decrypt(data, key):
    """Расшифровывает данные с использованием алгоритма AES в режиме CBC.

    Args:
        data (bytes): Данные для расшифровки.
        key (bytes): Ключ расшифровки.

    Returns:
        bytes: Расшифрованные данные.

    Как работает функция:
     1. Функция принимает на вход данные и ключ расшифровки.
     2. Создает объект расшифрования AES в режиме CBC с нулевым вектором инициализации (IV).
     3. Расшифровывает данные с использованием созданного объекта расшифрования.

    ASCII flowchart:
    Данные, Ключ
    ↓
    Создание объекта расшифрования AES (CBC, IV=0)
    ↓
    Расшифровка данных

    Примеры:
        >>> key = b'\\x00' * 16
        >>> data = b'test data here'
        >>> encrypted_data = aes_cbc_encrypt(data, key)
        >>> decrypted_data = aes_cbc_decrypt(encrypted_data, key)
        >>> decrypted_data
        b'test data here'
    """
    ...
```

### `aes_cbc_decrypt_a32`

```python
def aes_cbc_decrypt_a32(data, key):
    """Расшифровывает данные, представленные в виде массива 32-битных целых чисел, с использованием AES в режиме CBC.

    Args:
        data (list[int]): Данные для расшифровки в виде массива 32-битных целых чисел.
        key (list[int]): Ключ расшифровки в виде массива 32-битных целых чисел.

    Returns:
        tuple[int]: Расшифрованные данные в виде массива 32-битных целых чисел.

    Как работает функция:
    1.  Преобразует входные массивы 32-битных целых чисел `data` и `key` в строки байтов с использованием функции `a32_to_str`.
    2.  Расшифровывает полученную строку байтов с помощью функции `aes_cbc_decrypt`, используя преобразованный ключ.
    3.  Преобразует расшифрованную строку байтов обратно в массив 32-битных целых чисел с использованием функции `str_to_a32`.

    ASCII flowchart:
    data: list[int], key: list[int]
    ↓
    a32_to_str(data), a32_to_str(key)
    ↓
    aes_cbc_decrypt(data, key)
    ↓
    str_to_a32(decrypted_data)
    ↓
    return decrypted_data: tuple[int]

    Примеры:
        >>> data = [1, 2, 3]
        >>> key = [4, 5, 6]
        >>> encrypted_data = aes_cbc_encrypt_a32(data, key)
        >>> decrypted_data = aes_cbc_decrypt_a32(encrypted_data, key)
        >>> decrypted_data
        (1, 2, 3)
    """
    ...
```

### `base64urldecode`

```python
def base64urldecode(data):
    """Декодирует строку из формата Base64 URL.

    Args:
        data (str): Строка для декодирования.

    Returns:
        bytes: Декодированная строка байтов.

    Как работает функция:
     1. Функция принимает на вход строку в формате Base64 URL.
     2. Добавляет необходимое количество символов `=` для корректной работы Base64.
     3. Заменяет символы `-`, `_` и `,` на `+`, `/` и пустую строку соответственно.
     4. Декодирует строку с использованием `base64.b64decode`.

    ASCII flowchart:
    Строка Base64 URL
    ↓
    Добавление '='
    ↓
    Замена символов
    ↓
    Декодирование Base64

    Примеры:
        >>> base64urldecode('YTBi')
        b'a0b'
    """
    ...
```

### `base64_to_a32`

```python
def base64_to_a32(s):
    """Декодирует строку из формата Base64 URL и преобразует в массив 32-битных целых чисел.

    Args:
        s (str): Строка для декодирования.

    Returns:
        tuple[int]: Массив 32-битных целых чисел.

    Как работает функция:
     1. Функция принимает на вход строку в формате Base64 URL.
     2. Декодирует строку с использованием `base64urldecode`.
     3. Преобразует полученную строку байтов в массив 32-битных целых чисел с использованием `str_to_a32`.

    ASCII flowchart:
    Строка Base64 URL
    ↓
    Декодирование Base64 URL
    ↓
    Преобразование в массив 32-битных целых чисел

    Примеры:
        >>> base64_to_a32('AQID')
        (65537,)
    """
    ...
```

### `base64urlencode`

```python
def base64urlencode(data):
    """Кодирует строку байтов в формат Base64 URL.

    Args:
        data (bytes): Строка байтов для кодирования.

    Returns:
        str: Закодированная строка в формате Base64 URL.

    Как работает функция:
     1. Функция принимает на вход строку байтов.
     2. Кодирует строку с использованием `base64.b64encode`.
     3. Заменяет символы `+`, `/` и `=` на `-`, `_` и пустую строку соответственно.

    ASCII flowchart:
    Строка байтов
    ↓
    Кодирование Base64
    ↓
    Замена символов

    Примеры:
        >>> base64urlencode(b'test')
        'dGVzdA'
    """
    ...
```

### `a32_to_base64`

```python
def a32_to_base64(a):
    """Преобразует массив 32-битных целых чисел в строку Base64 URL.

    Args:
        a (list[int]): Массив 32-битных целых чисел.

    Returns:
        str: Строка в формате Base64 URL.

    Как работает функция:
     1. Функция принимает на вход массив 32-битных целых чисел.
     2. Преобразует массив в строку байтов с использованием `a32_to_str`.
     3. Кодирует полученную строку в формат Base64 URL с использованием `base64urlencode`.

    ASCII flowchart:
    Массив 32-битных целых чисел
    ↓
    Преобразование в строку байтов
    ↓
    Кодирование Base64 URL

    Примеры:
        >>> a32_to_base64([1, 2, 3])
        'AAAAAQAAAAIAAAAD'
    """
    ...
```

### `get_chunks`

```python
def get_chunks(size):
    """Разбивает размер файла на чанки для скачивания.

    Args:
        size (int): Размер файла в байтах.

    Returns:
        dict: Словарь, где ключ - начальная позиция чанка, значение - размер чанка.

    Как работает функция:
     1. Функция принимает на вход размер файла в байтах.
     2. Определяет размер первого чанка в зависимости от номера итерации.
     3. Разбивает файл на чанки размером 0x20000 * i, где i увеличивается с каждой итерацией, пока не достигнет 8, но не более чем на размер файла.
     4. После этого разбивает остаток файла на чанки размером 0x100000.
     5. Последний чанк может быть меньше 0x100000, чтобы покрыть оставшуюся часть файла.
     6. Возвращает словарь, где ключ - начальная позиция чанка, значение - размер чанка.

    ASCII flowchart:
    Размер файла
    ↓
    Определение размера первого чанка
    ↓
    Разбиение на чанки (0x20000 * i)
    ↓
    Разбиение остатка на чанки (0x100000)
    ↓
    Определение размера последнего чанка
    ↓
    Возврат словаря чанков

    Примеры:
        >>> get_chunks(1000000)
        {0: 131072, 131072: 262144, 393216: 524288, 917504: 82496}
    """
    ...