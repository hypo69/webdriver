# Модуль `product_fields`

## Обзор

Модуль `product_fields` предназначен для работы с полями товаров в PrestaShop. Он предоставляет класс `ProductFields`, который позволяет удобно управлять атрибутами товара, как основными, так и мультиязычными. Модуль включает функциональность для загрузки значений по умолчанию, установки мультиязычных значений, а также преобразования объекта в словарь, пригодный для использования в API PrestaShop.

## Подробнее

Этот модуль является ключевым компонентом для интеграции с API PrestaShop, поскольку он облегчает процесс создания и обновления информации о товарах. Он абстрагирует сложность работы с отдельными полями и мультиязычными значениями, предоставляя простой и понятный интерфейс. `ProductFields` предназначен для представления данных о товаре в формате, совместимом с требованиями PrestaShop API.

## Классы

### `ProductFields`

**Описание**: Класс `ProductFields` предназначен для представления и управления полями товара в формате, требуемом API PrestaShop. Он содержит атрибуты для хранения значений различных полей товара, включая идентификаторы, коды, цены, описания и другие параметры. Класс обеспечивает методы для загрузки значений по умолчанию, установки мультиязычных значений и преобразования данных в формат, пригодный для отправки в API PrestaShop.

**Принцип работы**:

1.  **Инициализация**: При создании экземпляра класса происходит загрузка значений по умолчанию для полей товара из файла `product_fields_default_values.json` и списка полей из файла `fields_list.txt`. Это позволяет инициализировать объект с предопределенным набором параметров.
2.  **Установка значений**: Класс предоставляет сеттеры для каждого поля товара, что позволяет устанавливать и изменять значения атрибутов. Для мультиязычных полей используется метод `_set_multilang_value`, который обеспечивает правильное форматирование данных для разных языков.
3.  **Преобразование в словарь**: Метод `to_dict` преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop. Он исключает поля со значениями `None` или пустой строкой и форматирует мультиязычные поля в требуемый формат.

**Атрибуты**:

*   `presta_fields` (SimpleNamespace): Объект SimpleNamespace, содержащий все поля товара. Инициализируется в методе `__post_init__`.
*   `id_lang` (int): ID языка, используемый по умолчанию для мультиязычных полей. По умолчанию равен 1.

**Методы**:

*   `__post_init__()`: Инициализирует объект после создания экземпляра класса. Вызывает метод `_payload` для загрузки значений по умолчанию.
*   `_payload()`: Загружает значения по умолчанию для полей товара из файлов `fields_list.txt` и `product_fields_default_values.json`.
*   `_set_multilang_value(field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool`: Устанавливает мультиязычное значение для заданного поля.
*   `to_dict() -> Dict[str, Any]`: Преобразует объект `ProductFields` в словарь, пригодный для использования в API PrestaShop.

### `_set_multilang_value`

```python
def _set_multilang_value(self, field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool:
    """
    Устанавливает мультиязычное значение для заданного поля.

    Args:
        field_name (str): Имя поля (например, 'name', 'description').
        value (str): Значение для установки.
        id_lang (Optional[int | str]): ID языка. Если не указан, используется self.id_lan.

    Returns:
        bool: True, если значение успешно установлено, False в случае ошибки.
    """
```

**Назначение**:
Устанавливает мультиязычное значение для указанного поля объекта `ProductFields`.

**Параметры**:

*   `field_name` (str): Имя поля, для которого устанавливается значение.
*   `value` (str): Значение, которое необходимо установить для указанного поля.
*   `id_lang` (Optional[int | str], optional): ID языка, для которого устанавливается значение. Если не указан, используется значение по умолчанию `self.id_lang`. По умолчанию `None`.

**Возвращает**:

*   `bool`: `True`, если значение успешно установлено, `False` в случае ошибки.

**Вызывает исключения**:

*   `Exception`: В случае возникновения ошибки при установке значения в мультиязычное поле.

**Внутренние функции**:

*   `escape_and_strip(text: str) -> str`:
    ```python
       def escape_and_strip(text: str) -> str:
           """
           Очищает и экранирует строку, заменяя символы "'" и '"' на "\\'" и '\\"',
           удаляя пробелы в начале и конце.
           """
    ```
    *   **Назначение**: Очищает и экранирует входную строку.

    *   **Параметры**:
        *   `text` (str): Текст для очистки и экранирования.

    *   **Возвращает**:
        *   `str`: Очищенная и экранированная строка.
*   **Как работает функция**:
    1.  Экранирует специальные символы.
    2.  Заменяет символы кавычек.
    3.  Удаляет пробелы в начале и конце строки.

**Как работает функция**:

1.  Функция `_set_multilang_value` принимает имя поля (`field_name`), значение (`value`) и, опционально, ID языка (`id_lang`).
2.  Сначала вызывается внутренняя функция `escape_and_strip` для очистки и экранирования входного значения.
3.  Если `id_lang` не указан, используется значение `self.id_lang` по умолчанию.
4.  Формируется словарь `lang_data`, содержащий ID языка и значение для установки.
5.  Функция пытается получить текущее значение поля из атрибута `presta_fields`.
6.  Если поле не существует, создается новое поле в `presta_fields` с мультиязычной структурой.
7.  Если поле существует, проверяется, является ли оно словарем с ключом `language`, содержащим список. Если нет, поле перезаписывается с новой мультиязычной структурой.
8.  Если поле имеет правильную структуру, функция пытается обновить значение для указанного языка. Если язык уже существует в списке, его значение обновляется. Если язык не существует, добавляется новая запись в список.
9.  В случае успеха функция возвращает `True`. Если возникает исключение, функция логирует ошибку и возвращает `False`.

```
    Начало
    │
    ├── Очистка и экранирование значения (escape_and_strip)
    │
    ├── Определение ID языка (id_lang)
    │
    ├── Формирование данных о языке (lang_data)
    │
    ├── Получение текущего значения поля
    │   ├── Поле не существует? → Создание нового поля
    │   │   └── Создание словаря с данными о языке
    │   │
    │   └── Поле существует?
    │       ├── Проверка структуры поля → Если структура неправильная, создание нового поля
    │       │   └── Создание словаря с данными о языке
    │       │
    │       └── Обновление или добавление данных о языке в существующий список
    │           ├── Поиск существующего языка
    │           │   ├── Язык найден? → Обновление значения
    │           │   └── Язык не найден? → Добавление нового языка
    │           │
    │           └── Успешное завершение
    │
    └── Завершение
```

**Примеры**:

```python
product_fields = ProductFields()
result = product_fields._set_multilang_value('name', 'Test Product', id_lang=2)
print(result)  # Вывод: True

result = product_fields._set_multilang_value('description', 'Test Description')
print(result)  # Вывод: True
```

## EnumRedirect

```python
class EnumRedirect(Enum):
    """Перечисление для типов редиректов."""
    ERROR_404 = '404'
    REDIRECT_301_PRODUCT = '301-product'
    REDIRECT_302_PRODUCT = '302-product'
    REDIRECT_301_CATEGORY = '301-category'
    REDIRECT_302_CATEGORY = '302-category'
```

**Описание**:
Перечисление `EnumRedirect` определяет возможные типы редиректов для продукта.

**Элементы перечисления**:

*   `ERROR_404`: Указывает на ошибку 404 (страница не найдена).
*   `REDIRECT_301_PRODUCT`: Указывает на постоянный редирект (301) на другой продукт.
*   `REDIRECT_302_PRODUCT`: Указывает на временный редирект (302) на другой продукт.
*   `REDIRECT_301_CATEGORY`: Указывает на постоянный редирект (301) на другую категорию.
*   `REDIRECT_302_CATEGORY`: Указывает на временный редирект (302) на другую категорию.

## EnumCondition

```python
class EnumCondition(Enum):
    """Перечисление для состояний товара."""
    NEW = 'new'
    USED = 'used'
    REFURBISHED = 'refurbished'
```

**Описание**:
Перечисление `EnumCondition` определяет возможные состояния товара.

**Элементы перечисления**:

*   `NEW`: Указывает на новое состояние товара.
*   `USED`: Указывает на бывшее в употреблении состояние товара.
*   `REFURBISHED`: Указывает на восстановленное состояние товара.

## EnumVisibity

```python
class EnumVisibity(Enum):\n    """Перечисление для видимости товара."""
    BOTH = 'both'
    CATALOG = 'catalog'
    SEARCH = 'search'
    NONE = 'none'
```

**Описание**:
Перечисление `EnumVisibity` определяет возможные варианты видимости товара в магазине.

**Элементы перечисления**:

*   `BOTH`: Товар виден и в каталоге, и в результатах поиска.
*   `CATALOG`: Товар виден только в каталоге.
*   `SEARCH`: Товар виден только в результатах поиска.
*   `NONE`: Товар не виден ни в каталоге, ни в результатах поиска.

## EnumProductType

```python
class EnumProductType(Enum):\n    """Перечисление для типов товаров."""
    STANDARD = 'standard'
    PACK = 'pack'
    VIRTUAL = 'virtual'
    COMBINATIONS = 'combinations'
    EMPTY = ''
```

**Описание**:
Перечисление `EnumProductType` определяет возможные типы товаров в магазине.

**Элементы перечисления**:

*   `STANDARD`: Обычный, стандартный товар.
*   `PACK`: Набор (комплект) товаров.
*   `VIRTUAL`: Виртуальный товар (например, электронная книга или услуга).
*   `COMBINATIONS`: Товар с комбинациями (например, одежда разных размеров и цветов).
*   `EMPTY`: Пустой тип товара (возможно, для каких-то специальных случаев).

## Функции

В классе `ProductFields` определено множество property, которые соответствуют полям в таблицах `ps_product` и `ps_product_lang`. Каждое property имеет геттер и сеттер для получения и установки значения соответствующего поля.

### Пример property: `id_product`

```python
    @property
    def id_product(self) -> Optional[int]:
        """ property `ps_product.id_product: int(10) unsigned` """
        return self.presta_fields.id_product

    @id_product.setter
    def id_product(self, value: int = None):\n        """ setter `ID` товара. Для нового товара id назначается из `PrestaShop`. """
        try:
            self.presta_fields.id_product = value
        except Exception as ex:
            logger.error(f"Ошибка при установке id_product:",ex)
```

**Описание**:

Это property представляет поле `id_product` из таблицы `ps_product`.

*   Геттер возвращает текущее значение `id_product`.
*   Сеттер устанавливает значение `id_product`.

**Как работает property**:

1.  При вызове геттера возвращается значение атрибута `id_product` из объекта `presta_fields`.
2.  При вызове сеттера устанавливается значение атрибута `id_product` в объекте `presta_fields`. Если возникает исключение, оно логируется.

### to_dict()

```python
def to_dict(self) -> Dict[str, Any]:
    """
    Преобразует объект ProductFields в словарь для PrestaShop API,
    исключая ключи, значения которых равны None или пустой строке,
    и формирует мультиязычные поля в нужном формате. Все поля должны быть представлены как строки.

    Returns:
        Dict[str, Any]: Словарь с полями, готовый для PrestaShop API.
    """
```

**Назначение**:
Преобразует объект `ProductFields` в словарь, пригодный для отправки в PrestaShop API.

**Параметры**:
*отсутствуют*

**Возвращает**:

*   `Dict[str, Any]`: Словарь с полями объекта `ProductFields`, готовый для использования в PrestaShop API.

**Как работает функция**:

1.  Инициализируется пустой словарь `product_dict`, в который будут добавлены поля товара.
2.  Для каждого поля товара (например, `id_product`, `id_supplier`, `name`, `description` и т.д.) проверяется, установлено ли значение.
3.  Если значение установлено, оно преобразуется в строку с помощью вспомогательной функции `str_val` и добавляется в словарь `product_dict`.
4.  Для мультиязычных полей (например, `name`, `description`, `description_short` и т.д.) вызывается метод `_format_multilang_value` для форматирования значения в требуемый формат.
5.  После обработки всех полей формируется словарь `associations_dict` с ассоциациями (категории, изображения, комбинации и т.д.).
6.  Если словарь `associations_dict` не пустой, он добавляется в словарь `product_dict` под ключом `"associations"`.
7.  В конце функция возвращает словарь `product_dict`.

```
Начало
│
├── Инициализация словаря product_dict
│
├── Обработка полей ps_product
│   ├── Проверка значения поля
│   │   ├── Значение не None? → Преобразование в строку и добавление в product_dict
│   │   └── Значение None? → Пропуск поля
│
├── Обработка полей ps_product_lang
│   ├── Проверка значения поля
│   │   ├── Значение не None? → Форматирование мультиязычного значения и добавление в product_dict
│   │   └── Значение None? → Пропуск поля
│
├── Обработка ассоциаций
│   ├── Инициализация словаря associations_dict
│   ├── Проверка наличия ассоциаций и их значений
│   │   ├── Ассоциации существуют? → Формирование словаря ассоциаций и добавление в associations_dict
│   │   └── Ассоциации не существуют? → Пропуск ассоциаций
│
├── Добавление словаря associations_dict в product_dict (если он не пустой)
│
└── Возврат словаря product_dict
```

**Примеры**:

```python
product_fields = ProductFields()
product_fields.id_product = 123
product_fields.name = "Test Product"
product_dict = product_fields.to_dict()
print(product_dict)