# Модуль для работы с изображениями (g4f.image)

## Обзор

Модуль предоставляет инструменты для обработки изображений, включая конвертацию, проверку формата, изменение размера и кодирование в Data URI. Он использует библиотеку PIL (Pillow) для работы с изображениями и включает поддержку SVG через cairosvg.

## Подробнее

Этот модуль предназначен для обработки различных типов изображений, поступающих из разных источников (файлы, байты, строки Data URI). Он обеспечивает унифицированный интерфейс для работы с изображениями, приводя их к формату PIL Image, а также предоставляет функции для проверки форматов, извлечения данных из Data URI и изменения размеров изображений. Модуль также обрабатывает ориентацию изображения на основе данных EXIF и удаляет прозрачность.

## Функции

### `to_image`

```python
def to_image(image: ImageType, is_svg: bool = False) -> Image:
    """
    Конвертирует входное изображение в объект PIL Image.

    Args:
        image (Union[str, bytes, Image]): Входное изображение.
        is_svg (bool, optional): Указывает, является ли изображение SVG. По умолчанию `False`.

    Returns:
        Image: Конвертированный объект PIL Image.

    Raises:
        MissingRequirementsError: Если отсутствуют необходимые библиотеки (Pillow или cairosvg).
    """
```

**Назначение**: Конвертирует изображение различных форматов (строка, байты, PIL Image) в объект PIL Image.

**Параметры**:
- `image` (ImageType): Изображение для конвертации. Может быть строкой (путь к файлу или Data URI), байтами или объектом PIL Image.
- `is_svg` (bool, optional): Флаг, указывающий, что входное изображение является SVG. По умолчанию `False`.

**Возвращает**:
- `Image`: Объект PIL Image, представляющий входное изображение.

**Вызывает исключения**:
- `MissingRequirementsError`: Если не установлены необходимые библиотеки `pillow` или `cairosvg`.
- `ValueError`: Если Data URI имеет неверный формат или формат изображения не поддерживается.

**Как работает функция**:

1. **Проверка зависимостей**: Убеждается, что установлена библиотека Pillow, необходимая для работы с изображениями.
2. **Обработка Data URI**: Если входное изображение является строкой и начинается с "data:", оно считается Data URI. Проверяется, что Data URI имеет правильный формат изображения, затем извлекаются бинарные данные.
3. **Обработка SVG**: Если `is_svg` равен `True`, пытается импортировать `cairosvg` и конвертировать SVG в PNG.
4. **Обработка байтов**: Если входное изображение является байтами, проверяет, что это изображение в поддерживаемом формате, и открывает его с помощью PIL.
5. **Обработка PIL Image**: Если входное изображение уже является объектом PIL Image, возвращает его без изменений.
6. **Обработка пути к файлу**: Если входное изображение является строкой или `os.PathLike`, открывает файл как изображение.

**ASCII Flowchart**:

```
    Начало
    │
    ├── Проверка Pillow
    │   └── Если Pillow не установлен: MissingRequirementsError
    │
    ├── Проверка типа image
    │   ├── image - строка и начинается с "data:"
    │   │   ├── Проверка Data URI
    │   │   │   └── Если Data URI неверный: ValueError
    │   │   └── Извлечение данных из Data URI
    │   │
    │   ├── image - SVG и is_svg = True
    │   │   ├── Проверка cairosvg
    │   │   │   └── Если cairosvg не установлен: MissingRequirementsError
    │   │   └── Конвертация SVG в PNG
    │   │
    │   ├── image - байты
    │   │   └── Проверка формата изображения
    │   │       └── Если формат не поддерживается: ValueError
    │   │   └── Открытие изображения с помощью PIL
    │   │
    │   ├── image - PIL Image
    │   │   └── Возврат image без изменений
    │   │
    │   └── Открытие файла как изображения с помощью PIL
    │
    └── Возврат PIL Image
```

**Примеры**:

```python
from io import BytesIO
from PIL import Image

# Пример 1: Конвертация из пути к файлу
# image = to_image("path/to/image.png")

# Пример 2: Конвертация из байтов
image_bytes = b'\x89PNG\r\n\x1a\n...'  # Заглушка для PNG-байтов
image = to_image(image_bytes)

# Пример 3: Конвертация из объекта PIL Image
image_pil = Image.new("RGB", (60, 30), color='red')
image = to_image(image_pil)

# Пример 4: Конвертация из Data URI
data_uri = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w+..."  # Заглушка для Data URI
image = to_image(data_uri)
```

### `is_allowed_extension`

```python
def is_allowed_extension(filename: str) -> bool:
    """
    Проверяет, имеет ли заданное имя файла допустимое расширение.

    Args:
        filename (str): Имя файла для проверки.

    Returns:
        bool: True, если расширение допустимо, иначе False.
    """
```

**Назначение**: Проверяет, входит ли расширение файла в список разрешенных.

**Параметры**:
- `filename` (str): Имя файла для проверки.

**Возвращает**:
- `bool`: `True`, если расширение файла входит в список разрешенных, иначе `False`.

**Как работает функция**:

1. **Проверка наличия точки**: Убеждается, что в имени файла есть точка, разделяющая имя и расширение.
2. **Извлечение расширения**: Извлекает расширение файла, приводя его к нижнему регистру.
3. **Проверка расширения**: Проверяет, входит ли расширение в список разрешенных расширений (`ALLOWED_EXTENSIONS`).

**ASCII Flowchart**:

```
    Начало
    │
    ├── Проверка наличия точки в имени файла
    │   └── Если точки нет: Возврат False
    │
    ├── Извлечение расширения файла
    │
    └── Проверка расширения в ALLOWED_EXTENSIONS
    │   ├── Если расширение разрешено: Возврат True
    │   └── Иначе: Возврат False
    │
    Конец
```

**Примеры**:

```python
# Пример 1: Разрешенное расширение
filename = "image.png"
is_allowed = is_allowed_extension(filename)
print(is_allowed)  # Вывод: True

# Пример 2: Неразрешенное расширение
filename = "document.txt"
is_allowed = is_allowed_extension(filename)
print(is_allowed)  # Вывод: False
```

### `is_data_uri_an_image`

```python
def is_data_uri_an_image(data_uri: str) -> bool:
    """
    Проверяет, представляет ли данный Data URI изображение.

    Args:
        data_uri (str): Data URI для проверки.

    Raises:
        ValueError: Если Data URI недействителен или формат изображения не разрешен.
    """
```

**Назначение**: Проверяет, является ли строка Data URI изображением и имеет ли допустимый формат.

**Параметры**:
- `data_uri` (str): Строка Data URI для проверки.

**Вызывает исключения**:
- `ValueError`: Если Data URI имеет неверный формат или формат изображения не поддерживается.

**Как работает функция**:

1. **Проверка формата Data URI**: Проверяет, начинается ли строка с `data:image/` и содержит ли информацию о формате изображения.
2. **Извлечение формата изображения**: Извлекает формат изображения из Data URI.
3. **Проверка формата изображения**: Проверяет, входит ли формат изображения в список разрешенных форматов (`ALLOWED_EXTENSIONS`) или является ли он `svg+xml`.

**ASCII Flowchart**:

```
    Начало
    │
    ├── Проверка формата Data URI (data:image/...)
    │   └── Если формат неверный: ValueError
    │
    ├── Извлечение формата изображения
    │
    └── Проверка формата изображения в ALLOWED_EXTENSIONS или svg+xml
    │   └── Если формат не разрешен: ValueError
    │
    Конец
```

**Примеры**:

```python
# Пример 1: Правильный Data URI
data_uri = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w+..."
#is_data_uri_an_image(data_uri)  # Вывод: (не вызывает исключение)

# Пример 2: Неправильный Data URI (не начинается с data:image/)
data_uri = "text/plain;base64,SGVsbG8gV29ybGQh"
#is_data_uri_an_image(data_uri)  # Вывод: ValueError: Invalid data URI image.

# Пример 3: Неподдерживаемый формат изображения
data_uri = "data:image/tiff;base64,AAAA"
#is_data_uri_an_image(data_uri)  # Вывод: ValueError: Invalid image format (from mime file type).
```

### `is_accepted_format`

```python
def is_accepted_format(binary_data: bytes) -> str:
    """
    Проверяет, представляет ли заданный бинарный код изображение в принятом формате.

    Args:
        binary_data (bytes): Бинарные данные для проверки.

    Raises:
        ValueError: Если формат изображения не разрешен.
    """
```

**Назначение**: Определяет формат изображения по его бинарным данным (magic numbers) и проверяет, является ли формат допустимым.

**Параметры**:
- `binary_data` (bytes): Бинарные данные изображения.

**Возвращает**:
- `str`: MIME-тип изображения (например, "image/jpeg", "image/png").

**Вызывает исключения**:
- `ValueError`: Если формат изображения не распознан или не является допустимым.

**Как работает функция**:

1. **Проверка JPEG**: Проверяет, начинается ли с `\xFF\xD8\xFF`.
2. **Проверка PNG**: Проверяет, начинается ли с `\x89PNG\r\n\x1a\n`.
3. **Проверка GIF**: Проверяет, начинается ли с `GIF87a` или `GIF89a`.
4. **Проверка JFIF**: Проверяет, начинается ли с `\x89JFIF` или `JFIF\x00`.
5. **Проверка JPEG (альтернативный вариант)**: Проверяет, начинается ли с `\xFF\xD8`.
6. **Проверка WEBP**: Проверяет, начинается ли с `RIFF` и содержит ли `WEBP` в определенных позициях.
7. **Неизвестный формат**: Если ни один из форматов не распознан, вызывает исключение `ValueError`.

**ASCII Flowchart**:

```
    Начало
    │
    ├── Проверка JPEG (\xFF\xD8\xFF)
    │   └── Если JPEG: Возврат "image/jpeg"
    │
    ├── Проверка PNG (\x89PNG\r\n\x1a\n)
    │   └── Если PNG: Возврат "image/png"
    │
    ├── Проверка GIF (GIF87a или GIF89a)
    │   └── Если GIF: Возврат "image/gif"
    │
    ├── Проверка JFIF (\x89JFIF или JFIF\x00)
    │   └── Если JFIF: Возврат "image/jpeg"
    │
    ├── Проверка JPEG (\xFF\xD8)
    │   └── Если JPEG: Возврат "image/jpeg"
    │
    ├── Проверка WEBP (RIFF...WEBP)
    │   └── Если WEBP: Возврат "image/webp"
    │
    └── Формат не распознан: ValueError
    │
    Конец
```

**Примеры**:

```python
# Пример 1: JPEG
jpeg_data = b'\xFF\xD8\xFF...'  # Заглушка для JPEG-байтов
format = is_accepted_format(jpeg_data)
print(format)  # Вывод: image/jpeg

# Пример 2: PNG
png_data = b'\x89PNG\r\n\x1a\n...'  # Заглушка для PNG-байтов
format = is_accepted_format(png_data)
print(format)  # Вывод: image/png

# Пример 3: Неизвестный формат
unknown_data = b'AAAA'
#format = is_accepted_format(unknown_data)  # Вывод: ValueError: Invalid image format (from magic code).
```

### `extract_data_uri`

```python
def extract_data_uri(data_uri: str) -> bytes:
    """
    Извлекает двоичные данные из заданного Data URI.

    Args:
        data_uri (str): Data URI.

    Returns:
        bytes: Извлеченные двоичные данные.
    """
```

**Назначение**: Извлекает бинарные данные из Data URI.

**Параметры**:
- `data_uri` (str): Строка Data URI.

**Возвращает**:
- `bytes`: Бинарные данные, извлеченные из Data URI.

**Как работает функция**:

1. **Разделение Data URI**: Разделяет строку Data URI по запятой, чтобы отделить метаданные от данных.
2. **Извлечение данных**: Извлекает часть данных (после последней запятой).
3. **Декодирование Base64**: Декодирует данные из Base64 в бинарный формат.

**ASCII Flowchart**:

```
    Начало
    │
    ├── Разделение Data URI по запятой
    │
    ├── Извлечение данных (после последней запятой)
    │
    └── Декодирование Base64
    │
    Конец
```

**Примеры**:

```python
# Пример 1: Извлечение данных из Data URI
data_uri = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w+..."
binary_data = extract_data_uri(data_uri)
print(type(binary_data))  # Вывод: <class 'bytes'>
```

### `get_orientation`

```python
def get_orientation(image: Image) -> int:
    """
    Получает ориентацию заданного изображения.

    Args:
        image (Image): Изображение.

    Returns:
        int: Значение ориентации.
    """
```

**Назначение**: Получает ориентацию изображения из метаданных EXIF.

**Параметры**:
- `image` (Image): Объект PIL Image.

**Возвращает**:
- `int | None`: Значение ориентации изображения или `None`, если ориентация не найдена.

**Как работает функция**:

1. **Получение данных EXIF**: Пытается получить данные EXIF из изображения.
2. **Извлечение ориентации**: Извлекает значение тега ориентации (274) из данных EXIF.

**ASCII Flowchart**:

```
    Начало
    │
    ├── Получение данных EXIF из изображения
    │   └── Если изображение не имеет атрибута getexif или _getexif: Возврат None
    │
    ├── Извлечение тега ориентации (274) из данных EXIF
    │   └── Если тег ориентации не найден: Возврат None
    │
    Конец
```

**Примеры**:

```python
from PIL import Image

# Пример 1: Получение ориентации изображения
image = Image.new("RGB", (60, 30), color='red')
orientation = get_orientation(image)
print(orientation)  # Вывод: None (если EXIF отсутствует)
```

### `process_image`

```python
def process_image(image: Image, new_width: int, new_height: int) -> Image:
    """
    Обрабатывает заданное изображение, корректируя его ориентацию и изменяя размер.

    Args:
        image (Image): Изображение для обработки.
        new_width (int): Новая ширина изображения.
        new_height (int): Новая высота изображения.

    Returns:
        Image: Обработанное изображение.
    """
```

**Назначение**: Обрабатывает изображение, корректируя ориентацию на основе данных EXIF, изменяя его размер и удаляя прозрачность (если есть).

**Параметры**:
- `image` (Image): Объект PIL Image для обработки.
- `new_width` (int): Новая ширина изображения.
- `new_height` (int): Новая высота изображения.

**Возвращает**:
- `Image`: Обработанное изображение.

**Как работает функция**:

1. **Коррекция ориентации**: Получает ориентацию изображения и применяет необходимые повороты и отражения.
2. **Изменение размера**: Изменяет размер изображения до указанных `new_width` и `new_height`.
3. **Удаление прозрачности**: Если изображение имеет прозрачность (RGBA), создает новое изображение RGB с белым фоном и вставляет исходное изображение.
4. **Конвертация в RGB**: Если изображение не в формате RGB, конвертирует его в формат RGB.

**ASCII Flowchart**:

```
    Начало
    │
    ├── Получение ориентации изображения
    │   └── Если ориентация найдена:
    │       └── Коррекция ориентации (поворот/отражение)
    │
    ├── Изменение размера изображения (thumbnail)
    │
    ├── Проверка режима изображения (RGBA)
    │   └── Если RGBA:
    │       └── Создание нового RGB-изображения с белым фоном
    │       └── Вставка исходного изображения на белый фон
    │
    ├── Проверка режима изображения (RGB)
    │   └── Если не RGB:
    │       └── Конвертация в RGB
    │
    Конец
```

**Примеры**:

```python
from PIL import Image

# Пример 1: Обработка изображения
image = Image.new("RGBA", (100, 100), color=(255, 0, 0, 128))  # Прозрачный красный
new_image = process_image(image, 50, 50)
#new_image.show()
```

### `to_bytes`

```python
def to_bytes(image: ImageType) -> bytes:
    """
    Конвертирует заданное изображение в байты.

    Args:
        image (ImageType): Изображение для преобразования.

    Returns:
        bytes: Изображение в виде байтов.
    """
```

**Назначение**: Конвертирует изображение любого поддерживаемого типа в байты.

**Параметры**:
- `image` (ImageType): Изображение для конвертации (строка, байты, PIL Image, Path).

**Возвращает**:
- `bytes`: Изображение в виде байтов.

**Как работает функция**:

1. **Проверка типа**: Определяет тип входного изображения.
2. **Обработка байтов**: Если это байты, возвращает их без изменений.
3. **Обработка Data URI**: Если это Data URI, извлекает бинарные данные.
4. **Обработка PIL Image**: Если это PIL Image, сохраняет его в BytesIO и получает байты.
5. **Обработка пути к файлу**: Если это путь к файлу (str или Path), читает файл и возвращает байты.
6. **Чтение из объекта**: В противном случае пытается прочитать данные из объекта (например, файлового потока).

**ASCII Flowchart**:

```
    Начало
    │
    ├── Проверка типа image
    │   ├── image - байты: Возврат image
    │   ├── image - Data URI: Извлечение данных из Data URI и возврат
    │   ├── image - PIL Image: Сохранение в BytesIO и возврат байтов
    │   ├── image - путь к файлу (str или Path): Чтение файла и возврат байтов
    │   └── Попытка чтения из объекта (image.read())
    │
    Конец
```

**Примеры**:

```python
from PIL import Image
from io import BytesIO

# Пример 1: Конвертация PIL Image в байты
image = Image.new("RGB", (60, 30), color='red')
image_bytes = to_bytes(image)
print(type(image_bytes))  # Вывод: <class 'bytes'>

# Пример 2: Конвертация пути к файлу в байты
# image_bytes = to_bytes("path/to/image.png")

# Пример 3: Конвертация Data URI в байты
data_uri = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w+..."
image_bytes = to_bytes(data_uri)
print(type(image_bytes))  # Вывод: <class 'bytes'>
```

### `to_data_uri`

```python
def to_data_uri(image: ImageType) -> str:
    """
    Преобразует заданное изображение в Data URI.

    Args:
        image (ImageType): Изображение для преобразования.

    Returns:
        str: Изображение в виде Data URI.
    """
```

**Назначение**: Конвертирует изображение в формат Data URI.

**Параметры**:
- `image` (ImageType): Изображение для конвертации (строка, байты, PIL Image, Path).

**Возвращает**:
- `str`: Изображение в формате Data URI.

**Как работает функция**:

1. **Проверка типа**: Если изображение уже является строкой, возвращает его.
2. **Конвертация в байты**: Конвертирует изображение в байты с помощью `to_bytes`.
3. **Кодирование Base64**: Кодирует байты в Base64.
4. **Формирование Data URI**: Формирует строку Data URI с MIME-типом и закодированными данными.

**ASCII Flowchart**:

```
    Начало
    │
    ├── Проверка типа image
    │   ├── image - строка: Возврат image
    │   └── Конвертация в байты (to_bytes)
    │
    ├── Кодирование Base64
    │
    ├── Определение MIME-типа
    │
    └── Формирование Data URI
    │
    Конец
```

**Примеры**:

```python
from PIL import Image

# Пример 1: Конвертация PIL Image в Data URI
image = Image.new("RGB", (60, 30), color='red')
data_uri = to_data_uri(image)
print(data_uri[:50])  # Вывод: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAF...

# Пример 2: Конвертация пути к файлу в Data URI
# data_uri = to_data_uri("path/to/image.png")
```

## Классы

### `ImageDataResponse`

```python
class ImageDataResponse():
    """
    Представляет ответ с данными изображения.

    Attributes:
        images (Union[str, list]): Изображения (строка или список строк).
        alt (str): Альтернативный текст для изображения.
    """
    def __init__(
        self,
        images: Union[str, list],
        alt: str,
    ):
        self.images = images
        self.alt = alt

    def get_list(self) -> list[str]:
        return [self.images] if isinstance(self.images, str) else self.images
```

**Описание**: Класс представляет собой контейнер для хранения данных об изображении, таких как URL изображения и альтернативный текст. Он предоставляет метод для получения списка URL изображений.

**Атрибуты**:
- `images` (Union[str, list]): URL изображения или список URL изображений.
- `alt` (str): Альтернативный текст для изображения.

**Методы**:
- `get_list`(): Возвращает список URL изображений. Если `images` является строкой, он будет преобразован в список, содержащий только эту строку.

### `ImageRequest`

```python
class ImageRequest():
    """
    Представляет запрос изображения с параметрами.

    Attributes:
        options (dict): Словарь с параметрами запроса.
    """
    def __init__(
        self,
        options: dict = {}
    ):
        self.options = options

    def get(self, key: str):
        return self.options.get(key)
```

**Описание**: Класс представляет собой контейнер для хранения параметров запроса изображения. Он предоставляет метод для получения значения параметра по ключу.

**Атрибуты**:
- `options` (dict): Словарь, содержащий параметры запроса.

**Методы**:
- `get(key: str)`: Возвращает значение параметра из словаря `options` по заданному ключу. Если ключ отсутствует, возвращает `None`.

```