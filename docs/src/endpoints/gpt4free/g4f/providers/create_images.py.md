# Модуль для создания изображений на основе текстовых запросов
## Обзор

Модуль `create_images.py` предназначен для расширения функциональности провайдеров в проекте `hypotez`, позволяя им генерировать изображения на основе текстовых запросов, встроенных в сообщения. Он содержит класс `CreateImagesProvider`, который обрабатывает запросы на создание изображений, используя предоставленные функции для создания изображений как в синхронном, так и в асинхронном режимах.

## Подробней

Этот модуль позволяет интегрировать генерацию изображений непосредственно в процесс обработки текстовых сообщений. Он анализирует сообщения на наличие специальных тегов `<img data-prompt="...">`, содержащих текстовые запросы для генерации изображений. Затем он использует предоставленные функции `create_images` и `create_async` для создания изображений на основе этих запросов и включает сгенерированные изображения в выходные данные.

## Классы

### `CreateImagesProvider`

**Описание**: Класс провайдера для создания изображений на основе текстовых запросов.

**Принцип работы**:
   - Класс `CreateImagesProvider` инициализируется с указанием базового провайдера, функций для синхронного и асинхронного создания изображений, системного сообщения и флага для включения заполнителя изображения.
   - При получении запроса на создание завершения (completion), он анализирует сообщения на наличие тегов `<img data-prompt="...">`.
   - Для каждого найденного тега он извлекает текстовый запрос и использует функцию `create_images` (синхронно) или `create_async` (асинхронно) для создания изображения.
   - Сгенерированное изображение включается в выходные данные вместо тега запроса.

**Атрибуты**:

- `provider` (ProviderType): Базовый провайдер для обработки задач, не связанных с изображениями.
- `create_images` (callable): Функция для синхронного создания изображений.
- `create_images_async` (callable): Функция для асинхронного создания изображений.
- `system_message` (str): Системное сообщение, объясняющее возможность создания изображений.
- `include_placeholder` (bool): Флаг, определяющий, следует ли включать заполнитель изображения в вывод.
- `__name__` (str): Имя провайдера.
- `url` (str): URL провайдера.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу.

**Методы**:

- `__init__`: Инициализирует экземпляр класса `CreateImagesProvider`.
- `create_completion`: Создает результат завершения, обрабатывая все запросы на создание изображений, найденные в сообщениях.
- `create_async`: Асинхронно создает ответ, обрабатывая все запросы на создание изображений, найденные в сообщениях.

## Функции

### `__init__`

```python
def __init__(
        self,
        provider: ProviderType,
        create_images: callable,
        create_async: callable,
        system_message: str = system_message,
        include_placeholder: bool = True
    ) -> None:
    """
    Инициализирует CreateImagesProvider.

    Args:
        provider (ProviderType): Базовый провайдер.
        create_images (callable): Функция для синхронного создания изображений.
        create_async (callable): Функция для асинхронного создания изображений.
        system_message (str, optional): Системное сообщение, которое будет добавлено в начало сообщений. По умолчанию используется предопределенное сообщение.
        include_placeholder (bool, optional): Определяет, следует ли включать заполнители изображений в вывод. По умолчанию True.
    """
```

**Назначение**: Инициализация класса `CreateImagesProvider`

**Параметры**:

- `provider` (ProviderType): Базовый провайдер, который будет использоваться для выполнения задач, не связанных с генерацией изображений.
- `create_images` (callable): Функция, вызываемая для синхронного создания изображений на основе текстового запроса.
- `create_async` (callable): Функция, вызываемая для асинхронного создания изображений на основе текстового запроса.
- `system_message` (str, optional): Сообщение, которое будет добавлено в начало списка сообщений для указания модели, что она может генерировать изображения. По умолчанию используется значение `system_message`, определенное в модуле.
- `include_placeholder` (bool, optional): Флаг, указывающий, следует ли включать исходный текст запроса изображения в возвращаемый результат. По умолчанию `True`.

**Возвращает**:
- `None`

**Вызывает исключения**:
- Отсутствуют

**Как работает функция**:

1. Функция инициализирует класс `CreateImagesProvider`, присваивая переданные аргументы соответствующим атрибутам экземпляра класса.

ASCII flowchart:

```
A [Присваивание базового провайдера]
↓
B [Присваивание функции для синхронного создания изображений]
↓
C [Присваивание функции для асинхронного создания изображений]
↓
D [Присваивание системного сообщения]
↓
E [Присваивание флага для включения заполнителя изображения]
↓
F [Присваивание имени провайдера]
↓
G [Присваивание URL провайдера]
↓
H [Присваивание статуса работы провайдера]
↓
I [Присваивание флага поддержки потоковой передачи]
```

**Примеры**:

```python
# Пример инициализации CreateImagesProvider с базовым провайдером, функциями создания изображений и системным сообщением
provider = SomeBaseProvider()
create_images_func = lambda prompt: f"Image data for prompt: {prompt}"
create_async_func = lambda prompt: asyncio.Future(f"Async image data for prompt: {prompt}")
image_provider = CreateImagesProvider(provider, create_images_func, create_async_func, system_message="You can generate images.")

# Пример инициализации CreateImagesProvider с использованием значений по умолчанию для system_message и include_placeholder
image_provider_default = CreateImagesProvider(provider, create_images_func, create_async_func)
```

### `create_completion`

```python
def create_completion(
        self,
        model: str,
        messages: Messages,
        stream: bool = False,
        **kwargs
    ) -> CreateResult:
    """
    Создает результат завершения, обрабатывая все запросы на создание изображений, найденные в сообщениях.

    Args:
        model (str): Модель для использования при создании.
        messages (Messages): Сообщения для обработки, которые могут содержать запросы изображений.
        stream (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию False.
        **kwargs: Дополнительные аргументы ключевого слова для провайдера.

    Yields:
        CreateResult: Выдает части обработанных сообщений, включая данные изображения, если применимо.

    Note:
        Этот метод обрабатывает сообщения для обнаружения запросов на создание изображений. Когда такой запрос найден,
        он вызывает синхронную функцию создания изображений и включает результирующее изображение в выходные данные.
    """
```

**Назначение**: Метод `create_completion` предназначен для создания результата завершения (completion), который может включать сгенерированные изображения на основе текстовых запросов, найденных в сообщениях.

**Параметры**:

- `model` (str): Идентификатор модели, которая будет использоваться для создания завершения.
- `messages` (Messages): Список сообщений, которые необходимо обработать. Эти сообщения могут содержать текстовые запросы для генерации изображений, заключенные в специальные теги.
- `stream` (bool, optional): Флаг, указывающий, следует ли возвращать результат в виде потока (yield). По умолчанию имеет значение `False`.
- `**kwargs`: Дополнительные именованные аргументы, которые могут быть переданы базовому провайдеру.

**Возвращает**:

- `CreateResult`: Yields фрагменты обработанных сообщений, включая сгенерированные изображения, если они были запрошены в сообщениях.

**Вызывает исключения**:

- Отсутствуют

**Как работает функция**:

1.  **Добавление системного сообщения**: В начало списка сообщений добавляется системное сообщение (`self.system_message`), которое информирует модель о возможности генерации изображений.
2.  **Инициализация буфера**: Создается пустая строка `buffer`, которая будет использоваться для накопления фрагментов сообщений.
3.  **Обработка фрагментов сообщений**:
    *   Функция итерируется по фрагментам сообщений, полученным от базового провайдера (`self.provider.create_completion`).
    *   Если фрагмент является экземпляром `ImageResponse`, он немедленно возвращается.
    *   Если фрагмент является строкой и либо `buffer` не пуст, либо фрагмент содержит символ `<`, то фрагмент добавляется к `buffer`.
    *   Если `buffer` содержит символ `>`, это означает, что в буфере может находиться тег запроса изображения.
    *   Функция пытается найти в `buffer` тег `<img data-prompt="(.*?)">`, используя регулярное выражение.
    *   Если тег найден:
        *   Извлекается заполнитель (placeholder) и текстовый запрос (prompt) из тега.
        *   Строка `buffer` разделяется на три части: `start` (до тега), `placeholder` (сам тег) и `append` (после тега).
        *   Если `start` не пуст, он возвращается.
        *   Если `self.include_placeholder` имеет значение `True`, то возвращается `placeholder`.
        *   Вызывается функция `self.create_images` для генерации изображения на основе `prompt`. Результат генерации возвращается.
        *   Если `append` не пуст, он возвращается.
        *   `buffer` очищается.
    *   Если тег не найден, то `buffer` возвращается и очищается.
    *   Если фрагмент не является строкой или не содержит символ `<`, то он немедленно возвращается.

ASCII flowchart:

```
A [Добавление системного сообщения в начало списка сообщений]
↓
B [Инициализация буфера]
↓
C [Получение фрагмента сообщения от базового провайдера]
│
├── D [Фрагмент является ImageResponse?]
│   └── Да: E [Возврат фрагмента]
│   └── Нет:
│       ├── F [Фрагмент является строкой и (буфер не пуст или фрагмент содержит '<')?]
│       │   └── Да: G [Добавление фрагмента в буфер]
│       │       ↓
│       │       ├── H [Буфер содержит '>']
│       │       │   └── Да:
│       │       │       ├── I [Поиск тега <img data-prompt="(.*?)"> в буфере]
│       │       │       │   └── Тег найден:
│       │       │       │       ├── J [Разделение буфера на start, placeholder и append]
│       │       │       │       ├── K [start не пуст?]
│       │       │       │       │   └── Да: L [Возврат start]
│       │       │       │       │   └── Нет: ...
│       │       │       │       ├── M [self.include_placeholder == True?]
│       │       │       │       │   └── Да: N [Возврат placeholder]
│       │       │       │       │   └── Нет: ...
│       │       │       │       ├── O [Вызов self.create_images(prompt) и возврат результата]
│       │       │       │       ├── P [append не пуст?]
│       │       │       │       │   └── Да: Q [Возврат append]
│       │       │       │       │   └── Нет: ...
│       │       │       │       └── R [Очистка буфера]
│       │       │       │   └── Тег не найден: S [Возврат буфера]
│       │       │       │       └── T [Очистка буфера]
│       │       │       └── Нет: ...
│       │       └── Нет: E [Возврат фрагмента]
│
```

**Примеры**:

```python
# Пример использования create_completion с моковым провайдером
class MockProvider:
    def create_completion(self, model, messages, stream, **kwargs):
        yield "Hello, "
        yield '<img data-prompt="a cat">'
        yield "!"

def create_image(prompt):
    return [f"Image of {prompt}"]

mock_provider = MockProvider()
image_provider = CreateImagesProvider(mock_provider, create_image, create_image)

result = image_provider.create_completion("test_model", [{"role": "user", "content": "Hello, <img data-prompt='a cat'>!"}])
print(list(result))
# Output: ['Hello, ', '<img data-prompt="a cat">', 'Image of a cat', '!']
```

### `create_async`

```python
async def create_async(
        self,
        model: str,
        messages: Messages,
        **kwargs
    ) -> str:
    """
    Асинхронно создает ответ, обрабатывая все запросы на создание изображений, найденные в сообщениях.

    Args:
        model (str): Модель для использования при создании.
        messages (Messages): Сообщения для обработки, которые могут содержать запросы изображений.
        **kwargs: Дополнительные аргументы ключевого слова для провайдера.

    Returns:
        str: Обработанная строка ответа, включая асинхронно сгенерированные данные изображения, если применимо.

    Note:
        Этот метод обрабатывает сообщения для обнаружения запросов на создание изображений. Когда такой запрос найден,
        он вызывает асинхронную функцию создания изображений и включает результирующее изображение в выходные данные.
    """
```

**Назначение**: Асинхронное создание ответа на основе входящих сообщений с возможностью вставки сгенерированных изображений.

**Параметры**:

- `model` (str): Идентификатор модели, используемой для создания ответа.
- `messages` (Messages): Список сообщений, которые необходимо обработать. Сообщения могут содержать запросы на создание изображений.
- `**kwargs`: Дополнительные именованные аргументы, передаваемые базовому провайдеру.

**Возвращает**:

- `str`: Строка, содержащая обработанный ответ, включая сгенерированные изображения, если они были запрошены.

**Вызывает исключения**:

- Отсутствуют

**Как работает функция**:

1.  **Добавление системного сообщения**: В начало списка сообщений вставляется системное сообщение, которое сообщает модели о возможности генерации изображений.
2.  **Получение ответа от базового провайдера**: Вызывается асинхронный метод `create_async` базового провайдера для получения начального ответа на основе входных сообщений.
3.  **Поиск запросов на создание изображений**: В полученном ответе ищутся теги `<img data-prompt="(.*?)">`, которые указывают на необходимость генерации изображений. Используется регулярное выражение `re.findall`.
4.  **Асинхронная генерация изображений**: Для каждого найденного тега извлекается текстовый запрос (prompt) и вызывается асинхронная функция `self.create_images_async` для генерации соответствующего изображения. Все асинхронные задачи добавляются в список `results`.
5.  **Сбор результатов**: Используется `asyncio.gather` для одновременного выполнения всех задач по генерации изображений и сбора результатов.
6.  **Вставка изображений в ответ**: После получения всех сгенерированных изображений, они вставляются в исходный ответ вместо соответствующих тегов `<img data-prompt="(.*?)">`. Если `self.include_placeholder` имеет значение `True`, то перед каждым изображением вставляется исходный тег запроса.
7.  **Возврат обработанного ответа**: Возвращается строка, содержащая окончательный ответ с вставленными изображениями.

ASCII flowchart:

```
A [Добавление системного сообщения в начало списка сообщений]
↓
B [Получение ответа от базового провайдера]
↓
C [Поиск тегов <img data-prompt="(.*?)"> в ответе]
│
├── D [Найдены теги?]
│   └── Да:
│       ├── E [Для каждого тега: извлечение текстового запроса (prompt)]
│       ├── F [Асинхронный вызов self.create_images_async(prompt)]
│       ├── G [Добавление задачи в список results]
│       ├── H [Сбор результатов с помощью asyncio.gather(*results)]
│       ├── I [Для каждого результата: вставка изображения в ответ вместо тега]
│       └── J [Возврат обработанного ответа]
│   └── Нет:
│       └── J [Возврат обработанного ответа]
```

**Примеры**:

```python
import asyncio

class MockProvider:
    async def create_async(self, model, messages, **kwargs):
        return "Hello, <img data-prompt='a cat'>!"

async def create_image(prompt):
    return f"Image of {prompt}"

async def main():
    mock_provider = MockProvider()
    image_provider = CreateImagesProvider(mock_provider, create_image, create_image)
    result = await image_provider.create_async("test_model", [{"role": "user", "content": "Generate an image of a cat."}])
    print(result)

if __name__ == "__main__":
    asyncio.run(main())
# Output: Hello, Image of a cat!