# Модуль `retry_provider.py`

## Обзор

Модуль `retry_provider.py` предоставляет классы для повторных попыток выполнения запросов к различным провайдерам, если первичная попытка завершилась неудачей. Он содержит реализации для последовательного перебора провайдеров и для повторных попыток с одним и тем же провайдером.

## Подробнее

Этот модуль предоставляет механизмы для обеспечения отказоустойчивости при использовании нескольких провайдеров для генерации контента. Он позволяет автоматически переключаться на другого провайдера в случае неудачи и поддерживает как синхронные, так и асинхронные операции.

## Классы

### `IterListProvider`

**Описание**: Класс `IterListProvider` предназначен для последовательного перебора списка провайдеров и выполнения запроса к каждому из них, пока не будет получен успешный ответ.

**Принцип работы**:

1.  При инициализации класс получает список провайдеров, которые будут использоваться для выполнения запросов.
2.  Метод `create_completion` перебирает провайдеров из списка, выполняет запрос к каждому из них и возвращает результат, если запрос выполнен успешно.
3.  Если запрос к какому-либо провайдеру завершается неудачей, класс переходит к следующему провайдеру в списке.
4.  Если все провайдеры в списке вернули ошибку, класс вызывает исключение `RetryProviderError` или `RetryNoProviderError`.

**Аттрибуты**:

*   `providers` (List[Type[BaseProvider]]): Список провайдеров для использования.
*   `shuffle` (bool): Флаг, указывающий, нужно ли перемешивать список провайдеров.
*   `working` (bool): Флаг, указывающий, работает ли провайдер.
*   `last_provider` (Type[BaseProvider]): Последний использованный провайдер.

**Методы**:

*   `__init__`: Инициализирует экземпляр класса `IterListProvider`.
*   `create_completion`: Создает завершение, используя доступных провайдеров, с возможностью потоковой передачи ответа.
*   `create_async_generator`: Асинхронно создает генератор, используя доступных провайдеров, с возможностью потоковой передачи ответа.
*   `get_create_function`: Возвращает функцию создания завершения.
*   `get_async_create_function`: Возвращает асинхронную функцию создания генератора.
*   `get_providers`: Возвращает список провайдеров, поддерживающих потоковую передачу, исключая провайдеров из списка игнорируемых.

### `RetryProvider`

**Описание**: Класс `RetryProvider` предназначен для повторных попыток выполнения запроса к одному и тому же провайдеру, если первичная попытка завершилась неудачей.

**Принцип работы**:

1.  При инициализации класс получает список провайдеров, флаг для повторных попыток с одним провайдером, и максимальное количество повторных попыток.
2.  Метод `create_completion` пытается выполнить запрос к первому провайдеру в списке указанное количество раз.
3.  Если запрос к провайдеру завершается неудачей после всех попыток, класс вызывает исключение `RetryProviderError` или `RetryNoProviderError`.
4.  Если флаг `single_provider_retry` установлен в `False`, класс использует функциональность родительского класса `IterListProvider` для перебора провайдеров.

**Аттрибуты**:

*   `providers` (List[Type[BaseProvider]]): Список провайдеров для использования.
*   `shuffle` (bool): Флаг, указывающий, нужно ли перемешивать список провайдеров.
*   `single_provider_retry` (bool): Флаг, указывающий, нужно ли повторять попытки только с одним провайдером.
*   `max_retries` (int): Максимальное количество повторных попыток для одного провайдера.
*   `working` (bool): Флаг, указывающий, работает ли провайдер.
*   `last_provider` (Type[BaseProvider]): Последний использованный провайдер.

**Методы**:

*   `__init__`: Инициализирует экземпляр класса `RetryProvider`.
*   `create_completion`: Создает завершение, используя доступных провайдеров, с возможностью повторных попыток и потоковой передачи ответа.
*   `create_async_generator`: Асинхронно создает генератор, используя доступных провайдеров, с возможностью повторных попыток и потоковой передачи ответа.
*   `get_create_function`: Возвращает функцию создания завершения.
*   `get_async_create_function`: Возвращает асинхронную функцию создания генератора.
*   `get_providers`: Возвращает список провайдеров, поддерживающих потоковую передачу, исключая провайдеров из списка игнорируемых.

## Функции

### `raise_exceptions`

```python
def raise_exceptions(exceptions: dict) -> None:
    """
    Вызывает объединенное исключение, если во время повторных попыток возникли какие-либо исключения.

    Args:
        exceptions (dict): Словарь исключений, возникших во время повторных попыток.

    Raises:
        RetryProviderError: Если какой-либо провайдер столкнулся с исключением.
        RetryNoProviderError: Если провайдер не найден.
    """
```

**Назначение**: Функция `raise_exceptions` предназначена для вызова исключения, которое объединяет все исключения, возникшие во время повторных попыток использования различных провайдеров.

**Параметры**:

*   `exceptions` (dict): Словарь, содержащий исключения, возникшие во время попыток. Ключами словаря являются имена провайдеров, а значениями - соответствующие исключения.

**Возвращает**:

*   None

**Вызывает исключения**:

*   `RetryProviderError`: Если во время повторных попыток возникли какие-либо исключения. Содержит сообщение, перечисляющее все провайдеры и соответствующие исключения.
*   `RetryNoProviderError`: Если не было найдено ни одного провайдера.

**Как работает функция**:

1.  Функция проверяет, пуст ли словарь `exceptions`.
2.  Если словарь не пуст, это означает, что во время повторных попыток возникли исключения.
3.  Функция формирует сообщение об ошибке, которое содержит информацию о каждом провайдере и соответствующем исключении.
4.  Вызывается исключение `RetryProviderError` с сформированным сообщением.
5.  Если словарь `exceptions` пуст, вызывается исключение `RetryNoProviderError` с сообщением о том, что провайдер не найден.

```
Проверка наличия исключений
      |
      V
  Словарь исключений пуст?
      |
      ├── Нет → Формирование сообщения об ошибке
      |           |
      |           V
      |       Вызов RetryProviderError с сообщением
      |
      └── Да → Вызов RetryNoProviderError
```

**Примеры**:

Пример 1: Вызов исключения `RetryProviderError`, если во время повторных попыток возникли исключения.

```python
exceptions = {
    "Provider1": ValueError("Invalid value"),
    "Provider2": KeyError("Key not found")
}
try:
    raise_exceptions(exceptions)
except RetryProviderError as ex:
    print(ex)
```

Пример 2: Вызов исключения `RetryNoProviderError`, если не было найдено ни одного провайдера.

```python
exceptions = {}
try:
    raise_exceptions(exceptions)
except RetryNoProviderError as ex:
    print(ex)