# Модуль `FlowGpt`

## Обзор

Модуль `FlowGpt` предоставляет асинхронтный интерфейс для взаимодействия с сервисом FlowGPT для генерации текста. Он поддерживает различные модели, включая GPT-3.5 Turbo, GPT-4 Turbo, Google Gemini и другие. Модуль позволяет отправлять запросы к FlowGPT и получать ответы в виде асинхронного генератора.

## Подробней

Модуль `FlowGpt` является частью проекта `hypotez` и предназначен для обеспечения доступа к различным моделям генерации текста через FlowGPT. Он использует асинхронные запросы для эффективного взаимодействия с API FlowGPT и предоставляет удобный интерфейс для работы с разными моделями и параметрами.

## Классы

### `FlowGpt`

**Описание**: Класс `FlowGpt` реализует асинхронного провайдера для взаимодействия с API FlowGPT.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую структуру для асинхронных провайдеров, возвращающих результаты в виде генератора.
- `ProviderModelMixin`: Добавляет функциональность для работы с моделями, предоставляемыми провайдером.

**Аттрибуты**:
- `url` (str): URL для взаимодействия с FlowGPT.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения ответов от FlowGPT.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        temperature: float = 0.7,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от FlowGPT.

        Args:
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки в FlowGPT.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            temperature (float, optional): Температура генерации. По умолчанию `0.7`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий ответы от FlowGPT.
        """
```

**Назначение**: Создает асинхронный генератор для получения ответов от FlowGPT на основе предоставленных параметров.

**Параметры**:
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки в FlowGPT.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `temperature` (float, optional): Температура генерации. По умолчанию `0.7`.
- `kwargs (dict, optional): Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий ответы от FlowGPT.

**Как работает функция**:

1.  **Получение модели**: Извлекает название модели, используя метод `get_model` класса `FlowGpt`.
2.  **Формирование заголовков**:
    *   Создает метку времени (`timestamp`).
    *   Генерирует случайный шестнадцатеричный код (`nonce`).
    *   Формирует строку данных для подписи, объединяя timestamp, nonce и токен авторизации.
    *   Вычисляет MD5-хеш строки данных для получения подписи (`signature`).
    *   Определяет заголовки HTTP-запроса, включая User-Agent, Referer, Content-Type, Authorization и другие необходимые параметры.

3.  **Подготовка данных для запроса**:
    *   Извлекает историю сообщений из списка `messages`, исключая системные сообщения.
    *   Формирует системное сообщение (`system_message`), объединяя содержимое всех системных сообщений. Если системные сообщения отсутствуют, устанавливает сообщение по умолчанию.
    *   Создает словарь `data`, содержащий параметры запроса, такие как модель, вопрос, историю сообщений, системное сообщение, температуру и другие параметры.

4.  **Отправка запроса и обработка ответа**:
    *   Инициализирует асинхронную сессию `ClientSession` с заданными заголовками.
    *   Отправляет POST-запрос к API FlowGPT (`https://prod-backend-k8s.flowgpt.com/v3/chat-anonymous`) с данными в формате JSON.
    *   Вызывает `raise_for_status` для проверки статуса ответа и выбрасывания исключения в случае ошибки.
    *   Перебирает чанки (фрагменты) ответа, полученные от сервера.
    *   Для каждого чанка проверяет, содержит ли он полезные данные (не является ли пустым).
    *   Загружает JSON из чанка и проверяет наличие ключа "event".
    *   Если "event" равен "text", извлекает данные из ключа "data" и передает их через генератор.

**Внутренние функции**:

Внутри этой функции нет внутренних функций.

**ASII flowchart**:

```
    Начало
    │
    └──> Получение модели (model = cls.get_model(model))
    │
    └──> Формирование заголовков (timestamp, nonce, signature, headers)
    │
    └──> Подготовка данных для запроса (history, system_message, data)
    │
    └──> Отправка POST-запроса к API FlowGPT
    │
    └──> Обработка ответа (перебор чанков, извлечение данных)
    │
    └──> Выдача данных через генератор (yield message["data"])
    │
    Конец
```

**Примеры**:

```python
# Пример вызова функции create_async_generator
messages = [
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "Hello, how are you?"}
]
async def main():
    generator = await FlowGpt.create_async_generator(model="gpt-3.5-turbo", messages=messages)
    async for message in generator:
        print(message)

# Пример использования прокси
messages = [
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "Hello, how are you?"}
]
async def main():
    generator = await FlowGpt.create_async_generator(model="gpt-3.5-turbo", messages=messages, proxy="http://your_proxy:8080")
    async for message in generator:
        print(message)