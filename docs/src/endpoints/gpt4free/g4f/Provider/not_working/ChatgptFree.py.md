# Модуль `ChatgptFree.py`

## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с сервисом ChatgptFree. Он позволяет генерировать текст на основе предоставленных сообщений, используя асинхронные генераторы для потоковой передачи результатов. Модуль предназначен для интеграции в проекты, требующие доступа к моделям GPT через API ChatgptFree.

## Подробнее

Модуль `ChatgptFree` предназначен для асинхронного взаимодействия с сервисом ChatgptFree. Он использует `StreamSession` для выполнения HTTP-запросов и асинхронные генераторы для обработки потоковых данных. Основная задача модуля - отправка запроса с сообщением пользователя и получение сгенерированного ответа от модели ChatgptFree.

Модуль выполняет следующие шаги:

1. **Инициализация сессии:**
   - Создается асинхронная сессия с использованием `StreamSession` для выполнения HTTP-запросов.
   - Устанавливаются заголовки запроса, включая `authority`, `accept`, `accept-language` и другие.
   - Используется прокси, если он предоставлен.

2. **Получение `_post_id` и `_nonce`:**
   - Если `_post_id` и `_nonce` не установлены, модуль выполняет GET-запрос к главной странице (`cls.url`).
   - Извлекает `_post_id` и `_nonce` из HTML-кода страницы с использованием регулярных выражений.

3. **Формирование и отправка запроса:**
   - Форматирует предоставленные сообщения в строку с использованием `format_prompt`.
   - Формирует данные запроса, включая `_wpnonce`, `post_id`, `url`, `action`, `message` и `bot_id`.
   - Отправляет POST-запрос к `f"{cls.url}/wp-admin/admin-ajax.php"` с сформированными данными и cookies.

4. **Обработка потокового ответа:**
   - Читает ответ построчно, используя `response.iter_lines()`.
   - Декодирует каждую строку из байтов в UTF-8 и удаляет пробельные символы.
   - Если строка начинается с `'data: '`, извлекает JSON-данные и пытается их распарсить.
   - Извлекает контент из поля `'content'` в JSON-данных и передает его в генератор.
   - Если строка не начинается с `'data: '`, добавляет её в буфер.

5. **Обработка завершающего буфера:**
   - После завершения потока проверяет, содержит ли буфер данные.
   - Пытается распарсить буфер как JSON и извлечь данные из поля `'data'`, если оно присутствует.

## Классы

### `ChatgptFree`

**Описание**:
Класс `ChatgptFree` предоставляет интерфейс для взаимодействия с ChatgptFree. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`, что позволяет использовать его для асинхронной генерации текста и управления моделями.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для управления моделями.

**Атрибуты**:
- `url` (str): URL-адрес сервиса ChatgptFree.
- `working` (bool): Флаг, указывающий, работает ли сервис.
- `_post_id` (str | None): ID поста для запросов.
- `_nonce` (str | None): Nonce для защиты от CSRF.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения ответов от ChatgptFree.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 120,
        cookies: dict = None,
        **kwargs
    ) -> AsyncGenerator[str, None]:
        """
        Создает асинхронный генератор для получения ответов от ChatgptFree.

        Args:
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
            cookies (dict, optional): Cookies для отправки с запросом. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncGenerator[str, None]: Асинхронный генератор, выдающий текстовые ответы от ChatgptFree.

        Raises:
            RuntimeError: Если не удается найти `post_id` или `nonce` на главной странице.
            Exception: Если возникает ошибка при выполнении HTTP-запроса.
        """
        ...
```

**Назначение**:
Функция `create_async_generator` создает асинхронный генератор, который позволяет получать ответы от ChatgptFree в асинхронном режиме. Она отвечает за установку соединения, отправку запроса и обработку потокового ответа от сервера.

**Параметры**:
- `model` (str): Имя модели, которую нужно использовать для генерации ответа.
- `messages` (Messages): Список сообщений, которые нужно отправить в ChatgptFree.
- `proxy` (str, optional): Адрес прокси-сервера, через который нужно отправлять запросы. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от сервера в секундах. По умолчанию `120`.
- `cookies` (dict, optional): Словарь с cookies, которые нужно отправить вместе с запросом. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в функцию.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор, который выдает текстовые ответы от ChatgptFree.

**Вызывает исключения**:
- `RuntimeError`: Вызывается, если не удается найти `post_id` или `nonce` на главной странице ChatgptFree.
- `Exception`: Вызывается при возникновении ошибок во время выполнения HTTP-запроса.

**Как работает функция**:

1. **Инициализация заголовков и сессии**:
   - Функция начинается с определения необходимых заголовков HTTP-запроса. Эти заголовки включают информацию о браузере, платформе и типе контента.
   - Создается асинхронная сессия с использованием `StreamSession`, которая позволяет отправлять потоковые запросы. Прокси-сервер и время ожидания устанавливаются в соответствии с переданными аргументами.

2. **Получение `_post_id` и `_nonce`**:
   - Проверяется, были ли уже получены значения `_post_id` и `_nonce`. Если нет, функция выполняет GET-запрос к главной странице ChatgptFree.
   - Из полученного HTML-кода извлекаются значения `_post_id` и `_nonce` с использованием регулярных выражений. Если какое-либо из значений не найдено, вызывается исключение `RuntimeError`.

3. **Формирование данных запроса**:
   - Подготавливаются данные для отправки в теле POST-запроса. Это включает форматирование сообщений пользователя с использованием функции `format_prompt`, а также добавление `_wpnonce`, `post_id`, `url`, `action` и `bot_id`.

4. **Отправка POST-запроса и обработка ответа**:
   - Отправляется POST-запрос к указанному URL-адресу (`f"{cls.url}/wp-admin/admin-ajax.php"`) с сформированными данными и cookies.
   - Функция начинает читать ответ построчно в асинхронном режиме. Каждая строка декодируется из байтов в UTF-8.
   - Если строка начинается с `'data: '`, функция пытается извлечь JSON-данные из этой строки и извлечь контент из поля `'content'`. Этот контент передается в асинхронный генератор.
   - Если строка не начинается с `'data: '`, она добавляется в буфер для последующей обработки.

5. **Обработка завершающего буфера**:
   - После завершения чтения потока проверяется, содержит ли буфер какие-либо данные.
   - Если буфер содержит данные, функция пытается распарсить его как JSON и извлечь данные из поля `'data'`. Эти данные также передаются в асинхронный генератор.

```
Инициализация заголовков и сессии
     │
     │
     ▼
Получение _post_id и _nonce
     │
     │
     ▼
Формирование данных запроса
     │
     │
     ▼
Отправка POST-запроса и обработка ответа
     │
     │
     ▼
Обработка завершающего буфера
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import AsyncGenerator, List, Dict

async def main():
    model: str = "gpt-4o-mini-2024-07-18"
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Hello, how are you?"}
    ]
    proxy: str = None
    timeout: int = 120
    cookies: Dict[str, str] = {}

    async def consume_generator(generator: AsyncGenerator[str, None]):
        async for message in generator:
            print(message, end="")

    generator: AsyncGenerator[str, None] = ChatgptFree.create_async_generator(
        model=model, messages=messages, proxy=proxy, timeout=timeout, cookies=cookies
    )

    await consume_generator(generator)

if __name__ == "__main__":
    asyncio.run(main())