# Модуль AiChatOnline

## Обзор

Модуль `AiChatOnline` предоставляет асинхронный интерфейс для взаимодействия с сервисом AiChatOnline для генерации текста на основе предоставленных сообщений. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет функциональность для получения токена и создания асинхронного генератора для получения ответов от модели.

## Подробней

Модуль предназначен для интеграции с другими частями проекта, где требуется взаимодействие с AI-моделью через API AiChatOnline. Он предоставляет удобный интерфейс для отправки сообщений и получения ответов в асинхронном режиме, что позволяет избежать блокировки основного потока выполнения.

## Классы

### `AiChatOnline`

**Описание**: Класс `AiChatOnline` является асинхронным провайдером, предоставляющим методы для взаимодействия с API AiChatOnline.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `site_url` (str): URL сайта AiChatOnline.
- `url` (str): Базовый URL для API AiChatOnline.
- `api_endpoint` (str): Endpoint API для чата с GPT.
- `working` (bool): Флаг, указывающий на работоспособность провайдера (по умолчанию `False`).
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o-mini`).

**Методы**:
- `grab_token`: Асинхронный метод для получения уникального идентификатора пользователя.
- `create_async_generator`: Асинхронный метод для создания генератора, который отправляет сообщения и получает ответы от API AiChatOnline.

## Функции

### `grab_token`

```python
    @classmethod
    async def grab_token(
        cls,
        session: ClientSession,
        proxy: str
    ) -> str:
        """Получает уникальный идентификатор пользователя с использованием предоставленной сессии и прокси.

        Args:
            cls (AiChatOnline): Ссылка на класс `AiChatOnline`.
            session (ClientSession): Асинхронная HTTP-сессия для выполнения запросов.
            proxy (str): Адрес прокси-сервера для использования при запросе.

        Returns:
            str: Уникальный идентификатор пользователя, полученный из ответа API.

        Raises:
            aiohttp.ClientResponseError: Если HTTP-запрос завершается с ошибкой.

        """
```

**Назначение**: Получение уникального идентификатора пользователя для взаимодействия с API AiChatOnline.

**Параметры**:
- `cls`: Ссылка на класс `AiChatOnline`.
- `session` (`ClientSession`): Асинхронная HTTP-сессия для выполнения запросов.
- `proxy` (`str`): Адрес прокси-сервера для использования при запросе.

**Возвращает**:
- `str`: Уникальный идентификатор пользователя, полученный из ответа API.

**Вызывает исключения**:
- `aiohttp.ClientResponseError`: Если HTTP-запрос завершается с ошибкой.

**Как работает функция**:
1. **Выполнение GET-запроса**: Функция отправляет GET-запрос к API AiChatOnline для получения уникального идентификатора пользователя. URL включает случайную строку, сгенерированную с помощью `get_random_string()`.
2. **Обработка ответа**: После получения ответа функция проверяет статус код HTTP-ответа и вызывает исключение `aiohttp.ClientResponseError` в случае ошибки.
3. **Извлечение данных**: Из JSON-ответа извлекается значение ключа `'data'`, которое и является уникальным идентификатором пользователя.
4. **Возврат результата**: Функция возвращает полученный уникальный идентификатор пользователя.

**ASCII flowchart**:

```
A [Создание URL с случайной строкой]
|
B [Выполнение GET-запроса к API]
|
C [Проверка статус кода HTTP-ответа]
|
D [Извлечение 'data' из JSON-ответа]
|
E [Возврат уникального идентификатора]
```

**Примеры**:

```python
import asyncio
from aiohttp import ClientSession

async def main():
    proxy = "http://your_proxy:8080"  # Замените на ваш прокси-сервер
    async with ClientSession() as session:
        token = await AiChatOnline.grab_token(session, proxy)
        print(f"Уникальный идентификатор пользователя: {token}")

if __name__ == "__main__":
    asyncio.run(main())
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с API AiChatOnline.

        Args:
            cls (AiChatOnline): Ссылка на класс `AiChatOnline`.
            model (str): Модель для использования в запросе.
            messages (Messages): Список сообщений для отправки в запросе.
            proxy (str, optional): Адрес прокси-сервера для использования при запросе. По умолчанию `None`.
            **kwargs: Дополнительные именованные аргументы.

        Yields:
            str: Части ответа, полученные от API AiChatOnline.

        Raises:
            aiohttp.ClientResponseError: Если HTTP-запрос завершается с ошибкой.

        """
```

**Назначение**: Создание асинхронного генератора для отправки сообщений и получения ответов от API AiChatOnline.

**Параметры**:
- `cls`: Ссылка на класс `AiChatOnline`.
- `model` (`str`): Модель для использования в запросе.
- `messages` (`Messages`): Список сообщений для отправки в запросе.
- `proxy` (`str`, optional): Адрес прокси-сервера для использования при запросе. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы.

**Yields**:
- `str`: Части ответа, полученные от API AiChatOnline.

**Вызывает исключения**:
- `aiohttp.ClientResponseError`: Если HTTP-запрос завершается с ошибкой.

**Как работает функция**:
1. **Определение заголовков**: Функция определяет заголовки HTTP-запроса, включая `User-Agent`, `Referer`, `Content-Type` и другие необходимые параметры.
2. **Создание асинхронной сессии**: Используется `ClientSession` для создания асинхронной HTTP-сессии с заданными заголовками.
3. **Формирование данных запроса**: Формируются данные запроса, включая `conversationId` (случайная строка) и `prompt` (отформатированные сообщения).
4. **Получение токена**: Вызывается метод `grab_token` для получения уникального идентификатора пользователя.
5. **Выполнение POST-запроса**: Функция отправляет POST-запрос к API AiChatOnline с заголовками и данными.
6. **Обработка ответа**: Для каждого чанка в ответе функция пытается извлечь сообщение из JSON-формата и передать его в генератор. В случае ошибки при обработке JSON, итерация продолжается.
7. **Генерация результата**: Функция генерирует части ответа по мере их получения из API.

**ASCII flowchart**:

```
A [Определение заголовков HTTP-запроса]
|
B [Создание асинхронной сессии]
|
C [Формирование данных запроса]
|
D [Получение токена пользователя]
|
E [Выполнение POST-запроса к API]
|
F [Обработка чанков ответа]
|
G [Извлечение сообщения из JSON]
|
H [Генерация части ответа]
```

**Примеры**:

```python
import asyncio
from aiohttp import ClientSession
from typing import List, Dict, AsyncGenerator

async def main():
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Привет!"}
    ]
    proxy = "http://your_proxy:8080"  # Замените на ваш прокси-сервер

    async def consume_generator(generator: AsyncGenerator[str, None]) -> None:
        async for message in generator:
            print(message, end="")
        print()

    generator = await AiChatOnline.create_async_generator("gpt-4o-mini", messages, proxy)
    await consume_generator(generator)

if __name__ == "__main__":
    asyncio.run(main())