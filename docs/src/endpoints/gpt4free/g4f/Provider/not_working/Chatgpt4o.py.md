# Модуль Chatgpt4o

## Обзор

Модуль `Chatgpt4o` предназначен для асинхронного взаимодействия с провайдером Chatgpt4o через его API. Он включает в себя методы для отправки сообщений и получения ответов от модели, а также для обработки ошибок и управления сессиями.
Модуль входит в состав проекта `hypotez` и предназначен для работы с асинхронными запросами к API.

## Подробней

Модуль `Chatgpt4o` является реализацией асинхронного провайдера для взаимодействия с сервисом Chatgpt4o. Он использует библиотеки `requests` для выполнения HTTP-запросов и `typing` для аннотации типов. В модуле реализованы методы для установки соединения, отправки запросов и обработки ответов от API Chatgpt4o.

## Классы

### `Chatgpt4o`

**Описание**: Класс `Chatgpt4o` представляет собой асинхронный провайдер для взаимодействия с API Chatgpt4o. Он наследует функциональность от `AsyncProvider` и `ProviderModelMixin`, что позволяет ему использовать общие методы и атрибуты для работы с провайдерами и моделями.

**Наследует**:
- `AsyncProvider`: Обеспечивает базовую функциональность для асинхронных провайдеров.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями провайдера.

**Аттрибуты**:
- `url` (str): URL-адрес сервиса Chatgpt4o (`https://chatgpt4o.one`).
- `working` (bool): Флаг, указывающий, работает ли провайдер (по умолчанию `False`).
- `_post_id` (str | None): Идентификатор поста, необходимый для запросов (изначально `None`).
- `_nonce` (str | None): Nonce, необходимый для запросов (изначально `None`).
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o-mini-2024-07-18`).
- `models` (List[str]): Список поддерживаемых моделей (`['gpt-4o-mini-2024-07-18']`).
- `model_aliases` (Dict[str, str]): Псевдонимы моделей, например, `"gpt-4o-mini": "gpt-4o-mini-2024-07-18"`.

**Методы**:
- `create_async()`: Асинхронный метод для создания запроса и получения ответа от API Chatgpt4o.

## Функции

### `create_async`

```python
@classmethod
async def create_async(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    cookies: dict = None,
    **kwargs
) -> str:
    """
    Асинхронно создает запрос к API Chatgpt4o и возвращает ответ.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки в запросе.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
        cookies (dict, optional): Куки для отправки в запросе. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        str: Ответ от API Chatgpt4o.

    Raises:
        RuntimeError: Если не удается получить `post_id` или `nonce`, или если отсутствует поле `data` в ответе.
        Exception: Если во время выполнения запроса произошла ошибка.

    Внутренние функции:
        Нет внутренних функций.
    """
```

**Назначение**:
Функция `create_async` выполняет асинхронный запрос к API Chatgpt4o с использованием предоставленных параметров, таких как модель, сообщения и прокси. Она отвечает за установление соединения, отправку данных и обработку полученного ответа.

**Параметры**:
- `cls`: Ссылка на класс `Chatgpt4o`.
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки в запросе.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
- `cookies` (dict, optional): Куки для отправки в запросе. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `str`: Ответ от API Chatgpt4o.

**Вызывает исключения**:
- `RuntimeError`: Если не удается получить `post_id` или `nonce`, или если отсутствует поле `data` в ответе.

**Как работает функция**:

1. **Определение заголовков**:
   - Функция начинает с определения необходимых заголовков (`headers`) для HTTP-запроса, включая `authority`, `accept`, `origin` и другие параметры, необходимые для взаимодействия с API Chatgpt4o.
2. **Инициализация асинхронной сессии**:
   - Создается асинхронная сессия с использованием `StreamSession` из библиотеки `requests`. В сессию передаются заголовки, куки, настройки прокси и время ожидания.
3. **Получение `post_id` и `nonce` (если необходимо)**:
   - Проверяется, установлены ли `cls._post_id` и `cls._nonce`. Если они не установлены, функция выполняет GET-запрос к главной странице сервиса (`cls.url + "/"`) для извлечения этих значений из HTML-кода страницы.
   - Используются регулярные выражения (`re.search`) для поиска значений `data-post-id` и `data-nonce` в HTML-коде.
   - Если `post_id` или `nonce` не найдены, вызывается исключение `RuntimeError`.
4. **Форматирование запроса**:
   - Форматируются сообщения (`messages`) с использованием функции `format_prompt` для подготовки данных к отправке.
5. **Подготовка данных для POST-запроса**:
   - Создается словарь `data`, содержащий параметры для POST-запроса, такие как `_wpnonce`, `post_id`, `url`, `action`, `message` и `bot_id`.
6. **Выполнение POST-запроса**:
   - Выполняется POST-запрос к адресу `f"{cls.url}/wp-admin/admin-ajax.php"` с использованием асинхронной сессии. В запросе передаются данные (`data`) и куки (`cookies`).
7. **Обработка ответа**:
   - Проверяется статус ответа с использованием `raise_for_status`.
   - Преобразуется ответ в формат JSON (`response_json`).
   - Проверяется наличие поля `data` в JSON-ответе. Если поле отсутствует, вызывается исключение `RuntimeError`.
8. **Возврат данных**:
   - Возвращается значение поля `data` из JSON-ответа.

**ASCII Flowchart**:

```
   Начало
   │
   ├── Заголовки HTTP
   │
   ├── Асинхронная сессия (StreamSession)
   │
   ├── Проверка наличия post_id и nonce
   │   │
   │   └── Если отсутствуют: GET-запрос к главной странице
   │       │
   │       └── Извлечение post_id и nonce из HTML
   │
   ├── Форматирование сообщений (format_prompt)
   │
   ├── Подготовка данных для POST-запроса
   │
   ├── POST-запрос к API
   │
   ├── Обработка ответа
   │   │
   │   └── Проверка статуса ответа
   │
   ├── Преобразование ответа в JSON
   │
   ├── Проверка наличия поля 'data'
   │
   └── Возврат значения поля 'data'
   │
   Конец
```

**Примеры**:

1. **Пример успешного запроса**:

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
model = "gpt-4o-mini-2024-07-18"
response = await Chatgpt4o.create_async(model=model, messages=messages)
print(response)  # Вывод: "I am doing well, thank you for asking!" (пример)
```

2. **Пример запроса с использованием прокси**:

```python
messages = [{"role": "user", "content": "Tell me a joke."}]
model = "gpt-4o-mini-2024-07-18"
proxy = "http://your_proxy:8080"
response = await Chatgpt4o.create_async(model=model, messages=messages, proxy=proxy)
print(response)  # Вывод: "Why don't scientists trust atoms? Because they make up everything!" (пример)
```

3. **Пример запроса с куками**:

```python
messages = [{"role": "user", "content": "What is the capital of France?"}]
model = "gpt-4o-mini-2024-07-18"
cookies = {"session_id": "12345", "user_token": "abcdef"}
response = await Chatgpt4o.create_async(model=model, messages=messages, cookies=cookies)
print(response)  # Вывод: "The capital of France is Paris." (пример)