# Модуль `Airforce`

## Обзор

Модуль `Airforce` предоставляет асинхронный интерфейс для взаимодействия с API Airforce, позволяя генерировать текст и изображения. Он поддерживает потоковую передачу данных и предоставляет методы для фильтрации нежелательного контента. Модуль включает поддержку различных моделей, в том числе `llama-3.1-70b-chat` и `flux`, а также предоставляет возможность использования прокси-серверов.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта `hypotez`, обеспечивая возможность генерации контента с использованием API Airforce. Он включает в себя методы для получения списка доступных моделей, фильтрации контента и обработки ошибок.

## Классы

### `Airforce`

**Описание**: Класс `Airforce` является основным классом, предоставляющим методы для генерации текста и изображений с использованием API Airforce. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет методы для управления моделями.

**Атрибуты**:
- `url` (str): Базовый URL для API Airforce.
- `api_endpoint_completions` (str): URL для API завершения текста.
- `api_endpoint_imagine2` (str): URL для API генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Поддерживает ли потоковую передачу данных.
- `supports_system_message` (bool): Поддерживает ли системные сообщения.
- `supports_message_history` (bool): Поддерживает ли историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `models` (List[str]): Список доступных моделей для генерации текста.
- `image_models` (List[str]): Список доступных моделей для генерации изображений.
- `hidden_models` (Set[str]): Набор скрытых моделей, которые не должны отображаться в списке доступных моделей.
- `additional_models_imagine` (List[str]): Список дополнительных моделей для генерации изображений.
- `model_aliases` (Dict[str, str]): Словарь, содержащий псевдонимы для моделей.

**Методы**:
- `get_models()`: Возвращает список доступных моделей.
- `get_model(model: str) -> str`: Возвращает фактическое имя модели из псевдонима.
- `_filter_content(part_response: str) -> str`: Фильтрует нежелательный контент из частичного ответа.
- `_filter_response(response: str) -> str`: Фильтрует полный ответ для удаления системных ошибок и другого нежелательного текста.
- `generate_image(...)`: Асинхронно генерирует изображение на основе заданных параметров.
- `generate_text(...)`: Асинхронно генерирует текст на основе заданных параметров.
- `create_async_generator(...)`: Создает асинхронный генератор для генерации текста или изображений в зависимости от выбранной модели.

## Функции

### `split_message`

```python
def split_message(message: str, max_length: int = 1000) -> List[str]:
    """Splits the message into parts up to (max_length)."""
    ...
```

**Назначение**: Разделяет сообщение на части длиной не более `max_length` символов.

**Параметры**:
- `message` (str): Сообщение для разделения.
- `max_length` (int, optional): Максимальная длина каждой части сообщения. По умолчанию `1000`.

**Возвращает**:
- `List[str]`: Список частей сообщения.

**Как работает функция**:
1. **Инициализация**: Функция принимает входное сообщение и максимальную длину части сообщения.
2. **Разделение сообщения**: Если длина сообщения превышает `max_length`, функция ищет ближайший пробел перед `max_length`. Если пробел не найден, сообщение разделяется на `max_length`.
3. **Формирование частей**: Найденная часть сообщения добавляется в список `chunks`, и процесс повторяется для оставшейся части сообщения.
4. **Завершение**: Последняя часть сообщения (или все сообщение, если оно короче `max_length`) добавляется в список, и функция возвращает список частей.

```
A: Начало
│
B: Проверка длины сообщения
│
C: Поиск точки разделения
│
D: Добавление части в chunks
│
E: Обновление сообщения
│
F: Конец
```

**Примеры**:

```python
>>> split_message("This is a long message that needs to be split into smaller parts.", max_length=20)
['This is a long ', 'message that needs ', 'to be split into ', 'smaller parts.']

>>> split_message("Short message", max_length=100)
['Short message']
```

### `Airforce.get_models`

```python
@classmethod
def get_models(cls):
    """Get available models with error handling"""
    ...
```

**Назначение**: Получает список доступных моделей из API Airforce с обработкой ошибок.

**Возвращает**:
- `List[str]`: Список доступных моделей.

**Как работает функция**:
1. **Кэширование**: Функция проверяет, были ли уже получены модели изображений и модели текста. Если нет, то происходит их получение из API.
2. **Получение моделей изображений**: Функция выполняет GET-запрос к `f"{cls.url}/imagine2/models"` для получения списка моделей изображений. Если запрос успешен, список моделей изображений обновляется. В случае ошибки, список моделей изображений заполняется значениями по умолчанию из `cls.additional_models_imagine`.
3. **Получение моделей текста**: Функция выполняет GET-запрос к `f"{cls.url}/models"` для получения списка моделей текста. Если запрос успешен, список моделей текста обновляется. В случае ошибки, список моделей текста заполняется значениями по умолчанию из `cls.model_aliases.keys()`.
4. **Фильтрация**: Функция удаляет скрытые модели из списка доступных моделей.
5. **Возврат**: Функция возвращает список доступных моделей.

```
A: Начало
│
B: Проверка кэша моделей изображений
│
C: Получение моделей изображений из API
│
D: Проверка кэша моделей текста
│
E: Получение моделей текста из API
│
F: Фильтрация скрытых моделей
│
G: Конец
```

**Примеры**:

```python
>>> Airforce.get_models()
['llama-3.1-70b-chat', 'openchat-3.5-0106', ...]
```

### `Airforce.get_model`

```python
@classmethod
def get_model(cls, model: str) -> str:
    """Get the actual model name from alias"""
    ...
```

**Назначение**: Получает фактическое имя модели из псевдонима.

**Параметры**:
- `model` (str): Псевдоним модели.

**Возвращает**:
- `str`: Фактическое имя модели.

**Как работает функция**:
1. **Поиск псевдонима**: Функция ищет псевдоним модели в словаре `cls.model_aliases`.
2. **Возврат**: Если псевдоним найден, функция возвращает соответствующее ему фактическое имя модели. В противном случае функция возвращает либо переданное имя модели, либо значение `cls.default_model`, если имя модели не было передано.

```
A: Начало
│
B: Поиск псевдонима модели
│
C: Возврат имени модели
│
D: Конец
```

**Примеры**:

```python
>>> Airforce.get_model("openchat-3.5")
'openchat-3.5-0106'

>>> Airforce.get_model("unknown_model")
'unknown_model'

>>> Airforce.get_model("")
'llama-3.1-70b-chat'
```

### `Airforce._filter_content`

```python
@classmethod
def _filter_content(cls, part_response: str) -> str:
    """
    Filters out unwanted content from the partial response.
    """
    ...
```

**Назначение**: Фильтрует нежелательный контент из частичного ответа.

**Параметры**:
- `part_response` (str): Частичный ответ для фильтрации.

**Возвращает**:
- `str`: Отфильтрованный частичный ответ.

**Как работает функция**:
1. **Удаление сообщений об ограничении длины**: Функция удаляет сообщения о превышении лимита символов на сообщение.
2. **Удаление сообщений об ограничении скорости**: Функция удаляет сообщения об ограничении скорости запросов.
3. **Возврат**: Функция возвращает отфильтрованный частичный ответ.

```
A: Начало
│
B: Удаление сообщений об ограничении длины
│
C: Удаление сообщений об ограничении скорости
│
D: Конец
```

**Примеры**:

```python
>>> Airforce._filter_content("One message exceeds the \\d+chars per message limit\\..+https:\\/\\/discord\\.com\\/invite\\/\\S+")
''

>>> Airforce._filter_content("Rate limit \\(\\d+\\/minute\\) exceeded\\. Join our discord for more: .+https:\\/\\/discord\\.com\\/invite\\/\\S+")
''

>>> Airforce._filter_content("This is a clean message.")
'This is a clean message.'
```

### `Airforce._filter_response`

```python
@classmethod
def _filter_response(cls, response: str) -> str:
    """
    Filters the full response to remove system errors and other unwanted text.
    """
    ...
```

**Назначение**: Фильтрует полный ответ для удаления системных ошибок и другого нежелательного текста.

**Параметры**:
- `response` (str): Полный ответ для фильтрации.

**Возвращает**:
- `str`: Отфильтрованный полный ответ.

**Вызывает исключения**:
- `ValueError`: Если в ответе содержится сообщение "Model not found or too long input. Or any other error (xD)".

**Как работает функция**:
1. **Проверка на наличие ошибки**: Функция проверяет, содержит ли ответ сообщение об ошибке, указывающее на то, что модель не найдена или входные данные слишком длинные. Если такое сообщение присутствует, функция вызывает исключение `ValueError`.
2. **Удаление идентификаторов ошибок**: Функция удаляет идентификаторы ошибок из ответа.
3. **Удаление токенов**: Функция удаляет токены `<|im_end|>` и `</s>` из ответа.
4. **Удаление префиксов**: Функция удаляет префиксы "Assistant: ", "AI: ", "ANSWER: " и "Output: " из ответа.
5. **Фильтрация контента**: Функция вызывает метод `_filter_content` для фильтрации нежелательного контента.
6. **Возврат**: Функция возвращает отфильтрованный полный ответ.

```
A: Начало
│
B: Проверка на наличие ошибки
│
C: Удаление идентификаторов ошибок
│
D: Удаление токенов
│
E: Удаление префиксов
│
F: Фильтрация контента
│
G: Конец
```

**Примеры**:

```python
>>> Airforce._filter_response("This is a clean response.")
'This is a clean response.'

>>> Airforce._filter_response("Model not found or too long input. Or any other error (xD)")
ValueError: Model not found or too long input. Or any other error (xD)
```

### `Airforce.generate_image`

```python
@classmethod
async def generate_image(
    cls,
    model: str,
    prompt: str,
    size: str,
    seed: int,
    proxy: str = None
) -> AsyncResult:
    """
    Generates image, buffers the response, filters it, and returns the final result.
    """
    ...
```

**Назначение**: Асинхронно генерирует изображение на основе заданных параметров.

**Параметры**:
- `model` (str): Модель для генерации изображения.
- `prompt` (str): Текстовое описание изображения.
- `size` (str): Размер изображения.
- `seed` (int): Зерно для генерации случайных чисел.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий объекты `ImageResponse`.

**Вызывает исключения**:
- `RuntimeError`: Если генерация изображения не удалась.

**Как работает функция**:
1. **Подготовка заголовков**: Функция подготавливает заголовки HTTP-запроса, включая User-Agent, Accept, Accept-Language, Accept-Encoding и Content-Type.
2. **Подготовка параметров**: Функция подготавливает параметры запроса, включая модель, текстовое описание, размер и зерно.
3. **Выполнение запроса**: Функция выполняет GET-запрос к API генерации изображений (`cls.api_endpoint_imagine2`) с заданными параметрами.
4. **Обработка ответа**: Если запрос успешен (код состояния 200), функция извлекает URL изображения из ответа и возвращает объект `ImageResponse`. В случае ошибки, функция вызывает исключение `RuntimeError`.
5. **Возврат**: Функция возвращает асинхронный генератор, который возвращает объекты `ImageResponse`.

```
A: Начало
│
B: Подготовка заголовков
│
C: Подготовка параметров
│
D: Выполнение запроса к API
│
E: Обработка ответа
│
F: Конец
```

**Примеры**:

```python
# Пример вызова функции генерации изображения
async for result in Airforce.generate_image(model="flux", prompt="A cat", size="1:1", seed=12345):
    print(result)
```

### `Airforce.generate_text`

```python
@classmethod
async def generate_text(
    cls,
    model: str,
    messages: Messages,
    max_tokens: int,
    temperature: float,
    top_p: float,
    stream: bool,
    proxy: str = None
) -> AsyncResult:
    """
    Generates text, buffers the response, filters it, and returns the final result.
    """
    ...
```

**Назначение**: Асинхронно генерирует текст на основе заданных параметров.

**Параметры**:
- `model` (str): Модель для генерации текста.
- `messages` (Messages): Список сообщений для генерации текста.
- `max_tokens` (int): Максимальное количество токенов в ответе.
- `temperature` (float): Температура для генерации текста.
- `top_p` (float): Top-p для генерации текста.
- `stream` (bool): Указывает, использовать ли потоковую передачу данных.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий сгенерированный текст.

**Как работает функция**:
1. **Подготовка заголовков**: Функция подготавливает заголовки HTTP-запроса, включая User-Agent, Accept, Accept-Language, Accept-Encoding и Content-Type.
2. **Разделение сообщений**: Функция разделяет сообщения на части длиной не более 1000 символов с помощью функции `split_message`.
3. **Подготовка данных**: Функция подготавливает данные запроса, включая сообщения, модель, температуру, top-p и флаг потоковой передачи данных.
4. **Выполнение запроса**: Функция выполняет POST-запрос к API завершения текста (`cls.api_endpoint_completions`) с заданными данными.
5. **Обработка ответа**: Если используется потоковая передача данных, функция обрабатывает ответ построчно, извлекая и фильтруя сгенерированный текст. Если потоковая передача не используется, функция обрабатывает ответ целиком, извлекая и фильтруя сгенерированный текст.
6. **Возврат**: Функция возвращает асинхронный генератор, который возвращает сгенерированный текст.

```
A: Начало
│
B: Подготовка заголовков
│
C: Разделение сообщений
│
D: Подготовка данных
│
E: Выполнение запроса к API
│
F: Обработка ответа (потоковая или не потоковая)
│
G: Конец
```

**Примеры**:

```python
# Пример вызова функции генерации текста
messages = [{"role": "user", "content": "Write a short story."}]
async for result in Airforce.generate_text(model="llama-3.1-70b-chat", messages=messages, max_tokens=100, temperature=0.7, top_p=0.9, stream=True):
    print(result)
```

### `Airforce.create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    prompt: str = None,
    proxy: str = None,
    max_tokens: int = 512,
    temperature: float = 1,
    top_p: float = 1,
    stream: bool = True,
    size: str = "1:1",
    seed: int = None,
    **kwargs
) -> AsyncResult:
    """
    
    """
    ...
```

**Назначение**: Создает асинхронный генератор для генерации текста или изображений в зависимости от выбранной модели.

**Параметры**:
- `model` (str): Модель для генерации контента.
- `messages` (Messages): Список сообщений для генерации текста.
- `prompt` (str, optional): Текстовое описание изображения. По умолчанию `None`.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `512`.
- `temperature` (float, optional): Температура для генерации текста. По умолчанию `1`.
- `top_p` (float, optional): Top-p для генерации текста. По умолчанию `1`.
- `stream` (bool, optional): Указывает, использовать ли потоковую передачу данных. По умолчанию `True`.
- `size` (str, optional): Размер изображения. По умолчанию `"1:1"`.
- `seed` (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий сгенерированный контент.

**Как работает функция**:
1. **Получение модели**: Функция получает фактическое имя модели с помощью метода `get_model`.
2. **Проверка типа модели**: Функция проверяет, является ли выбранная модель моделью изображения.
3. **Генерация изображения**: Если выбрана модель изображения, функция вызывает метод `generate_image` для генерации изображения.
4. **Генерация текста**: Если выбрана модель текста, функция вызывает метод `generate_text` для генерации текста.
5. **Возврат**: Функция возвращает асинхронный генератор, который возвращает сгенерированный контент.

```
A: Начало
│
B: Получение модели
│
C: Проверка типа модели
│
D: Генерация изображения или текста
│
E: Конец
```

**Примеры**:

```python
# Пример вызова функции для генерации текста
messages = [{"role": "user", "content": "Write a poem."}]
async for result in Airforce.create_async_generator(model="llama-3.1-70b-chat", messages=messages):
    print(result)

# Пример вызова функции для генерации изображения
async for result in Airforce.create_async_generator(model="flux", messages=[{"role": "user", "content": "A cat"}], prompt="A cat"):
    print(result)