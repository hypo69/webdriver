# Модуль `ChatGptt`

## Обзор

Модуль `ChatGptt` предоставляет асинхронный интерфейс для взаимодействия с моделью ChatGPTT. Он позволяет генерировать текст на основе предоставленных сообщений, используя API сервиса `chatgptt.me`. Модуль поддерживает потоковую передачу данных, системные сообщения и историю сообщений.

## Подробней

Модуль `ChatGptt` предназначен для интеграции с проектами, требующими функциональности чат-ботов или генерации текста на основе AI. Он использует асинхронные запросы для неблокирующего взаимодействия с API, что позволяет эффективно обрабатывать большое количество запросов. Модуль предоставляет методы для форматирования запросов и обработки ответов от API, обеспечивая удобный интерфейс для разработчиков.

## Классы

### `ChatGptt`

**Описание**: Класс `ChatGptt` является асинхронным провайдером, который реализует взаимодействие с API `chatgptt.me` для генерации текста. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:

- `AsyncGeneratorProvider`: Обеспечивает базовую структуру для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Аттрибуты**:

- `url` (str): URL сервиса `chatgptt.me`.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (List[str]): Список поддерживаемых моделей.

**Методы**:

- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от API.

    Raises:
        RuntimeError: Если не удалось извлечь токены аутентификации из HTML страницы.
        Exception: Если возникает ошибка при выполнении запроса.

    """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который взаимодействует с API `chatgptt.me` для генерации текста на основе предоставленных сообщений.

**Параметры**:

- `cls`: Ссылка на класс `ChatGptt`.
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Вызывает исключения**:

- `RuntimeError`: Если не удалось извлечь токены аутентификации из HTML страницы.

**Как работает функция**:

1. **Определение модели**:
   - Используется метод `cls.get_model(model)` для получения названия модели.
2. **Формирование заголовков**:
   - Создаются HTTP-заголовки для запроса, включающие `authority`, `accept`, `origin`, `referer` и `user-agent`.
3. **Создание асинхронной сессии**:
   - Используется `ClientSession` для выполнения HTTP-запросов.
4. **Получение содержимого начальной страницы**:
   - Выполняется GET-запрос к `cls.url` для получения HTML-содержимого страницы.
   - Проверяется статус ответа с помощью `raise_for_status`.
5. **Извлечение токенов аутентификации**:
   - Используются регулярные выражения для поиска `nonce` и `post_id` в HTML.
   - Проверяется наличие обоих токенов, и если какой-либо отсутствует, вызывается `RuntimeError`.
6. **Формирование полезной нагрузки (payload)**:
   - Создается словарь `payload` с данными для отправки, включающий `_wpnonce`, `post_id`, `url`, `action`, `message`, `bot_id`, `chatbot_identity`, `wpaicg_chat_client_id` и `wpaicg_chat_history`.
   - `message` формируется с использованием `format_prompt(messages)`.
   - `wpaicg_chat_client_id` генерируется случайным образом.
7. **Отправка POST-запроса и потоковая обработка ответа**:
   - Выполняется POST-запрос к `cls.api_endpoint` с заголовками и данными.
   - Проверяется статус ответа с помощью `raise_for_status`.
   - Полученный JSON-ответ обрабатывается, и извлекается значение из ключа `data`, которое возвращается через `yield`.

**Внутренние функции**: Нет

**ASCII flowchart**:

```
    Начало
     ↓
  Определение модели
     ↓
  Формирование заголовков
     ↓
  Создание асинхронной сессии
     ↓
  Получение HTML страницы
     ↓
  Извлечение nonce и post_id
     ↓
  Формирование payload
     ↓
  Отправка POST запроса
     ↓
  Получение JSON ответа
     ↓
  Извлечение данных из 'data'
     ↓
    Конец (yield)
```

**Примеры**:

```python
# Пример использования функции create_async_generator
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for message in ChatGptt.create_async_generator(model="gpt-4", messages=messages):
    print(message)
```
```python
# Пример использования функции create_async_generator c прокси
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for message in ChatGptt.create_async_generator(model="gpt-4", messages=messages, proxy="http://proxy.example.com"):
    print(message)