# Модуль `FreeNetfly`

## Обзор

Модуль `FreeNetfly` предоставляет асинхронный генератор для взаимодействия с API `free.netfly.top`. Он позволяет получать ответы от языковых моделей, таких как `gpt-3.5-turbo` и `gpt-4`, через асинхронные запросы. Модуль включает в себя обработку ошибок, повторные попытки и разбор потоковых ответов JSON.

## Подробней

Модуль предназначен для использования в асинхронных приложениях, требующих взаимодействия с API `free.netfly.top`. Он автоматически обрабатывает потоковые данные, извлекает полезный контент и обеспечивает устойчивость к временным сбоям в сети.

## Классы

### `FreeNetfly`

**Описание**: Класс `FreeNetfly` является подклассом `AsyncGeneratorProvider` и `ProviderModelMixin` и предоставляет методы для асинхронной генерации ответов от API `free.netfly.top`.

**Принцип работы**:
Класс использует `aiohttp` для отправки асинхронных POST-запросов к API. Он обрабатывает потоковые ответы, разбирает JSON и извлекает контент. В случае ошибок соединения или таймаутов, класс автоматически повторяет запрос несколько раз с экспоненциальной задержкой.

**Аттрибуты**:
- `url` (str): Базовый URL для `free.netfly.top`.
- `api_endpoint` (str): Endpoint для выполнения запросов к API.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-3.5-turbo`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-3.5-turbo`, `gpt-4`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.
- `_process_response`: Обрабатывает HTTP-ответ и извлекает контент из потока данных.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от API.

        Args:
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий текстовые фрагменты ответа.

        Raises:
            ClientError: Если произошла ошибка при выполнении запроса.
            asyncio.TimeoutError: Если истекло время ожидания ответа.

        Example:
            Примеры вызовов со всем спектром параметров. которы можно передать в функцию
        """
        ...
```

**Назначение**: Функция `create_async_generator` создает и возвращает асинхронный генератор, который отправляет запросы к API `free.netfly.top` и возвращает ответы в виде потока текстовых фрагментов.

**Параметры**:
- `model` (str): Имя языковой модели, которую нужно использовать (например, `gpt-3.5-turbo`).
- `messages` (Messages): Список сообщений, отправляемых в API в теле запроса.
- `proxy` (str, optional): URL прокси-сервера, если необходимо использовать прокси для подключения. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает текстовые фрагменты ответа от API.

**Вызывает исключения**:
- `ClientError`: Возникает при ошибках, связанных с HTTP-запросами (например, при отсутствии соединения или неверном URL).
- `asyncio.TimeoutError`: Возникает, если время ожидания ответа от API истекло.

**Как работает функция**:

1. **Формирование заголовков**: Функция начинает с определения необходимых HTTP-заголовков, включая `accept`, `content-type`, `user-agent` и другие.
2. **Формирование тела запроса**: Создается словарь `data`, содержащий сообщения, модель, температуру и другие параметры, необходимые для API.
3. **Повторные попытки**: Функция выполняет до 5 попыток отправки запроса с экспоненциальной задержкой между попытками.
4. **Отправка запроса**: Используется `aiohttp.ClientSession` для отправки POST-запроса к API с заданными заголовками, телом запроса и прокси (если указан).
5. **Обработка ответа**: Если запрос успешен, функция вызывает `_process_response` для обработки потокового ответа.
6. **Обработка ошибок**: Если во время выполнения запроса возникают ошибки `ClientError` или `asyncio.TimeoutError`, функция повторяет попытку, если не достигнуто максимальное количество попыток.
7. **Возврат результата**: Если запрос выполнен успешно, функция возвращает асинхронный генератор, выдающий фрагменты текста. Если все попытки завершились неудачей, выбрасывается последнее исключение.

**Внутренние функции**: Нет.

```
Формирование заголовков и тела запроса
↓
Цикл повторных попыток (максимум 5)
│
├──► Отправка POST-запроса к API
│   │
│   ├──► Успех: Обработка ответа через _process_response
│   │   │
│   │   └──► Выход из функции (return)
│   │
│   └──► Ошибка (ClientError, asyncio.TimeoutError):
│       │
│       └──► Задержка (экспоненциальная) и повторная попытка
│
└──► Все попытки неудачны: Выброс исключения
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio

async def main():
    model = "gpt-3.5-turbo"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for chunk in FreeNetfly.create_async_generator(model=model, messages=messages):
        print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

### `_process_response`

```python
    @classmethod
    async def _process_response(cls, response) -> AsyncGenerator[str, None]:
        """Обрабатывает HTTP-ответ и извлекает контент из потока данных.

        Args:
            response: Объект HTTP-ответа от aiohttp.

        Yields:
            str: Фрагменты текста, извлеченные из потока данных.

        Raises:
            json.JSONDecodeError: Если не удается разобрать JSON.
            KeyError: Если в JSON отсутствует ожидаемый ключ.

        Example:
            Примеры вызовов со всем спектром параметров. которы можно передать в функцию
        """
        ...
```

**Назначение**: Функция `_process_response` обрабатывает HTTP-ответ, полученный от API, и извлекает текстовый контент из потока данных, генерируя его в виде асинхронного генератора.

**Параметры**:
- `response`: Объект HTTP-ответа, полученный от `aiohttp.ClientSession.post`.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор, который выдает текстовые фрагменты, извлеченные из потока данных.

**Вызывает исключения**:
- `json.JSONDecodeError`: Возникает, если не удается разобрать JSON из потока данных.
- `KeyError`: Возникает, если в структуре JSON отсутствуют ожидаемые ключи.

**Как работает функция**:

1. **Инициализация буфера**: Функция начинает с инициализации пустого буфера `buffer`, в котором накапливаются данные из потока.
2. **Чтение потока**: Асинхронно читает данные из потока `response.content` по строкам.
3. **Декодирование и накопление**: Декодирует каждую строку из байтов в UTF-8 и добавляет её в буфер.
4. **Поиск завершающих символов**: Проверяет, заканчивается ли буфер последовательностью `\n\n`, что указывает на конец блока данных.
5. **Разделение на подстроки**: Если буфер заканчивается на `\n\n`, он разделяется на подстроки по разделителю `\n`.
6. **Обработка подстрок**: Каждая подстрока проверяется на наличие префикса `data: `.
7. **Извлечение JSON**: Если подстрока начинается с `data: `, извлекается JSON-данные из подстроки, удаляя префикс `data: `.
8. **Извлечение контента**: Из JSON-данных извлекается поле `content` из структуры `data['choices'][0]['delta']`.
9. **Генерация контента**: Если поле `content` существует, оно генерируется как часть асинхронного генератора.
10. **Обработка ошибок JSON**: Если возникают ошибки при разборе JSON или отсутствуют ожидаемые ключи, ошибки перехватываются и выводятся в консоль.
11. **Очистка буфера**: После обработки блока данных буфер очищается.
12. **Обработка остатка**: После завершения чтения потока обрабатывается оставшийся контент в буфере.

**Внутренние функции**: Нет.

```
Инициализация буфера
↓
Асинхронное чтение данных из потока HTTP-ответа
↓
Декодирование данных и добавление в буфер
↓
Проверка, заканчивается ли буфер на '\n\n'
├──► Да: Разделение буфера на подстроки по '\n'
│   │
│   └──► Обработка каждой подстроки:
│       │   │
│       │   └──► Проверка, начинается ли подстрока с 'data: '
│       │       │
│       │       ├──► Да: Извлечение JSON-данных
│       │       │   │
│       │       │   └──► Извлечение 'content' из JSON
│       │       │       │
│       │       │       └──► Генерация 'content'
│       │       │
│       │       └──► Нет: Пропуск подстроки
│   │
│   └──► Очистка буфера
│
└──► Нет: Продолжение чтения данных из потока
↓
Обработка остатка в буфере (после завершения чтения потока)
```

**Примеры**:

```python
# Пример использования _process_response
import asyncio
from aiohttp import ClientSession

async def main():
    async with ClientSession() as session:
        async with session.get("https://free.netfly.top") as response:  # Замените URL на реальный
            async for chunk in FreeNetfly._process_response(response):
                print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())