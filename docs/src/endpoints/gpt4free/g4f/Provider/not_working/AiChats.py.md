# Модуль `AiChats`

## Обзор

Модуль `AiChats` предоставляет асинхронный интерфейс для взаимодействия с сервисом AI-Chats.org. Он поддерживает как генерацию текста (чат), так и генерацию изображений (DALL-E). Модуль использует асинхронные генераторы для обработки ответов от API.

## Подробнее

Модуль предназначен для интеграции с AI-Chats.org для выполнения задач генерации текста и изображений. Он реализует асинхронное взаимодействие с API, что позволяет эффективно обрабатывать запросы.
В данном модуле не реализована функция логирования, но она требуется согласно инструкции.

## Классы

### `AiChats`

**Описание**: Класс `AiChats` является асинхронным генератором и миксином для работы с моделями.

**Принцип работы**:
Класс наследует `AsyncGeneratorProvider` и `ProviderModelMixin`, что позволяет ему использовать асинхронные генераторы для получения ответов от API и предоставлять информацию о поддерживаемых моделях.

**Атрибуты**:
- `url` (str): URL сервиса AI-Chats.org.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Флаг, указывающий, работает ли провайдер (в данном случае `False`).
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-4`, `dalle`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.
- `create_async`: Создает асинхронную функцию для получения ответа от API.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API AI-Chats.org.

    Args:
        model (str): Модель для использования (`gpt-4` или `dalle`).
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от API.

    Raises:
        Exception: Если возникает ошибка при выполнении запроса к API.

    Example:
        Примеры вызовов с различными параметрами:
        >>> async for response in AiChats.create_async_generator(model='gpt-4', messages=[{'role': 'user', 'content': 'Hello'}]):
        ...     print(response)

        >>> async for response in AiChats.create_async_generator(model='dalle', messages=[{'role': 'user', 'content': 'A cat'}]):
        ...     print(response)
    """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API AI-Chats.org. в зависимости от модели (`gpt-4` или `dalle`), формирует и отправляет запрос, обрабатывает ответ и возвращает его в виде асинхронного генератора.

**Параметры**:
- `cls`: Ссылка на класс `AiChats`.
- `model` (str): Модель для использования (`gpt-4` или `dalle`).
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при выполнении запроса к API.

**Как работает функция**:
1. **Определение заголовков**: Функция начинает с определения необходимых HTTP-заголовков для запроса.
2. **Создание сессии**: Создается асинхронная сессия `aiohttp.ClientSession` с заданными заголовками.
3. **Формирование запроса**: В зависимости от выбранной модели (`dalle` или `gpt-4`), формируется тело запроса:
   - Для `dalle` извлекается последний элемент `content` из списка сообщений.
   - Для `gpt-4` используется функция `format_prompt` для форматирования сообщений.
4. **Отправка запроса и обработка ответа**: Отправляется `POST`-запрос к API:
   - Для `dalle`:
     - Извлекается `image_url` из JSON-ответа.
     - Получаются бинарные данные изображения по URL.
     - Кодируется изображение в base64 и возвращается в виде `ImageResponse`.
   - Для `gpt-4`:
     - Читается ответ построчно, извлекаются данные, начинающиеся с `data: `.
     - Возвращается полученное сообщение.
5. **Обработка ошибок**: Если в процессе выполнения запроса возникает ошибка, она перехватывается и возвращается сообщение об ошибке.

**Внутренние функции**:
- Отсутствуют.

**ASCII Flowchart**:

```
Начало
    ↓
Определение заголовков
    ↓
Создание асинхронной сессии
    ↓
Выбор модели (dalle или gpt-4)
    ├── dalie ──► Извлечение prompt
    │   ↓
    │   Формирование тела запроса (image)
    │   ↓
    └── gpt-4 ──► Форматирование prompt
        ↓
        Формирование тела запроса (chat)
        ↓
    Отправка POST-запроса к API
    ↓
    Обработка ответа
    ├── dalie ──► Извлечение URL изображения
    │   ↓
    │   Получение бинарных данных изображения
    │   ↓
    │   Кодирование в Base64
    │   ↓
    │   Возврат ImageResponse
    │   
    └── gpt-4 ──► Чтение ответа построчно
        ↓
        Извлечение данных data:
        ↓
        Возврат сообщения
        ↓
Конец
```

**Примеры**:

- Пример для `gpt-4`:

```python
async for response in AiChats.create_async_generator(model='gpt-4', messages=[{'role': 'user', 'content': 'Hello'}]):
    print(response)
```

- Пример для `dalle`:

```python
async for response in AiChats.create_async_generator(model='dalle', messages=[{'role': 'user', 'content': 'A cat'}]):
    print(response)
```

### `create_async`

```python
@classmethod
async def create_async(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> str:
    """
    Создает асинхронную функцию для получения ответа от API AI-Chats.org.

    Args:
        model (str): Модель для использования (`gpt-4` или `dalle`).
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        str: Ответ от API.

    Example:
        Примеры вызовов с различными параметрами:
        >>> await AiChats.create_async(model='gpt-4', messages=[{'role': 'user', 'content': 'Hello'}])

        >>> await AiChats.create_async(model='dalle', messages=[{'role': 'user', 'content': 'A cat'}])
    """
```

**Назначение**: Создает асинхронную функцию для получения ответа от API AI-Chats.org. Она вызывает `create_async_generator` и возвращает первый ответ, полученный от генератора.

**Параметры**:
- `cls`: Ссылка на класс `AiChats`.
- `model` (str): Модель для использования (`gpt-4` или `dalle`).
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `str`: Ответ от API.

**Вызывает исключения**:
- Отсутствуют (исключения обрабатываются внутри `create_async_generator`).

**Как работает функция**:
1. **Вызов генератора**: Функция вызывает `create_async_generator` с переданными аргументами.
2. **Получение ответа**: Происходит итерация по асинхронному генератору:
   - Если ответ является экземпляром `ImageResponse`, возвращается URL изображения.
   - В противном случае возвращается сам ответ.

**Внутренние функции**:
- Отсутствуют.

**ASCII Flowchart**:

```
Начало
    ↓
Вызов create_async_generator
    ↓
Получение первого ответа от генератора
    ↓
Проверка типа ответа
    ├── ImageResponse ──► Возврат URL изображения
    │   ↓
    └── Другой тип ──► Возврат ответа
        ↓
Конец
```

**Примеры**:

- Пример для `gpt-4`:

```python
await AiChats.create_async(model='gpt-4', messages=[{'role': 'user', 'content': 'Hello'}])
```

- Пример для `dalle`:

```python
await AiChats.create_async(model='dalle', messages=[{'role': 'user', 'content': 'A cat'}])