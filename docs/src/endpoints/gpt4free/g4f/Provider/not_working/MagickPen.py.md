# Модуль `MagickPen`

## Обзор

Модуль `MagickPen` представляет собой асинхронный провайдер для взаимодействия с API MagickPen. Он позволяет генерировать текст на основе предоставленных сообщений, используя асинхронные генераторы. Модуль поддерживает потоковую передачу данных, системные сообщения и историю сообщений.

## Подробней

Модуль предназначен для интеграции с сервисом MagickPen, предоставляющим API для генерации текста. Он использует асинхронные запросы для взаимодействия с API и предоставляет удобный интерфейс для получения результатов в виде асинхронного генератора. Этот модуль можно использовать для создания чат-ботов, генерации контента и других задач, требующих взаимодействия с языковой моделью MagickPen.

## Классы

### `MagickPen`

**Описание**: Класс `MagickPen` является асинхронным провайдером и предоставляет методы для взаимодействия с API MagickPen.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса MagickPen.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o-mini`).
- `models` (List[str]): Список поддерживаемых моделей (`['gpt-4o-mini']`).

**Методы**:
- `fetch_api_credentials()`: Асинхронный метод для получения учетных данных API.
- `create_async_generator()`: Асинхронный метод для создания асинхронного генератора для получения данных от API.

## Функции

### `fetch_api_credentials`

```python
    @classmethod
    async def fetch_api_credentials(cls) -> tuple:
        """Асинхронно извлекает необходимые учетные данные API из JavaScript файла на веб-сайте MagickPen.

        Args:
            cls: Класс, для которого вызывается метод.

        Returns:
            tuple: Кортеж, содержащий X_API_SECRET, signature, timestamp, nonce и secret.

        Raises:
            Exception: Если не удается извлечь все необходимые данные из JavaScript файла.
        """
```

**Назначение**: Получение учетных данных API, необходимых для аутентификации и авторизации запросов к API MagickPen.

**Параметры**:
- `cls` (Type[MagickPen]): Ссылка на класс `MagickPen`.

**Возвращает**:
- `tuple`: Кортеж, содержащий следующие элементы:
    - `X_API_SECRET` (str): Секретный ключ API.
    - `signature` (str): Подпись запроса.
    - `timestamp` (str): Временная метка запроса.
    - `nonce` (str): Случайная строка, используемая для генерации подписи.
    - `secret` (str): Дополнительный секретный ключ.

**Вызывает исключения**:
- `Exception`: Если не удается извлечь все необходимые данные из JavaScript файла.

**Как работает функция**:

1. **Получение JavaScript файла**: Функция отправляет GET-запрос к URL `https://magickpen.com/_nuxt/bf709a9ce19f14e18116.js` для получения JavaScript файла.
2. **Извлечение `X_API_SECRET`**: Использует регулярное выражение для поиска значения `"X-API-Secret"` в тексте файла.
3. **Генерация `timestamp` и `nonce`**: Генерирует текущую временную метку в миллисекундах и случайную строку.
4. **Создание `signature`**: Сортирует и объединяет строки `["TGDBU9zCgM", timestamp, nonce]`, затем вычисляет MD5-хеш полученной строки.
5. **Извлечение `secret`**: Использует регулярное выражение для поиска значения `secret` в тексте файла.
6. **Проверка наличия данных**: Проверяет, что все необходимые данные (X_API_SECRET, timestamp, nonce, secret) были успешно извлечены.
7. **Возврат данных**: Возвращает кортеж, содержащий извлеченные и сгенерированные данные.

```
A: Получение JavaScript файла
|
B: Извлечение X_API_SECRET
|
C: Генерация timestamp и nonce
|
D: Создание signature
|
E: Извлечение secret
|
F: Проверка наличия данных
|
G: Возврат данных
```

**Примеры**:

```python
# Пример вызова функции
X_API_SECRET, signature, timestamp, nonce, secret = await MagickPen.fetch_api_credentials()
print(f"X_API_SECRET: {X_API_SECRET}")
print(f"signature: {signature}")
print(f"timestamp: {timestamp}")
print(f"nonce: {nonce}")
print(f"secret: {secret}")
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения данных от API MagickPen.

        Args:
            cls: Класс, для которого вызывается метод.
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию None.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий декодированные фрагменты ответа от API.

        Raises:
            Exception: Если возникает ошибка при взаимодействии с API.
        """
```

**Назначение**: Создание асинхронного генератора для взаимодействия с API MagickPen и получения данных в потоковом режиме.

**Параметры**:
- `cls` (Type[MagickPen]): Ссылка на класс `MagickPen`.
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий декодированные фрагменты ответа от API.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при взаимодействии с API.

**Как работает функция**:

1. **Получение модели**: Получает модель, используя метод `cls.get_model(model)`.
2. **Получение учетных данных**: Вызывает метод `cls.fetch_api_credentials()` для получения учетных данных API.
3. **Формирование заголовков**: Создает словарь `headers`, содержащий необходимые заголовки для запроса.
4. **Формирование тела запроса**: Форматирует сообщения, используя функцию `format_prompt(messages)`, и создает словарь `payload`, содержащий запрос и данные для защиты от ботов.
5. **Отправка запроса**: Отправляет POST-запрос к API-endpoint, используя `ClientSession` из библиотеки `aiohttp`.
6. **Обработка ответа**: Получает ответ от API и итерируется по его содержимому, выдавая декодированные фрагменты ответа через `yield`.

```
A: Получение модели
|
B: Получение учетных данных
|
C: Формирование заголовков
|
D: Формирование тела запроса
|
E: Отправка запроса
|
F: Обработка ответа
```

**Примеры**:

```python
# Пример вызова функции
model = "gpt-4o-mini"
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for chunk in MagickPen.create_async_generator(model=model, messages=messages):
    print(chunk, end="")