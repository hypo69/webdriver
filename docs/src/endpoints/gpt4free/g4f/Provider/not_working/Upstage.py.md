# Модуль для работы с Upstage API
======================================

Модуль предоставляет асинхронный интерфейс для взаимодействия с API Upstage AI для генерации текста.

## Обзор

Этот модуль содержит класс `Upstage`, который наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`. Он предназначен для асинхронной генерации текста с использованием моделей Upstage AI. Модуль поддерживает выбор модели, передачу сообщений и проксирование запросов.

## Подробней

Модуль `Upstage` использует `aiohttp` для выполнения асинхронных HTTP-запросов к API Upstage AI. Он форматирует запросы и обрабатывает ответы, извлекая сгенерированный текст из потока данных. Модуль также предоставляет возможность выбора модели из списка поддерживаемых моделей или использования псевдонимов моделей.

## Классы

### `Upstage`

**Описание**: Класс для взаимодействия с API Upstage AI для генерации текста.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL консоли Upstage AI.
- `api_endpoint` (str): URL API для запросов на завершение текста.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию (`solar-pro`).
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

**Методы**:
- `get_model(model: str) -> str`: Возвращает имя модели на основе псевдонима или имени модели.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения текста от API Upstage AI.

## Функции

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """Возвращает имя модели на основе псевдонима или имени модели.

        Args:
            model (str): Имя модели или псевдоним.

        Returns:
            str: Имя модели.
        """
        ...
```

**Назначение**: Возвращает имя модели на основе предоставленного псевдонима или имени модели.

**Параметры**:
- `model` (str): Имя модели или псевдоним модели.

**Возвращает**:
- `str`: Имя модели. Если модель не найдена в списке моделей и псевдонимов, возвращается модель по умолчанию.

**Как работает функция**:
1. **Проверка наличия модели в списке `models`**: Функция проверяет, существует ли предоставленное имя модели в списке поддерживаемых моделей `cls.models`.
2. **Проверка наличия модели в словаре псевдонимов `model_aliases`**: Если модель не найдена в списке моделей, функция проверяет, существует ли она в словаре псевдонимов `cls.model_aliases`.
3. **Возврат значения**:
   - Если модель найдена в списке `models` или в словаре `model_aliases`, функция возвращает соответствующее значение.
   - В противном случае функция возвращает значение `cls.default_model`.

```
Проверка наличия модели в списке поддерживаемых моделей
│
├───> Модель найдена?
│     │
│     └───> Да: Вернуть имя модели
│     │
│     └───> Нет: Проверка наличия модели в словаре псевдонимов
│          │
│          ├───> Псевдоним найден?
│          │     │
│          │     └───> Да: Вернуть имя модели по псевдониму
│          │     │
│          │     └───> Нет: Вернуть модель по умолчанию
│          │
│          └───> Возврат модели по умолчанию
│
└───> Возврат модели по умолчанию
```

**Примеры**:

```python
# Пример 1: Получение имени модели по псевдониму
model_name = Upstage.get_model("solar-mini")
print(model_name)  # Вывод: upstage/solar-1-mini-chat

# Пример 2: Получение имени модели по умолчанию
model_name = Upstage.get_model("unknown_model")
print(model_name)  # Вывод: solar-pro

# Пример 3: Получение имени модели из списка поддерживаемых моделей
model_name = Upstage.get_model("solar-pro")
print(model_name)  # Вывод: solar-pro
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения текста от API Upstage AI.

        Args:
            model (str): Имя модели.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст от API.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для получения текста от API Upstage AI.

**Параметры**:
- `model` (str): Имя модели для использования.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст от API.

**Как работает функция**:

1. **Получение модели**: Сначала функция вызывает `cls.get_model(model)`, чтобы получить имя модели на основе предоставленного аргумента `model`.
2. **Подготовка заголовков**: Функция определяет заголовки, которые будут отправлены с HTTP-запросом.
3. **Создание сессии `aiohttp`**: Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов.
4. **Подготовка данных для запроса**: Формируются данные запроса, включая флаг `stream`, сообщения и имя модели. Сообщения форматируются с помощью `format_prompt(messages)`.
5. **Выполнение POST-запроса**: Функция выполняет POST-запрос к API Upstage AI с использованием `session.post`.
6. **Обработка потока данных**: Функция асинхронно итерируется по ответу от API. Для каждой строки проверяется, является ли она данными (`data: ...`). Если строка содержит данные, они декодируются из JSON и извлекается содержимое (`content`).
7. **Генерация текста**: Извлеченное содержимое генерируется с использованием `yield content`.
8. **Обработка завершения**: Если строка равна `data: [DONE]`, цикл завершается.

```
Получение модели
│
├───> Подготовка заголовков
│     │
│     └───> Создание асинхронной сессии
│          │
│          └───> Формирование данных запроса
│               │
│               └───> Выполнение POST-запроса к API
│                    │
│                    └───> Итерация по потоку данных
│                         │
│                         ├───> Строка является данными?
│                         │     │
│                         │     └───> Да: Декодирование JSON и извлечение содержимого
│                         │     │
│                         │     └───> Нет: Проверка на завершение потока
│                         │
│                         └───> Генерация содержимого
│
└───> Завершение
```

**Примеры**:

```python
# Пример 1: Создание асинхронного генератора для получения текста
import asyncio

async def main():
    messages = [{"role": "user", "content": "Напиши короткое стихотворение о космосе."}]
    generator = Upstage.create_async_generator(model="solar-pro", messages=messages)
    async for text in generator:
        print(text, end="")

if __name__ == "__main__":
    asyncio.run(main())

# Пример 2: Использование прокси-сервера
import asyncio

async def main():
    messages = [{"role": "user", "content": "Расскажи о себе."}]
    generator = Upstage.create_async_generator(model="solar-pro", messages=messages, proxy="http://your_proxy:8080")
    async for text in generator:
        print(text, end="")

if __name__ == "__main__":
    asyncio.run(main())