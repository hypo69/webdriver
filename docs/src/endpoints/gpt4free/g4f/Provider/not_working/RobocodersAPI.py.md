# Модуль для работы с API Robocoders AI

## Обзор

Модуль `RobocodersAPI` предназначен для взаимодействия с API Robocoders AI. Он предоставляет асинхронный генератор для получения ответов от AI-агентов, таких как `GeneralCodingAgent`, `RepoAgent` и `FrontEndAgent`. Модуль поддерживает сохранение истории сообщений и использует кэширование для управления токенами доступа и идентификаторами сессий.

## Подробней

`RobocodersAPI` использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов к API Robocoders AI. Для извлечения токена доступа из HTML-страницы используется `BeautifulSoup`. Кэширование токенов доступа и идентификаторов сессий осуществляется в файле `robocoders.json`, расположенном в директории `cookies`. Это позволяет повторно использовать существующие сессии и токены, минимизируя количество запросов к серверу авторизации.

## Классы

### `RobocodersAPI`

**Описание**: Класс `RobocodersAPI` предоставляет методы для взаимодействия с API Robocoders AI.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию результатов.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Аттрибуты**:
- `label` (str): Метка провайдера ("API Robocoders AI").
- `url` (str): URL документации API ("https://api.robocoders.ai/docs").
- `api_endpoint` (str): URL конечной точки API для чата ("https://api.robocoders.ai/chat").
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (`True`).
- `default_model` (str): Модель, используемая по умолчанию (`'GeneralCodingAgent'`).
- `agent` (List[str]): Список доступных агентов.
- `models` (List[str]): Список поддерживаемых моделей.
- `CACHE_DIR` (Path): Директория для хранения кэша.
- `CACHE_FILE` (Path): Путь к файлу кэша (`robocoders.json`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.
- `_get_or_create_access_and_session`: Получает или создает токен доступа и идентификатор сессии.
- `_fetch_and_cache_access_token`: Получает и кэширует токен доступа.
- `_create_and_cache_session`: Создает и кэширует идентификатор сессии.
- `_save_cached_data`: Сохраняет данные в кэш.
- `_update_cached_data`: Обновляет данные в кэше.
- `_clear_cached_data`: Очищает кэш.
- `_get_cached_data`: Получает данные из кэша.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API Robocoders AI.

    Args:
        cls (RobocodersAPI): Класс RobocodersAPI.
        model (str): Модель агента для использования.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): HTTP-прокси для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий ответы от API.

    Raises:
        Exception: Если не удалось инициализировать взаимодействие с API, произошла ошибка авторизации,
                   ошибка валидации входных данных, серверная ошибка или неожиданная ошибка.

    Внутренние функции:
        Отсутствуют

    Как работает функция:
    1. Устанавливает таймаут для HTTP-запросов.
    2. Создает асинхронную сессию с использованием `aiohttp.ClientSession`.
    3. Загружает или создает токен доступа и идентификатор сессии с помощью `_get_or_create_access_and_session`.
    4. Формирует заголовки запроса, включая токен доступа.
    5. Формирует данные запроса, включая идентификатор сессии, промпт и модель агента.
    6. Отправляет POST-запрос к API и обрабатывает ответ.
    7. В случае ошибки авторизации очищает кэш и вызывает исключение.
    8. В случае достижения лимита ресурсов отправляет дополнительный запрос для продолжения диалога.
    9. Декодирует и обрабатывает данные ответа, извлекая сообщения и передавая их через генератор.

    ASCII Flowchart:
    Начало --> Создание сессии
    Создание сессии --> Получение/создание токена и session_id
    Получение/создание токена и session_id --> Формирование запроса
    Формирование запроса --> Отправка POST-запроса к API
    Отправка POST-запроса к API --> Обработка ответа
    Обработка ответа --> Выдача сообщений через генератор
    Обработка ответа --> Достигнут лимит ресурсов?
    Достигнут лимит ресурсов? -- Да --> Отправка запроса на продолжение
    Отправка запроса на продолжение --> Обработка ответа на продолжение
    Обработка ответа на продолжение --> Выдача сообщений через генератор
    Достигнут лимит ресурсов? -- Нет --> Конец

    Примеры:
    ```python
    # Пример использования create_async_generator
    messages = [{"role": "user", "content": "Привет, как дела?"}]
    async for message in RobocodersAPI.create_async_generator(model="GeneralCodingAgent", messages=messages):
        print(message)
    ```
    """
    ...
```

### `_get_or_create_access_and_session`

```python
    @staticmethod
    async def _get_or_create_access_and_session(session: aiohttp.ClientSession) -> tuple[str, str]:
        """
        Получает существующий или создает новый токен доступа и идентификатор сессии.

        Args:
            session (aiohttp.ClientSession): Асинхронная сессия для выполнения HTTP-запросов.

        Returns:
            tuple[str, str]: Кортеж, содержащий токен доступа и идентификатор сессии.

        Raises:
            Exception: Если не удалось получить токен доступа или создать сессию.

        Внутренние функции:
            Отсутствуют

        Как работает функция:
        1. Создает директорию для кэша, если она не существует.
        2. Пытается загрузить данные из кэша.
        3. Если данные в кэше валидны (токен доступа и идентификатор сессии присутствуют), возвращает их.
        4. Если данные не валидны или отсутствуют, получает новый токен доступа и создает новую сессию.
        5. Возвращает новый токен доступа и идентификатор сессии.

        ASCII Flowchart:
        Начало --> Проверка наличия кэша
        Проверка наличия кэша -- Кэш существует --> Загрузка данных из кэша
        Проверка наличия кэша -- Кэш не существует --> Получение нового токена
        Загрузка данных из кэша --> Проверка валидности данных
        Проверка валидности данных -- Данные валидны --> Возврат данных из кэша
        Проверка валидности данных -- Данные не валидны --> Получение нового токена
        Получение нового токена --> Создание новой сессии
        Создание новой сессии --> Возврат нового токена и session_id
        Конец

        Примеры:
        ```python
        # Пример использования _get_or_create_access_and_session
        async with aiohttp.ClientSession() as session:
            access_token, session_id = await RobocodersAPI._get_or_create_access_and_session(session)
            print(f"Access Token: {access_token}, Session ID: {session_id}")
        ```
        """
        ...
```

### `_fetch_and_cache_access_token`

```python
    @staticmethod
    async def _fetch_and_cache_access_token(session: aiohttp.ClientSession) -> str:
        """
        Получает токен доступа с сервера авторизации и кэширует его.

        Args:
            session (aiohttp.ClientSession): Асинхронная сессия для выполнения HTTP-запросов.

        Returns:
            str: Токен доступа.

        Raises:
            MissingRequirementsError: Если не установлена библиотека `beautifulsoup4`.

        Внутренние функции:
            Отсутствуют

        Как работает функция:
        1. Проверяет, установлена ли библиотека `beautifulsoup4`. Если нет, вызывает исключение.
        2. Отправляет GET-запрос к серверу авторизации.
        3. Извлекает токен доступа из HTML-ответа с использованием `BeautifulSoup`.
        4. Кэширует токен доступа.
        5. Возвращает токен доступа.

        ASCII Flowchart:
        Начало --> Проверка наличия BeautifulSoup
        Проверка наличия BeautifulSoup -- BeautifulSoup установлен --> Отправка GET-запроса к серверу авторизации
        Проверка наличия BeautifulSoup -- BeautifulSoup не установлен --> Вызов исключения MissingRequirementsError
        Отправка GET-запроса к серверу авторизации --> Извлечение токена из HTML
        Извлечение токена из HTML --> Кэширование токена
        Кэширование токена --> Возврат токена
        Конец

        Примеры:
        ```python
        # Пример использования _fetch_and_cache_access_token
        async with aiohttp.ClientSession() as session:
            token = await RobocodersAPI._fetch_and_cache_access_token(session)
            print(f"Access Token: {token}")
        ```
        """
        ...
```

### `_create_and_cache_session`

```python
    @staticmethod
    async def _create_and_cache_session(session: aiohttp.ClientSession, access_token: str) -> str:
        """
        Создает новую сессию на сервере и кэширует идентификатор сессии.

        Args:
            session (aiohttp.ClientSession): Асинхронная сессия для выполнения HTTP-запросов.
            access_token (str): Токен доступа.

        Returns:
            str: Идентификатор сессии.

        Raises:
            Exception: Если произошла ошибка авторизации или ошибка валидации входных данных.

        Внутренние функции:
            Отсутствуют

        Как работает функция:
        1. Отправляет GET-запрос к серверу для создания сессии, используя токен доступа.
        2. Извлекает идентификатор сессии из JSON-ответа.
        3. Кэширует идентификатор сессии.
        4. Возвращает идентификатор сессии.

        ASCII Flowchart:
        Начало --> Отправка GET-запроса для создания сессии
        Отправка GET-запроса для создания сессии --> Извлечение session_id из JSON
        Извлечение session_id из JSON --> Кэширование session_id
        Кэширование session_id --> Возврат session_id
        Конец

        Примеры:
        ```python
        # Пример использования _create_and_cache_session
        async with aiohttp.ClientSession() as session:
            token = "your_access_token"
            session_id = await RobocodersAPI._create_and_cache_session(session, token)
            print(f"Session ID: {session_id}")
        ```
        """
        ...
```

### `_save_cached_data`

```python
    @staticmethod
    def _save_cached_data(new_data: dict):
        """
        Сохраняет новые данные в файл кэша.

        Args:
            new_data (dict): Данные для сохранения.

        Внутренние функции:
            Отсутствуют

        Как работает функция:
        1. Создает директорию для кэша, если она не существует.
        2. Создает файл кэша, если он не существует.
        3. Сохраняет данные в файл кэша в формате JSON.

        ASCII Flowchart:
        Начало --> Создание директории кэша
        Создание директории кэша --> Создание файла кэша
        Создание файла кэша --> Сохранение данных в JSON
        Конец

        Примеры:
        ```python
        # Пример использования _save_cached_data
        data = {"access_token": "your_access_token"}
        RobocodersAPI._save_cached_data(data)
        ```
        """
        ...
```

### `_update_cached_data`

```python
    @staticmethod
    def _update_cached_data(updated_data: dict):
        """
        Обновляет существующие данные в кэше новыми значениями.

        Args:
            updated_data (dict): Данные для обновления.

        Внутренние функции:
            Отсутствуют

        Как работает функция:
        1. Пытается загрузить существующие данные из файла кэша.
        2. Если файл кэша поврежден, начинает с пустого словаря.
        3. Обновляет загруженные данные новыми значениями.
        4. Сохраняет обновленные данные в файл кэша.

        ASCII Flowchart:
        Начало --> Загрузка данных из кэша
        Загрузка данных из кэша --> Проверка целостности данных
        Проверка целостности данных -- Данные повреждены --> Инициализация пустого словаря
        Проверка целостности данных -- Данные не повреждены --> Обновление данных
        Обновление данных --> Сохранение данных в JSON
        Конец

        Примеры:
        ```python
        # Пример использования _update_cached_data
        data = {"sid": "your_session_id"}
        RobocodersAPI._update_cached_data(data)
        ```
        """
        ...
```

### `_clear_cached_data`

```python
    @staticmethod
    def _clear_cached_data():
        """
        Удаляет файл кэша.

        Args:
            Нет аргументов.

        Внутренние функции:
            Отсутствуют

        Как работает функция:
        1. Проверяет, существует ли файл кэша.
        2. Если файл существует, удаляет его.

        ASCII Flowchart:
        Начало --> Проверка наличия файла кэша
        Проверка наличия файла кэша -- Файл существует --> Удаление файла кэша
        Проверка наличия файла кэша -- Файл не существует --> Конец
        Конец

        Примеры:
        ```python
        # Пример использования _clear_cached_data
        RobocodersAPI._clear_cached_data()
        ```
        """
        ...
```

### `_get_cached_data`

```python
    @staticmethod
    def _get_cached_data() -> dict:
        """
        Получает все данные из кэша.

        Args:
            Нет аргументов.

        Returns:
            dict: Данные из кэша.

        Внутренние функции:
            Отсутствуют

        Как работает функция:
        1. Проверяет, существует ли файл кэша.
        2. Если файл существует, загружает данные из него.
        3. Если файл поврежден, возвращает пустой словарь.
        4. Если файл не существует, возвращает пустой словарь.

        ASCII Flowchart:
        Начало --> Проверка наличия файла кэша
        Проверка наличия файла кэша -- Файл существует --> Загрузка данных из кэша
        Проверка наличия файла кэша -- Файл не существует --> Возврат пустого словаря
        Загрузка данных из кэша --> Проверка целостности данных
        Проверка целостности данных -- Данные повреждены --> Возврат пустого словаря
        Проверка целостности данных -- Данные не повреждены --> Возврат данных
        Конец

        Примеры:
        ```python
        # Пример использования _get_cached_data
        data = RobocodersAPI._get_cached_data()
        print(f"Cached Data: {data}")
        ```
        """
        ...