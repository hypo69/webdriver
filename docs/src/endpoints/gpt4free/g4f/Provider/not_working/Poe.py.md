# Модуль для взаимодействия с Poe.com
=================================================

Модуль содержит класс `Poe`, который используется для взаимодействия с Poe.com, платформой, предоставляющей доступ к различным моделям искусственного интеллекта.

## Обзор

Модуль `Poe.py` предназначен для обеспечения взаимодействия с платформой Poe.com, позволяя использовать различные модели, такие как Llama-2 и GPT, через веб-интерфейс. Он автоматизирует процесс отправки запросов и получения ответов от этих моделей, используя Selenium WebDriver для управления браузером.

## Подробнее

Этот модуль предоставляет класс `Poe`, который наследуется от `AbstractProvider`. Он использует Selenium WebDriver для автоматизации взаимодействия с веб-сайтом Poe.com.  Код модуля включает в себя установку перехватчика WebSocket для извлечения ответов от AI моделей в реальном времени.

## Классы

### `Poe`

**Описание**: Класс для взаимодействия с Poe.com.

**Наследует**:
- `AbstractProvider`: Абстрактный класс-родитель, определяющий интерфейс для провайдеров.

**Атрибуты**:
- `url` (str): URL сайта Poe.com.
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (в данном случае `True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (в данном случае `True`).
- `models` (dict): Список поддерживаемых моделей.

**Методы**:
- `create_completion`: Метод для создания и получения ответа от модели.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    webdriver: WebDriver = None,
    user_data_dir: str = None,
    headless: bool = True,
    **kwargs
) -> CreateResult:
    """
    Создает и возвращает ответ от указанной модели на Poe.com.

    Args:
        cls: Ссылка на класс.
        model (str): Имя модели для использования.
        messages (Messages): Список сообщений для отправки модели.
        stream (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        webdriver (WebDriver, optional): Инстанс WebDriver для управления браузером. По умолчанию `None`.
        user_data_dir (str, optional): Путь к каталогу пользовательских данных браузера. По умолчанию `None`.
        headless (bool, optional): Флаг, указывающий, запускать ли браузер в headless-режиме. По умолчанию `True`.
        **kwargs: Дополнительные аргументы.

    Returns:
        CreateResult: Результат выполнения запроса.

    Raises:
        ValueError: Если указанная модель не поддерживается.
        RuntimeError: Если не удалось найти текстовое поле для ввода запроса.

    Внутренние функции:
        element_send_text - функция для ввода текста в элемент на веб-странице.

    """
```

**Назначение**:
Функция `create_completion` отвечает за создание запроса к выбранной модели на платформе Poe.com и получение ответа. Она использует Selenium WebDriver для автоматизации действий в браузере, включая открытие страницы, ввод текста запроса и ожидание ответа.

**Параметры**:
- `cls`: Ссылка на класс.
- `model` (str): Имя модели для использования. Если не указано, используется `gpt-3.5-turbo`.
- `messages` (Messages): Список сообщений, отправляемых модели.
- `stream` (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `webdriver` (WebDriver, optional): Инстанс WebDriver для управления браузером. По умолчанию `None`.
- `user_data_dir` (str, optional): Путь к каталогу пользовательских данных браузера. По умолчанию `None`.
- `headless` (bool, optional): Флаг, указывающий, запускать ли браузер в headless-режиме (без графического интерфейса). По умолчанию `True`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `CreateResult`: Результат выполнения запроса. В данном случае, функция возвращает чанки текста по мере их генерации моделью.

**Вызывает исключения**:
- `ValueError`: Если указанная модель не поддерживается.
- `RuntimeError`: Если не удалось найти текстовое поле для ввода запроса.

**Как работает функция**:
1. **Подготовка**:
   - Проверяет, указана ли модель. Если нет, использует `gpt-3.5-turbo`.
   - Проверяет, поддерживается ли указанная модель, выбрасывая `ValueError`, если модель не найдена в списке поддерживаемых.
   - Форматирует запросы, используя функцию `format_prompt`.

2. **Автоматизация браузера**:
   - Создает сессию WebDriver, используя `WebDriverSession`.
   - Внутри контекстного менеджера `with session as driver`:
     - Добавляет скрипт для перехвата сообщений WebSocket и извлечения ответов от AI-модели. Скрипт устанавливает перехватчик, который сохраняет сообщения от сервера в глобальные переменные `window._message` и `window._message_finished`.
     - Пытается открыть страницу Poe.com с выбранной моделью и дождаться появления текстового поля для ввода запроса.
     - Если происходит ошибка (например, пользователь не залогинен), пытается переоткрыть браузер и повторить попытку. Если это не удается, выбрасывает `RuntimeError`.

3. **Отправка запроса и получение ответа**:
   - Вводит текст запроса в текстовое поле, используя функцию `element_send_text`.
   - Нажимает кнопку отправки сообщения.
   - Запускает цикл, в котором:
     - Выполняет JavaScript-скрипт для получения чанка ответа из глобальной переменной `window._message`.
     - Если получен чанк, возвращает его.
     - Если `window._message_finished` установлен в `true`, завершает цикл.
     - Если чанк не получен, ждет 0.1 секунды и повторяет попытку.

4. **Обработка ошибок**:
   - В случае возникновения исключений в процессе автоматизации браузера, они перехватываются и логируются с использованием `logger.error`.

**Внутренние функции**:
- **element_send_text**: функция для ввода текста в элемент на веб-странице.

**ASCII flowchart функции**:

```
    Начало
     ↓
  Проверка модели
     ↓
  Форматирование запроса
     ↓
  Создание сессии WebDriver
     ↓
  Добавление скрипта для перехвата сообщений
     ↓
  Открытие страницы Poe.com и ожидание текстового поля
     ↓
  Ввод текста запроса и отправка сообщения
     ↓
  Цикл получения чанков ответа:
     ├─> Выполнение JavaScript-скрипта для получения чанка
     │   ↓
     ├─> Чанк получен?
     │   ├─> Да: Возврат чанка
     │   │   ↓
     │   ├─> Нет: Проверка window._message_finished
     │   │   ├─> Закончено: Выход из цикла
     │   │   ↓
     │   ├─> Ожидание 0.1 секунды и повтор
     │   ↓
    Конец
```

**Примеры**:

Пример 1: Использование с минимальными параметрами.
```python
messages = [{"role": "user", "content": "Hello, Poe!"}]
result = Poe.create_completion(model="gpt-3.5-turbo", messages=messages, stream=True)
for chunk in result:
    print(chunk, end="")
```

Пример 2: Использование с указанием прокси и каталога пользовательских данных.
```python
messages = [{"role": "user", "content": "Как написать Hello World на Python?"}]
result = Poe.create_completion(
    model="gpt-4",
    messages=messages,
    stream=True,
    proxy="http://your_proxy:8080",
    user_data_dir="/path/to/user/data/dir"
)
for chunk in result:
    print(chunk, end="")
```

Пример 3: Использование с WebDriver
```python
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

# Настройка опций Chrome
chrome_options = Options()
chrome_options.add_argument("--disable-extensions")
chrome_options.add_argument("--disable-gpu")
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")

# Инициализация драйвера Chrome
driver = webdriver.Chrome(options=chrome_options)

messages = [{"role": "user", "content": "Расскажи мне анекдот."}]
result = Poe.create_completion(
    model="gpt-3.5-turbo",
    messages=messages,
    stream=True,
    webdriver=driver
)

for chunk in result:
    print(chunk, end="")

driver.quit()