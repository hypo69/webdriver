# Модуль `ReplicateHome.py`

## Обзор

Модуль предназначен для взаимодействия с платформой Replicate для выполнения задач генерации текста и изображений. Он предоставляет асинхронный генератор для получения результатов и поддерживает потоковую передачу данных. Модуль позволяет использовать различные модели, такие как `google-deepmind/gemma-2b-it` для текста и `stability-ai/stable-diffusion-3` для изображений.

## Подробнее

Модуль `ReplicateHome` асинхронно взаимодействует с API Replicate для генерации текста и изображений. Он поддерживает выбор различных моделей и предоставляет удобный интерфейс для получения результатов. В основном используется для интеграции с сервисами, требующими асинхронной обработки и потоковой передачи данных, например, для чат-ботов или систем генерации изображений в реальном времени. Расположение файла в структуре проекта `hypotez` указывает на его использование в качестве одного из провайдеров для GPT4Free.

## Классы

### `ReplicateHome`

**Описание**: Класс `ReplicateHome` предоставляет интерфейс для взаимодействия с API Replicate для генерации текста и изображений.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию результатов.
- `ProviderModelMixin`: Предоставляет методы для управления моделями.

**Атрибуты**:
- `url` (str): URL главной страницы Replicate.
- `api_endpoint` (str): URL API для выполнения предсказаний.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `image_models` (List[str]): Список поддерживаемых моделей для генерации изображений.
- `text_models` (List[str]): Список поддерживаемых моделей для генерации текста.
- `models` (List[str]): Объединенный список моделей для текста и изображений.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей для удобства использования.
- `model_versions` (Dict[str, str]): Словарь версий моделей для обеспечения совместимости.

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    prompt: str = None,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для выполнения запросов к API Replicate.

    Args:
        cls (ReplicateHome): Класс `ReplicateHome`.
        model (str): Имя модели для использования.
        messages (Messages): Список сообщений для формирования запроса.
        prompt (str, optional): Текст запроса. По умолчанию `None`.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор для получения результатов.

    Raises:
        Exception: Если предсказание не удалось или истекло время ожидания.

    """
```

**Назначение**: Создает и запускает асинхронный генератор для взаимодействия с API Replicate, позволяя получать результаты генерации текста или изображений в асинхронном режиме.

**Параметры**:
- `cls`: Класс `ReplicateHome`.
- `model` (str): Имя модели, которую необходимо использовать для генерации.
- `messages` (Messages): Список сообщений, используемых для формирования запроса. Этот параметр может содержать контекст или инструкции для модели.
- `prompt` (str, optional): Непосредственный текст запроса. Если не указан, формируется автоматически на основе `messages`. По умолчанию `None`.
- `proxy` (str, optional): URL прокси-сервера для выполнения запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API Replicate.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который предоставляет результаты генерации по мере их поступления.

**Вызывает исключения**:
- `Exception`: Если во время выполнения запроса произошла ошибка, например, предсказание не удалось (`failed`) или истекло время ожидания (`timed out`).

**Как работает функция**:

1. **Определение модели**: Функция начинает с определения используемой модели на основе входного параметра `model`, применяя псевдонимы, если необходимо.
2. **Формирование заголовков**: Заголовки HTTP-запроса настраиваются для имитации запроса от браузера, включая User-Agent, Referer и Content-Type.
3. **Создание сессии**: Используется асинхронная сессия `aiohttp` для выполнения запросов. При необходимости устанавливается прокси-сервер.
4. **Формирование запроса**: Если `prompt` не указан, он формируется на основе `messages`. Для моделей изображений берется последнее сообщение.
5. **Отправка запроса**: Запрос отправляется на API Replicate с указанием модели, версии и входных данных.
6. **Получение ID предсказания**: Из ответа извлекается ID предсказания, который используется для опроса статуса выполнения.
7. **Опрос статуса**: Выполняется циклический опрос API для получения статуса предсказания. Опрос выполняется с интервалом в 5 секунд и максимальным количеством попыток 30.
8. **Обработка результата**:
   - Если статус `succeeded`, результат возвращается в виде генератора. Для моделей изображений возвращается URL изображения. Для текстовых моделей возвращаются чанки текста.
   - Если статус `failed`, выбрасывается исключение с описанием ошибки.
9. **Обработка таймаута**: Если за 30 попыток статус не становится `succeeded`, выбрасывается исключение о таймауте.

**Внутренние функции**:

Внутри `create_async_generator` используются асинхронные операции для выполнения HTTP-запросов и обработки ответов. Важной частью является цикл опроса статуса предсказания, который включает в себя следующие шаги:

   - Ожидание (`asyncio.sleep(delay)`): Задержка между запросами для снижения нагрузки на API.
   - Обработка JSON (`response.json()`): Попытка распарсить ответ как JSON. В случае ошибки парсинга выполняется дополнительная обработка для извлечения JSON из текста ответа.

**ASCII flowchart**:

```
     Определение модели
     │
     Формирование заголовков
     │
     Создание асинхронной сессии
     │
     Формирование запроса (prompt)
     │
     Отправка POST запроса
     │
     Получение ID предсказания
     │
     Начало цикла опроса статуса (30 попыток)
     │
     GET запрос к API опроса
     │
     Получение результата
     ├───> Статус "succeeded" ───> Обработка результата (генерация изображения или текста) ───> Выход
     │
     └───> Статус "failed"    ───> Выброс исключения
     │
     └───> Таймаут (после 30 попыток) ───> Выброс исключения
     │
     Конец
```

**Примеры**:

1. Генерация текста с использованием модели `google-deepmind/gemma-2b-it`:

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.not_working.ReplicateHome import ReplicateHome

async def main():
    model = "gemma-2b"
    messages = [{"role": "user", "content": "Напиши короткий стих о весне."}]
    generator = await ReplicateHome.create_async_generator(model=model, messages=messages)
    async for chunk in generator:
        print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

2. Генерация изображения с использованием модели `stability-ai/stable-diffusion-3`:

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.not_working.ReplicateHome import ReplicateHome

async def main():
    model = "sd-3"
    messages = [{"role": "user", "content": "A beautiful landscape with mountains and a lake."}]
    generator = await ReplicateHome.create_async_generator(model=model, messages=messages)
    async for image_response in generator:
        print(f"Image URL: {image_response.url}")

if __name__ == "__main__":
    asyncio.run(main())