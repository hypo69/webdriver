# Модуль для работы с DuckDuckGo в качестве поставщика услуг

## Обзор

Модуль предоставляет класс `DuckDuckGo`, который позволяет взаимодействовать с чат-ботом DuckDuckGo для генерации текста на основе предоставленных сообщений. Он использует библиотеку `duckduckgo_search` для взаимодействия с API DuckDuckGo и поддерживает асинхронную генерацию текста.

## Подробнее

Этот модуль интегрирует DuckDuckGo в качестве одного из поставщиков услуг в проекте `hypotez`. Он включает поддержку потоковой передачи ответов, системных сообщений и истории сообщений. Модуль предназначен для использования в асинхронных приложениях и обеспечивает взаимодействие с DuckDuckGo через его API.

## Классы

### `DuckDuckGo`

**Описание**: Класс `DuckDuckGo` является асинхронным генератором и предоставляет интерфейс для взаимодействия с чат-ботом DuckDuckGo.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет миксин для работы с моделями.

**Атрибуты**:
- `label` (str): Метка поставщика услуг ("Duck.ai (duckduckgo_search)").
- `url` (str): URL для взаимодействия с DuckDuckGo AI Chat.
- `api_base` (str): Базовый URL для API DuckDuckGo.
- `working` (bool): Указывает, работает ли поставщик услуг (по умолчанию `False`).
- `supports_stream` (bool): Указывает, поддерживает ли поставщик потоковую передачу ответов (по умолчанию `True`).
- `supports_system_message` (bool): Указывает, поддерживает ли поставщик системные сообщения (по умолчанию `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли поставщик историю сообщений (по умолчанию `True`).
- `default_model` (str): Модель, используемая по умолчанию ("gpt-4o-mini").
- `models` (List[str]): Список поддерживаемых моделей.
- `ddgs` (DDGS): Инстанс класса `DDGS` из библиотеки `duckduckgo_search` (инициализируется как `None`).
- `model_aliases` (Dict[str, str]): Псевдонимы моделей для удобства использования.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от DuckDuckGo.
- `nodriver_auth`: Выполняет аутентификацию с использованием `nodriver`.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 60,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от DuckDuckGo.

    Args:
        model (str): Имя используемой модели.
        messages (Messages): Список сообщений для отправки в чат-бот.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Максимальное время ожидания ответа. По умолчанию `60`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий фрагменты текста ответа.

    Raises:
        ImportError: Если не установлен пакет `duckduckgo_search`.
        Exception: Если возникает ошибка при взаимодействии с API DuckDuckGo.
    """
```

**Назначение**:
Создает асинхронный генератор, который отправляет сообщения в чат-бот DuckDuckGo и возвращает ответы в виде фрагментов текста.

**Как работает функция**:

1. **Проверка зависимостей**:
   - Проверяет, установлен ли пакет `duckduckgo_search`. Если нет, вызывает исключение `ImportError`.
2. **Инициализация `DDGS`**:
   - Если `cls.ddgs` еще не инициализирован, создает инстанс класса `DDGS` с указанным прокси и таймаутом.
   - Если `has_nodriver` имеет значение True, то вызывается функция `cls.nodriver_auth`
3. **Получение имени модели**:
   - Вызывает `cls.get_model(model)` для получения правильного имени модели.
4. **Генерация ответа**:
   - Вызывает `cls.ddgs.chat_yield` с последним сообщением пользователя, именем модели и таймаутом.
   - Перебирает фрагменты ответа, возвращаемые генератором `chat_yield`, и передает их вызывающей стороне.

**ASII flowchart**:

```
A: Проверка наличия duckduckgo_search
|
B: Инициализация DDGS (если необходимо)
|
C: nodriver_auth (если необходимо)
|
D: Получение имени модели
|
E: Вызов cls.ddgs.chat_yield для генерации ответа
|
F: Передача фрагментов ответа
```

**Примеры**:

```python
# Пример использования create_async_generator
model_name = "gpt-4o-mini"
messages = [{"role": "user", "content": "Hello, DuckDuckGo!"}]
async for chunk in DuckDuckGo.create_async_generator(model=model_name, messages=messages):
    print(chunk, end="")
```

### `nodriver_auth`

```python
@classmethod
async def nodriver_auth(cls, proxy: str = None):
    """
    Выполняет аутентификацию с использованием nodriver для получения необходимых параметров.

    Args:
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
    """
```

**Назначение**:
Выполняет аутентификацию с использованием `nodriver` для получения параметров `X-Vqd-4`, `X-Vqd-Hash-1` и `F-Fe-Version`, необходимых для взаимодействия с API DuckDuckGo.

**Как работает функция**:

1. **Запуск браузера**:
   - Запускает браузер с использованием `get_nodriver` с указанным прокси.
2. **Определение обработчика запросов**:
   - Определяет функцию `on_request`, которая будет вызываться при отправке каждого запроса.
   - Внутри `on_request` проверяется, содержит ли URL запроса `cls.api_base`.
   - Если URL содержит `cls.api_base`, извлекаются значения заголовков `X-Vqd-4`, `X-Vqd-Hash-1` и `F-Fe-Version` и сохраняются в атрибуты `cls.ddgs._chat_vqd`, `cls.ddgs._chat_vqd_hash` и `cls.ddgs._chat_xfe` соответственно.
3. **Активация Network.enable()**:
   - Активирует перехват сетевых запросов с помощью `page.send(nodriver.cdp.network.enable())`.
4. **Добавление обработчика**:
   - Добавляет обработчик `on_request` для события `nodriver.cdp.network.RequestWillBeSent`.
5. **Открытие страницы**:
   - Открывает страницу `cls.url` в браузере с помощью `browser.get(cls.url)`.
6. **Ожидание аутентификации**:
   - Ожидает, пока не будет установлено значение `cls.ddgs._chat_vqd`.
7. **Закрытие страницы**:
   - Закрывает текущую страницу с помощью `page.close()`.
8. **Остановка браузера**:
   - Останавливает браузер с помощью `stop_browser()` в блоке `finally`, чтобы гарантировать, что браузер будет остановлен даже в случае возникновения исключения.

**ASII flowchart**:

```
A: Запуск браузера (get_nodriver)
|
B: Определение обработчика запросов (on_request)
|
C: Активация Network.enable()
|
D: Добавление обработчика запросов
|
E: Открытие страницы (browser.get(cls.url))
|
F: Ожидание аутентификации (cls.ddgs._chat_vqd установлено)
|
G: Закрытие страницы
|
H: Остановка браузера (stop_browser)
```

**Примеры**:

```python
# Пример использования nodriver_auth
async def example():
    await DuckDuckGo.nodriver_auth(proxy="http://your_proxy")
```