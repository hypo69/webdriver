# Модуль для работы с Ylokh API
## Обзор

Модуль `Ylokh.py` предоставляет класс `Ylokh`, который является асинхронным провайдером для взаимодействия с API `chat.ylokh.xyz`. Этот API используется для получения ответов от языковой модели, такой как GPT-3.5-turbo. Класс поддерживает потоковую передачу данных и сохранение истории сообщений.

## Подробней

Этот модуль позволяет интегрировать взаимодействие с Ylokh API в асинхронные приложения. Он предоставляет удобный интерфейс для отправки сообщений и получения ответов, поддерживая как потоковый, так и не потоковый режимы. Модуль предназначен для использования в проектах, требующих асинхронного взаимодействия с языковыми моделями. Расположение файла в проекте указывает на его роль как одного из провайдеров для доступа к различным языковым моделям через `gpt4free`.

## Классы

### `Ylokh`

**Описание**: Класс `Ylokh` является асинхронным провайдером для взаимодействия с API `chat.ylokh.xyz`.

**Наследует**:
- `AsyncGeneratorProvider`: Наследует функциональность асинхронного генератора провайдера.

**Аттрибуты**:
- `url` (str): URL API `chat.ylokh.xyz`.
- `working` (bool): Указывает, работает ли провайдер в данный момент. Изначально установлено значение `False`.
- `supports_message_history` (bool): Поддержка истории сообщений. Установлено значение `True`.
- `supports_gpt_35_turbo` (bool): Поддержка модели GPT-3.5-turbo. Установлено значение `True`.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения ответов от API.

## Функции

### `create_async_generator`

```python
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool = True,
        proxy: str = None,
        timeout: int = 120,
        **kwargs
    ) -> AsyncResult:
        """ Создает асинхронный генератор для получения ответов от API.
        Args:
            cls (class): Класс, для которого создается генератор.
            model (str): Название модели для использования (например, "gpt-3.5-turbo").
            messages (Messages): Список сообщений для отправки в API.
            stream (bool, optional): Флаг, указывающий, использовать ли потоковый режим. По умолчанию `True`.
            proxy (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию 120.
            **kwargs: Дополнительные аргументы для передачи в API.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от API.

        Raises:
            Exception: Возникает, если при запросе к API произошла ошибка.

        """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API `chat.ylokh.xyz`.

**Параметры**:
- `cls` (class): Класс, для которого создается генератор.
- `model` (str): Название модели для использования (например, "gpt-3.5-turbo").
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool, optional): Флаг, указывающий, использовать ли потоковый режим. По умолчанию `True`.
- `proxy` (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа от API в секундах. По умолчанию 120.
- `**kwargs`: Дополнительные аргументы для передачи в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Вызывает исключения**:
- `Exception`: Возникает, если при запросе к API произошла ошибка.

**Как работает функция**:

1. **Инициализация параметров**:
   - Функция `create_async_generator` принимает параметры, такие как модель, сообщения, флаг потоковой передачи, прокси и время ожидания.
   - Если модель не указана, устанавливается значение по умолчанию "gpt-3.5-turbo".

2. **Формирование заголовков и данных**:
   - Создаются заголовки (`headers`) с указанием источника и реферера.
   - Формируются данные (`data`) для отправки в API, включающие сообщения, модель, параметры температуры, штрафы присутствия и частоты, разрешение на резервный режим и флаг потоковой передачи.
   - Дополнительные аргументы (`kwargs`) также добавляются в данные.

3. **Выполнение запроса к API**:
   - Используется асинхронная сессия (`StreamSession`) для отправки POST-запроса к API `https://chatapi.ylokh.xyz/v1/chat/completions`.
   - В случае ошибки при запросе вызывается исключение `response.raise_for_status()`.

4. **Обработка потокового режима**:
   - Если включен потоковый режим (`stream=True`):
     - Функция итерируется по строкам в ответе от API.
     - Каждая строка декодируется.
     - Если строка начинается с "data: ", она обрабатывается как часть данных ответа.
     - Если строка "data: [DONE]", итерация прекращается.
     - JSON-данные извлекаются из строки и загружаются.
     - Извлекается содержимое сообщения (`content`) из данных и возвращается через `yield`.

5. **Обработка не потокового режима**:
   - Если потоковый режим выключен (`stream=False`):
     - Функция ожидает получения полного JSON-ответа от API.
     - Извлекается содержимое сообщения (`content`) из ответа и возвращается через `yield`.

```
create_async_generator
│
├───> Настройка параметров (модель, сообщения, stream, proxy, timeout)
│
├───> Формирование HTTP-заголовков и данных запроса
│   │   headers = {"Origin": cls.url, "Referer": f"{cls.url}/"}
│   │   data = {"messages": messages, "model": model, ...}
│
├───> Отправка POST-запроса к API (https://chatapi.ylokh.xyz/v1/chat/completions)
│   │   async with session.post("...", json=data) as response:
│   │   response.raise_for_status() # Проверка статуса ответа
│
├───> Обработка потокового режима (stream=True)
│   │   async for line in response.iter_lines():
│   │   │   line = line.decode()
│   │   │   if line.startswith("data: "):
│   │   │   │   if line.startswith("data: [DONE]"): break
│   │   │   │   line = json.loads(line[6:])
│   │   │   │   content = line["choices"][0]["delta"].get("content")
│   │   │   │   if content: yield content # Возврат части контента
│
└───> Обработка не потокового режима (stream=False)
│   │   chat = await response.json()
│   │   yield chat["choices"][0]["message"].get("content") # Возврат полного контента
│
```

**Примеры**:

Пример 1: Использование потокового режима

```python
async for message in Ylokh.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello!"}]):
    print(message)
```

Пример 2: Использование не потокового режима

```python
async for message in Ylokh.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello!"}], stream=False):
    print(message)
```