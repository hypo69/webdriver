# Модуль для работы с Phind API (g4f Provider)

## Обзор

Модуль `Phind.py` предоставляет асинхронный генератор для взаимодействия с API Phind, предназначенным для получения ответов на вопросы с использованием различных моделей, включая GPT-4 и Phind-34B. Модуль поддерживает потоковую передачу данных, сохранение истории сообщений и работу через прокси.

## Подробнее

Этот модуль является частью проекта `hypotez` и служит для интеграции с сервисом Phind, предоставляющим ответы на вопросы с использованием моделей искусственного интеллекта. Он позволяет отправлять запросы к API Phind и получать ответы в асинхронном режиме. Модуль включает в себя функции для генерации challenge, необходимого для аутентификации запросов.

## Классы

### `Phind`

**Описание**: Класс `Phind` является асинхронным генератором провайдера для работы с API Phind.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных генераторов провайдеров.

**Атрибуты**:
- `url` (str): URL сервиса Phind (`https://www.phind.com`).
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `lockdown` (bool): Указывает, находится ли провайдер в режиме lockdown (в данном случае `True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (в данном случае `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (в данном случае `True`).

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения ответов от API Phind.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    creative_mode: bool = False,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от API Phind.

    Args:
        model (str): Название модели для использования (например, "gpt-4" или "Phind-34B").
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию `120`.
        creative_mode (bool, optional): Включает ли креативный режим. По умолчанию `False`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от API.

    Raises:
        RuntimeError: Если API возвращает ошибку.

    """
    ...
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для взаимодействия с API Phind. Она отправляет запрос к API с заданным списком сообщений и параметрами, а затем возвращает асинхронный генератор, который выдает ответы от API по мере их поступления.

**Параметры**:
- `cls`: Ссылка на класс `Phind`.
- `model` (str): Название модели для использования (например, "gpt-4" или "Phind-34B").
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа от API в секундах. По умолчанию `120`.
- `creative_mode` (bool, optional): Включает ли креативный режим. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Вызывает исключения**:
- `RuntimeError`: Если API возвращает ошибку.

**Как работает функция**:

1. **Подготовка заголовков**: Функция подготавливает заголовки HTTP-запроса, включая информацию о `Accept`, `Origin`, `Referer` и другие параметры, необходимые для успешного взаимодействия с API Phind.
2. **Создание сессии**: Создается асинхронная сессия с использованием `StreamSession` для выполнения HTTP-запросов. Указывается информация для `impersonate` и `proxies` если нужно использовать прокси.
3. **Получение challenge_seeds**: Функция отправляет GET-запрос на URL `https://www.phind.com/search?home=true` и извлекает значения `challenge_seeds` из HTML-кода ответа. Эти значения необходимы для генерации challenge, который используется для аутентификации запроса.
4. **Формирование данных запроса**: На основе входных параметров формируется словарь `data`, содержащий вопрос, историю вопросов и ответов, параметры запроса (язык, модель, креативный режим и т.д.).
5. **Генерация challenge**: С использованием полученных `challenge_seeds` и сформированных данных запроса генерируется challenge с помощью функции `generate_challenge`.
6. **Отправка POST-запроса**: Функция отправляет POST-запрос на URL `https://https.api.phind.com/infer/` с заголовками и данными, сформированными на предыдущих шагах.
7. **Обработка ответа**: Функция обрабатывает ответ от API построчно, выделяя полезные данные и отбрасывая метаданные и другие служебные сообщения. Если в ответе содержится сообщение об ошибке (`<PHIND_BACKEND_ERROR>`), выбрасывается исключение `RuntimeError`.
8. **Генерация данных**: Функция возвращает данные в виде асинхронного генератора, который выдает декодированные строки ответа.

**ASCII flowchart**:

```
A: Подготовка заголовков и создание сессии
↓
B: Получение challenge_seeds из HTML
↓
C: Формирование данных запроса (вопрос, история, параметры)
↓
D: Генерация challenge
↓
E: Отправка POST-запроса к API
↓
F: Обработка ответа и генерация данных
```

**Примеры**:

```python
# Пример вызова функции create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model = "gpt-4"
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Как создать список в Python?"}
    ]
    proxy = None
    timeout = 120
    creative_mode = False

    generator = await Phind.create_async_generator(
        model=model,
        messages=messages,
        proxy=proxy,
        timeout=timeout,
        creative_mode=creative_mode
    )

    async for response in generator:
        print(response, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

### `deterministic_stringify`

```python
def deterministic_stringify(obj):
    """Преобразует объект в JSON-подобную строку с детерминированным порядком ключей.

    Args:
        obj (dict): Объект для преобразования.

    Returns:
        str: JSON-подобная строка с детерминированным порядком ключей.
    """
    ...
```

**Назначение**: Функция `deterministic_stringify` преобразует объект (обычно словарь) в JSON-подобную строку с гарантированным детерминированным порядком ключей. Это необходимо для того, чтобы при повторном вызове функции с одним и тем же объектом всегда получалась одинаковая строка.

**Параметры**:
- `obj` (dict): Объект для преобразования.

**Возвращает**:
- `str`: JSON-подобная строка с детерминированным порядком ключей.

**Как работает функция**:

1. **Обработка значений**: Внутренняя функция `handle_value` рекурсивно обрабатывает значения объекта. Для словарей и списков она сортирует ключи и элементы, чтобы обеспечить детерминированный порядок. Булевы значения преобразуются в строки `'true'` и `'false'`. Числа форматируются с фиксированной точностью и удалением незначащих нулей. Строки заключаются в двойные кавычки.
2. **Сортировка элементов**: Функция сортирует элементы словаря по ключам.
3. **Формирование строки**: Функция формирует строку, объединяя ключи и значения в формате `'ключ:значение'` и разделяя элементы запятыми.

**ASCII flowchart**:

```
A: Сортировка ключей словаря
↓
B: Рекурсивная обработка значений
↓
C: Формирование JSON-подобной строки
```

**Примеры**:

```python
# Пример вызова функции deterministic_stringify
obj = {"b": 2, "a": 1, "c": {"f": 6, "e": 5}}
result = deterministic_stringify(obj)
print(result)  # Output: a:1.00000000,b:2.00000000,c:{e:5.00000000,f:6.00000000}
```

### `prng_general`

```python
def prng_general(seed, multiplier, addend, modulus):
    """Генерирует псевдослучайное число с использованием общих параметров.

    Args:
        seed (int): Начальное значение.
        multiplier (int): Множитель.
        addend (int): Приращение.
        modulus (int): Модуль.

    Returns:
        float: Псевдослучайное число в диапазоне [0, 1).
    """
    ...
```

**Назначение**: Функция `prng_general` генерирует псевдослучайное число с использованием заданных параметров: начального значения (`seed`), множителя (`multiplier`), приращения (`addend`) и модуля (`modulus`).

**Параметры**:
- `seed` (int): Начальное значение.
- `multiplier` (int): Множитель.
- `addend` (int): Приращение.
- `modulus` (int): Модуль.

**Возвращает**:
- `float`: Псевдослучайное число в диапазоне [0, 1).

**Как работает функция**:

1. **Вычисление значения**: Функция вычисляет новое значение `a` по формуле `a = seed * multiplier + addend`.
2. **Нормализация значения**: Если `a` отрицательно, функция преобразует его в положительное значение по модулю `modulus`. Затем функция нормализует значение, разделяя его на `modulus`, чтобы получить псевдослучайное число в диапазоне [0, 1).

**ASCII flowchart**:

```
A: Вычисление значения (seed * multiplier + addend)
↓
B: Нормализация значения по модулю
↓
C: Возврат псевдослучайного числа
```

**Примеры**:

```python
# Пример вызова функции prng_general
seed = 123
multiplier = 456
addend = 789
modulus = 1000
result = prng_general(seed, multiplier, addend, modulus)
print(result)  # Output: 0.537
```

### `generate_challenge_seed`

```python
def generate_challenge_seed(l):
    """Генерирует seed для challenge на основе входного объекта.

    Args:
        l (dict): Входной объект для генерации seed.

    Returns:
        int: Seed для challenge.
    """
    ...
```

**Назначение**: Функция `generate_challenge_seed` генерирует seed для challenge на основе входного объекта (обычно словаря). Seed используется для генерации challenge, который необходим для аутентификации запросов к API Phind.

**Параметры**:
- `l` (dict): Входной объект для генерации seed.

**Возвращает**:
- `int`: Seed для challenge.

**Как работает функция**:

1. **Детерминированная сериализация**: Функция преобразует входной объект в JSON-подобную строку с детерминированным порядком ключей с помощью функции `deterministic_stringify`.
2. **URL-кодирование**: Функция кодирует полученную строку с использованием URL-кодирования, чтобы обеспечить безопасную передачу строки в запросе.
3. **Вычисление хеша**: Функция вычисляет хеш от URL-кодированной строки с помощью функции `simple_hash`.

**ASCII flowchart**:

```
A: Детерминированная сериализация объекта
↓
B: URL-кодирование строки
↓
C: Вычисление хеша строки
```

**Примеры**:

```python
# Пример вызова функции generate_challenge_seed
obj = {"b": 2, "a": 1, "c": {"f": 6, "e": 5}}
result = generate_challenge_seed(obj)
print(result)
```

### `simple_hash`

```python
def simple_hash(s):
    """Вычисляет простой хеш строки.

    Args:
        s (str): Строка для вычисления хеша.

    Returns:
        int: Хеш строки.
    """
    ...
```

**Назначение**: Функция `simple_hash` вычисляет простой хеш строки. Она используется для генерации seed для challenge.

**Параметры**:
- `s` (str): Строка для вычисления хеша.

**Возвращает**:
- `int`: Хеш строки.

**Как работает функция**:

1. **Инициализация хеша**: Функция инициализирует переменную `d` значением 0.
2. **Итерация по символам**: Функция итерируется по каждому символу в строке.
3. **Вычисление хеша**: Для каждого символа функция вычисляет новое значение хеша по формуле `d = ((d << 5) - d + ord(char[0])) & 0xFFFFFFFF`. Если полученное значение превышает `0x7FFFFFFF`, функция вычитает `0x100000000`.

**ASCII flowchart**:

```
A: Инициализация хеша
↓
B: Итерация по символам строки
↓
C: Вычисление хеша для каждого символа
```

**Примеры**:

```python
# Пример вызова функции simple_hash
string = "example"
result = simple_hash(string)
print(result)
```

### `generate_challenge`

```python
def generate_challenge(obj, **kwargs):
    """Генерирует challenge на основе объекта и параметров.

    Args:
        obj (dict): Объект для генерации challenge.
        **kwargs: Параметры для prng_general.

    Returns:
        float: Сгенерированный challenge.
    """
    ...
```

**Назначение**: Функция `generate_challenge` генерирует challenge на основе объекта и параметров. Challenge используется для аутентификации запросов к API Phind.

**Параметры**:
- `obj` (dict): Объект для генерации challenge.
- `**kwargs`: Параметры для функции `prng_general`.

**Возвращает**:
- `float`: Сгенерированный challenge.

**Как работает функция**:

1. **Генерация seed**: Функция генерирует seed для challenge с помощью функции `generate_challenge_seed`.
2. **Генерация псевдослучайного числа**: Функция генерирует псевдослучайное число с использованием функции `prng_general` и seed, полученного на предыдущем шаге.

**ASCII flowchart**:

```
A: Генерация seed для challenge
↓
B: Генерация псевдослучайного числа
```

**Примеры**:

```python
# Пример вызова функции generate_challenge
obj = {"b": 2, "a": 1}
kwargs = {"multiplier": 456, "addend": 789, "modulus": 1000}
result = generate_challenge(obj, **kwargs)
print(result)