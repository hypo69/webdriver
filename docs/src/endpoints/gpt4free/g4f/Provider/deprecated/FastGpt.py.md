# Модуль `FastGpt.py`

## Обзор

Модуль `FastGpt.py` представляет собой реализацию провайдера `FastGpt` для проекта `hypotez`. Он предназначен для взаимодействия с сервисом `chat9.fastgpt.me` и предоставляет функциональность создания запросов к моделям GPT (Generative Pre-trained Transformer). Модуль поддерживает потоковую передачу данных, работу с моделью `gpt-3.5-turbo`, но не поддерживает `gpt-4`.

## Подробней

Этот модуль позволяет отправлять запросы к API `chat9.fastgpt.me` для генерации текста на основе предоставленных сообщений. Он использует библиотеку `requests` для выполнения HTTP-запросов и обрабатывает потоковые ответы, извлекая сгенерированный контент. Модуль также включает логику для выбора случайного поддомена для запросов.

## Классы

### `FastGpt`

**Описание**: Класс `FastGpt` является реализацией абстрактного провайдера `AbstractProvider` и предоставляет методы для взаимодействия с API `chat9.fastgpt.me`.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для провайдеров.

**Аттрибуты**:
- `url` (str): URL-адрес сервиса `chat9.fastgpt.me`.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `needs_auth` (bool): Указывает, требуется ли аутентификация для работы с провайдером.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo`.
- `supports_gpt_4` (bool): Указывает, поддерживает ли провайдер модель `gpt-4`.

**Методы**:
- `create_completion()`: Статический метод для создания запроса к API и получения результата.

## Функции

### `create_completion`

```python
def create_completion(
    model: str,
    messages: list[dict[str, str]],
    stream: bool, **kwargs: Any) -> CreateResult:
    """
    Создает запрос к API `chat9.fastgpt.me` для генерации текста на основе предоставленных сообщений.

    Args:
        model (str): Имя используемой модели.
        messages (list[dict[str, str]]): Список сообщений для отправки в API.
        stream (bool): Указывает, использовать ли потоковую передачу данных.
        **kwargs (Any): Дополнительные параметры запроса, такие как температура, штрафы и т.д.

    Returns:
        CreateResult: Результат запроса в виде генератора токенов.

    Raises:
        requests.exceptions.RequestException: В случае ошибок при выполнении HTTP-запроса.

    """
```

**Назначение**:
Функция `create_completion` отправляет запрос к API `chat9.fastgpt.me` и возвращает результат в виде генератора токенов. Она формирует HTTP-запрос с необходимыми заголовками и данными, а затем обрабатывает потоковый ответ, извлекая сгенерированный контент.

**Параметры**:
- `model` (str): Имя используемой модели.
- `messages` (list[dict[str, str]]): Список сообщений для отправки в API.
- `stream` (bool): Указывает, использовать ли потоковую передачу данных.
- `**kwargs` (Any): Дополнительные параметры запроса, такие как `temperature`, `presence_penalty`, `frequency_penalty` и `top_p`.

**Возвращает**:
- `CreateResult`: Генератор, который выдает токены сгенерированного текста.

**Вызывает исключения**:
- `requests.exceptions.RequestException`: В случае ошибок при выполнении HTTP-запроса.

**Как работает функция**:

1. **Определение заголовков**: Функция начинает с определения необходимых HTTP-заголовков для запроса.

2. **Формирование JSON-данных**: Подготавливает JSON-данные, которые будут отправлены в теле запроса. Эти данные включают сообщения, модель, параметры потоковой передачи и другие параметры, такие как температура, штрафы и вероятность выбора наиболее вероятного токена (`top_p`).

3. **Выбор поддомена**: Случайно выбирает один из поддоменов (`jdaen979ew` или `chat9`) для отправки запроса.

4. **Отправка запроса**: Отправляет POST-запрос к API `chat9.fastgpt.me` с использованием библиотеки `requests`. Указываются заголовки, JSON-данные и параметр `stream` для потоковой передачи.

5. **Обработка потокового ответа**: Перебирает строки в потоковом ответе, декодирует их и извлекает содержимое. Если строка содержит `b'content'`, она разбирается как JSON, и извлекается токен из поля `content`.

6. **Генерация токенов**: Если токен успешно извлечен, он возвращается через `yield`, что делает функцию генератором.

7. **Обработка ошибок**: В случае возникновения исключений при обработке JSON или извлечении токенов, они игнорируются, и функция продолжает обработку следующих строк.

```
Начало
  │
  ├── Определение заголовков HTTP-запроса
  │
  ├── Формирование JSON-данных для запроса
  │
  ├── Выбор случайного поддомена
  │
  ├── Отправка POST-запроса к API
  │
  ├── Обработка потокового ответа
  │   │
  │   └── Для каждой строки в ответе:
  │       │
  │       ├── Проверка наличия 'content'
  │       │
  │       └── Извлечение и генерация токена
  │
  └── Конец
```

**Примеры**:

```python
# Пример использования функции create_completion
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
kwargs = {"temperature": 0.7, "top_p": 0.9}

result = FastGpt.create_completion(model=model, messages=messages, stream=stream, **kwargs)
if result:
    for token in result:
        print(token, end="")