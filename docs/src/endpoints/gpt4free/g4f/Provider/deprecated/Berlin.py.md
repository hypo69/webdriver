# Модуль Berlin

## Обзор

Модуль `Berlin` предоставляет асинхронный генератор для взаимодействия с API `ai.berlin4h.top` с целью получения ответов от языковой модели, такой как `gpt-3.5-turbo`. Он позволяет отправлять запросы к модели и получать ответы в виде асинхронного потока данных.

## Подробнее

Модуль `Berlin` предназначен для использования в проекте `hypotez` для обеспечения возможности взаимодействия с языковой моделью Berlin. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет удобный интерфейс для отправки сообщений и получения ответов. Модуль включает в себя функциональность для аутентификации, форматирования запросов и обработки ответов от API.

## Классы

### `Berlin`

**Описание**: Класс `Berlin` является провайдером асинхронного генератора, который взаимодействует с API `ai.berlin4h.top`.

**Принцип работы**:
1.  Аутентифицируется на сервере, получая токен доступа.
2.  Форматирует входные сообщения в формат, требуемый API.
3.  Отправляет запрос к API с использованием асинхронного HTTP-клиента.
4.  Получает ответ от API в виде потока данных и извлекает из него содержимое.

**Атрибуты**:

*   `url` (str): URL-адрес API `ai.berlin4h.top`.
*   `working` (bool): Флаг, указывающий на работоспособность провайдера (по умолчанию `False`).
*   `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo` (по умолчанию `True`).
*   `_token` (str | None): Токен аутентификации, полученный от API (изначально `None`).

**Методы**:

*   `create_async_generator`: Создает асинхронный генератор для получения ответов от языковой модели.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от языковой модели.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы для передачи в API.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий ответы от модели.

        Raises:
            RuntimeError: Если получен некорректный ответ от API.

        Как работает функция:
        1. Проверяет, если `model` не указана, устанавливает значение по умолчанию `"gpt-3.5-turbo"`.
        2. Формирует заголовки HTTP-запроса, включая `User-Agent`, `Accept`, `Content-Type` и другие.
        3. Если токен аутентификации `cls._token` не установлен, выполняет вход в систему, используя учетные данные.
        4. Получает токен из ответа и сохраняет его в `cls._token`.
        5. Формирует запрос данных, включая `prompt`, `parentMessageId` и `options`.
        6. Отправляет асинхронный POST-запрос к API `f"{cls.url}/api/chat/completions"` с использованием `aiohttp.ClientSession`.
        7. Обрабатывает ответ от API, извлекая содержимое из каждого чанка и выдавая его через генератор.
        8. В случае ошибки при обработке чанка вызывает исключение `RuntimeError`.

        Внутренние функции:
            Отсутствуют.

        ASCII flowchart:

        [Начало] --> [Установка параметров]
        [Установка параметров] --> [Аутентификация (если требуется)]
        [Аутентификация (если требуется)] --> [Формирование запроса]
        [Формирование запроса] --> [Отправка POST-запроса]
        [Отправка POST-запроса] --> [Получение ответа]
        [Получение ответа] --> [Обработка чанков]
        [Обработка чанков] --> [Извлечение содержимого]
        [Извлечение содержимого] --> [Выдача содержимого через yield]
        [Обработка чанков] --Ошибка--> [Вызов RuntimeError]
        [Выдача содержимого через yield] --> [Конец]
        """
```

**Параметры**:

*   `model` (str): Название модели для использования.
*   `messages` (Messages): Список сообщений для отправки.
*   `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
*   `**kwargs`: Дополнительные аргументы для передачи в API.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, выдающий ответы от модели.

**Вызывает исключения**:

*   `RuntimeError`: Если получен некорректный ответ от API.

**Примеры**:

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.deprecated.Berlin import Berlin
from src.endpoints.gpt4free.g4f.typing import Messages

async def main():
    messages: Messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for response in Berlin.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(response, end="")

if __name__ == "__main__":
    asyncio.run(main())