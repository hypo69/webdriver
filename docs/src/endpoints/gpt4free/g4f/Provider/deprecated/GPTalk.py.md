# Модуль `GPTalk`

## Обзор

Модуль `GPTalk` предоставляет асинхронный класс `GPTalk`, который используется для взаимодействия с API GPTalk для генерации текста. Он поддерживает модель `gpt-3.5-turbo` и использует `aiohttp` для асинхронных HTTP-запросов. Модуль также включает функции для форматирования промптов и обработки ответов от API.

## Подробней

Модуль предназначен для работы с сервисом GPTalk, предоставляющим доступ к языковым моделям. Он автоматически обновляет токен авторизации и поддерживает лимиты использования, чтобы обеспечить стабильную работу.

## Классы

### `GPTalk`

**Описание**: Асинхронный провайдер для взаимодействия с API GPTalk.

**Принцип работы**:
1.  **Инициализация**: При первом обращении или по истечении срока действия токена, класс выполняет вход в систему для получения токена авторизации.
2.  **Формирование запроса**: Формирует запрос к API GPTalk, включая промпт, модель и другие параметры.
3.  **Отправка запроса**: Отправляет POST-запрос к API для получения сгенерированного текста.
4.  **Обработка ответа**: Получает ответ в виде потока данных и извлекает текст, генерируя его по частям.
5.  **Авторизация**: Класс автоматически обновляет токен авторизации при необходимости.

**Аттрибуты**:

*   `url` (str): URL API GPTalk.
*   `working` (bool): Флаг, указывающий, работает ли провайдер.
*   `supports_gpt_35_turbo` (bool): Флаг, указывающий, поддерживает ли провайдер модель `gpt-3.5-turbo`.
*   `_auth` (Optional[dict]): Словарь, содержащий информацию об авторизации.
*   `used_times` (int): Количество использований токена авторизации.

**Методы**:

*   `create_async_generator`: Асинхронный генератор для получения текста от API GPTalk.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения текста от API GPTalk.

    Args:
        model (str): Имя модели для использования.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий текст от API.

    Raises:
        Exception: Если возникает ошибка при выполнении запроса к API.
    """
```

**Назначение**: Создает и возвращает асинхронный генератор, который при итерации выдает фрагменты текста, сгенерированные моделью GPTalk на основе предоставленных сообщений.

**Параметры**:

*   `cls` (GPTalk): Ссылка на класс `GPTalk`.
*   `model` (str): Имя используемой модели. Если не указана, используется `gpt-3.5-turbo`.
*   `messages` (Messages): Список сообщений, отправляемых в API для генерации текста.
*   `proxy` (str, optional): URL прокси-сервера, если необходимо использовать прокси для подключения к API. По умолчанию `None`.
*   `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, который выдает текст, сгенерированный API GPTalk.

**Вызывает исключения**:

*   `Exception`: Вызывается, если возникает ошибка при выполнении HTTP-запроса к API GPTalk или при обработке ответа.

**Как работает функция**:

1.  **Инициализация параметров**: Функция принимает параметры, такие как имя модели, список сообщений и прокси-сервер (если указан). Если модель не указана, используется значение по умолчанию `gpt-3.5-turbo`.
2.  **Подготовка заголовков**: Создаются заголовки HTTP-запроса, включая информацию о браузере, платформе и времени.
3.  **Управление авторизацией**: Проверяется, существует ли действующий токен авторизации. Если токен отсутствует, истек или превышено количество использований, выполняется запрос на получение нового токена.
4.  **Формирование данных запроса**: Формируются данные запроса, включая отформатированный промпт, модель, параметры температуры и другие настройки.
5.  **Отправка запроса на генерацию**: Отправляется POST-запрос к API GPTalk для запуска генерации текста.
6.  **Получение токена потока**: Из ответа извлекается токен, необходимый для получения потока сгенерированного текста.
7.  **Получение потока текста**: Отправляется GET-запрос для получения потока сгенерированного текста.
8.  **Обработка потока**: Поток данных обрабатывается построчно. Каждая строка, начинающаяся с `data:`, содержит фрагмент сгенерированного текста. Фрагменты извлекаются, объединяются и выдаются через генератор.
9.  **Завершение**: Генератор завершает работу при получении строки `data: [DONE]`.

**Внутренние функции**:

*   В данной функции внутренние функции отсутствуют.

**Примеры**:

```python
async def main():
    messages = [{"role": "user", "content": "Напиши короткий стих про осень."}]
    async for message in GPTalk.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(message, end="")

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
```

**ASCII flowchart**:

```
+---------------------+
|  Инициализация      |
|  параметров         |
+---------+-----------+
          |
+---------v-----------+
|  Подготовка         |
|  заголовков         |
+---------+-----------+
          |
+---------v-----------+
|  Управление         |
|  авторизацией       |
+---------+-----------+
          |
+---------v-----------+
|  Формирование       |
|  данных запроса     |
+---------+-----------+
          |
+---------v-----------+
|  Отправка           |
|  запроса на         |
|  генерацию          |
+---------+-----------+
          |
+---------v-----------+
|  Получение токена   |
|  потока             |
+---------+-----------+
          |
+---------v-----------+
|  Получение потока   |
|  текста             |
+---------+-----------+
          |
+---------v-----------+
|  Обработка потока   |
+---------+-----------+
          |
+---------v-----------+
|  Завершение         |
+---------------------+