# Модуль GeekGpt для работы с провайдером GeekGpt
## Обзор

Модуль `GeekGpt` предназначен для взаимодействия с провайдером GeekGpt для создания текстовых завершений. Он поддерживает модели `gpt-3.5-turbo` и `gpt-4`, потоковую передачу данных и сохранение истории сообщений. Этот модуль является частью проекта `hypotez` и предназначен для использования в качестве одного из провайдеров при работе с большими языковыми моделями.

## Подробнее

Модуль содержит класс `GeekGpt`, который наследуется от абстрактного класса `AbstractProvider`. Он определяет методы для создания запросов к API GeekGpt и обработки ответов. В частности, он поддерживает потоковую передачу данных, что позволяет получать ответы в реальном времени.

## Классы

### `GeekGpt`

**Описание**: Класс для взаимодействия с провайдером GeekGpt.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для всех провайдеров.

**Атрибуты**:
- `url` (str): URL-адрес API GeekGpt.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу данных.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий, поддерживает ли провайдер модель `gpt-3.5-turbo`.
- `supports_gpt_4` (bool): Флаг, указывающий, поддерживает ли провайдер модель `gpt-4`.

### `create_completion`

```python
    @classmethod
    def create_completion(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        **kwargs
    ) -> CreateResult:
        """
        Создает текстовое завершение с использованием API GeekGpt.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для отправки в API.
            stream (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
            **kwargs: Дополнительные аргументы для передачи в API.

        Returns:
            CreateResult: Результат создания завершения.

        Raises:
            RuntimeError: Если возникает ошибка при обработке ответа от API.

        Внутренние функции:
            Отсутствуют.
        """
```

**Назначение**: Создает запрос к API GeekGpt и обрабатывает ответ для получения текстового завершения.

**Параметры**:
- `cls` (GeekGpt): Ссылка на класс `GeekGpt`.
- `model` (str): Название модели для использования (например, "gpt-3.5-turbo").
- `messages` (Messages): Список сообщений, представляющих историю разговора.
- `stream` (bool): Флаг, указывающий, следует ли использовать потоковый режим.
- `**kwargs`: Дополнительные параметры, такие как `temperature`, `presence_penalty`, `top_p`, `frequency_penalty`.

**Возвращает**:
- `CreateResult`: Генератор, выдающий текстовые фрагменты завершения в потоковом режиме.

**Вызывает исключения**:
- `RuntimeError`: Если при обработке ответа от API возникает ошибка, например, если формат ответа не соответствует ожидаемому.

**Как работает функция**:

1. **Подготовка данных**:
   - Если модель не указана, устанавливается значение по умолчанию "gpt-3.5-turbo".
   - Формируется JSON-словарь `json_data` с параметрами запроса, такими как сообщения, модель, температура и другие параметры, переданные через `kwargs`.
   - JSON-словарь преобразуется в строку с использованием `dumps` для оптимизации передачи данных.

2. **Формирование заголовков**:
   - Определяются заголовки HTTP-запроса, включая `authority`, `accept`, `content-type`, `authorization` и другие параметры, необходимые для взаимодействия с API.

3. **Отправка запроса**:
   - С помощью библиотеки `requests` отправляется POST-запрос к API `https://ai.fakeopen.com/v1/chat/completions` с указанными заголовками и данными.
   - Устанавливается `stream=True` для получения ответа в потоковом режиме.

4. **Обработка потокового ответа**:
   - Функция итерируется по строкам ответа, полученным через `response.iter_lines()`.
   - Для каждой строки проверяется наличие подстроки `b'content'`.
   - Если подстрока найдена, строка декодируется и из нее удаляется префикс `data: `.
   - Если строка равна `"[DONE]"`, цикл завершается.
   - Из JSON-данных извлекается содержимое сообщения (`content`) и возвращается через `yield`.
   - Если при обработке JSON возникает ошибка, генерируется исключение `RuntimeError`.

**ASCII Flowchart**:

```
    Начало
      ↓
    Подготовка данных (json_data, headers)
      ↓
    Отправка POST-запроса (requests.post)
      ↓
    Обработка ответа (response.iter_lines)
      ↓
    Проверка наличия 'content' в строке
      ↓
    Извлечение JSON-данных
      ↓
    Извлечение 'content' из JSON
      ↓
    Выдача 'content' через yield
      ↓
    Конец (или обработка ошибки)
```

**Примеры**:

```python
# Пример 1: Создание простого завершения
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
result = GeekGpt.create_completion(model=model, messages=messages, stream=stream)
for chunk in result:
    print(chunk, end="")

# Пример 2: Создание завершения с дополнительными параметрами
model = "gpt-4"
messages = [{"role": "user", "content": "Translate to French: Hello, world!"}]
stream = True
kwargs = {"temperature": 0.7, "top_p": 0.9}
result = GeekGpt.create_completion(model=model, messages=messages, stream=stream, **kwargs)
for chunk in result:
    print(chunk, end="")