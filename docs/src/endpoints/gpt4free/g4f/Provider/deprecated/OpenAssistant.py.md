# Модуль OpenAssistant

## Обзор

Модуль `OpenAssistant` предоставляет асинхронный генератор для взаимодействия с моделью Open Assistant. Он позволяет отправлять сообщения и получать ответы в потоковом режиме.

## Подробней

Модуль предназначен для интеграции с платформой Open Assistant, используя их API для обмена сообщениями с моделью. В частности, он создаёт чат, отправляет запросы и обрабатывает ответы в реальном времени.

## Классы

### `OpenAssistant`

**Описание**: Класс `OpenAssistant` является асинхронным провайдером генератора для взаимодействия с моделью Open Assistant.

**Принцип работы**:
1.  Инициализирует URL и указывает на необходимость аутентификации.
2.  Использует асинхронный генератор для отправки сообщений и получения ответов от Open Assistant API.
3.  Применяет `aiohttp` для выполнения асинхронных HTTP-запросов.

**Аттрибуты**:

*   `url` (str): URL для взаимодействия с Open Assistant API.
*   `needs_auth` (bool): Указывает, требуется ли аутентификация для использования провайдера.
*   `working` (bool): Указывает, работает ли провайдер в данный момент.
*   `model` (str): Название используемой модели Open Assistant по умолчанию.

**Методы**:

*   `create_async_generator`: Создаёт асинхронный генератор для взаимодействия с моделью.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        cookies: dict = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с моделью Open Assistant.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            cookies (dict, optional): Cookie для аутентификации. По умолчанию `None`.
            **kwargs: Дополнительные параметры для настройки генератора.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий ответы от модели.

        Raises:
            RuntimeError: Если API возвращает сообщение об ошибке.
            aiohttp.ClientResponseError: Если возникает HTTP ошибка при запросе.
        """
```

**Назначение**: Создаёт асинхронный генератор, который позволяет взаимодействовать с моделью Open Assistant, отправлять сообщения и получать ответы в асинхронном режиме.

**Параметры**:

*   `model` (str): Название модели, которую нужно использовать.
*   `messages` (Messages): Список сообщений, которые будут отправлены.
*   `proxy` (str, optional): Адрес прокси-сервера, если необходимо его использовать. По умолчанию `None`.
*   `cookies` (dict, optional): Cookie для аутенентификации. По умолчанию `None`.
*   `**kwargs`: Дополнительные аргументы для конфигурации.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, предоставляющий ответы от модели.

**Вызывает исключения**:

*   `RuntimeError`: Вызывается, если API возвращает сообщение об ошибке.
*   `aiohttp.ClientResponseError`: Вызывается, если происходит HTTP ошибка при запросе.

**Как работает функция**:

1.  **Инициализация**: Функция начинается с получения или установки cookie для аутентификации. Если cookie не предоставлены, они извлекаются с `open-assistant.io`.
2.  **Создание сессии**: Создается сессия `aiohttp.ClientSession` для управления HTTP-соединениями.
3.  **Получение chat_id**: Отправляется POST-запрос к `https://open-assistant.io/api/chat` для создания нового чата и получения его идентификатора (`chat_id`).
4.  **Отправка сообщения пользователя**: Форматируется сообщение пользователя с использованием `format_prompt(messages)` и отправляется POST-запрос к `https://open-assistant.io/api/chat/prompter_message` с `chat_id` и содержимым сообщения. В ответ получается `parent_id`.
5.  **Запрос ответа от ассистента**: Отправляется POST-запрос к `https://open-assistant.io/api/chat/assistant_message` с `chat_id`, `parent_id`, конфигурацией модели и параметрами для генерации текста. В результате получается `message_id`.
6.  **Получение событий**: Отправляется POST-запрос к `https://open-assistant.io/api/chat/events` для получения событий в реальном времени. Функция асинхронно перебирает строки ответа, декодирует их и извлекает текст ответа.
7.  **Удаление чата**: После завершения обмена сообщениями отправляется DELETE-запрос к `https://open-assistant.io/api/chat` для удаления чата.

```
    +---------------------+
    |  Начало             |
    +---------------------+
         ↓
    +---------------------+
    |  Получение cookies  |
    +---------------------+
         ↓
    +---------------------+
    |  Создание сессии    |
    +---------------------+
         ↓
    +---------------------+
    |  Получение chat_id  |
    +---------------------+
         ↓
    +---------------------+
    |  Отправка сообщения |
    +---------------------+
         ↓
    +---------------------+
    |  Получение parent_id|
    +---------------------+
         ↓
    +---------------------+
    |  Запрос ответа     |
    +---------------------+
         ↓
    +---------------------+
    |  Получение message_id|
    +---------------------+
         ↓
    +---------------------+
    |  Получение событий   |
    +---------------------+
         ↓
    +---------------------+
    |  Удаление чата      |
    +---------------------+

```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model_name = "OA_SFT_Llama_30B_6"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello, how are you?"}]
    
    async for message in OpenAssistant.create_async_generator(model=model_name, messages=messages):
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())