# Модуль Yqcloud

## Обзор

Модуль `Yqcloud` предоставляет асинхронный генератор для взаимодействия с сервисом `chat9.yqcloud.top`. Он позволяет отправлять запросы к API для генерации текста на основе предоставленных сообщений, используя GPT-3.5 Turbo.

## Подробней

Этот модуль предназначен для работы с API `chat9.yqcloud.top` и предоставляет функциональность асинхронной генерации текста. Он включает в себя функции для создания заголовков запроса и полезной нагрузки (payload), а также для обработки потоковых ответов от сервера. Модуль использует `StreamSession` для асинхронной отправки запросов и обработки ответов.

## Классы

### `Yqcloud`

**Описание**: Класс `Yqcloud` является провайдером асинхронной генерации текста.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL-адрес сервиса `chat9.yqcloud.top`.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели GPT-3.5 Turbo.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения потоковых ответов от API.

### `create_async_generator`

```python
    @staticmethod
    async def create_async_generator(
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 120,
        **kwargs,
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения потоковых ответов от API.

        Args:
            model (str): Модель для генерации текста.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            timeout (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий чанки текста.

        Raises:
            RuntimeError: Если IP-адрес заблокирован из-за обнаружения злоупотреблений.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для получения потоковых ответов от API `chat9.yqcloud.top`.

**Параметры**:
- `model` (str): Модель для генерации текста.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий чанки текста.

**Вызывает исключения**:
- `RuntimeError`: Если IP-адрес заблокирован из-за обнаружения злоупотреблений.

**Как работает функция**:
1. Функция создает асинхронную сессию с использованием `StreamSession` и переданных параметров, таких как заголовки, прокси и таймаут.
2. Формируется полезная нагрузка (payload) для запроса с помощью функции `_create_payload`.
3. Отправляется POST-запрос к API `https://api.aichatos.cloud/api/generateStream` с сформированной полезной нагрузкой.
4. Функция итерируется по чанкам ответа, декодирует их и проверяет наличие сообщения о блокировке IP-адреса.
5. Если IP-адрес заблокирован, выбрасывается исключение `RuntimeError`.
6. Возвращает чанки текста через генератор.

```
Создание сессии --> Формирование Payload --> POST-запрос к API
    |                      |                      |
    V                      V                      V
Обработка ответа <-- Проверка IP-адреса <-- Получение чанков ответа
    |                      |                      |
    V                      V                      V
   Вывод чанков текста <-- Выброс исключения  <-- Обнаружена блокировка
```

**Примеры**:
```python
# Пример использования create_async_generator
async def example():
    messages = [{"role": "user", "content": "Hello"}]
    async for chunk in Yqcloud.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(chunk, end="")
```

## Функции

### `_create_header`

```python
def _create_header():
    """Создает словарь с заголовками запроса.

    Returns:
        dict: Словарь с заголовками запроса.
    """
    ...
```

**Назначение**: Создает словарь с заголовками запроса, необходимыми для взаимодействия с API.

**Возвращает**:
- `dict`: Словарь с заголовками запроса.

**Как работает функция**:
1. Функция создает и возвращает словарь с предопределенными заголовками, такими как `accept`, `content-type`, `origin` и `referer`.
2. Эти заголовки необходимы для успешного выполнения запроса к API `chat9.yqcloud.top`.

```
Создание заголовков --> Возврат словаря с заголовками
```

**Примеры**:
```python
# Пример использования _create_header
headers = _create_header()
print(headers)
```

### `_create_payload`

```python
def _create_payload(
    messages: Messages,
    system_message: str = "",
    user_id: int = None,
    **kwargs
):
    """Создает полезную нагрузку (payload) для запроса к API.

    Args:
        messages (Messages): Список сообщений для отправки.
        system_message (str, optional): Системное сообщение. По умолчанию "".
        user_id (int, optional): ID пользователя. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        dict: Словарь с полезной нагрузкой для запроса.
    """
    ...
```

**Назначение**: Создает словарь с полезной нагрузкой (payload) для запроса к API.

**Параметры**:
- `messages` (Messages): Список сообщений для отправки.
- `system_message` (str, optional): Системное сообщение. По умолчанию "".
- `user_id` (int, optional): ID пользователя. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `dict`: Словарь с полезной нагрузкой для запроса.

**Как работает функция**:
1. Функция генерирует случайный `user_id`, если он не был предоставлен.
2. Формирует словарь с параметрами запроса, такими как `prompt`, `network`, `system`, `withoutContext`, `stream` и `userId`.
3. Использует функцию `format_prompt` для форматирования сообщений.

```
Генерация User ID --> Форматирование сообщений --> Создание Payload
```

**Примеры**:
```python
# Пример использования _create_payload
messages = [{"role": "user", "content": "Hello"}]
payload = _create_payload(messages=messages)
print(payload)