# Модуль Blackbox.py

## Обзор

Модуль `Blackbox.py` предоставляет реализацию асинхронного провайдера для взаимодействия с Blackbox AI. Он поддерживает как текстовые, так и графические модели, включая возможность работы с историей сообщений и системными сообщениями. Модуль предназначен для интеграции с `gpt4free`.

## Подробней

Модуль предназначен для работы с API Blackbox AI. Он включает в себя функциональность для:

-   Генерации сессий и идентификаторов.
-   Получения списка доступных моделей.
-   Проверки премиум-доступа пользователя.
-   Создания асинхронных генераторов для обработки запросов к API.

Модуль также поддерживает работу с изображениями и предоставляет возможность использования различных "агентских режимов" (Agent Modes) для моделей.

## Классы

### `Conversation`

Описание назначения класса: Класс для хранения информации о текущем разговоре с Blackbox AI.

**Наследует:**

-   `JsonConversation`: Наследует функциональность для работы с JSON-представлением истории разговоров.

**Атрибуты:**

-   `validated_value` (str): Валидированное значение, полученное из Blackbox AI.
-   `chat_id` (str): Идентификатор чата.
-   `message_history` (Messages): История сообщений в чате.
-   `model` (str): Модель, используемая в разговоре.

**Методы:**

-   `__init__(self, model: str)`: Инициализирует объект Conversation.

### `Blackbox`

Описание назначения класса: Класс, реализующий асинхронный провайдер для Blackbox AI.

**Наследует:**

-   `AsyncGeneratorProvider`: Наследует функциональность для асинхронной генерации ответов.
-   `ProviderModelMixin`: Добавляет поддержку выбора моделей.

**Атрибуты:**

-   `label` (str): Метка провайдера ("Blackbox AI").
-   `url` (str): URL главной страницы Blackbox AI ("https://www.blackbox.ai").
-   `api_endpoint` (str): URL API Blackbox AI ("https://www.blackbox.ai/api/chat").
-   `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
-   `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи (True).
-   `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений (True).
-   `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (True).
-   `default_model` (str): Модель, используемая по умолчанию ("blackboxai").
-   `default_vision_model` (str): Модель для работы с изображениями по умолчанию (default_model).
-   `default_image_model` (str): Модель для генерации изображений по умолчанию ('flux').
-   `fallback_models` (list): Список бесплатных моделей, доступных для использования.
-    `image_models` (list): Список моделей для работы с изображениями.
-   `vision_models` (list): Список моделей для работы с vision задачами.
-   `userSelectedModel` (list): Список моделей, выбранных пользователем.
-   `agentMode` (dict): Конфигурация режимов агента для моделей.
-   `trendingAgentMode` (dict): Конфигурация популярных режимов агента.
-   `_all_models` (list): Полный список доступных моделей (для авторизованных пользователей).
-   `models` (list): Список моделей, инициализированный `fallback_models`.
-   `model_aliases` (dict): Псевдонимы моделей.

**Методы:**

-   `generate_session(cls, id_length: int = 21, days_ahead: int = 365) -> dict`: Генерирует динамическую сессию с правильным ID и форматом истечения срока действия.
-   `fetch_validated(cls, url: str = "https://www.blackbox.ai", force_refresh: bool = False) -> Optional[str]`: Получает валидированное значение с веб-сайта Blackbox AI.
-   `generate_id(cls, length: int = 7) -> str`: Генерирует случайный идентификатор заданной длины.
-   `get_models(cls) -> list`: Возвращает список доступных моделей в зависимости от статуса авторизации пользователя.
-   `_check_premium_access(cls) -> bool`: Проверяет наличие авторизованной сессии в HAR-файлах.
-   `create_async_generator(...) -> AsyncResult`: Создает асинхронный генератор для отправки запросов к API Blackbox AI.

## Функции

### `generate_session`

```python
    @classmethod
    def generate_session(cls, id_length: int = 21, days_ahead: int = 365) -> dict:
        """
        Generate a dynamic session with proper ID and expiry format.
        
        Args:
            id_length: Length of the numeric ID (default: 21)
            days_ahead: Number of days ahead for expiry (default: 365)
        
        Returns:
            dict: A session dictionary with user information and expiry
        """
        ...
```

**Назначение**:
Генерирует динамическую сессию с правильным форматом ID и даты истечения срока действия.

**Параметры**:

-   `id_length` (int): Длина числового ID (по умолчанию: 21).
-   `days_ahead` (int): Количество дней, на которое нужно установить дату истечения срока действия (по умолчанию: 365).

**Возвращает**:

-   `dict`: Словарь сессии с информацией о пользователе и сроке действия.

**Как работает функция**:

1.  **Генерация числового ID**: Функция генерирует числовой идентификатор, используя случайный выбор из цифр `0-9`. Длина идентификатора определяется параметром `id_length`.
2.  **Генерация даты истечения срока действия**: Вычисляется будущая дата истечения срока действия путем добавления `days_ahead` дней к текущей дате.
3.  **Декодирование email**: Декодируется email адрес из base64 строки.
4.  **Генерация image ID**: Генерируется случайный ID для image.
5.  **Формирование URL изображения**: Генерируется URL изображения профиля пользователя.
6.  **Создание словаря сессии**: Создается словарь, содержащий информацию о пользователе (имя, email, URL изображения, ID) и дате истечения срока действия.

```
     Начало
     ↓
     → Генерация числового ID
     ↓
     Генерация даты истечения срока действия
     ↓
     Декодирование email
     ↓
     Генерация image ID
     ↓    ↓ 
     Создание словаря сессии
     ↓
     Конец
```

**Примеры**:

```python
session = Blackbox.generate_session()
print(session)
# {'user': {'name': 'BLACKBOX AI', 'email': 'gisele@blackbox.ai', 'image': 'https://lh3.googleusercontent.com/a/ACg8oc...=s96-c', 'id': '...'}, 'expires': '2025-05-21T14:22:12.123Z'}
```

### `fetch_validated`

```python
    @classmethod
    async def fetch_validated(cls, url: str = "https://www.blackbox.ai", force_refresh: bool = False) -> Optional[str]:
       """ """
```

**Назначение**:
Извлекает валидированное значение с веб-сайта Blackbox AI, используя кеширование для повышения производительности.

**Параметры**:

-   `url` (str): URL для получения валидированного значения (по умолчанию: "https://www.blackbox.ai").
-   `force_refresh` (bool): Флаг, указывающий, нужно ли принудительно обновить кеш (по умолчанию: False).

**Возвращает**:

-   `Optional[str]`: Валидированное значение (UUID) в случае успеха, или `None` в случае ошибки или отсутствия значения.

**Как работает функция**:

1.  **Проверка кеша**: Проверяет наличие кешированного значения в файле `blackbox.json` в директории cookies. Если значение найдено и `force_refresh` равен `False`, функция возвращает кешированное значение.
2.  **Поиск JS-файлов**: Если кеш не найден или требуется обновление, функция отправляет GET-запрос на указанный `url` и извлекает список JS-файлов, соответствующих шаблону `static/chunks/\\d{4}-[a-fA-F0-9]+\\.js`.
3.  **Извлечение UUID**: Для каждого найденного JS-файла функция отправляет GET-запрос, извлекает содержимое и ищет UUID, соответствующие шаблону `["\\\']([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})["\\\']`.
4.  **Валидация контекста**: Проверяет, является ли контекст, окружающий UUID, валидным, проверяя наличие символов `a-z` с последующим символом `=`.
5.  **Кеширование значения**: Если валидированное значение найдено, функция сохраняет его в файл `blackbox.json`.
6.  **Обработка ошибок**: В случае возникновения ошибок при чтении кеша, выполнении HTTP-запросов или записи в кеш, функция логирует ошибки с помощью `debug.log`.

```
     Начало
     ↓
     → Проверка кеша
     ↓
     Поиск JS-файлов
     ↓
     Извлечение UUID
     ↓
     Валидация контекста
     ↓    ↓ 
     Кеширование значения
     ↓
     Конец
```

**Примеры**:

```python
validated_value = await Blackbox.fetch_validated()
if validated_value:
    print(f"Валидированное значение: {validated_value}")
else:
    print("Не удалось получить валидированное значение")
```

### `generate_id`

```python
    @classmethod
    def generate_id(cls, length: int = 7) -> str:
        """ """
```

**Назначение**:
Генерирует случайный идентификатор заданной длины, используя буквенно-цифровые символы.

**Параметры**:

-   `length` (int): Длина генерируемого идентификатора (по умолчанию: 7).

**Возвращает**:

-   `str`: Случайный идентификатор.

**Как работает функция**:

1.  **Определение набора символов**: Определяется набор символов, из которых будет генерироваться идентификатор (`string.ascii_letters + string.digits`).
2.  **Генерация идентификатора**: Случайно выбираются символы из определенного набора и объединяются в строку длиной `length`.

```
     Начало
     ↓
     → Определение набора символов
     ↓
     Генерация идентификатора
     ↓
     Конец
```

**Примеры**:

```python
random_id = Blackbox.generate_id()
print(random_id)  # Например: "aB3cD5e"
```

### `get_models`

```python
    @classmethod
    def get_models(cls) -> list:
        """
        Returns a list of available models based on authorization status.
        Authorized users get the full list of models.
        Unauthorized users only get fallback_models.
        """
        ...
```

**Назначение**:
Возвращает список доступных моделей в зависимости от статуса авторизации пользователя.

**Параметры**:

-   `cls`: Ссылка на класс `Blackbox`.

**Возвращает**:

-   `list`: Список доступных моделей.

**Как работает функция**:

1.  **Проверка премиум-доступа**: Функция вызывает `cls._check_premium_access()`, чтобы определить, имеет ли пользователь премиум-доступ.
2.  **Возврат списка моделей**:
    -   Если у пользователя есть премиум-доступ (`has_premium_access == True`), функция возвращает полный список моделей (`cls._all_models`).
    -   Если у пользователя нет премиум-доступа (`has_premium_access == False`), функция возвращает список бесплатных моделей (`cls.fallback_models`).
3.  **Логирование**: Функция логирует информацию о том, какой список моделей был возвращен, используя `debug.log`.

```
     Начало
     ↓
     → Проверка премиум-доступа
     ↓
     Возврат списка моделей
     ↓
     Конец
```

**Примеры**:

```python
models = Blackbox.get_models()
print(models)  # Например: ["blackboxai", "gpt-4o-mini", ...]
```

### `_check_premium_access`

```python
    @classmethod
    def _check_premium_access(cls) -> bool:
        """
        Checks for an authorized session in HAR files.
        Returns True if a valid session is found that differs from the demo.
        """
        ...
```

**Назначение**:
Проверяет наличие авторизованной сессии в HAR-файлах.

**Параметры**:

-   `cls`: Ссылка на класс `Blackbox`.

**Возвращает**:

-   `bool`: `True`, если найдена действительная сессия, отличающаяся от демонстрационной, `False` в противном случае.

**Как работает функция**:

1.  **Получение директории HAR-файлов**: Функция пытается получить доступ к директории, в которой хранятся HAR-файлы, используя `get_cookies_dir()`.
2.  **Обход HAR-файлов**: Если директория доступна для чтения, функция обходит все файлы с расширением ".har" в этой директории.
3.  **Анализ HAR-файлов**: Для каждого HAR-файла функция пытается загрузить JSON-данные и проанализировать записи (`entries`) в разделе `log`.
4.  **Поиск запросов к API Blackbox**: Функция ищет запросы к API Blackbox (`'blackbox.ai/api' in entry['request']['url']`).
5.  **Извлечение данных сессии**: Если найден запрос к API Blackbox, функция пытается извлечь данные сессии из ответа. Данные сессии должны содержать поля `"user"`, `"email"` и `"expires"`.
6.  **Проверка на демонстрационную сессию**: Функция генерирует демонстрационную сессию с помощью `cls.generate_session()` и сравнивает email пользователя в извлеченной сессии с email пользователя в демонстрационной сессии. Если email отличаются, это означает, что пользователь имеет премиум-доступ.
7.  **Обработка ошибок**: Функция обрабатывает исключения, которые могут возникнуть при чтении HAR-файлов, разборе JSON-данных и т.д., и логирует ошибки с помощью `debug.log`.

```
     Начало
     ↓
     → Получение директории HAR-файлов
     ↓
     Обход HAR-файлов
     ↓
     Анализ HAR-файлов
     ↓
     Поиск запросов к API Blackbox
     ↓    ↓ 
     Извлечение данных сессии
     ↓
     Проверка на демонстрационную сессию
     ↓
     Конец
```

**Примеры**:

```python
has_premium_access = Blackbox._check_premium_access()
if has_premium_access:
    print("У пользователя есть премиум-доступ")
else:
    print("У пользователя нет премиум-доступа")
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        prompt: str = None,
        proxy: str = None,
        media: MediaListType = None,
        top_p: float = None,
        temperature: float = None,
        max_tokens: int = None,
        conversation: Conversation = None,
        return_conversation: bool = False,
        **kwargs
    ) -> AsyncResult:
        """ """
```

**Назначение**:
Создает асинхронный генератор для отправки запросов к API Blackbox AI.

**Параметры**:

-   `model` (str): Название модели для использования.
-   `messages` (Messages): Список сообщений для отправки в API.
-   `prompt` (str, optional): Дополнительный промт для отправки. По умолчанию `None`.
-   `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
-   `media` (MediaListType, optional): Список медиа-файлов для отправки. По умолчанию `None`.
-   `top_p` (float, optional): Значение top_p для настройки генерации. По умолчанию `None`.
-   `temperature` (float, optional): Значение temperature для настройки генерации. По умолчанию `None`.
-   `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `None`.
-   `conversation` (Conversation, optional): Объект Conversation для хранения истории сообщений. По умолчанию `None`.
-   `return_conversation` (bool, optional): Флаг, указывающий, нужно ли возвращать объект Conversation. По умолчанию `False`.
-   `**kwargs`: Дополнительные параметры.

**Возвращает**:

-   `AsyncResult`: Асинхронный генератор, возвращающий текст ответа от API Blackbox AI.

**Как работает функция**:

1.  **Подготовка данных**:
    -   Определяется модель для использования с помощью `cls.get_model(model)`.
    -   Формируются заголовки HTTP-запроса.
    -   Если объект `conversation` не передан или у него отсутствует `chat_id`, создается новый объект `Conversation` и генерируется `chat_id` и `validated_value`.
    -   Преобразуются сообщения в формат, требуемый API Blackbox AI.
    -   Если переданы медиа-файлы, они преобразуются в формат data URI и добавляются к последнему сообщению.
    -   Из HAR files извлекаются данные сессии. Если HAR files отсутствуют, то генерируется демо сессия.
2.  **Отправка запроса**:
    -   Формируется словарь `data`, содержащий все необходимые параметры для запроса к API.
    -   Отправляется POST-запрос на `cls.api_endpoint` с использованием `aiohttp.ClientSession`.
3.  **Обработка ответа**:
    -   Функция итерируется по чанкам ответа, декодирует их и передаёт в генератор.
    -   Если модель является моделью генерации изображений, функция ищет URL изображения в ответе и возвращает `ImageResponse`.
    -   Если `return_conversation` равен `True`, функция добавляет ответ ассистента в историю сообщений и возвращает объект `conversation`.
4. **Логирование**:
    -   Перед отправкой запроса к API функция логирует информацию об используемой сессии (демонстрационная или премиум) и email пользователя, если сессия найдена в HAR-файлах.

```
     Начало
     ↓
     → Подготовка данных
     ↓
     Отправка запроса
     ↓
     Обработка ответа
     ↓    ↓ 
     Логирование
     ↓
     Конец
```

**Примеры**:

```python
async def process_message():
    async for response in Blackbox.create_async_generator(model="blackboxai", messages=[{"role": "user", "content": "Hello"}], return_conversation=True):
        if isinstance(response, Conversation):
            print(f"История сообщений: {response.message_history}")
        else:
            print(f"Ответ: {response}")

await process_message()