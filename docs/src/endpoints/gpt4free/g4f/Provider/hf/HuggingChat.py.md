# Модуль HuggingChat

## Обзор

Модуль `HuggingChat` предоставляет класс `HuggingChat`, который позволяет взаимодействовать с моделями Hugging Face для создания чат-ботов. Он поддерживает как текстовые, так и визуальные модели, потоковую передачу ответов, аутентификацию и интеграцию с веб-поиском.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с различными AI-моделями через API Hugging Face. Он использует библиотеку `curl_cffi` для выполнения асинхронных HTTP-запросов и предоставляет удобный интерфейс для создания и управления беседами. Модуль также обрабатывает аутентификацию, позволяя пользователям входить в систему через веб-интерфейс или с использованием файлов cookie.

## Классы

### `Conversation`

**Описание**: Класс `Conversation` представляет собой контейнер для хранения информации о текущей беседе, включая идентификаторы беседы и сообщений для каждой используемой модели.

**Наследует**: `JsonConversation`

**Атрибуты**:
- `models` (dict): Словарь, содержащий информацию о беседах для каждой модели. Ключом является идентификатор модели, а значением - словарь с `conversationId` и `messageId`.

### `HuggingChat`

**Описание**: Класс `HuggingChat` является основным классом для взаимодействия с API Hugging Face. Он предоставляет методы для аутентификации, создания бесед, отправки сообщений и получения ответов в потоковом режиме.

**Наследует**: `AsyncAuthedProvider`, `ProviderModelMixin`

**Атрибуты**:
- `domain` (str): Доменное имя Hugging Face ("huggingface.co").
- `origin` (str): Базовый URL Hugging Face ("https://huggingface.co").
- `url` (str): URL для взаимодействия с чат-ботом ("https://huggingface.co/chat").
- `working` (bool): Флаг, указывающий, работает ли провайдер (True).
- `use_nodriver` (bool): Флаг, указывающий, следует ли использовать бездрайверный режим (True).
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу (True).
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация (True).
- `default_model` (str): Модель, используемая по умолчанию.
- `default_vision_model` (str): Визуальная модель, используемая по умолчанию.
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `image_models` (list): Список моделей для работы с изображениями.
- `text_models` (list): Список текстовых моделей.
- `models` (list): Список доступных моделей.
- `vision_models` (list): Список доступных визуальных моделей.

**Методы**:
- `get_models()`: Получает список доступных моделей из API Hugging Face.
- `on_auth_async()`: Выполняет аутентификацию пользователя и возвращает результат аутентификации.
- `create_authed()`: Создает аутентифицированный запрос к API Hugging Face и возвращает асинхронный результат.
- `create_conversation()`: Создает новую беседу с указанной моделью.
- `fetch_message_id()`: Получает идентификатор последнего сообщения в беседе.

## Функции

### `get_models`

```python
    @classmethod
    def get_models(cls):
        """
        Получает список доступных моделей из API Hugging Face.

        Если список моделей еще не был загружен, функция выполняет HTTP-запрос к странице чата Hugging Face,
        извлекает список моделей из HTML-кода и сохраняет его в атрибуте `cls.models`.

        Returns:
            list: Список идентификаторов доступных моделей.

        Raises:
            Exception: Если возникает ошибка при чтении моделей.
        """
        ...
```

**Назначение**: Получение списка доступных моделей из API Hugging Face.

**Как работает функция**:

1.  Проверяет, загружен ли уже список моделей (`cls.models`). Если да, возвращает его.
2.  Если список моделей не загружен, выполняет HTTP-запрос к странице чата Hugging Face (`cls.url`).
3.  Извлекает список моделей из HTML-кода страницы, используя регулярные выражения.
4.  Преобразует извлеченный текст в формат JSON.
5.  Извлекает идентификаторы моделей из JSON-данных и сохраняет их в `cls.models`.
6.  В случае ошибки логирует исключение и использует резервный список моделей (`fallback_models`).

**ASCII flowchart**:

```
A: Проверка cls.models
|
Нет
|
B: HTTP-запрос к cls.url
|
C: Извлечение списка моделей из HTML
|
D: Преобразование в JSON
|
E: Извлечение идентификаторов моделей
|
F: Сохранение в cls.models
|
Да
|
G: Возврат cls.models
```

**Примеры**:

```python
models = HuggingChat.get_models()
print(models)
# ['meta-llama/Llama-2-70b-chat-hf', 'google/flan-t5-xxl', ...]
```

### `on_auth_async`

```python
    @classmethod
    async def on_auth_async(cls, cookies: Cookies = None, proxy: str = None, **kwargs) -> AsyncIterator:
        """
        Выполняет асинхронную аутентификацию пользователя.

        Функция проверяет наличие файлов cookie для домена Hugging Face и, если они есть,
        возвращает результат аутентификации с этими файлами cookie. Если файлы cookie отсутствуют,
        функция запрашивает у пользователя учетные данные и выполняет вход в систему через веб-интерфейс.

        Args:
            cookies (Cookies, optional): Файлы cookie для домена Hugging Face. По умолчанию `None`.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Yields:
            AuthResult: Результат аутентификации.
            RequestLogin: Запрос на вход в систему, если требуется аутентификация.
        """
        ...
```

**Назначение**: Асинхронная аутентификация пользователя.

**Как работает функция**:

1.  Проверяет наличие файлов cookie (`hf-chat`) в предоставленных файлах cookie или получает их из браузера.
2.  Если файлы cookie найдены, возвращает результат аутентификации (`AuthResult`) с этими файлами cookie.
3.  Если файлы cookie отсутствуют и требуется аутентификация (`cls.needs_auth`), запрашивает у пользователя учетные данные (`RequestLogin`).
4.  Выполняет вход в систему через веб-интерфейс и возвращает результат аутентификации с полученными файлами cookie.
5.  Если аутентификация не требуется, генерирует случайный идентификатор сессии и возвращает результат аутентификации с ним.

**ASCII flowchart**:

```
A: Проверка наличия cookies
|
Да
|
B: Возврат AuthResult с cookies
|
Нет
|
C: Проверка needs_auth
|
Да
|
D: Запрос учетных данных (RequestLogin)
|
E: Вход через веб-интерфейс
|
F: Возврат AuthResult с полученными cookies
|
Нет
|
G: Генерация случайного ID сессии
|
H: Возврат AuthResult с ID сессии
```

**Примеры**:

```python
async for result in HuggingChat.on_auth_async():
    if isinstance(result, AuthResult):
        print("Аутентификация успешна")
    elif isinstance(result, RequestLogin):
        print("Требуется вход в систему")
```

### `create_authed`

```python
    @classmethod
    async def create_authed(
        cls,
        model: str,
        messages: Messages,
        auth_result: AuthResult,
        prompt: str = None,
        media: MediaListType = None,
        return_conversation: bool = False,
        conversation: Conversation = None,
        web_search: bool = False,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный запрос к API Hugging Face с аутентификацией.

        Args:
            model (str): Идентификатор модели.
            messages (Messages): Список сообщений в беседе.
            auth_result (AuthResult): Результат аутентификации.
            prompt (str, optional): Дополнительный текст для запроса. По умолчанию `None`.
            media (MediaListType, optional): Список медиафайлов для запроса. По умолчанию `None`.
            return_conversation (bool, optional): Флаг, указывающий, следует ли возвращать объект беседы. По умолчанию `False`.
            conversation (Conversation, optional): Объект беседы. По умолчанию `None`.
            web_search (bool, optional): Флаг, указывающий, следует ли использовать веб-поиск. По умолчанию `False`.
            **kwargs: Дополнительные аргументы.

        Yields:
            str: Текст ответа в потоковом режиме.
            ImageResponse: Ответ с изображением, если модель поддерживает работу с изображениями.
            Sources: Источники, найденные в веб-поиске.
            TitleGeneration: Заголовок, сгенерированный моделью.
            Reasoning: Промежуточные рассуждения модели.
            FinishReason: Причина завершения беседы.

        Raises:
            MissingRequirementsError: Если не установлена библиотека `curl_cffi`.
            MissingAuthError: Если отсутствует аутентификация.
            ResponseError: Если получен ответ с ошибкой.
        """
        ...
```

**Назначение**: Создание аутентифицированного запроса к API Hugging Face.

**Как работает функция**:

1.  Проверяет, установлена ли библиотека `curl_cffi`. Если нет, вызывает исключение `MissingRequirementsError`.
2.  Определяет модель для запроса, используя `cls.get_model()`.
3.  Создает сессию `curl_cffi` с использованием данных аутентификации (`auth_result`).
4.  Если объект беседы (`conversation`) не предоставлен или не содержит информации о моделях, создает новый объект беседы (`Conversation`).
5.  Проверяет, существует ли беседа для указанной модели в объекте беседы. Если нет, создает новую беседу (`cls.create_conversation()`) и сохраняет ее идентификатор в объекте беседы.
6.  Формирует входные данные (`inputs`) для запроса, используя либо весь список сообщений (`messages`), либо только последнее сообщение пользователя.
7.  Формирует настройки (`settings`) для запроса, включая входные данные, идентификатор сообщения, флаги для повторной отправки и продолжения беседы, а также флаг для использования веб-поиска.
8.  Формирует заголовки (`headers`) для запроса, включая информацию об источнике и реферере.
9.  Создает объект `CurlMime` для отправки данных в формате multipart/form-data, включая текстовые данные (`settings`) и медиафайлы (изображения).
10. Отправляет POST-запрос к API Hugging Face (`cls.url`) с использованием сессии `curl_cffi`, заголовков и данных в формате multipart/form-data.
11. Обрабатывает ответ от API Hugging Face в потоковом режиме, извлекая текст ответа, изображения, источники веб-поиска, заголовки и промежуточные рассуждения модели.
12. Возвращает результаты в виде потока, используя `yield`.

**ASCII flowchart**:

```
A: Проверка curl_cffi
|
Нет
|
B: Вызов MissingRequirementsError
|
Да
|
C: Определение модели
|
D: Создание сессии curl_cffi
|
E: Проверка conversation
|
Нет
|
F: Создание объекта Conversation
|
Да
|
G: Проверка наличия беседы для модели
|
Нет
|
H: Создание беседы (create_conversation)
|
Да
|
I: Формирование входных данных (inputs)
|
J: Формирование настроек (settings)
|
K: Формирование заголовков (headers)
|
L: Создание объекта CurlMime
|
M: Отправка POST-запроса к API
|
N: Обработка ответа в потоковом режиме
|
O: Возврат результатов через yield
```

**Примеры**:

```python
messages = [
    {"role": "user", "content": "Привет!"},
    {"role": "assistant", "content": "Здравствуйте!"}
]
async for result in HuggingChat.create_authed(
    model="meta-llama/Llama-2-70b-chat-hf",
    messages=messages,
    auth_result=auth_result
):
    print(result)
```

### `create_conversation`

```python
    @classmethod
    def create_conversation(cls, session: Session, model: str):
        """
        Создает новую беседу с указанной моделью.

        Args:
            session (Session): Сессия `curl_cffi`.
            model (str): Идентификатор модели.

        Returns:
            str: Идентификатор новой беседы.

        Raises:
            MissingAuthError: Если отсутствует аутентификация.
            ResponseError: Если получен ответ с ошибкой.
        """
        ...
```

**Назначение**: Создание новой беседы с указанной моделью.

**Как работает функция**:

1.  Формирует JSON-данные для запроса, содержащие идентификатор модели.
2.  Отправляет POST-запрос к API Hugging Face (`cls.url + '/conversation'`) с использованием сессии `curl_cffi` и JSON-данных.
3.  Обрабатывает ответ от API Hugging Face:
    -   Если получен код состояния 401, вызывает исключение `MissingAuthError`.
    -   Если получен код состояния 400, вызывает исключение `ResponseError`.
    -   В противном случае извлекает идентификатор беседы из JSON-ответа.
4.  Возвращает идентификатор новой беседы.

**ASCII flowchart**:

```
A: Формирование JSON-данных
|
B: Отправка POST-запроса к API
|
C: Обработка ответа
|   |   |
401 400 default
|   |   |
D   E   F
|   |   |
MissingAuthError ResponseError Извлечение ID беседы
|   |   |
Возврат ID беседы
```

**Примеры**:

```python
conversation_id = HuggingChat.create_conversation(session, "meta-llama/Llama-2-70b-chat-hf")
print(conversation_id)
# "..."
```

### `fetch_message_id`

```python
    @classmethod
    def fetch_message_id(cls, session: Session, conversation_id: str):
        """
        Получает идентификатор последнего сообщения в беседе.

        Args:
            session (Session): Сессия `curl_cffi`.
            conversation_id (str): Идентификатор беседы.

        Returns:
            str: Идентификатор последнего сообщения в беседе.

        Raises:
            RuntimeError: Если не удалось распарсить ответ или извлечь идентификатор сообщения.
        """
        ...
```

**Назначение**: Получение идентификатора последнего сообщения в беседе.

**Как работает функция**:

1.  Отправляет GET-запрос к API Hugging Face (`cls.url + f'/conversation/{conversation_id}/__data.json?x-sveltekit-invalidated=11'`) с использованием сессии `curl_cffi`.
2.  Разбирает ответ, разделяя его на строки и обрабатывая каждую строку как JSON.
3.  Ищет строку, содержащую JSON-данные с ключом "nodes".
4.  Извлекает идентификатор сообщения из JSON-данных, используя ключи "nodes", "data", "messages", "id".
5.  В случае ошибки вызывает исключение `RuntimeError`.
6.  Возвращает идентификатор последнего сообщения в беседе.

**ASCII flowchart**:

```
A: Отправка GET-запроса к API
|
B: Разбор ответа на строки
|
C: Поиск JSON-данных с "nodes"
|
D: Извлечение ID сообщения из JSON
|
E: Обработка ошибок
|
F: Возврат ID сообщения
```

**Примеры**:

```python
message_id = HuggingChat.fetch_message_id(session, "...")
print(message_id)
# "..."