# Модуль `ChatGLM`

## Обзор

Модуль `ChatGLM` предоставляет асинхронную поддержку для взаимодействия с моделью ChatGLM. Он позволяет генерировать текст на основе предоставленных сообщений, используя API ChatGLM. Поддерживает потоковую передачу данных и предоставляет функциональность для работы с прокси-серверами.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими взаимодействия с языковой моделью ChatGLM. Он использует асинхронные запросы для обеспечения неблокирующего взаимодействия с API, что важно для высокой производительности и отзывчивости системы. Модуль также обрабатывает ответы в формате `text/event-stream`, что позволяет получать сгенерированный текст по частям в режиме реального времени.

## Классы

### `ChatGLM`

**Описание**: Класс `ChatGLM` является асинхронным провайдером для взаимодействия с API ChatGLM. Он реализует методы для отправки сообщений и получения ответов в потоковом режиме.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями провайдера.

**Атрибуты**:
- `url` (str): URL веб-сайта ChatGLM.
- `api_endpoint` (str): URL API для взаимодействия с ChatGLM.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Флаг, указывающий, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`"glm-4"`).
- `models` (list[str]): Список поддерживаемых моделей (включает только `default_model`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API ChatGLM.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от API ChatGLM.

    Args:
        model (str): Имя используемой модели.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий текст ответа.

    Как работает функция:
    1. Генерируется уникальный `device_id` для идентификации устройства.
    2. Формируются заголовки запроса, включая `X-Device-Id`.
    3. Создается `ClientSession` с заданными заголовками.
    4. Формируется полезная нагрузка `data` для запроса, включая сообщения и метаданные.
    5. Отправляется `POST` запрос к `cls.api_endpoint` с использованием `session.post`.
    6. Обрабатываются чанки данных из потока ответа, декодируются и извлекается текстовое содержимое.
    7. Если статус в JSON ответе равен `'finish'`, генерируется `FinishReason("stop")`.
    8. В случае ошибки декодирования JSON, она игнорируется.

    ASCII flowchart:

    Установка Device ID  -> Формирование заголовков ->  Создание ClientSession
        |
        V
    Формирование тела запроса (JSON)
        |
        V
    Отправка POST-запроса к API
        |
        V
    Получение чанков данных из ответа
        |
        V
    Декодирование чанков и извлечение контента
        |
        V
    Генерация текста или FinishReason("stop") ->  Завершение
    """
```

**Параметры**:
- `cls`: Ссылка на класс `ChatGLM`.
- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий текст ответа.

**Внутренние переменные**:
- `device_id` (str): Уникальный идентификатор устройства, генерируется на основе UUID.
- `headers` (dict): Словарь с заголовками HTTP-запроса.
- `session` (ClientSession): Асинхронная сессия для выполнения HTTP-запросов.
- `data` (dict): Словарь с данными, отправляемыми в теле POST-запроса.
- `yield_text` (int): Индекс последнего обработанного символа в текстовом содержимом.

**Примеры**:
```python
messages = [{"role": "user", "content": "Hello, ChatGLM!"}]
async for message in ChatGLM.create_async_generator(model="glm-4", messages=messages):
    print(message)
```
```python
messages = [{"role": "user", "content": "Как дела?"}]
async for message in ChatGLM.create_async_generator(model="glm-4", messages=messages, proxy="http://your-proxy:8080"):
    print(message)
```
```python
messages = [{"role": "user", "content": "Tell me a joke"}]
async for message in ChatGLM.create_async_generator(model="glm-4", messages=messages):
    print(message)