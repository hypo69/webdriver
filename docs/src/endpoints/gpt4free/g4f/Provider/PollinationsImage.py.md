# Модуль `PollinationsImage.py`

## Обзор

Модуль `PollinationsImage.py` предоставляет класс `PollinationsImage`, который является подклассом `PollinationsAI`. Он предназначен для работы с моделями генерации изображений от Pollinations AI. Класс позволяет динамически подгружать и комбинировать различные модели изображений, а также предоставляет асинхронный генератор для создания изображений на основе текстовых запросов.

## Подробней

Этот модуль является частью системы, которая использует модели машинного обучения для генерации изображений на основе текстовых описаний. Он расширяет функциональность базового класса `PollinationsAI`, добавляя специфические методы для работы с моделями изображений и обработки запросов на генерацию изображений. Модуль также обеспечивает механизм для управления и синхронизации загрузки моделей.

## Классы

### `PollinationsImage`

**Описание**: Класс `PollinationsImage` предназначен для генерации изображений с использованием моделей Pollinations AI. Он наследуется от класса `PollinationsAI` и расширяет его функциональность, добавляя поддержку моделей изображений.

**Принцип работы**:
Класс использует статические методы для управления списком доступных моделей изображений и асинхронный генератор для создания изображений на основе текстовых запросов. Он также обеспечивает форматирование запросов и передачу параметров для генерации изображений.

**Наследует**
- `PollinationsAI`: Базовый класс для взаимодействия с моделями Pollinations AI.

**Атрибуты**:
- `label` (str): Метка класса, используемая для идентификации провайдера ("PollinationsImage").
- `default_model` (str): Модель, используемая по умолчанию ("flux").
- `default_vision_model` (None): Модель машинного зрения, используемая по умолчанию (None).
- `default_image_model` (str): Модель изображений, используемая по умолчанию (совпадает с `default_model`).
- `image_models` (list[str]): Список поддерживаемых моделей изображений, изначально содержащий только `default_image_model`.
- `_models_loaded` (bool): Флаг, указывающий, были ли загружены модели (используется для синхронизации).

**Методы**:
- `get_models(**kwargs)`: Возвращает список доступных моделей изображений.
- `create_async_generator(...)`: Создает асинхронный генератор для генерации изображений на основе текстового запроса.

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs):
        """
        Возвращает список доступных моделей изображений.

        Args:
            kwargs (dict): Дополнительные аргументы (не используются).

        Returns:
            list[str]: Список доступных моделей изображений.
        """
```

**Назначение**: Метод `get_models` возвращает список доступных моделей изображений. Если модели еще не были загружены, он загружает их, объединяя модели из родительского класса `PollinationsAI` и дополнительные модели, специфичные для данного класса.

**Как работает функция**:

1.  **Проверка загрузки моделей**: Проверяет, был ли установлен флаг `_models_loaded`.
2.  **Если модели не загружены**:
    *   Вызывает метод `get_models` родительского класса `PollinationsAI` для загрузки моделей родительского класса.
    *   Объединяет списки моделей из `cls.image_models`, `PollinationsAI.image_models` и `cls.extra_image_models`, используя `dict.fromkeys` для удаления дубликатов и сохранения порядка.
    *   Присваивает объединенный список `cls.image_models`.
    *   Устанавливает флаг `_models_loaded` в `True`.
3.  **Возвращает список моделей**: Возвращает текущий список `cls.image_models`.

```
    Проверка загрузки моделей
    │
    └───> Модели не загружены?
         │
         ├───> Да: Загрузка моделей родительского класса
         │    │
         │    └───> Объединение списков моделей
         │    │
         │    └───> Установка флага загрузки моделей
         │
         └───> Нет: Возврат текущего списка моделей
```

**Примеры**:

```python
models = PollinationsImage.get_models()
print(models)
# Вывод: ['flux', ...]
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        prompt: str = None,
        aspect_ratio: str = "1:1",
        width: int = None,
        height: int = None,
        seed: Optional[int] = None,
        cache: bool = False,
        nologo: bool = True,
        private: bool = False,
        enhance: bool = False,
        safe: bool = False,
        n: int = 4,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для генерации изображений на основе текстового запроса.

        Args:
            model (str): Модель для генерации изображений.
            messages (Messages): Список сообщений для формирования запроса.
            proxy (str, optional): Прокси-сервер для выполнения запроса. По умолчанию `None`.
            prompt (str, optional): Дополнительный текст запроса. По умолчанию `None`.
            aspect_ratio (str, optional): Соотношение сторон изображения. По умолчанию "1:1".
            width (int, optional): Ширина изображения. По умолчанию `None`.
            height (int, optional): Высота изображения. По умолчанию `None`.
            seed (Optional[int], optional): Зерно для генерации случайных чисел. По умолчанию `None`.
            cache (bool, optional): Использовать ли кэш. По умолчанию `False`.
            nologo (bool, optional): Удалять ли логотип. По умолчанию `True`.
            private (bool, optional): Сделать ли изображение приватным. По умолчанию `False`.
            enhance (bool, optional): Улучшать ли изображение. По умолчанию `False`.
            safe (bool, optional): Использовать ли безопасный режим. По умолчанию `False`.
            n (int, optional): Количество изображений для генерации. По умолчанию 4.
            kwargs (dict): Дополнительные аргументы.

        Yields:
            AsyncResult: Части изображения, генерируемые асинхронно.
        """
```

**Назначение**: Метод `create_async_generator` создает асинхронный генератор для генерации изображений на основе текстового запроса. Он принимает различные параметры, определяющие модель, прокси, размеры изображения, и другие настройки генерации.

**Параметры**:
- `model` (str): Модель для генерации изображений.
- `messages` (Messages): Список сообщений для формирования запроса.
- `proxy` (str, optional): Прокси-сервер для выполнения запроса. По умолчанию `None`.
- `prompt` (str, optional): Дополнительный текст запроса. По умолчанию `None`.
- `aspect_ratio` (str, optional): Соотношение сторон изображения. По умолчанию "1:1".
- `width` (int, optional): Ширина изображения. По умолчанию `None`.
- `height` (int, optional): Высота изображения. По умолчанию `None`.
- `seed` (Optional[int], optional): Зерно для генерации случайных чисел. По умолчанию `None`.
- `cache` (bool, optional): Использовать ли кэш. По умолчанию `False`.
- `nologo` (bool, optional): Удалять ли логотип. По умолчанию `True`.
- `private` (bool, optional): Сделать ли изображение приватным. По умолчанию `False`.
- `enhance` (bool, optional): Улучшать ли изображение. По умолчанию `False`.
- `safe` (bool, optional): Использовать ли безопасный режим. По умолчанию `False`.
- `n` (int, optional): Количество изображений для генерации. По умолчанию 4.
- `kwargs` (dict): Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий части изображений по мере их генерации.

**Как работает функция**:

1.  **Обновление моделей**: Вызывает метод `get_models()` для обновления списка доступных моделей.
2.  **Запуск асинхронной генерации**: Запускает асинхронный генератор `_generate_image` с передачей параметров, необходимых для генерации изображения.
    *   Форматирует запрос, объединяя `messages` и `prompt` с помощью `format_image_prompt`.
    *   Передает параметры `proxy`, `aspect_ratio`, `width`, `height`, `seed`, `cache`, `nologo`, `private`, `enhance`, `safe` и `n` в генератор.
3.  **Генерация чанков**: Итерируется по чанкам, генерируемым `_generate_image`, и передает их вызывающей стороне с помощью `yield`.

```
    Обновление моделей
    │
    └───> Запуск асинхронной генерации
         │
         ├───> Форматирование запроса
         │    │
         │    └───> Запуск _generate_image
         │
         └───> Генерация чанков и передача их вызывающей стороне
```

**Примеры**:

```python
async for chunk in PollinationsImage.create_async_generator(model='flux', messages=['cat']):
    print(chunk)