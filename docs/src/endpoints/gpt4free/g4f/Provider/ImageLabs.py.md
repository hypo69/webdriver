# Модуль для работы с ImageLabs
===================================

Модуль содержит класс `ImageLabs`, который используется для генерации изображений через API ImageLabs.

## Обзор

Модуль `ImageLabs` предоставляет асинхронный интерфейс для генерации изображений на основе текстового запроса. Он поддерживает настройку размера изображения, негативные запросы и использует асинхронные HTTP-запросы для взаимодействия с API.

## Подробней

Этот модуль является провайдером для генерации изображений, интегрированным в систему `hypotez`. Он использует API сервиса ImageLabs для создания изображений на основе текстовых запросов. Поддерживается указание размеров изображения и негативных запросов.

## Классы

### `ImageLabs`

**Описание**: Класс `ImageLabs` реализует асинхронного провайдера для генерации изображений через API ImageLabs.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса ImageLabs.
- `api_endpoint` (str): URL API endpoint для генерации изображений.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`sdxl-turbo`).
- `default_image_model` (str): Модель изображения, используемая по умолчанию (совпадает с `default_model`).
- `image_models` (list[str]): Список поддерживаемых моделей изображений.
- `models` (list[str]): Список моделей (совпадает с `image_models`).

**Методы**:
- `create_async_generator`: Асинхронно генерирует изображения на основе текстового запроса.
- `get_model`: Возвращает модель по умолчанию.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        # Image
        prompt: str = None,
        negative_prompt: str = "",
        width: int = 1152,
        height: int = 896,
        **kwargs
    ) -> AsyncResult:
        """Асинхронно генерирует изображения на основе текстового запроса.

        Args:
            model (str): Модель для генерации изображения.
            messages (Messages): Список сообщений для контекста (используется последнее сообщение как запрос).
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
            negative_prompt (str, optional): Негативный запрос, описывающий, что не должно быть на изображении. По умолчанию "".
            width (int, optional): Ширина изображения. По умолчанию 1152.
            height (int, optional): Высота изображения. По умолчанию 896.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий объекты `ImageResponse` с URL сгенерированных изображений.

        Raises:
            Exception: Если происходит ошибка во время генерации изображения.

        Как работает функция:
        1.  **Подготовка заголовков**: Функция подготавливает заголовки для HTTP-запросов, включая User-Agent, Content-Type и Referer.
        2.  **Создание асинхронной сессии**: Создается асинхронная сессия `aiohttp.ClientSession` с заданными заголовками.
        3.  **Извлечение запроса**: Если `prompt` не указан, он извлекается из последнего сообщения в списке `messages`.
        4.  **Формирование payload**: Формируется JSON payload с параметрами запроса, такими как `prompt`, `seed`, `width`, `height` и `negative_prompt`.
        5.  **Отправка запроса на генерацию**: Отправляется POST-запрос к API ImageLabs (`/txt2img`) с сформированным payload.
        6.  **Получение task_id**: Из ответа извлекается `task_id`, который используется для отслеживания прогресса генерации.
        7.  **Опрос прогресса**: В цикле отправляются POST-запросы к API ImageLabs (`/progress`) для получения информации о прогрессе генерации изображения.
        8.  **Проверка статуса**: Проверяется статус генерации изображения. Если статус `Done` или получен `final_image_url`, функция возвращает объект `ImageResponse` с URL изображения.
        9.  **Обработка ошибок**: Если в статусе содержится слово `error`, выбрасывается исключение с информацией об ошибке.
        10. **Ожидание**: Между запросами на проверку прогресса происходит ожидание в 1 секунду (`asyncio.sleep(1)`).

        Внутренние функции:
            Отсутствуют
        """
```

**Flowchart работы функции `create_async_generator`:**

```
    Начало
     ↓
    Подготовка заголовков
     ↓
    Создание асинхронной сессии
     ↓
    Извлечение запроса (prompt)
     ↓
    Формирование payload
     ↓
    Отправка запроса на генерацию
     ↓
    Получение task_id
     ↓
    Цикл опроса прогресса:
     │
     ├──→ Отправка запроса на проверку прогресса
     │    ↓
     ├──→ Проверка статуса (Done/Error)
     │    │
     │    ├── Done →  Создание ImageResponse и завершение
     │    │
     │    └── Error →  Выброс исключения
     │
     └── Ожидание 1 секунда
```

**Примеры**:
```python
# Пример вызова create_async_generator
model = "sdxl-turbo"
messages = [{"content": "A cat in space"}]
#result = await ImageLabs.create_async_generator(model=model, messages=messages)

# Пример с указанием размеров и негативного запроса
model = "sdxl-turbo"
messages = [{"content": "A cat in space"}]
#result = await ImageLabs.create_async_generator(model=model, messages=messages, width=512, height=512, negative_prompt="blurry, low quality")
```

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """Возвращает модель по умолчанию.

        Args:
            model (str): Запрашиваемая модель.

        Returns:
            str: Модель по умолчанию (`sdxl-turbo`).
        """
```

**Как работает функция**:
Функция `get_model` просто возвращает значение атрибута `cls.default_model`, которое представляет собой модель по умолчанию.
Принимает `model:str`, но не использует его. Всегда возвращает `cls.default_model`

**Примеры**:
```python
# Пример вызова get_model
model = ImageLabs.get_model("any_model")
print(model)  # Вывод: sdxl-turbo