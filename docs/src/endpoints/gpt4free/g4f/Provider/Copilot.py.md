# Модуль для работы с Microsoft Copilot
=================================================

Модуль содержит класс :class:`Copilot`, который используется для взаимодействия с Microsoft Copilot для генерации текста и изображений.

Пример использования
----------------------

```python
# Пример использования будет добавлен позднее, когда будет предоставлен код для примера
```

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [Conversation](#conversation)
    - [Copilot](#copilot)
- [Функции](#функции)
    - [get_access_token_and_cookies](#get_access_token_and_cookies)
    - [readHAR](#readhar)
    - [get_clarity](#get_clarity)

## Обзор

Модуль `Copilot.py` предоставляет интерфейс для взаимодействия с Microsoft Copilot, позволяя генерировать текст и изображения. Он включает в себя классы для управления диалогами и аутентификацией, а также функции для получения токенов доступа и работы с файлами HAR.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с Microsoft Copilot. Он использует библиотеки `curl_cffi` и `nodriver` для осуществления HTTP и WebSocket соединений, а также для автоматизации входа в систему через браузер. Модуль предоставляет возможность создавать и поддерживать диалоги, отправлять текстовые запросы и медиафайлы, а также получать ответы в виде текста и изображений.

## Классы

### `Conversation`

**Описание**: Класс для представления разговора с Copilot.

**Наследует**: JsonConversation

**Атрибуты**:
- `conversation_id` (str): Идентификатор разговора.

**Методы**:
- `__init__(conversation_id: str)`: Конструктор класса. Инициализирует объект `Conversation` с заданным `conversation_id`.

### `Copilot`

**Описание**: Класс для взаимодействия с Microsoft Copilot.

**Наследует**: AbstractProvider, ProviderModelMixin

**Атрибуты**:
- `label` (str): Метка провайдера (Microsoft Copilot).
- `url` (str): URL Copilot.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `default_model` (str): Модель, используемая по умолчанию ("Copilot").
- `models` (list): Список поддерживаемых моделей ("Copilot", "Think Deeper").
- `model_aliases` (dict): Псевдонимы моделей.
- `websocket_url` (str): URL для WebSocket соединения.
- `conversation_url` (str): URL для управления разговорами.
- `_access_token` (str): Токен доступа.
- `_cookies` (dict): Cookie для аутентификации.

**Методы**:
- `create_completion(model: str, messages: Messages, stream: bool = False, proxy: str = None, timeout: int = 900, prompt: str = None, media: MediaListType = None, conversation: BaseConversation = None, return_conversation: bool = False, api_key: str = None, **kwargs) -> CreateResult`:
    Функция создает запрос к Copilot и возвращает результат.

## Функции

### `get_access_token_and_cookies`

```python
async def get_access_token_and_cookies(url: str, proxy: str = None, target: str = "ChatAI") -> tuple[str, dict]:
    """
    Получает токен доступа и cookie для Microsoft Copilot, используя автоматизированный браузер.

    Args:
        url (str): URL для доступа к Copilot.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию None.
        target (str, optional): Цель для получения токена доступа. По умолчанию "ChatAI".

    Returns:
        tuple[str, dict]: Кортеж, содержащий токен доступа и словарь cookie.

    Как работает функция:
    1. Инициализирует автоматизированный браузер с использованием `get_nodriver` с заданным прокси и каталогом пользовательских данных.
    2. Открывает указанный URL в браузере.
    3. Извлекает токен доступа из `localStorage` браузера, ожидая, пока он не станет доступным.
       Токен извлекается, только если `credentialType` равен "AccessToken", время истечения (`expiresOn`) больше текущего времени, и цель (`target`) включает указанную цель.
    4. Получает все cookie для указанного URL с помощью `nodriver.cdp.network.get_cookies`.
    5. Закрывает страницу и останавливает браузер.
    6. Возвращает токен доступа и cookie.

    Примеры:
        # Пример вызова функции с параметрами
        access_token, cookies = asyncio.run(get_access_token_and_cookies("https://copilot.microsoft.com", proxy="http://proxy:8080", target="ChatAI"))
    """
```

**Как работает функция**:

```
    +---------------------------------------------------------------------+
    | A: Инициализация автоматизированного браузера                        |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  browser, stop_browser = await get_nodriver(proxy=proxy, user_data_dir="copilot")
    |                                                                     |
    +---------------------------------------------------------------------+
    | B: Открытие URL в браузере                                          |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  page = await browser.get(url)                                      |
    |                                                                     |
    +---------------------------------------------------------------------+
    | C: Извлечение токена доступа из localStorage                          |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  access_token = await page.evaluate(...)                            |
    |                                                                     |
    +---------------------------------------------------------------------+
    | D: Получение cookie                                                   |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  cookies = {}                                                       |
    |  for c in await page.send(nodriver.cdp.network.get_cookies([url])): |
    |      cookies[c.name] = c.value                                      |
    |                                                                     |
    +---------------------------------------------------------------------+
    | E: Закрытие страницы и остановка браузера                             |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  await page.close()                                                 |
    |  stop_browser()                                                      |
    |                                                                     |
    +---------------------------------------------------------------------+
    | F: Возврат токена доступа и cookie                                    |
    +---------------------------------------------------------------------+

```

### `readHAR`

```python
def readHAR(url: str) -> tuple[str, dict]:
    """
    Читает файлы HAR (HTTP Archive) для извлечения токена доступа и cookie.

    Args:
        url (str): URL для поиска в файлах HAR.

    Returns:
        tuple[str, dict]: Кортеж, содержащий токен доступа и словарь cookie.

    Raises:
        NoValidHarFileError: Если токен доступа не найден в файлах HAR.

    Как работает функция:
    1. Получает список путей к файлам HAR с использованием `get_har_files()`.
    2. Перебирает каждый файл HAR, пытаясь загрузить его содержимое как JSON.
    3. Для каждого файла HAR перебирает записи (`entries`) в логе.
    4. Проверяет, начинается ли URL запроса (`request.url`) с указанного URL.
    5. Если URL совпадает, извлекает заголовки запроса и проверяет наличие заголовка `authorization`.
       Если заголовок `authorization` присутствует, извлекает токен доступа из его значения.
    6. Извлекает cookie из запроса и формирует словарь cookie.
    7. Если токен доступа не найден после перебора всех файлов HAR, вызывает исключение `NoValidHarFileError`.
    8. Возвращает токен доступа и cookie.

    Примеры:
        # Пример вызова функции
        api_key, cookies = readHAR("https://copilot.microsoft.com")
    """
```

**Как работает функция**:

```
    +---------------------------------------------------------------------+
    | A: Получение списка файлов HAR                                       |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  for path in get_har_files():                                       |
    |                                                                     |
    +---------------------------------------------------------------------+
    | B: Чтение и разбор файла HAR                                         |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  with open(path, 'rb') as file:                                     |
    |      harFile = json.loads(file.read())                             |
    |                                                                     |
    +---------------------------------------------------------------------+
    | C: Поиск токена доступа и cookie в записях HAR                       |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  for v in harFile['log']['entries']:                                 |
    |      if v['request']['url'].startswith(url):                        |
    |          v_headers = get_headers(v)                                 |
    |          if "authorization" in v_headers:                           |
    |              api_key = v_headers["authorization"].split(maxsplit=1).pop()
    |          if v['request']['cookies']:                                 |
    |              cookies = {c['name']: c['value'] for c in v['request']['cookies']}
    |                                                                     |
    +---------------------------------------------------------------------+
    | D: Выброс исключения, если токен не найден                          |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  if api_key is None:                                               |
    |      raise NoValidHarFileError("No access token found in .har files")
    |                                                                     |
    +---------------------------------------------------------------------+
    | E: Возврат токена доступа и cookie                                    |
    +---------------------------------------------------------------------+

```

### `get_clarity`

```python
def get_clarity() -> bytes:
    """
    Возвращает base64-декодированные данные, используемые для Clarity.

    Returns:
        bytes: Декодированные данные Clarity.

    Как работает функция:
    1. Определяет base64-encoded строку, представляющую сжатые данные.
    2. Декодирует base64-encoded строку, используя `base64.b64decode()`.
    3. Возвращает декодированные данные.

    Примеры:
        # Пример вызова функции
        clarity_data = get_clarity()
    """
```

**Как работает функция**:

```
    +---------------------------------------------------------------------+
    | A: Определение base64-encoded данных                                |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  body = base64.b64decode("H4sIAAAAAAAAA23RwU7DMAwG4HfJ2...")      |
    |                                                                     |
    +---------------------------------------------------------------------+
    | B: Декодирование base64-encoded данных                               |
    +---------------------------------------------------------------------+
    |                                                                     |
    |  body = base64.b64decode(...)                                        |
    |                                                                     |
    +---------------------------------------------------------------------+
    | C: Возврат декодированных данных                                      |
    +---------------------------------------------------------------------+