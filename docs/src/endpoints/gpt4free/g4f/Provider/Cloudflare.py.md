# Модуль Cloudflare

## Обзор

Модуль `Cloudflare` предоставляет асинхронный интерфейс для взаимодействия с AI-моделями, размещенными на платформе Cloudflare AI Playground. Он поддерживает потоковую передачу данных, системные сообщения и историю сообщений. Модуль использует `nodriver` или `curl_cffi` для выполнения HTTP-запросов.

## Подробнее

Модуль предназначен для использования в проекте `hypotez` для обеспечения доступа к различным AI-моделям через API Cloudflare. Он включает в себя функциональность для получения списка доступных моделей, создания асинхронных генераторов для взаимодействия с моделями и обработки ответов от API.

## Классы

### `Cloudflare`

**Описание**: Класс `Cloudflare` является провайдером для работы с AI-моделями Cloudflare. Он реализует асинхронный генератор для обработки потоковых ответов от API.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.
- `AuthFileMixin`: Обеспечивает авторизацию через файл.

**Атрибуты**:
- `label` (str): Метка провайдера ("Cloudflare AI").
- `url` (str): URL AI Playground Cloudflare ("https://playground.ai.cloudflare.com").
- `working` (bool): Указывает, работает ли провайдер (True).
- `use_nodriver` (bool): Указывает, использовать ли `nodriver` для запросов (True).
- `api_endpoint` (str): URL API для выполнения запросов ("https://playground.ai.cloudflare.com/api/inference").
- `models_url` (str): URL для получения списка моделей ("https://playground.ai.cloudflare.com/api/models").
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу (True).
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения (True).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (True).
- `default_model` (str): Модель по умолчанию ("@cf/meta/llama-3.3-70b-instruct-fp8-fast").
- `model_aliases` (dict): Псевдонимы для моделей.
- `_args` (dict): Аргументы для HTTP-запросов.

**Методы**:
- `get_models()`: Получает список доступных моделей.
- `create_async_generator()`: Создает асинхронный генератор для взаимодействия с моделью.

## Функции

### `get_models`

```python
@classmethod
def get_models(cls) -> str:
    """
    Получает список доступных моделей из API Cloudflare.

    Args:
        cls (Cloudflare): Класс Cloudflare.

    Returns:
        str: Список доступных моделей.

    Raises:
        ResponseStatusError: Если возникает ошибка при выполнении HTTP-запроса.
    """
    ...
```

**Назначение**: Получение списка доступных моделей AI из API Cloudflare.

**Параметры**:
- `cls` (Cloudflare): Класс `Cloudflare`.

**Возвращает**:
- `str`: Список доступных моделей.

**Вызывает исключения**:
- `ResponseStatusError`: Если возникает ошибка при выполнении HTTP-запроса.

**Как работает функция**:

1. **Проверка кэша**: Функция сначала проверяет, были ли модели уже загружены в атрибут класса `cls.models`. Если модели уже загружены, функция возвращает их из кэша.
2. **Инициализация аргументов**: Если модели не были загружены, функция проверяет, были ли инициализированы аргументы для HTTP-запросов (`cls._args`).
   - Если `cls._args` равно `None`, функция пытается получить аргументы, используя `get_args_from_nodriver`, если доступен `nodriver`. В противном случае используются стандартные заголовки и куки.
3. **Выполнение HTTP-запроса**: После инициализации аргументов функция выполняет GET-запрос к `cls.models_url` с использованием `Session` из модуля `requests`.
4. **Обработка ответа**:
   - Функция объединяет куки из ответа с текущими куками в `cls._args`.
   - Функция проверяет статус ответа и вызывает исключение `ResponseStatusError`, если статус указывает на ошибку.
   - Если запрос успешен, функция извлекает список моделей из JSON-ответа и сохраняет его в `cls.models`.
5. **Возврат списка моделей**: Функция возвращает список доступных моделей.

**Внутренние функции**: Нет.

**ASCII flowchart**:

```
A[Проверка cls.models]
│
├───> B[Если cls.models: возврат cls.models]
│
└───> C[Проверка cls._args]
    │
    ├───> D[Если cls._args: выполнение HTTP-запроса]
    │
    └───> E[Инициализация cls._args с использованием get_args_from_nodriver или DEFAULT_HEADERS]
        │
        F[Выполнение HTTP-запроса к cls.models_url]
        │
        G[Обработка ответа: извлечение списка моделей из JSON и сохранение в cls.models]
        │
        H[Возврат cls.models]
```

**Примеры**:

```python
# Пример вызова функции для получения списка моделей
models = Cloudflare.get_models()
print(models)
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    max_tokens: int = 2048,
    cookies: Cookies = None,
    timeout: int = 300,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с AI-моделью Cloudflare.

    Args:
        cls (Cloudflare): Класс Cloudflare.
        model (str): Имя модели.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): URL прокси-сервера. По умолчанию None.
        max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию 2048.
        cookies (Cookies, optional): Куки для отправки. По умолчанию None.
        timeout (int, optional): Время ожидания ответа в секундах. По умолчанию 300.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор для получения ответов от API.

    Raises:
        ModelNotFoundError: Если указанная модель не найдена.
        ResponseStatusError: Если возникает ошибка при выполнении HTTP-запроса.
    """
    ...
```

**Назначение**: Создание асинхронного генератора для взаимодействия с AI-моделями Cloudflare.

**Параметры**:
- `cls` (Cloudflare): Класс `Cloudflare`.
- `model` (str): Имя модели.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `2048`.
- `cookies` (Cookies, optional): Куки для отправки. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа в секундах. По умолчанию `300`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор для получения ответов от API.

**Вызывает исключения**:
- `ModelNotFoundError`: Если указанная модель не найдена.
- `ResponseStatusError`: Если возникает ошибка при выполнении HTTP-запроса.

**Как работает функция**:

1. **Инициализация аргументов**: Функция сначала пытается загрузить аргументы из кэш-файла. Если кэш-файл не существует или его не удалось загрузить, функция пытается получить аргументы, используя `get_args_from_nodriver`, если доступен `nodriver`. В противном случае используются стандартные заголовки и куки.
2. **Получение модели**: Функция пытается получить модель, используя `cls.get_model(model)`. Если модель не найдена, вызывается исключение `ModelNotFoundError`.
3. **Формирование данных для запроса**: Функция формирует данные для POST-запроса, включая сообщения, модель, максимальное количество токенов и другие параметры.
4. **Выполнение асинхронного POST-запроса**: Функция выполняет асинхронный POST-запрос к `cls.api_endpoint` с использованием `StreamSession` из модуля `requests`.
5. **Обработка потокового ответа**:
   - Функция объединяет куки из ответа с текущими куками в `cls._args`.
   - Функция проверяет статус ответа и вызывает исключение `ResponseStatusError`, если статус указывает на ошибку.
   - Функция итерируется по строкам в ответе и обрабатывает их в зависимости от префикса:
     - Если строка начинается с `b'0:'`, функция загружает JSON из строки и передает его в генератор.
     - Если строка начинается с `b'e:'`, функция загружает JSON из строки, извлекает информацию об использовании и причине завершения и передает их в генератор.
6. **Сохранение аргументов в кэш-файл**: После завершения обработки ответа функция сохраняет аргументы в кэш-файл.

**Внутренние функции**: Нет.

**ASCII flowchart**:

```
A[Загрузка аргументов из кэш-файла]
│
├───> B[Если кэш-файл существует: загрузка аргументов]
│
└───> C[Получение аргументов с использованием get_args_from_nodriver или DEFAULT_HEADERS]
    │
    D[Получение модели с использованием cls.get_model(model)]
    │
    E[Формирование данных для POST-запроса]
    │
    F[Выполнение асинхронного POST-запроса к cls.api_endpoint]
    │
    G[Обработка потокового ответа: извлечение данных и передача в генератор]
    │
    H[Сохранение аргументов в кэш-файл]
```

**Примеры**:

```python
# Пример вызова функции для создания асинхронного генератора
messages = [{"role": "user", "content": "Hello, how are you?"}]
async def main():
    async for chunk in Cloudflare.create_async_generator(model="@cf/meta/llama-3.3-70b-instruct-fp8-fast", messages=messages):
        print(chunk)

asyncio.run(main())