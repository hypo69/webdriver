# Модуль для работы с провайдером You.com
## Обзор

Модуль предоставляет асинхронтный генератор для взаимодействия с сервисом You.com, включая поддержку текстовых и визуальных запросов. Он включает в себя классы и методы для работы с различными моделями, загрузки файлов и обработки ответов от You.com.

## Подробней

Модуль предназначен для интеграции с сервисом You.com, позволяя использовать различные модели для генерации текста и изображений. Он поддерживает стриминг ответов, загрузку изображений и обработку ошибок.
В коде используется асинхронный подход для обеспечения неблокирующей работы с сервисом.
Для запросов к сервису используется `StreamSession` из модуля `requests` проекта `hypotez`, который обеспечивает асинхронное взаимодействие по протоколу HTTP.

## Классы

### `You`

**Описание**: Класс `You` является асинхронным генератором и миксином для работы с провайдером You.com.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `label` (str): Метка провайдера ("You.com").
- `url` (str): URL сервиса You.com ("https://you.com").
- `working` (bool): Указывает, что провайдер работает (True).
- `default_model` (str): Модель, используемая по умолчанию ("gpt-4o-mini").
- `default_vision_model` (str): Модель для работы с изображениями по умолчанию ("agent").
- `image_models` (List[str]): Список моделей для генерации изображений (["dall-e"]).
- `models` (List[str]): Список поддерживаемых моделей.
- `_cookies` (Optional[Cookies]): Куки для аутентификации.
- `_cookies_used` (int): Количество использованных куки.
- `_telemetry_ids` (List[str]): Список идентификаторов телеметрии.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с You.com.
- `upload_file`: Загружает файл на сервер You.com.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool = True,
        image: ImageType = None,
        image_name: str = None,
        proxy: str = None,
        timeout: int = 240,
        chat_mode: str = "default",
        cookies: Cookies = None,
        **kwargs,
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с You.com.

        Args:
            model (str): Модель для использования.
            messages (Messages): Список сообщений для отправки.
            stream (bool, optional): Флаг стриминга ответов. По умолчанию True.
            image (ImageType, optional): Изображение для отправки. По умолчанию None.
            image_name (str, optional): Имя изображения. По умолчанию None.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию None.
            timeout (int, optional): Время ожидания ответа. По умолчанию 240.
            chat_mode (str, optional): Режим чата. По умолчанию "default".
            cookies (Cookies, optional): Куки для аутентификации. По умолчанию None.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор для получения ответов от You.com.

        Raises:
            MissingRequirementsError: Если не удалось получить куки.
            ResponseError: Если произошла ошибка при запросе к API.

        Example:
            Примеры вызовов со всем спектром параметров. которы можно передать в функцию

        """
        ...
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для взаимодействия с сервисом You.com. Она принимает различные параметры, такие как модель, сообщения, изображение, прокси, таймаут, режим чата и куки, и возвращает асинхронный генератор, который позволяет получать ответы от You.com в режиме реального времени.

**Параметры**:
- `cls`: Ссылка на класс `You`.
- `model` (str): Модель для использования при генерации ответа.
- `messages` (Messages): Список сообщений, отправляемых в запросе.
- `stream` (bool, optional): Флаг, указывающий, следует ли использовать потоковую передачу данных. По умолчанию `True`.
- `image` (ImageType, optional): Изображение, которое нужно отправить в запросе. По умолчанию `None`.
- `image_name` (str, optional): Имя файла изображения. По умолчанию `None`.
- `proxy` (str, optional): URL прокси-сервера для использования при подключении. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа от сервера в секундах. По умолчанию `240`.
- `chat_mode` (str, optional): Режим чата, определяющий тип взаимодействия с моделью. По умолчанию `"default"`.
- `cookies` (Cookies, optional): Куки для аутентификации и сохранения состояния сессии. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст или изображения от You.com.

**Вызывает исключения**:
- `MissingRequirementsError`: Если не удалось получить куки для не стандартного режима чата.
- `ResponseError`: Если сервер возвращает ошибку.

**Как работает функция**:

1. **Определение режима чата**: Функция определяет режим чата в зависимости от переданных параметров, таких как наличие изображения и выбранная модель. Если передано изображение или выбрана модель для работы с изображениями (`cls.default_vision_model`), режим чата устанавливается в `"agent"`. Для моделей, начинающихся с `"dall-e"`, режим устанавливается в `"create"`. В остальных случаях режим устанавливается в `"custom"`.

2. **Получение куки**: Если куки не переданы и режим чата не `"default"`, функция пытается получить куки из домена `.you.com`. Если это не удается, функция запускает браузер без драйвера (`get_nodriver`) для получения куки.

3. **Создание сессии**: Функция создает асинхронную сессию (`StreamSession`) с использованием прокси и таймаута.

4. **Загрузка файла (если есть изображение)**: Если передано изображение, функция загружает его на сервер с помощью метода `upload_file` и формирует данные для отправки.

5. **Формирование заголовков и данных**: Функция формирует заголовки и данные для запроса, включая сообщения, режим чата и выбранную модель.

6. **Выполнение запроса**: Функция выполняет GET-запрос к API `f"{cls.url}/api/streamingSearch"` с использованием сформированных заголовков, данных и куки.

7. **Обработка ответов**: Функция итерируется по строкам ответа и обрабатывает события, такие как ошибки, обновления чата и токены. Если событие равно `"youChatToken"`, функция извлекает текст из данных и передает его в генератор. Если событие равно `"youChatUpdate"` и режим чата `"create"`, функция извлекает URL изображения из данных и передает его в генератор.

**Внутренние функции**:
- Нет

**Примеры**:
```python
# Пример создания асинхронного генератора для текстового запроса
async def main():
    messages = [{"role": "user", "content": "Привет, как дела?"}]
    async for response in You.create_async_generator(model="gpt-4o-mini", messages=messages):
        print(response)

# Пример создания асинхронного генератора для запроса с изображением
async def main():
    with open("image.jpg", "rb") as f:
        image = f.read()
    messages = [{"role": "user", "content": "Опиши это изображение."}]
    async for response in You.create_async_generator(model="agent", messages=messages, image=image, image_name="image.jpg"):
        print(response)
```
ASCII flowchart:
```
A: Определение режима чата
│
B: Получение куки (если необходимо)
│
C: Создание асинхронной сессии
│
D: Загрузка файла (если есть изображение)
│
E: Формирование заголовков и данных
│
F: Выполнение GET-запроса к API
│
G: Обработка ответов
```

### `upload_file`

```python
    @classmethod
    async def upload_file(cls, client: StreamSession, cookies: Cookies, file: bytes, filename: str = None) -> dict:
        """
        Загружает файл на сервер You.com.

        Args:
            client (StreamSession): Асинхронный клиент для выполнения запросов.
            cookies (Cookies): Куки для аутентификации.
            file (bytes): Байтовое представление файла.
            filename (str, optional): Имя файла. По умолчанию None.

        Returns:
            dict: Словарь с результатами загрузки.

        Raises:
            ResponseError: Если произошла ошибка при загрузке файла.

        Example:
            Примеры вызовов со всем спектром параметров. которы можно передать в функцию

        """
        ...
```

**Назначение**: Функция `upload_file` загружает файл на сервер You.com, используя предоставленный асинхронный клиент `StreamSession`, куки для аутентификации и байтовое представление файла. Она возвращает словарь с результатами загрузки, содержащий информацию о файле.

**Параметры**:
- `cls`: Ссылка на класс `You`.
- `client` (StreamSession): Асинхронный клиент для выполнения запросов.
- `cookies` (Cookies): Куки для аутентификации.
- `file` (bytes): Байтовое представление файла для загрузки.
- `filename` (str, optional): Имя файла. Если не указано, генерируется автоматически на основе типа контента. По умолчанию `None`.

**Возвращает**:
- `dict`: Словарь с результатами загрузки, содержащий ключи: `"user_filename"` (имя файла), `"size"` (размер файла) и другие данные, возвращенные сервером.

**Вызывает исключения**:
- `ResponseError`: Если произошла ошибка при получении nonce или при загрузке файла.

**Как работает функция**:

1. **Получение nonce**: Функция отправляет GET-запрос к API `f"{cls.url}/api/get_nonce"` для получения nonce (одноразового ключа), необходимого для загрузки файла.

2. **Формирование данных формы**: Функция создает объект `FormData` и добавляет в него файл. Если имя файла не указано, оно генерируется автоматически на основе типа контента.

3. **Загрузка файла**: Функция отправляет POST-запрос к API `f"{cls.url}/api/upload"` с данными формы и заголовком `X-Upload-Nonce`.

4. **Обработка ответа**: Функция обрабатывает ответ от сервера, извлекает результаты загрузки и возвращает их в виде словаря.

**Внутренние функции**:
- Нет

**Примеры**:
```python
# Пример загрузки файла
async def main():
    async with StreamSession() as client:
        cookies = {"afUserId": "some_user_id"}
        with open("image.jpg", "rb") as f:
            file = f.read()
        result = await You.upload_file(client, cookies, file, "image.jpg")
        print(result)
```

ASCII flowchart:
```
A: Получение nonce
│
B: Формирование данных формы
│
C: Загрузка файла
│
D: Обработка ответа