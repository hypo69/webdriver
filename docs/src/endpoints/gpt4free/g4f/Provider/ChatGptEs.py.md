# Модуль ChatGptEs для работы с chatgpt.es
## Обзор

Модуль `ChatGptEs` предоставляет асинхронный генератор для взаимодействия с сервисом chatgpt.es. Он использует библиотеку `curl_cffi` для обхода Cloudflare и поддерживает различные модели, включая `gpt-4` и `gpt-4o`. Модуль предназначен для интеграции в проекты, требующие асинхронного взаимодействия с chatgpt.es.

## Подробнее

Этот модуль является частью проекта `hypotez` и обеспечивает взаимодействие с провайдером chatgpt.es. Он использует асинхронные запросы для генерации ответов на основе предоставленных сообщений. Важной особенностью является использование `curl_cffi` для обхода защиты Cloudflare, что позволяет стабильно получать ответы от сервиса.

## Классы

### `ChatGptEs`

**Описание**: Класс `ChatGptEs` предоставляет функциональность для взаимодействия с сервисом chatgpt.es. Он наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию ответов.
- `ProviderModelMixin`: Предоставляет методы для управления моделями.

**Атрибуты**:
- `url` (str): URL сервиса chatgpt.es.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Поддерживает ли потоковую передачу данных.
- `supports_system_message` (bool): Поддерживает ли системные сообщения.
- `supports_message_history` (bool): Поддерживает ли историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o`).
- `models` (list): Список поддерживаемых моделей (`gpt-4`, `gpt-4o`, `gpt-4o-mini`).
- `SYSTEM_PROMPT` (str): Системное сообщение, используемое для форматирования запросов.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с chatgpt.es.

        Args:
            model (str): Модель для использования.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от chatgpt.es.

        Raises:
            MissingRequirementsError: Если не установлен пакет `curl_cffi`.
            ValueError: Если получен неожиданный формат ответа или произошла ошибка при запросе.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для взаимодействия с chatgpt.es.

**Параметры**:
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий ответы от chatgpt.es.

**Вызывает исключения**:
- `MissingRequirementsError`: Если не установлен пакет `curl_cffi`.
- `ValueError`: Если получен неожиданный формат ответа или произошла ошибка при запросе.

**Как работает функция**:

1. **Проверка зависимостей**: Проверяет, установлен ли пакет `curl_cffi`. Если нет, вызывает исключение `MissingRequirementsError`.
2. **Форматирование запроса**: Форматирует запрос, объединяя системное сообщение и предоставленные сообщения.
3. **Создание сессии**: Создает сессию `curl_cffi` для выполнения запросов.
4. **Настройка заголовков**: Устанавливает необходимые заголовки для запроса, такие как `user-agent`, `referer` и `content-type`.
5. **Настройка прокси**: Если указан прокси-сервер, настраивает его для сессии.
6. **Первый запрос**: Выполняет первый запрос к chatgpt.es для получения `nonce` и `post_id`.
7. **Извлечение `nonce`**: Извлекает `nonce` из ответа, используя регулярные выражения.
8. **Извлечение `post_id`**: Извлекает `post_id` из ответа, используя регулярные выражения.
9. **Генерация `client_id`**: Генерирует случайный `client_id`.
10. **Подготовка данных**: Подготавливает данные для POST-запроса, включая `nonce`, `post_id`, `message` и `client_id`.
11. **POST-запрос**: Выполняет POST-запрос к API chatgpt.es с подготовленными данными.
12. **Обработка ответа**: Обрабатывает ответ, проверяет статус код и формат ответа.
13. **Генерация результата**: Если ответ успешен, извлекает данные и генерирует результат. В случае ошибки вызывает исключение `ValueError`.

**Внутренние функции**:
- Отсутствуют

**ASCII flowchart**:

```
    Проверка curl_cffi -> Форматирование запроса -> Создание сессии -> Настройка заголовков -> Настройка прокси
    ↓
    Первый запрос -> Извлечение nonce -> Извлечение post_id -> Генерация client_id -> Подготовка данных
    ↓
    POST-запрос -> Обработка ответа -> Генерация результата
```

**Примеры**:

```python
# Пример использования с минимальными параметрами
async for message in ChatGptEs.create_async_generator(model='gpt-4', messages=[{'role': 'user', 'content': 'Hello'}]):
    print(message)

# Пример использования с прокси-сервером
async for message in ChatGptEs.create_async_generator(model='gpt-4o', messages=[{'role': 'user', 'content': 'Как дела?'}], proxy='http://proxy.example.com:8080'):
    print(message)
```