# Модуль Jmuz

## Обзор

Модуль `Jmuz` предоставляет класс для взаимодействия с API Jmuz, который является провайдером моделей, аналогичных OpenAI. Класс `Jmuz` наследуется от класса `OpenaiTemplate` и предназначен для асинхронного обмена сообщениями с моделями Jmuz.

## Подробней

Модуль предназначен для интеграции с API Jmuz, позволяя использовать различные модели, такие как `gpt-4o`, `qwq-32b`, `gemini-1.5` и `deepseek-chat`. Он обеспечивает асинхронную генерацию ответов и поддерживает потоковую передачу данных.

## Классы

### `Jmuz(OpenaiTemplate)`

**Описание**: Класс `Jmuz` наследуется от `OpenaiTemplate` и предоставляет методы для взаимодействия с API Jmuz.

**Наследует**: `OpenaiTemplate`

**Атрибуты**:
- `url` (str): URL, связанный с Jmuz.
- `api_base` (str): Базовый URL API Jmuz.
- `api_key` (str): Ключ API для Jmuz.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `default_model` (str): Модель по умолчанию (`gpt-4o`).
- `model_aliases` (dict): Псевдонимы моделей для совместимости.

**Методы**:
- `get_models()`: Получает список доступных моделей.
- `create_async_generator()`: Создает асинхронный генератор для обмена сообщениями.

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs):
        """Получает список доступных моделей.

        Args:
            **kwargs: Дополнительные аргументы для получения моделей.

        Returns:
            list: Список доступных моделей.
        """
        ...
```

**Назначение**: Получение списка доступных моделей от API Jmuz.

**Параметры**:
- `**kwargs`: Дополнительные аргументы для получения моделей.

**Возвращает**:
- `list`: Список доступных моделей.

**Как работает функция**:

1. **Проверка наличия моделей**:
   - Проверяет, были ли уже загружены модели, обращаясь к `cls.models`.
2. **Загрузка моделей**:
   - Если модели еще не загружены, вызывает метод `super().get_models()` для получения списка моделей из API Jmuz.
3. **Возврат моделей**:
   - Возвращает список доступных моделей.

```text
Проверка наличия моделей --> Загрузка моделей (если необходимо) --> Возврат списка моделей
```

**Примеры**:

```python
models = Jmuz.get_models()
print(models)
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
            cls,
            model: str,
            messages: Messages,
            stream: bool = True,
            api_key: str = None, # Remove api_key from kwargs
            **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для обмена сообщениями.

        Args:
            model (str): Имя используемой модели.
            messages (Messages): Список сообщений для отправки.
            stream (bool): Флаг, указывающий на использование потоковой передачи данных.
            api_key (str, optional): Ключ API (удален из kwargs). По умолчанию `None`.
            **kwargs: Дополнительные аргументы для генератора.

        Returns:
            AsyncResult: Асинхронный генератор для получения ответов.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для обмена сообщениями с API Jmuz.

**Параметры**:
- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений для отправки.
- `stream` (bool): Флаг, указывающий на использование потоковой передачи данных. По умолчанию `True`.
- `api_key` (str, optional): Ключ API (удален из kwargs). По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы для генератора.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор для получения ответов.

**Как работает функция**:

1. **Получение имени модели**:
   - Получает имя модели с помощью метода `cls.get_model(model)`.
2. **Формирование заголовков**:
   - Создает заголовки для HTTP-запроса, включая ключ API и тип контента.
3. **Инициализация переменных**:
   - Инициализирует переменные `started` и `buffer` для обработки потоковых данных.
4. **Асинхронная генерация**:
   - Вызывает метод `super().create_async_generator()` для получения чанков данных из API Jmuz.
5. **Обработка чанков**:
   - Обрабатывает каждый чанк данных, удаляя нежелательные префиксы и URL Discord.
   - Если чанк является строкой, добавляет его в буфер.
   - Если чанк содержит "Join for free", "https://discord.gg/", или "o1-preview", очищает буфер.
   - Удаляет пробелы в начале буфера.
   - Если буфер не пуст, устанавливает флаг `started` и возвращает содержимое буфера.
6. **Возврат чанка**:
   - Если чанк не является строкой, возвращает его напрямую.

```text
Получение имени модели --> Формирование заголовков --> Инициализация переменных --> Асинхронная генерация --> Обработка чанков --> Возврат чанка
```

**Примеры**:

```python
async def main():
    messages = [{"role": "user", "content": "Hello, world!"}]
    async for chunk in Jmuz.create_async_generator(model="gpt-4o", messages=messages):
        print(chunk, end="")

# Запуск примера
# asyncio.run(main())