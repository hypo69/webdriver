# Модуль `CohereForAI_C4AI_Command.py`

## Обзор

Модуль предоставляет класс `CohereForAI_C4AI_Command`, который является асинхронным провайдером для взаимодействия с моделями CohereForAI C4AI Command через Hugging Face Space. Он позволяет генерировать текст на основе предоставленных сообщений и управлять ходом беседы, включая поддержку системных подсказок, управление историей диалогов и обработку ошибок.

## Подробней

Этот модуль предназначен для интеграции с моделями CohereForAI C4AI Command, размещенными на платформе Hugging Face Space. Он обеспечивает асинхронное взаимодействие, что позволяет эффективно обрабатывать запросы и генерировать ответы. Модуль также поддерживает управление историей диалогов с использованием cookies и идентификаторов бесед, что позволяет сохранять контекст и обеспечивать более последовательные ответы. Кроме того, модуль обрабатывает различные типы ответов от сервера, включая потоковую передачу текста, генерацию заголовков и завершение ответов.

## Классы

### `CohereForAI_C4AI_Command`

**Описание**: Класс `CohereForAI_C4AI_Command` является провайдером, который обеспечивает взаимодействие с моделями CohereForAI C4AI Command через Hugging Face Space. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:

- `AsyncGeneratorProvider`: Предоставляет базовую структуру для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями провайдера.

**Атрибуты**:

- `label` (str): Метка провайдера, `"CohereForAI C4AI Command"`.
- `url` (str): URL Hugging Face Space, `"https://cohereforai-c4ai-command.hf.space"`.
- `conversation_url` (str): URL для ведения бесед, формируется на основе `url`.
- `working` (bool): Указывает, работает ли провайдер, `True`.
- `default_model` (str): Модель по умолчанию, `"command-a-03-2025"`.
- `model_aliases` (dict): Псевдонимы моделей, сопоставляющие короткие имена с полными именами моделей.
- `models` (list): Список поддерживаемых моделей, полученный из ключей `model_aliases`.

#### Методы

- `get_model(model: str, **kwargs) -> str`: Возвращает полное имя модели на основе псевдонима.
- `create_async_generator(model: str, messages: Messages, api_key: str = None, proxy: str = None, conversation: JsonConversation = None, return_conversation: bool = False, **kwargs) -> AsyncResult`: Создает асинхронный генератор для взаимодействия с моделью.

## Функции

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str, **kwargs) -> str:
        ...
```

**Назначение**: Возвращает полное имя модели на основе предоставленного псевдонима. Если предоставленное имя модели есть в списке псевдонимов, возвращается соответствующее полное имя. В противном случае вызывается метод `get_model` родительского класса.

**Параметры**:

- `model` (str): Имя модели или псевдоним.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `str`: Полное имя модели.

**Как работает функция**:

1. **Проверка наличия в псевдонимах**: Функция проверяет, содержится ли предоставленное имя модели в значениях атрибута `model_aliases`.
2. **Возврат имени модели**: Если имя модели найдено в псевдонимах, функция возвращает его.
3. **Обращение к родительскому классу**: Если имя модели не найдено в псевдонимах, функция вызывает метод `get_model` родительского класса для обработки.

```
Проверка наличия имени модели в псевдонимах
│
├─── Если имя модели найдено в псевдонимах:
│    │
│    └─── Возврат полного имени модели
│
└─── Если имя модели не найдено в псевдонимах:
     │
     └─── Вызов метода `get_model` родительского класса
```

**Примеры**:

```python
# Пример 1: Получение полного имени модели по псевдониму
model_name = CohereForAI_C4AI_Command.get_model("command-r")
print(model_name)  # Вывод: command-r-08-2024

# Пример 2: Получение имени модели, которое уже является полным именем
model_name = CohereForAI_C4AI_Command.get_model("command-r-plus-08-2024")
print(model_name)  # Вывод: command-r-plus-08-2024
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls, model: str, messages: Messages,
        api_key: str = None, 
        proxy: str = None,
        conversation: JsonConversation = None,
        return_conversation: bool = False,
        **kwargs
    ) -> AsyncResult:
        ...
```

**Назначение**: Создает асинхронный генератор для взаимодействия с моделью CohereForAI C4AI Command.

**Параметры**:

- `model` (str): Имя модели для использования.
- `messages` (Messages): Список сообщений для отправки модели.
- `api_key` (str, optional): API-ключ для аутентификации. По умолчанию `None`.
- `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
- `conversation` (JsonConversation, optional): Объект, содержащий историю беседы. По умолчанию `None`.
- `return_conversation` (bool, optional): Флаг, указывающий, нужно ли возвращать объект беседы. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, возвращающий ответы модели.

**Как работает функция**:

1. **Получение имени модели**: Функция вызывает метод `get_model` для получения полного имени модели на основе предоставленного псевдонима.
2. **Формирование заголовков**: Функция формирует заголовки HTTP-запроса, включая информацию о User-Agent, Accept и Referer.
3. **Создание сессии**: Функция создает асинхронную сессию с использованием `ClientSession` для выполнения HTTP-запросов.
4. **Обработка системных сообщений**: Функция извлекает системные сообщения из списка сообщений и объединяет их в строку `system_prompt`.
5. **Формирование входных данных**: Если объект беседы не предоставлен, функция форматирует все сообщения с помощью `format_prompt`. В противном случае используется последнее сообщение пользователя.
6. **Создание или обновление беседы**: Если объект беседы не предоставлен или модель/предопределенный промт не соответствуют, функция создает новую беседу, отправляя POST-запрос к `conversation_url`.
7. **Получение message_id**: Функция отправляет GET-запрос к `conversation_url` для получения `message_id`, необходимого для отправки запроса.
8. **Формирование данных формы**: Функция формирует данные формы с использованием `FormData`, включая входные данные, `message_id` и другие параметры.
9. **Отправка запроса и обработка ответов**: Функция отправляет POST-запрос к `conversation_url` с данными формы и обрабатывает ответы от сервера.
10. **Обработка потоковых данных**: Функция обрабатывает потоковые данные, возвращаемые сервером, и извлекает токены текста, заголовки и финальные ответы.
11. **Обработка ошибок**: Если во время обработки возникает ошибка, функция генерирует исключение `RuntimeError`.

```
Получение имени модели
│
├─── Формирование заголовков HTTP-запроса
│   │
│   └─── Создание асинхронной сессии
│
├─── Извлечение системных сообщений
│   │
│   └─── Формирование входных данных
│
├─── Если объект беседы не предоставлен или модель/предопределенный промт не соответствуют:
│   │
│   └─── Создание новой беседы, отправляя POST-запрос к `conversation_url`
│
├─── Отправка GET-запроса к `conversation_url` для получения `message_id`
│   │
│   └─── Формирование данных формы с использованием `FormData`
│
├─── Отправка POST-запроса к `conversation_url` с данными формы
│   │
│   └─── Обработка потоковых данных и извлечение токенов текста, заголовков и финальных ответов
│
└─── Если во время обработки возникает ошибка:
    │
    └─── Генерация исключения `RuntimeError`
```

**Примеры**:

```python
# Пример 1: Создание асинхронного генератора с использованием модели и сообщений
messages = [
    {"role": "user", "content": "Привет, как дела?"}
]
async def main():
    async for response in CohereForAI_C4AI_Command.create_async_generator(model="command-r", messages=messages):
        print(response)

# Пример 2: Создание асинхронного генератора с использованием API-ключа и прокси
messages = [
    {"role": "user", "content": "Расскажи о себе."}
]
async def main():
    async for response in CohereForAI_C4AI_Command.create_async_generator(model="command-r", messages=messages, api_key="your_api_key", proxy="http://your_proxy"):
        print(response)