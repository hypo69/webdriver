# Модуль обработки статуса ответа

## Обзор

Модуль предназначен для проверки статуса HTTP-ответа и генерирования исключения в случае ошибки.
В частности, обрабатывает JSON-ответы для извлечения сообщения об ошибке, если таковое имеется.
Этот модуль помогает стандартизировать обработку ошибок в ответах от серверов, особенно при работе с API.

## Подробней

Модуль содержит единственную функцию `raise_for_status`, которая принимает HTTP-ответ и проверяет, является ли статус ответа успешным.
Если статус не успешный, функция пытается извлечь сообщение об ошибке из JSON-ответа.
Если это не удается, она использует текстовое содержимое ответа.
Затем вызывается исключение `ResponseStatusError` с соответствующим сообщением.

## Функции

### `raise_for_status`

```python
async def raise_for_status(response: Union[StreamResponse, ClientResponse], message: str = None):
    """ Проверяет статус HTTP-ответа и вызывает исключение `ResponseStatusError`, если произошла ошибка.

    Args:
        response (Union[StreamResponse, ClientResponse]): Объект HTTP-ответа, который нужно проверить. Может быть типа `StreamResponse` или `ClientResponse` из библиотеки `aiohttp`.
        message (str, optional): Дополнительное сообщение об ошибке. Используется, если не удается извлечь сообщение из тела ответа. По умолчанию `None`.

    Returns:
        None

    Raises:
        ResponseStatusError: Если статус ответа не является успешным (response.ok == False).

    **Как работает функция**:
    1. **Проверка статуса**: Проверяет, является ли статус ответа успешным (`response.ok`). Если да, функция завершает свою работу.
    2. **Определение типа контента**: Определяет тип контента ответа, проверяя заголовок `content-type`.
    3. **Обработка JSON**: Если контент является JSON, пытается извлечь сообщение об ошибке из JSON-данных (`data.get("error")` или `data.get("message")`).
    4. **Обработка текста**: Если контент не является JSON или не содержит сообщения об ошибке в формате JSON, извлекает текст из ответа.
    5. **Определение HTML**: Проверяет, является ли текст HTML-контентом.
    6. **Формирование сообщения**: Формирует сообщение об ошибке в зависимости от типа контента (JSON, HTML или текст).
    7. **Вызов исключения**: Вызывает исключение `ResponseStatusError` с сообщением об ошибке и статусом ответа.

     **Блок-схема работы функции**:

     Проверка статуса ответа (A)
     │
     └─── Нет ошибки? ─── Да: Завершить (B)
         │
         └───────────────── Нет ─────────────────┐
                                                 │
         Да (Ошибка)                              │
         │                                         │
         Определение типа контента (C)             │
         │                                         │
         └─── JSON? ─── Да: Извлечь сообщение из JSON (D)
             │           │
             │           └──────────────────────────────────┐
             │                                              │
             Нет                                            │
             │                                              │
             Извлечь текст из ответа (E)                    │
             │                                              │
             └─── HTML? ─── Да: Сообщение "HTML content" (F)
                 │           │
                 │           └──────────────────────────────────┐
                 │                                              │
                 Нет                                            │
                 │                                              │
                 Использовать текст ответа как сообщение (G)   │
                 │                                              │
                 └──────────────────────────────────────────────┘
             │
             Формирование сообщения об ошибке (H)
             │
             Вызов исключения ResponseStatusError (I)

    """
    if response.ok:
        return
    content_type = response.headers.get("content-type", "")
    if content_type.startswith("application/json"):
        try:
            data = await response.json()
            message = data.get("error", data.get("message", message))
            message = message.split(" <a ")[0]
        except Exception:
            pass
    if not message:
        text = await response.text()
        is_html = response.headers.get("content-type", "").startswith("text/html") or text.startswith("<!DOCTYPE")
        message = "HTML content" if is_html else text
    raise ResponseStatusError(f"Response {response.status}: {message}")