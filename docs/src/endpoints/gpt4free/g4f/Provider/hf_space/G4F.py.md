# Модуль `G4F`

## Обзор

Модуль `G4F` предоставляет интерфейс для работы с моделями генерации изображений, размещенными на Hugging Face Spaces, в частности, с моделями `DeepseekAI_JanusPro7b` и `BlackForestLabs_Flux1Dev`. Он позволяет генерировать изображения на основе текстовых запросов, используя различные модели и параметры.

## Подробнее

Модуль `G4F` является частью проекта `hypotez` и предназначен для интеграции с различными AI-моделями, предоставляемыми через Hugging Face Spaces. Он содержит классы и методы для взаимодействия с этими моделями, обработки запросов и получения результатов. Основное назначение модуля - упростить процесс генерации изображений на основе текстовых описаний, предоставляя удобный интерфейс для работы с различными моделями и параметрами. Модуль использует асинхронные запросы для эффективного взаимодействия с удаленными сервисами и предоставляет возможность настройки параметров генерации изображений, таких как размеры, seed и aspect ratio.

## Классы

### `FluxDev`

**Описание**: Класс `FluxDev` наследуется от `BlackForestLabs_Flux1Dev` и предназначен для работы с моделью `FLUX.1-dev`. Он устанавливает специфические значения для URL и пространства на Hugging Face.

   **Наследует**:
   - `BlackForestLabs_Flux1Dev`

   **Атрибуты**:
   - `url` (str): URL пространства Hugging Face для модели `FLUX.1-dev`.
   - `space` (str): Имя пространства Hugging Face для модели `FLUX.1-dev`.
   - `referer` (str): Referer для HTTP-запросов.

### `G4F`

**Описание**: Класс `G4F` наследуется от `DeepseekAI_JanusPro7b` и предоставляет интерфейс для работы с моделями генерации изображений G4F, размещенными на Hugging Face Spaces. Он устанавливает специфические значения для URL, пространства и других параметров, необходимых для взаимодействия с моделями.

   **Наследует**:
   - `DeepseekAI_JanusPro7b`

   **Атрибуты**:
   - `label` (str): Метка для идентификации класса.
   - `space` (str): Имя пространства Hugging Face.
   - `url` (str): URL основного пространства Hugging Face.
   - `api_url` (str): URL API для взаимодействия с моделью.
   - `url_flux` (str): URL для выполнения запросов к модели flux.
   - `referer` (str): Referer для HTTP-запросов.
   - `default_model` (str): Модель, используемая по умолчанию ("flux").
   - `model_aliases` (dict): Псевдонимы моделей.
   - `image_models` (list): Список моделей, поддерживающих генерацию изображений.
   - `models` (list): Полный список поддерживаемых моделей.

   **Методы**:
   - `create_async_generator`: Асинхронный генератор для создания изображений на основе текстового запроса.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    prompt: str = None,
    aspect_ratio: str = "1:1",
    width: int = None,
    height: int = None,
    seed: int = None,
    cookies: dict = None,
    api_key: str = None,
    zerogpu_uuid: str = "[object Object]",
    **kwargs
) -> AsyncResult:
    """
    Асинхронный генератор для создания изображений на основе текстового запроса.

    Args:
        cls (Type[G4F]): Класс, для которого вызывается метод.
        model (str): Имя используемой модели.
        messages (Messages): Список сообщений для формирования запроса.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
        aspect_ratio (str, optional): Соотношение сторон изображения. По умолчанию "1:1".
        width (int, optional): Ширина изображения в пикселях. По умолчанию `None`.
        height (int, optional): Высота изображения в пикселях. По умолчанию `None`.
        seed (int, optional): Seed для генерации случайных чисел. По умолчанию `None`.
        cookies (dict, optional): Cookies для HTTP-запросов. По умолчанию `None`.
        api_key (str, optional): API-ключ для доступа к сервису. По умолчанию `None`.
        zerogpu_uuid (str, optional): UUID для zerogpu. По умолчанию "[object Object]".
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий промежуточные результаты и финальное изображение.

    Raises:
        Exception: Если возникает ошибка при выполнении запроса.
    """
```

**Назначение**: Метод `create_async_generator` является асинхронным генератором, который создает изображения на основе текстового запроса, используя указанную модель и параметры. Он поддерживает различные модели, включая `flux` и `flux-dev`, а также модели, унаследованные от `DeepseekAI_JanusPro7b`.

**Как работает функция**:

1. **Обработка моделей `flux` и `flux-dev`**: Если указана модель `flux` или `flux-dev`, функция перенаправляет запрос к классу `FluxDev` для обработки.
2. **Обработка моделей `DeepseekAI_JanusPro7b`**: Если указана другая модель, функция вызывает метод `create_async_generator` родительского класса `DeepseekAI_JanusPro7b` для обработки запроса.
3. **Подготовка параметров**: Функция подготавливает параметры для запроса, такие как размеры изображения, seed и текстовый запрос.
4. **Получение API-ключа**: Если API-ключ не предоставлен, функция получает его, используя метод `get_zerogpu_token`.
5. **Выполнение запроса**: Функция выполняет асинхронный POST-запрос к API Hugging Face Space, используя `aiohttp.ClientSession`.
6. **Обработка ответа**: Функция обрабатывает ответ от API, извлекает URL изображения и возвращает объект `ImageResponse`.
7. **Асинхронное ожидание**: Функция использует `asyncio.create_task` для выполнения запроса в фоновом режиме и возвращает промежуточные результаты (Reasoning) до завершения задачи.

```
A: Проверка модели (flux, flux-dev, DeepseekAI_JanusPro7b)
|
B: Перенаправление запроса к FluxDev или DeepseekAI_JanusPro7b
|
C: Подготовка параметров (размеры, seed, запрос)
|
D: Получение API-ключа (если не предоставлен)
|
E: Выполнение POST-запроса к API Hugging Face Space
|
F: Обработка ответа и извлечение URL изображения
|
G: Асинхронное ожидание и возврат промежуточных результатов
```

**Примеры**:

```python
# Пример 1: Генерация изображения с использованием модели flux
async for chunk in G4F.create_async_generator(model="flux", messages=[{"role": "user", "content": "A cat"}], width=512, height=512):
    print(chunk)

# Пример 2: Генерация изображения с использованием модели DeepseekAI_JanusPro7b
async for chunk in G4F.create_async_generator(model="deepseek-image", messages=[{"role": "user", "content": "A dog"}], width=512, height=512):
    print(chunk)