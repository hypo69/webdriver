# Модуль `Qwen_Qwen_2_5`

## Обзор

Модуль `Qwen_Qwen_2_5` предоставляет асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.5 через Hugging Face Space. Он поддерживает потоковую передачу данных и системные сообщения.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения взаимодействия с определенной версией модели Qwen, размещенной на платформе Hugging Face Space. Он использует асинхронные запросы для генерации текста и обработки ответов в режиме реального времени.

## Классы

### `Qwen_Qwen_2_5`

**Описание**: Класс `Qwen_Qwen_2_5` реализует асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.5.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность асинхронного генератора.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `label` (str): Метка провайдера, `"Qwen Qwen-2.5"`.
- `url` (str): URL Hugging Face Space, `"https://qwen-qwen2-5.hf.space"`.
- `api_endpoint` (str): URL API для присоединения к очереди, `"https://qwen-qwen2-5.hf.space/queue/join"`.
- `working` (bool): Указывает, работает ли провайдер, `True`.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу, `True`.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения, `True`.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений, `False`.
- `default_model` (str): Модель по умолчанию, `"qwen-qwen2-5"`.
- `model_aliases` (dict): Псевдонимы моделей, `{"qwen-2.5": default_model}`.
- `models` (list): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от модели.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от модели Qwen Qwen-2.5.

    Args:
        model (str): Название модели.
        messages (Messages): Список сообщений для отправки модели.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий текстовые фрагменты ответа модели.

    Raises:
        aiohttp.ClientError: Если возникает ошибка при выполнении HTTP-запроса.
        json.JSONDecodeError: Если не удается декодировать JSON-ответ.

    Внутренние функции:
        generate_session_hash: Генерирует уникальный идентификатор сессии.
    """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.5 через API Hugging Face Space.

**Параметры**:
- `cls` (Qwen_Qwen_2_5): Ссылка на класс.
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки модели. Сообщения должны быть в формате, поддерживаемом API.
- `proxy` (str, optional): URL прокси-сервера для использования при отправке запросов. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает текстовые фрагменты ответа модели.

**Вызывает исключения**:
- `aiohttp.ClientError`: Если возникает ошибка при выполнении HTTP-запроса к API.
- `json.JSONDecodeError`: Если не удается декодировать JSON-ответ от API.

#### Внутренние функции:

##### `generate_session_hash`

```python
def generate_session_hash():
    """Generate a unique session hash."""
    return str(uuid.uuid4()).replace('-', '')[:10]
```

**Назначение**: Генерирует уникальный идентификатор сессии, который используется для взаимодействия с API.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `str`: Уникальный идентификатор сессии в виде строки.

**Как работает функция**:
1.  **Генерация UUID**: Генерирует UUID (Universally Unique Identifier) с помощью `uuid.uuid4()`. UUID - это 128-битный идентификатор, который с высокой вероятностью будет уникальным.
2.  **Удаление дефисов**: Удаляет все дефисы из сгенерированного UUID с помощью `replace('-', '')`. Это делается для соответствия требованиям к формату идентификатора сессии, который ожидает API.
3.  **Укорачивание строки**: Оставляет только первые 10 символов полученной строки с помощью `[:10]`. Это дополнительное условие для соответствия требованиям к длине идентификатора сессии.
4.  **Возврат результата**: Возвращает полученную строку, которая представляет собой уникальный идентификатор сессии.

```
Генерация UUID --> Удаление дефисов --> Укорачивание строки --> Результат
```

**Как работает функция `create_async_generator`**:

1.  **Генерация уникального идентификатора сессии**: Вызывает внутреннюю функцию `generate_session_hash` для получения уникального идентификатора сессии.
2.  **Подготовка заголовков**: Формирует заголовки HTTP-запроса, включая User-Agent, Accept, Referer и другие необходимые параметры.
3.  **Подготовка промпта**: Извлекает системные сообщения из списка сообщений и объединяет их в один системный промпт. Если системных сообщений нет, используется промпт по умолчанию.
4.  **Формирование полезной нагрузки (payload)**: Создает словарь `payload_join` с данными, которые будут отправлены в теле POST-запроса к API. Этот словарь включает промпт, системный промпт и идентификатор сессии.
5.  **Отправка запроса на присоединение к очереди**: Отправляет POST-запрос к API (`cls.api_endpoint`) с заголовками и полезной нагрузкой. Получает `event_id` из ответа.
6.  **Подготовка к запросу потока данных**: Формирует URL и заголовки для запроса потока данных.
7.  **Отправка запроса потока данных и обработка ответа**: Отправляет GET-запрос к API (`url_data`) для получения потока данных. Читает ответ построчно, декодирует каждую строку и пытается извлечь данные JSON.
8.  **Извлечение и обработка данных**: Анализирует JSON-данные, чтобы найти фрагменты текста, сгенерированные моделью. Если находит фрагмент, проверяет его на дубликаты и соответствие формату, а затем выдает его через генератор.
9.  **Обработка завершения**: Проверяет, не завершен ли процесс генерации. Если процесс завершен, извлекает итоговый текст ответа, очищает его от лишних символов и выдает оставшуюся часть ответа через генератор.
10. **Обработка ошибок**: Если не удается декодировать JSON-ответ, логирует ошибку с использованием модуля `src.logger`.

```
Генерация session_hash --> Подготовка заголовков и промпта --> Формирование payload -->
Отправка запроса на присоединение к очереди --> Получение event_id --> Подготовка к запросу потока данных -->
Отправка запроса потока данных и обработка ответа --> Извлечение и обработка данных --> Обработка завершения --> Выдача фрагментов текста
```

**Примеры**:

Пример 1: Базовый вызов с использованием минимального набора параметров.

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.hf_space.Qwen_Qwen_2_5 import Qwen_Qwen_2_5

async def main():
    messages = [{"role": "user", "content": "Translate to French: Hello, how are you?"}]
    async for message in Qwen_Qwen_2_5.create_async_generator(model="qwen-2.5", messages=messages):
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

Пример 2: Использование системного сообщения для установки контекста модели.

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.hf_space.Qwen_Qwen_2_5 import Qwen_Qwen_2_5

async def main():
    messages = [
        {"role": "system", "content": "You are a helpful translation assistant."},
        {"role": "user", "content": "Translate to French: Hello, how are you?"}
    ]
    async for message in Qwen_Qwen_2_5.create_async_generator(model="qwen-2.5", messages=messages):
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())
```