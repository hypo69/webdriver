# Модуль DeepInfra

## Обзор

Модуль `DeepInfra` предоставляет класс для взаимодействия с сервисом DeepInfra, который предоставляет API для работы с различными моделями машинного обучения, включая модели для генерации текста и изображений.
Этот модуль предназначен для интеграции с проектом `hypotez` и обеспечивает асинхронное взаимодействие с API DeepInfra.

## Подробнее

Модуль содержит класс `DeepInfra`, который наследует `OpenaiTemplate` и реализует методы для получения списка доступных моделей, генерации текста и создания изображений.
Он использует асинхронные запросы для эффективного взаимодействия с API DeepInfra.
Для работы с API требуется аутентификация.

## Классы

### `DeepInfra`

**Описание**: Класс для взаимодействия с API DeepInfra.

**Наследует**: `OpenaiTemplate`

**Атрибуты**:
- `url` (str): URL главной страницы DeepInfra.
- `login_url` (str): URL страницы для получения API ключей.
- `api_base` (str): Базовый URL для API DeepInfra.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `models` (List[str]): Список доступных текстовых моделей.
- `image_models` (List[str]): Список доступных моделей для генерации изображений.

**Методы**:

- `get_models(**kwargs)`: Возвращает список доступных моделей.
- `get_image_models(**kwargs)`: Возвращает список доступных моделей для генерации изображений.
- `create_async_generator(model: str, messages: Messages, stream: bool, prompt: str = None, temperature: float = 0.7, max_tokens: int = 1028, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения ответов от API DeepInfra.
- `create_async_image(prompt: str, model: str, api_key: str = None, api_base: str = "https://api.deepinfra.com/v1/inference", proxy: str = None, timeout: int = 180, extra_data: dict = {}, **kwargs) -> ImageResponse`: Создает изображение, используя API DeepInfra.

## Функции

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs):
        """
        Получает список доступных моделей из API DeepInfra.

        Args:
            **kwargs: Дополнительные аргументы.

        Returns:
            List[str]: Список доступных моделей.
        """
        ...
```

**Назначение**: Получает список доступных моделей из API DeepInfra и сохраняет их в атрибутах класса `models` и `image_models`.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `List[str]`: Список доступных моделей.

**Как работает функция**:

1. Проверяет, были ли уже загружены модели. Если да, то возвращает существующий список.
2. Если модели еще не загружены, то отправляет GET-запрос к API DeepInfra для получения списка моделей.
3. Разбирает JSON-ответ и разделяет модели на текстовые и графические, сохраняя их в `cls.models` и `cls.image_models` соответственно.
4. Объединяет списки текстовых и графических моделей в общий список `cls.models`.
5. Возвращает обновленный список моделей.

**ASCII flowchart**:

```
Проверка загруженных моделей
    │
    └─> Нет: Запрос к API DeepInfra
         │
         └─> Разбор JSON-ответа
              │
              ├─> Разделение на текстовые и графические модели
              │
              └─> Объединение списков
    │
    └─> Да: Возврат существующих моделей
```

### `get_image_models`

```python
    @classmethod
    def get_image_models(cls, **kwargs):
        """
        Получает список доступных моделей для генерации изображений.

        Args:
            **kwargs: Дополнительные аргументы.

        Returns:
            List[str]: Список доступных моделей для генерации изображений.
        """
        ...
```

**Назначение**: Возвращает список доступных моделей для генерации изображений.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `List[str]`: Список доступных моделей для генерации изображений.

**Как работает функция**:

1. Проверяет, были ли уже загружены графические модели. Если нет, то вызывает `get_models` для загрузки всех моделей.
2. Возвращает список графических моделей `cls.image_models`.

**ASCII flowchart**:

```
Проверка загруженных графических моделей
    │
    └─> Нет: Вызов get_models()
         │
         └─> Возврат списка графических моделей
    │
    └─> Да: Возврат списка графических моделей
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        prompt: str = None,
        temperature: float = 0.7,
        max_tokens: int = 1028,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от API DeepInfra.

        Args:
            model (str): Название модели.
            messages (Messages): Список сообщений для отправки.
            stream (bool): Флаг, указывающий на необходимость потоковой передачи.
            prompt (str, optional): Дополнительный промпт. Defaults to None.
            temperature (float, optional): Температура для генерации. Defaults to 0.7.
            max_tokens (int, optional): Максимальное количество токенов в ответе. Defaults to 1028.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий части ответа.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для получения ответов от API DeepInfra.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `model` (str): Название модели.
- `messages` (Messages): Список сообщений для отправки.
- `stream` (bool): Флаг, указывающий на необходимость потоковой передачи.
- `prompt` (str, optional): Дополнительный промпт. По умолчанию `None`.
- `temperature` (float, optional): Температура для генерации. По умолчанию `0.7`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `1028`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий части ответа.

**Как работает функция**:

1. Проверяет, является ли выбранная модель моделью для генерации изображений.
2. Если модель графическая, то вызывает `create_async_image` для создания изображения и возвращает результат.
3. Если модель текстовая, то устанавливает заголовки для запроса.
4. Вызывает метод `create_async_generator` из родительского класса `OpenaiTemplate` для генерации текста.
5. Передает заголовки и параметры в родительский метод.
6. Возвращает асинхронный генератор, который возвращает части ответа от API DeepInfra.

**ASCII flowchart**:

```
Проверка типа модели
    │
    └─> Графическая: Вызов create_async_image()
    │
    └─> Текстовая: Установка заголовков
         │
         └─> Вызов create_async_generator() из OpenaiTemplate
              │
              └─> Возврат асинхронного генератора
```

### `create_async_image`

```python
    @classmethod
    async def create_async_image(
        cls,
        prompt: str,
        model: str,
        api_key: str = None,
        api_base: str = "https://api.deepinfra.com/v1/inference",
        proxy: str = None,
        timeout: int = 180,
        extra_data: dict = {},
        **kwargs
    ) -> ImageResponse:
        """
        Создает изображение, используя API DeepInfra.

        Args:
            prompt (str): Промпт для генерации изображения.
            model (str): Название модели.
            api_key (str, optional): API ключ. Defaults to None.
            api_base (str, optional): Базовый URL API. Defaults to "https://api.deepinfra.com/v1/inference".
            proxy (str, optional): Прокси-сервер. Defaults to None.
            timeout (int, optional): Время ожидания запроса. Defaults to 180.
            extra_data (dict, optional): Дополнительные данные для отправки. Defaults to {}.
            **kwargs: Дополнительные аргументы.

        Returns:
            ImageResponse: Объект, содержащий сгенерированное изображение.
        """
        ...
```

**Назначение**: Создает изображение, используя API DeepInfra.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `prompt` (str): Промпт для генерации изображения.
- `model` (str): Название модели.
- `api_key` (str, optional): API ключ. По умолчанию `None`.
- `api_base` (str, optional): Базовый URL API. По умолчанию `"https://api.deepinfra.com/v1/inference"`.
- `proxy` (str, optional): Прокси-сервер. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания запроса. По умолчанию `180`.
- `extra_data` (dict, optional): Дополнительные данные для отправки. По умолчанию `{}`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `ImageResponse`: Объект, содержащий сгенерированное изображение.

**Как работает функция**:

1. Устанавливает заголовки для запроса, включая API ключ, если он предоставлен.
2. Создает асинхронную сессию с использованием `StreamSession`.
3. Получает модель, используя `cls.get_model(model)`.
4. Формирует данные для отправки в запросе, включая промпт и дополнительные данные.
5. Отправляет POST-запрос к API DeepInfra с использованием сформированных данных и заголовков.
6. Обрабатывает ответ от API, извлекая URL изображения.
7. Возвращает объект `ImageResponse`, содержащий URL изображения и промпт.

**ASCII flowchart**:

```
Установка заголовков
    │
    └─> Создание асинхронной сессии
         │
         └─> Получение модели
              │
              └─> Формирование данных для запроса
                   │
                   └─> Отправка POST-запроса к API
                        │
                        └─> Обработка ответа и извлечение URL изображения
                             │
                             └─> Возврат объекта ImageResponse
```