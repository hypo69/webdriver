# Модуль для работы с Reka API (требуется аутентификация)
=============================================================

Модуль содержит класс :class:`Reka`, который используется для взаимодействия с Reka AI API.
Этот класс предоставляет методы для создания завершений чата и загрузки изображений.
Для работы требуется аутентификация через cookies или bearer token.

Пример использования
----------------------

```python
reka = Reka()
messages = [{"role": "user", "content": "Hello"}]
for chunk in reka.create_completion(model="reka-core", messages=messages, stream=True):
    print(chunk, end="")
```

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [`Reka`](#reka)
- [Функции](#функции)
    - [`create_completion`](#create_completion)
    - [`upload_image`](#upload_image)
    - [`get_access_token`](#get_access_token)

## Обзор

Модуль `Reka` предоставляет интерфейс для взаимодействия с Reka AI API.
Он включает поддержку создания чат-завершений, загрузки изображений и аутентификации.
Модуль предназначен для использования в проектах, требующих интеграции с Reka AI.

## Подробнее

Этот модуль разработан для упрощения взаимодействия с Reka AI API. Он предоставляет удобные методы для выполнения различных задач, таких как создание завершений чата и загрузка изображений.
Класс `Reka` абстрагирует детали реализации API, предоставляя простой и понятный интерфейс для разработчиков.
Для работы с API требуется аутентификация, которая может быть выполнена через cookies или bearer token.

## Классы

### `Reka`

**Описание**: Класс для взаимодействия с Reka AI API.

   **Принцип работы**:
   Класс `Reka` наследует `AbstractProvider` и реализует методы для создания завершений чата, загрузки изображений и получения токена доступа. Он использует `requests` для отправки HTTP-запросов к Reka AI API.
   Для аутентификации используются cookies или bearer token.

**Наследует**:

- `AbstractProvider`: Абстрактный базовый класс для провайдеров.

**Атрибуты**:

- `domain` (str): Доменное имя Reka AI API (`space.reka.ai`).
- `url` (str): Полный URL Reka AI API (`https://space.reka.ai`).
- `working` (bool): Указывает, работает ли провайдер (всегда `True`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (всегда `True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу (всегда `True`).
- `default_vision_model` (str): Модель зрения по умолчанию (`reka`).
- `cookies` (dict): Словарь cookies для аутентификации.

**Методы**:

- `create_completion`: Создает завершение чата.
- `upload_image`: Загружает изображение.
- `get_access_token`: Получает токен доступа.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    api_key: str = None,
    image: ImageType = None,
    **kwargs
) -> CreateResult:
    """ Создает завершение чата с использованием Reka AI API.
    Args:
        model (str): Имя модели для использования.
        messages (Messages): Список сообщений для отправки в чат.
        stream (bool): Указывает, использовать ли потоковую передачу.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        api_key (str, optional): API ключ для аутентификации. По умолчанию `None`.
        image (ImageType, optional): Изображение для отправки с последним сообщением. По умолчанию `None`.

    Returns:
        CreateResult: Генератор токенов завершения чата.

    Raises:
        ValueError: Если не найдены cookies или appSession, или если не удалось получить токен доступа.

    """
```

**Назначение**: Создает завершение чата с использованием Reka AI API.

**Параметры**:

- `model` (str): Имя модели для использования.
- `messages` (Messages): Список сообщений для отправки в чат.
- `stream` (bool): Указывает, использовать ли потоковую передачу.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `api_key` (str, optional): API ключ для аутентификации. По умолчанию `None`.
- `image` (ImageType, optional): Изображение для отправки с последним сообщением. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `CreateResult`: Генератор токенов завершения чата.

**Вызывает исключения**:

- `ValueError`: Если не найдены cookies или `appSession`, или если не удалось получить токен доступа.

**Как работает функция**:

1. **Инициализация**:
   - Функция принимает параметры, необходимые для создания запроса к Reka AI API.
   - Проверяется наличие API-ключа. Если он не предоставлен, функция пытается получить его из cookies.
   - Если cookies отсутствуют или не содержат `appSession`, вызывается исключение `ValueError`.

2. **Формирование истории разговора**:
   -  Создается список `conversation`, содержащий сообщения для отправки в API.
   -  Сообщения преобразуются в формат, ожидаемый Reka AI API.

3. **Обработка изображений**:
   - Если передано изображение, оно загружается с помощью метода `upload_image`, и URL изображения добавляется к последнему сообщению в истории разговора.

4. **Формирование заголовков и данных запроса**:
   - Создаются заголовки HTTP-запроса, включая токен авторизации.
   - Формируются данные запроса в формате JSON, содержащие историю разговора, настройки потоковой передачи и другие параметры.

5. **Отправка запроса и обработка ответа**:
   - Отправляется POST-запрос к Reka AI API с использованием библиотеки `requests`.
   - Ответ обрабатывается построчно, извлекаются данные токенов и генерируются результаты.

6. **Генерация токенов**:
   -  Из каждой строки ответа извлекаются данные токена.
   -  Генерируется значение токена, которое передается вызывающей стороне с помощью `yield`.

```
   Начало
     ↓
   Проверка API-ключа
     ↓
   Формирование истории разговора
     ↓
   Обработка изображений
     ↓
   Формирование заголовков и данных запроса
     ↓
   Отправка запроса к Reka AI API
     ↓
   Обработка ответа и генерация токенов
     ↓
   Конец
```

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello"}]
for chunk in Reka.create_completion(model="reka-core", messages=messages, stream=True, api_key="your_api_key"):
    print(chunk, end="")

messages = [{"role": "user", "content": "Как дела?"}]
for chunk in Reka.create_completion(model="reka-core", messages=messages, stream=True, proxy="http://your_proxy:8080"):
    print(chunk, end="")
```

### `upload_image`

```python
def upload_image(cls, access_token: str, image: ImageType) -> str:
    """ Загружает изображение в Reka AI API.
    Args:
        access_token (str): Токен доступа для аутентификации.
        image (ImageType): Изображение для загрузки.

    Returns:
        str: URL загруженного изображения.

    """
```

**Назначение**: Загружает изображение в Reka AI API.

**Параметры**:

- `access_token` (str): Токен доступа для аутентификации.
- `image` (ImageType): Изображение для загрузки.

**Возвращает**:

- `str`: URL загруженного изображения.

**Как работает функция**:

1. **Инициализация**:
   - Функция принимает токен доступа и изображение для загрузки.
   - Генерируется случайный токен `boundary_token` для разделения частей multipart/form-data.

2. **Формирование заголовков запроса**:
   -  Создаются заголовки HTTP-запроса, включая токен авторизации и Content-Type для multipart/form-data.

3. **Подготовка данных изображения**:
   - Изображение преобразуется в байты с помощью функции `to_bytes`.
   - Формируется тело запроса в формате multipart/form-data, включающее данные изображения.

4. **Отправка запроса**:
   - Отправляется POST-запрос к Reka AI API для загрузки изображения.

5. **Обработка ответа**:
   -  Извлекается URL загруженного изображения из JSON-ответа.

```
   Начало
     ↓
   Инициализация
     ↓
   Формирование заголовков запроса
     ↓
   Подготовка данных изображения
     ↓
   Отправка запроса
     ↓
   Обработка ответа
     ↓
   Конец
```

**Примеры**:

```python
image_url = Reka.upload_image(access_token="your_access_token", image=b"your_image_data")
print(image_url)
```

### `get_access_token`

```python
def get_access_token(cls) -> str:
    """ Получает токен доступа из Reka AI API.
    Returns:
        str: Токен доступа.

    Raises:
        ValueError: Если не удалось получить токен доступа.
    """
```

**Назначение**: Получает токен доступа из Reka AI API.

**Возвращает**:

- `str`: Токен доступа.

**Вызывает исключения**:

- `ValueError`: Если не удалось получить токен доступа.

**Как работает функция**:

1. **Формирование заголовков запроса**:
   -  Создаются заголовки HTTP-запроса, включая Referer.

2. **Отправка запроса**:
   - Отправляется GET-запрос к Reka AI API для получения токена доступа.

3. **Обработка ответа**:
   -  Извлекается токен доступа из JSON-ответа.
   -  В случае ошибки вызывается исключение `ValueError`.

```
   Начало
     ↓
   Формирование заголовков запроса
     ↓
   Отправка запроса
     ↓
   Обработка ответа
     ↓
   Конец
```

**Примеры**:

```python
access_token = Reka.get_access_token()
print(access_token)