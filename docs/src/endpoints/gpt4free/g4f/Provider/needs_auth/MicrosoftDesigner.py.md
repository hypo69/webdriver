# Модуль MicrosoftDesigner

## Обзор

Модуль `MicrosoftDesigner` предоставляет асинхронный интерфейс для взаимодействия с Microsoft Designer API с целью генерации изображений на основе текстовых запросов. Он поддерживает различные модели изображений и предоставляет механизмы для аутентификации и обработки запросов.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими функциональность генерации изображений. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет методы для получения токенов доступа и создания изображений.

## Классы

### `MicrosoftDesigner`

**Описание**: Класс `MicrosoftDesigner` является основным классом, предоставляющим функциональность для генерации изображений с использованием Microsoft Designer API.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `label` (str): Метка провайдера ("Microsoft Designer").
- `url` (str): URL Microsoft Designer ("https://designer.microsoft.com").
- `working` (bool): Указывает, что провайдер в рабочем состоянии (`True`).
- `use_nodriver` (bool): Указывает на использование без драйвера (`True`).
- `needs_auth` (bool): Указывает на необходимость аутентификации (`True`).
- `default_image_model` (str): Модель изображения по умолчанию ("dall-e-3").
- `image_models` (list[str]): Список поддерживаемых моделей изображений (включая `default_image_model`, "1024x1024", "1024x1792", "1792x1024").
- `models` (list[str]): Псевдоним для `image_models`.

**Методы**:

- `create_async_generator(model: str, messages: Messages, prompt: str = None, proxy: str = None, **kwargs) -> AsyncResult`
    - **Описание**: Создает асинхронный генератор для генерации изображений.
- `generate(prompt: str, image_size: str, proxy: str = None) -> ImageResponse`
    - **Описание**: Генерирует изображение на основе заданного запроса и размера изображения.

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    prompt: str = None,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для генерации изображений.

    Args:
        model (str): Модель изображения для использования.
        messages (Messages): Список сообщений для формирования запроса.
        prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий объекты `ImageResponse`.

    Как работает функция:
    1. Определяет размер изображения на основе выбранной модели.
    2. Вызывает метод `generate` для создания изображения.
    3. Возвращает асинхронный генератор с результатом.

    ASCII flowchart:
    Model Selection --> Generate Image --> Return Async Generator
    """
```

#### `generate`

```python
@classmethod
async def generate(cls, prompt: str, image_size: str, proxy: str = None) -> ImageResponse:
    """
    Генерирует изображение на основе заданного запроса и размера изображения.

    Args:
        prompt (str): Текстовый запрос для генерации изображения.
        image_size (str): Размер изображения ("1024x1024", "1024x1792", "1792x1024").
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.

    Returns:
        ImageResponse: Объект `ImageResponse` с информацией о сгенерированных изображениях.

    Raises:
        NoValidHarFileError: Если не найден действительный HAR-файл.

    Как работает функция:
    1. Пытается прочитать токен доступа и user-agent из HAR-файла.
    2. Если HAR-файл не найден или не содержит токен доступа, пытается получить их, используя `get_access_token_and_user_agent`.
    3. Вызывает функцию `create_images` для создания изображений.
    4. Возвращает объект `ImageResponse` с результатами.

    ASCII flowchart:
    Read HAR File --> Get Access Token/User Agent --> Create Images --> Return ImageResponse
    """
```

## Функции

### `create_images`

```python
async def create_images(prompt: str, access_token: str, user_agent: str, image_size: str, proxy: str = None, seed: int = None)
```

**Назначение**: Асинхронно создает изображения, используя Microsoft Designer API.

**Параметры**:
- `prompt` (str): Текстовое описание желаемого изображения.
- `access_token` (str): Токен доступа для аутентификации в API.
- `user_agent` (str): User-Agent для HTTP-запросов.
- `image_size` (str): Размер изображения, например "1024x1024".
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `seed` (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.

**Возвращает**:
- `list[str]`: Список URL сгенерированных изображений.

**Как работает функция**:

1. **Подготовка заголовков и данных формы**: Формирует заголовки HTTP-запроса, включая токен доступа, идентификаторы клиента и другие метаданные. Также подготавливает данные формы, включая текстовое описание изображения, размер, зерно и другие параметры.
2. **Отправка запроса к API**: Отправляет POST-запрос к Microsoft Designer API с использованием `aiohttp.ClientSession`. В случае успеха получает ответ в формате JSON.
3. **Обработка ответа и запуск цикла опроса**: Извлекает метаданные для опроса (polling_meta_data) из первоначального ответа. Затем запускает бесконечный цикл, в котором периодически отправляет запросы к API для получения сгенерированных изображений.
4. **Ожидание и повторные запросы**: Внутри цикла ожидает интервал времени, указанный в `polling_meta_data`, и отправляет повторный POST-запрос.
5. **Извлечение URL изображений**: Как только в ответе появляются URL сгенерированных изображений, извлекает их и возвращает в виде списка.

**ASCII flowchart**:

```
Начало --> Подготовка заголовков и данных формы
        ↓
        Отправка POST-запроса к API
        ↓
        Обработка ответа (JSON)
        ↓
        Извлечение метаданных для опроса (polling_meta_data)
        ↓
        Начало цикла опроса --> Ожидание (poll_interval)
                             ↓
                             Отправка повторного POST-запроса
                             ↓
                             Обработка ответа
                             ↓
                             Извлечение URL изображений?
                             ↓ Да
                             Конец (возврат списка URL)
```

### `readHAR`

```python
def readHAR(url: str) -> tuple[str, str]
```

**Назначение**: Извлекает токен доступа и User-Agent из HAR-файлов.

**Параметры**:
- `url` (str): URL, для которого требуется извлечь данные.

**Возвращает**:
- `tuple[str, str]`: Кортеж, содержащий токен доступа и User-Agent.

**Вызывает исключения**:
- `NoValidHarFileError`: Если не найден действительный HAR-файл с требуемыми данными.

**Как работает функция**:

1. **Обход HAR-файлов**: Получает список путей к HAR-файлам с помощью `get_har_files()` и последовательно открывает каждый файл.
2. **Чтение и разбор JSON**: Пытается прочитать содержимое файла и разобрать его как JSON. Если файл не является корректным JSON, переходит к следующему файлу.
3. **Поиск нужной записи**: Перебирает записи в HAR-файле (`harFile['log']['entries']`) и ищет запись, URL которой начинается с заданного `url`.
4. **Извлечение заголовков**: Если найдена нужная запись, извлекает заголовки запроса с помощью `get_headers(v)`.
5. **Поиск токена и User-Agent**: Ищет в заголовках поля `authorization` и `user-agent`. Если они найдены, извлекает значения токена доступа и User-Agent соответственно.
6. **Возврат результата**: Если токен доступа найден, возвращает его вместе с User-Agent. Если токен доступа не найден ни в одном из HAR-файлов, вызывает исключение `NoValidHarFileError`.

**ASCII flowchart**:

```
Начало --> Получение списка HAR-файлов
        ↓
        Начало цикла по HAR-файлам --> Открытие файла
                                    ↓
                                    Чтение и разбор JSON
                                    ↓
                                    Начало цикла по записям в HAR-файле --> Проверка URL
                                                                        ↓ Да
                                                                        Извлечение заголовков
                                                                        ↓
                                                                        Поиск токена и User-Agent
                                                                        ↓ Найден токен
                                                                        Конец (возврат токена и User-Agent)
                                    ↓ Нет токена
        ↓ Все HAR-файлы просмотрены
        Вызов исключения NoValidHarFileError
```

### `get_access_token_and_user_agent`

```python
async def get_access_token_and_user_agent(url: str, proxy: str = None)
```

**Назначение**: Асинхронно получает токен доступа и User-Agent, используя браузер без драйвера.

**Параметры**:
- `url` (str): URL для получения токена доступа и User-Agent.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.

**Возвращает**:
- `tuple[str, str]`: Кортеж, содержащий токен доступа и User-Agent.

**Как работает функция**:

1. **Запуск браузера без драйвера**: Запускает браузер без драйвера с помощью `get_nodriver()`, передавая URL прокси-сервера и каталог пользовательских данных.
2. **Открытие страницы**: Открывает заданную страницу (`url`) в браузере.
3. **Извлечение User-Agent**: Извлекает User-Agent, выполнив JavaScript-код `navigator.userAgent` на странице.
4. **Извлечение токена доступа**: Выполняет JavaScript-код, который перебирает элементы `localStorage` и ищет элемент с `credentialType == "AccessToken"` и не истекшим сроком действия. Если такой элемент найден, извлекает токен доступа (`item.secret`).
5. **Ожидание токена доступа**: Если токен доступа не найден сразу, функция ожидает 1 секунду и повторяет попытку.
6. **Закрытие страницы и остановка браузера**: После получения токена доступа закрывает страницу и останавливает браузер.

**ASCII flowchart**:

```
Начало --> Запуск браузера без драйвера
        ↓
        Открытие страницы (URL)
        ↓
        Извлечение User-Agent
        ↓
        Начало цикла поиска токена --> Поиск токена в localStorage
                                     ↓ Найден токен
                                     Конец цикла
                                     ↓ Токен не найден
                                     Ожидание 1 секунда
        ↓ Токен найден
        Закрытие страницы
        ↓
        Остановка браузера
        ↓
        Конец (возврат токена и User-Agent)
```

## Примеры

Пример использования класса `MicrosoftDesigner`:

```python
from src.endpoints.gpt4free.g4f.Provider.needs_auth import MicrosoftDesigner
import asyncio

async def main():
    model = "dall-e-3"
    messages = [{"role": "user", "content": "A beautiful landscape"}]
    prompt = "Generate a stunning landscape painting"
    proxy = None

    async for image_response in MicrosoftDesigner.create_async_generator(model, messages, prompt, proxy):
        if image_response:
            print(f"Images: {image_response.images}")

if __name__ == "__main__":
    asyncio.run(main())