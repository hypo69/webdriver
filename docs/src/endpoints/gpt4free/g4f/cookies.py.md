# Модуль для работы с Cookies
===========================

Модуль предназначен для загрузки, сохранения и управления cookies для различных доменов, используемых в проекте.

## Обзор

Модуль `cookies.py` предоставляет функциональность для работы с cookies, включая их загрузку из различных браузеров и файлов, а также управление каталогом, где хранятся файлы cookies. Он использует библиотеку `browser_cookie3` для извлечения cookies из установленных браузеров и поддерживает чтение cookies из файлов в формате HAR (HTTP Archive) и JSON.

## Подробнее

Этот модуль важен для автоматизации задач, требующих аутентификации или сохранения состояния сессии, например, при взаимодействии с веб-сайтами через API или при парсинге веб-страниц. Он позволяет загружать cookies из браузеров пользователя, что может быть полезно для обхода ограничений, связанных с авторизацией.

## Классы

### `CookiesConfig`

**Описание**: Класс, содержащий конфигурацию для хранения cookies и пути к директории с cookies.

**Принцип работы**:
Класс `CookiesConfig` предназначен для хранения глобальной конфигурации, связанной с cookies. Он содержит словарь `cookies`, где хранятся cookies для различных доменов, а также путь к директории `cookies_dir`, где хранятся файлы cookies.

**Аттрибуты**:
- `cookies` (Dict[str, Cookies]): Словарь, где ключи - домены, а значения - cookies для этих доменов.
- `cookies_dir` (str): Путь к директории с файлами cookies. По умолчанию `"./har_and_cookies"`.

## Функции

### `g4f`

```python
def g4f(domain_name: str) -> list:
    """
    Load cookies from the 'g4f' browser (if exists).

    Args:
        domain_name (str): The domain for which to load cookies.

    Returns:
        list: List of cookies.
    """
    ...
```

**Назначение**: Загружает cookies из браузера `g4f` (если он существует) для указанного домена.

**Параметры**:
- `domain_name` (str): Домен, для которого необходимо загрузить cookies.

**Возвращает**:
- `list`: Список cookies.

**Как работает функция**:
1. Проверяет, установлена ли библиотека `platformdirs`. Если нет, возвращает пустой список.
2. Определяет директорию конфигурации пользователя для `g4f`.
3. Формирует путь к файлу cookies в директории `Default` внутри директории конфигурации.
4. Если файл cookies не существует, возвращает пустой список.
5. Иначе пытается загрузить cookies из файла с использованием функции `chrome` из `browser_cookie3` и возвращает их.

**Примеры**:
```python
cookies = g4f(".google.com")
print(cookies)  # Вывод: список cookies для домена .google.com, если они найдены
```

### `get_cookies`

```python
def get_cookies(domain_name: str, raise_requirements_error: bool = True, single_browser: bool = False, cache_result: bool = True) -> Dict[str, str]:
    """
    Load cookies for a given domain from all supported browsers and cache the results.

    Args:
        domain_name (str): The domain for which to load cookies.

    Returns:
        Dict[str, str]: A dictionary of cookie names and values.
    """
    ...
```

**Назначение**: Загружает cookies для указанного домена из всех поддерживаемых браузеров и кэширует результаты.

**Параметры**:
- `domain_name` (str): Домен, для которого необходимо загрузить cookies.
- `raise_requirements_error` (bool, optional): Если `True`, вызывает исключение `MissingRequirementsError`, если библиотека `browser_cookie3` не установлена. По умолчанию `True`.
- `single_browser` (bool, optional): Если `True`, загружает cookies только из первого найденного браузера. По умолчанию `False`.
- `cache_result` (bool, optional): Если `True`, кэширует результаты загрузки cookies. По умолчанию `True`.

**Возвращает**:
- `Dict[str, str]`: Словарь, где ключи - имена cookies, а значения - их значения.

**Как работает функция**:
1. Проверяет, есть ли cookies для указанного домена в кэше `CookiesConfig.cookies`. Если есть и `cache_result` равен `True`, возвращает cookies из кэша.
2. Если cookies в кэше нет или `cache_result` равен `False`, вызывает функцию `load_cookies_from_browsers` для загрузки cookies из браузеров.
3. Если `cache_result` равен `True`, сохраняет загруженные cookies в кэше `CookiesConfig.cookies`.
4. Возвращает загруженные cookies.

**Примеры**:
```python
cookies = get_cookies(".google.com")
print(cookies)  # Вывод: словарь cookie для домена .google.com

cookies = get_cookies(".google.com", cache_result=False) # Загрузка без кэширования
```

### `set_cookies`

```python
def set_cookies(domain_name: str, cookies: Cookies = None) -> None:
    """
    """
    ...
```

**Назначение**: Устанавливает cookies для указанного домена в кэше.

**Параметры**:
- `domain_name` (str): Домен, для которого необходимо установить cookies.
- `cookies` (Cookies, optional): Словарь cookies, который необходимо установить. Если `None`, удаляет cookies для указанного домена из кэша. По умолчанию `None`.

**Возвращает**:
- `None`

**Как работает функция**:
1. Если передан словарь `cookies`, сохраняет его в кэше `CookiesConfig.cookies` для указанного домена.
2. Если `cookies` равен `None`, удаляет cookies для указанного домена из кэша, если они там есть.

**Примеры**:
```python
set_cookies(".google.com", {"cookie1": "value1", "cookie2": "value2"})  # Установка cookies для домена .google.com
set_cookies(".google.com")  # Удаление cookies для домена .google.com из кэша
```

### `load_cookies_from_browsers`

```python
def load_cookies_from_browsers(domain_name: str, raise_requirements_error: bool = True, single_browser: bool = False) -> Cookies:
    """
    Helper function to load cookies from various browsers.

    Args:
        domain_name (str): The domain for which to load cookies.

    Returns:
        Dict[str, str]: A dictionary of cookie names and values.
    """
    ...
```

**Назначение**: Загружает cookies для указанного домена из различных браузеров.

**Параметры**:
- `domain_name` (str): Домен, для которого необходимо загрузить cookies.
- `raise_requirements_error` (bool, optional): Если `True`, вызывает исключение `MissingRequirementsError`, если библиотека `browser_cookie3` не установлена. По умолчанию `True`.
- `single_browser` (bool, optional): Если `True`, загружает cookies только из первого найденного браузера. По умолчанию `False`.

**Возвращает**:
- `Dict[str, str]`: Словарь, где ключи - имена cookies, а значения - их значения.

**Как работает функция**:
1. Проверяет, установлена ли библиотека `browser_cookie3`. Если нет и `raise_requirements_error` равен `True`, вызывает исключение `MissingRequirementsError`. Если библиотека не установлена и `raise_requirements_error` равен `False`, возвращает пустой словарь.
2. Создает пустой словарь `cookies` для хранения загруженных cookies.
3. Перебирает список браузеров `browsers`.
4. Для каждого браузера пытается загрузить cookies с использованием соответствующей функции.
5. Если загрузка прошла успешно, добавляет cookies в словарь `cookies`, проверяя, не истек ли срок их действия.
6. Если `single_browser` равен `True`, останавливает перебор браузеров после загрузки cookies из первого браузера.
7. Если при загрузке cookies произошла ошибка `BrowserCookieError`, игнорирует ее.
8. При возникновении других исключений логирует ошибку.
9. Возвращает словарь `cookies`.

**Примеры**:
```python
cookies = load_cookies_from_browsers(".google.com")
print(cookies)  # Вывод: словарь cookie для домена .google.com, загруженных из браузеров
```

### `set_cookies_dir`

```python
def set_cookies_dir(dir: str) -> None:
    """
    """
    ...
```

**Назначение**: Устанавливает директорию для хранения файлов cookies.

**Параметры**:
- `dir` (str): Путь к директории, где будут храниться файлы cookies.

**Возвращает**:
- `None`

**Как работает функция**:
1. Устанавливает значение атрибута `cookies_dir` класса `CookiesConfig` равным переданному пути.

**Примеры**:
```python
set_cookies_dir("./my_cookies")  # Установка директории для хранения файлов cookie
```

### `get_cookies_dir`

```python
def get_cookies_dir() -> str:
    """
    """
    ...
```

**Назначение**: Возвращает директорию, где хранятся файлы cookies.

**Параметры**:
- Нет

**Возвращает**:
- `str`: Путь к директории с файлами cookies.

**Как работает функция**:
1. Возвращает значение атрибута `cookies_dir` класса `CookiesConfig`.

**Примеры**:
```python
dir = get_cookies_dir()
print(dir)  # Вывод: путь к директории с файлами cookie
```

### `read_cookie_files`

```python
def read_cookie_files(dirPath: str = None):
    ...
```

**Назначение**: Читает файлы cookies из указанной директории (или из `CookiesConfig.cookies_dir`, если директория не указана) и загружает их в `CookiesConfig.cookies`. Поддерживает чтение файлов в формате HAR и JSON.

**Параметры**:
- `dirPath` (str, optional): Путь к директории с файлами cookies. Если не указан, используется значение `CookiesConfig.cookies_dir`.

**Возвращает**:
- `None`

**Как работает функция**:

1. **Определение директории**:
   - Если `dirPath` не указан, используется значение `CookiesConfig.cookies_dir`.

2. **Проверка доступа к директории**:
   - Проверяется, есть ли доступ на чтение к указанной директории.
   - Если директория не читаема, выводится сообщение в лог и функция завершается.

3. **Поиск файлов**:
   - Функция `os.walk` используется для рекурсивного обхода директории и поиска файлов с расширениями `.har` и `.json`.

4. **Обработка HAR-файлов**:
   - Для каждого найденного HAR-файла:
     - Открывается файл на чтение в бинарном режиме (`'rb'`).
     - Пытается загрузить содержимое файла как JSON. Если происходит ошибка `json.JSONDecodeError`, файл считается невалидным HAR-файлом и пропускается.
     - Извлекаются cookies из записей (`entries`) в HAR-файле. Для каждой записи определяется домен, если он присутствует в списке `DOMAINS`.
     - Cookies добавляются в `CookiesConfig.cookies`.

5. **Обработка JSON-файлов**:
   - Для каждого найденного JSON-файла:
     - Открывается файл на чтение в бинарном режиме (`'rb'`).
     - Пытается загрузить содержимое файла как JSON. Если происходит ошибка `json.JSONDecodeError`, файл считается невалидным JSON-файлом и пропускается.
     - Проверяется, является ли содержимое файла списком словарей, и содержит ли каждый словарь ключ `"domain"`. Если структура файла не соответствует ожидаемой, файл пропускается.
     - Извлекаются cookies из JSON-файла и добавляются в `CookiesConfig.cookies`.

6. **Логирование**:
   - В процессе работы функции выводятся сообщения в лог о чтении файлов и добавлении cookies.

**Примеры**:
```python
read_cookie_files()  # Чтение файлов cookies из директории по умолчанию (CookiesConfig.cookies_dir)
read_cookie_files("./my_cookies")  # Чтение файлов cookies из указанной директории
```

**Внутренние функции**:

### `get_domain`

```python
def get_domain(v: dict) -> str:
    """
    """
    ...
```

**Назначение**: Извлекает домен из заголовков запроса в HAR-файле.

**Параметры**:
- `v` (dict): Словарь, представляющий запись в HAR-файле.

**Возвращает**:
- `str`: Домен, если он найден в заголовках запроса и присутствует в списке `DOMAINS`. В противном случае - `None`.

**Как работает функция**:

1. **Извлечение заголовка Host/Authority**:
   - Извлекает значения заголовков `"host"` или `":authority"` из списка заголовков запроса (`v['request']['headers']`). Эти заголовки содержат информацию о домене.

2. **Проверка наличия домена в списке DOMAINS**:
   - Если заголовок найден, проверяет, содержится ли его значение в списке `DOMAINS`. Это необходимо для фильтрации доменов и обработки только тех, которые важны для приложения.

3. **Возврат домена**:
   - Если домен найден и содержится в списке `DOMAINS`, функция возвращает этот домен.
   - В противном случае функция возвращает `None`.

**Примеры**:

```python
har_entry = {
    'request': {
        'headers': [
            {'name': 'Host', 'value': 'www.google.com'},
            {'name': 'Content-Type', 'value': 'application/json'}
        ]
    }
}
domain = get_domain(har_entry)
print(domain)  # Вывод: www.google.com (если www.google.com есть в DOMAINS)
```

**Как работает функция `read_cookie_files`**:

1.  **Определение директории**:
     - Код проверяет, был ли предоставлен путь к директории (`dirPath`). Если нет, он использует путь, указанный в `CookiesConfig.cookies_dir`. Это позволяет гибко настраивать местоположение для чтения файлов cookie.

2.  **Проверка доступа к директории**:
     - Функция проверяет, имеет ли процесс право на чтение файлов в указанной директории. Если нет доступа на чтение, это регистрируется с помощью `debug.log`, и функция возвращается, не выполняя никаких дальнейших действий.

3.  **Поиск HAR и файлов cookie**:
     - Код использует `os.walk()` для рекурсивного просмотра указанной директории и всех ее поддиректорий. Он ищет файлы, заканчивающиеся на ".har" (HTTP Archive format) и ".json" (обычно содержащие данные cookie).

4.  **Чтение файлов HAR**:
     - Для каждого файла HAR, найденного в директории:
        - Код пытается открыть и проанализировать его как файл JSON. Обработка ошибок включена для перехвата любых проблем, которые могут возникнуть, если файл не является допустимым JSON (например, `json.JSONDecodeError`).
        - Извлекает домен из каждого HAR-файла с помощью функции `get_domain()`. Извлекает все куки, связанные с этим доменом.
        - Сохраняет извлеченные куки, перезаписывая любые предыдущие значения для одного и того же домена. Регистрирует добавленные куки.

5.  **Чтение файлов cookie**:
     - Для каждого файла cookie, найденного в каталоге:
        - Код пытается открыть и проанализировать его как файл JSON. Включена обработка ошибок для перехвата любых проблем, которые могут возникнуть, если файл не является допустимым JSON (например, `json.JSONDecodeError`).
        - Код проверяет, соответствует ли структура JSON ожидаемому формату (список словарей, каждый из которых содержит домен). Если структура неверна, файл пропускается.
        - Извлекает домен и связанные с ним куки. Сохраняет их, переписывая любые предыдущие значения для одного и того же домена. Регистрирует добавленные куки.

```
read_cookie_files

A[Проверка доступности `dirPath`]
|
B[Доступ к директории отсутствует]
|
C[Поиск файлов *.har и *.json]
|
D[Обнаружены HAR файлы]
|
E[Чтение HAR файла]
|
F[Извлечение cookies из HAR файла]
|
G[Обнаружены JSON файлы]
|
H[Чтение JSON файла]
|
I[Извлечение cookies из JSON файла]
|
J[Обновление CookiesConfig.cookies]
```

**Примеры**:
```python
read_cookie_files()