# Модуль для обработки медиафайлов
======================================

Модуль содержит функции для обработки и рендеринга медиафайлов, включая изображения и аудио, а также для интеграции медиафайлов в сообщения.

## Обзор

Этот модуль предназначен для работы с медиафайлами в контексте проекта `hypotez`. Он предоставляет функции для рендеринга медиафайлов из различных источников (URL, локальные файлы, base64-encoded данные), а также для объединения медиафайлов с сообщениями. Модуль также включает функции для преобразования медиафайлов в форматы, подходящие для использования в сообщениях.

## Подробнее

Модуль `media.py` предоставляет набор функций для обработки медиа контента, используемого в сообщениях. Он включает в себя рендеринг медиа (изображений и аудио) из различных источников, таких как URL, локальные файлы и base64-encoded данные. Функции модуля позволяют преобразовывать медиа файлы в форматы, подходящие для вставки в сообщения, а также объединять медиа с текстовым контентом.

## Функции

### `render_media`

```python
def render_media(bucket_id: str, name: str, url: str, as_path: bool = False, as_base64: bool = False) -> Union[str, Path]:
    """
    Функция для рендеринга медиафайлов.

    Args:
        bucket_id (str): Идентификатор бакета.
        name (str): Имя файла.
        url (str): URL файла.
        as_path (bool): Если `True`, возвращает путь к файлу.
        as_base64 (bool): Если `True`, возвращает base64-encoded данные.

    Returns:
        Union[str, Path]: URL, путь к файлу или base64-encoded данные.

    Как работает функция:
    1. Проверяет, нужно ли возвращать путь к файлу или base64-encoded данные.
    2. Если нужно, формирует путь к файлу на основе `bucket_id`, "media" и `name`.
    3. Если запрошен путь, возвращает его.
    4. Читает содержимое файла в байтах.
    5. Кодирует содержимое файла в base64.
    6. Если запрошен base64, возвращает его.
    7. Формирует строку data URI и возвращает её.
    8. Если ничего из вышеперечисленного не запрошено, возвращает исходный URL.

    ```
    A --> B --> C --> D
    |     |     |
    |     |     E
    |     |
    |     F
    |
    G
    ```
    Где:
    A: Проверка флагов `as_base64`, `as_path` или начинается ли URL с "/".
    B: Формирование пути к файлу.
    C: Проверка флага `as_path`.
    D: Возврат пути к файлу, если `as_path` равен `True`.
    E: Чтение содержимого файла в байтах.
    F: Кодирование содержимого файла в base64.
    G: Формирование строки data URI и возврат её.
    """
```

### `render_part`

```python
def render_part(part: dict) -> dict:
    """
    Функция для рендеринга части сообщения.

    Args:
        part (dict): Часть сообщения.

    Returns:
        dict: Обработанная часть сообщения.

    Как работает функция:
    1. Проверяет наличие ключа "type" в `part`. Если есть, возвращает `part` без изменений.
    2. Извлекает имя файла из `part`.
    3. Если имя файла отсутствует, формирует путь к директории бакета и возвращает текстовую часть сообщения, прочитанную из бакета.
    4. Если файл является аудио, возвращает `input_audio` с base64-encoded данными.
    5. Иначе, возвращает `image_url` с URL медиафайла.

    ```
    A --> B --> C --> D
    |     |     |
    |     |     E --> F --> G
    |     |
    |     H --> I --> J
    |
    K
    ```

    Где:
    A: Проверка наличия ключа "type" в `part`.
    B: Возврат `part` без изменений, если "type" присутствует.
    C: Извлечение имени файла из `part`.
    D: Проверка, отсутствует ли имя файла.
    E: Формирование пути к директории бакета.
    F: Чтение содержимого бакета.
    G: Формирование текстовой части сообщения и возврат её.
    H: Проверка, является ли файл аудио.
    I: Рендеринг медиа как base64 и формирование `input_audio`.
    J: Рендеринг медиа как URL и формирование `image_url`.
    K: Возврат обработанной части сообщения.
    """
```

### `merge_media`

```python
def merge_media(media: list, messages: list) -> Iterator:
    """
    Функция для объединения медиафайлов с сообщениями.

    Args:
        media (list): Список медиафайлов.
        messages (list): Список сообщений.

    Yields:
        Iterator: Итератор медиафайлов.

    Как работает функция:
    1. Итерируется по сообщениям.
    2. Если роль сообщения "user", обрабатывает содержимое сообщения.
    3. Если содержимое является списком, итерируется по частям содержимого.
    4. Если в части отсутствует "type", но есть "name", рендерит медиа как путь и добавляет в буфер.
    5. Если тип части "image_url", добавляет URL изображения в буфер.
    6. После обработки всех сообщений, выдает медиафайлы из буфера, а затем из списка media.

    ```
    A --> B --> C --> D
          |     |     |
          |     |     E --> F
          |     |
          |     G --> H
          |
          I --> J
    ```

    Где:
    A: Инициализация буфера.
    B: Итерация по сообщениям.
    C: Проверка роли сообщения ("user").
    D: Извлечение содержимого сообщения.
    E: Проверка, является ли содержимое списком.
    F: Итерация по частям содержимого.
    G: Проверка наличия "type" и "name" в части содержимого.
    H: Рендеринг медиа как путь и добавление в буфер.
    I: Проверка типа части содержимого ("image_url").
    J: Добавление URL изображения в буфер.
    K: Выдача медиафайлов из буфера и списка `media`.
    """
```

### `render_messages`

```python
def render_messages(messages: Messages, media: list = None) -> Iterator:
    """
    Функция для рендеринга сообщений с медиафайлами.

    Args:
        messages (Messages): Список сообщений.
        media (list, optional): Список медиафайлов. По умолчанию `None`.

    Yields:
        Iterator: Итератор обработанных сообщений.

    Как работает функция:
    1. Итерируется по сообщениям.
    2. Если содержимое сообщения является списком, рендерит каждую часть содержимого.
    3. Если есть медиафайлы и это последнее сообщение, добавляет медиафайлы в содержимое сообщения.
    4. Преобразует медиаданные в формат `input_audio` или `image_url` в зависимости от типа файла.
    5. Добавляет текстовое содержимое, если оно есть.

    ```
    A --> B --> C --> D
          |     |     |
          |     |     E --> F --> G
          |     |           |     |
          |     |           |     H --> I
          |     |           |
          |     |           J
          |     |
          |     K
          |
          L
    ```

    Где:
    A: Итерация по сообщениям.
    B: Проверка, является ли содержимое сообщения списком.
    C: Рендеринг каждой части содержимого.
    D: Проверка наличия медиафайлов и является ли сообщение последним.
    E: Преобразование медиаданных в `input_audio` или `image_url`.
    F: Проверка типа файла (аудио).
    G: Преобразование в `input_audio`.
    H: Преобразование в `image_url`.
    I: Добавление текстового содержимого, если оно есть.
    J: Выдача обработанного сообщения.
    K: Выдача исходного сообщения, если нет медиафайлов или это не последнее сообщение.
    L: Завершение итерации.
    """
```