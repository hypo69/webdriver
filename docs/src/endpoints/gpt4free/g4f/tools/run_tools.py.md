# Модуль для запуска инструментов обработки текста

## Обзор

Модуль `run_tools.py` предназначен для обработки и выполнения различных инструментов, используемых в процессе генерации текста, таких как поиск в интернете, работа с хранилищами данных (buckets) и управление API ключами. Он содержит классы и функции для асинхронного и синхронного выполнения этих инструментов, а также для обработки промежуточных результатов.

## Подробней

Этот модуль является ключевым компонентом системы, отвечающим за интеграцию различных инструментов для расширения возможностей языковых моделей. Он обеспечивает возможность использования внешних ресурсов и сервисов, таких как поисковые системы, для улучшения качества и релевантности генерируемого текста. Модуль также управляет аутентификацией и авторизацией при использовании API различных провайдеров.

## Классы

### `ToolHandler`

**Описание**: Класс `ToolHandler` предназначен для обработки различных типов инструментов.

**Принцип работы**: Класс содержит статические методы для валидации аргументов инструментов, обработки поисковых запросов, продолжения генерации текста и работы с хранилищами данных.

**Методы**:

- `validate_arguments(data: dict) -> dict`: Валидирует и парсит аргументы инструментов, представленные в виде словаря или JSON-строки.
- `process_search_tool(messages: Messages, tool: dict) -> Messages`: Обрабатывает запросы к поисковому инструменту, выполняет поиск и добавляет результаты в сообщения.
- `process_continue_tool(messages: Messages, tool: dict, provider: Any) -> Tuple[Messages, Dict[str, Any]]`: Обрабатывает запросы на продолжение генерации текста.
- `process_bucket_tool(messages: Messages, tool: dict) -> Messages`: Обрабатывает запросы к инструменту для работы с хранилищами данных (buckets).
- `process_tools(messages: Messages, tool_calls: List[dict], provider: Any) -> Tuple[Messages, Dict[str, Any]]`: Обрабатывает список вызовов инструментов и возвращает обновленные сообщения и аргументы.

### `AuthManager`

**Описание**: Класс `AuthManager` предназначен для управления API ключами.

**Принцип работы**: Класс содержит статические методы для получения пути к файлу с API ключом и загрузки API ключа из файла конфигурации.

**Методы**:

- `get_api_key_file(cls) -> Path`: Получает путь к файлу с API ключом для указанного провайдера.
- `load_api_key(provider: Any) -> Optional[str]`: Загружает API ключ из файла конфигурации, если это необходимо.

### `ThinkingProcessor`

**Описание**: Класс `ThinkingProcessor` предназначен для обработки чанков "размышлений" (thinking chunks).

**Принцип работы**: Класс содержит статический метод для обработки чанков, содержащих теги `<think>` и `</think>`, которые указывают на процесс размышления модели.

**Методы**:

- `process_thinking_chunk(chunk: str, start_time: float = 0) -> Tuple[float, List[Union[str, Reasoning]]]`: Обрабатывает чанк "размышлений" и возвращает время и результаты обработки.

## Функции

### `perform_web_search(messages: Messages, web_search_param: Any) -> Tuple[Messages, Optional[Sources]]`

```python
async def perform_web_search(messages: Messages, web_search_param: Any) -> Tuple[Messages, Optional[Sources]]:
    """Выполняет поиск в интернете и возвращает обновленные сообщения и источники.

    Args:
        messages (Messages): Список сообщений.
        web_search_param (Any): Параметр для поиска в интернете.

    Returns:
        Tuple[Messages, Optional[Sources]]: Обновленный список сообщений и источники (если есть).

    Raises:
        Exception: Если не удается выполнить поиск в интернете.

    Как работает функция:
     1. Функция проверяет, передан ли параметр `web_search_param`. Если параметр отсутствует, функция не выполняет поиск и возвращает исходные сообщения и `None` в качестве источников.
     2. Если параметр `web_search_param` передан, функция пытается выполнить поиск в интернете, используя функцию `do_search`. Параметр `web_search_param` используется в качестве поискового запроса, если он является строкой и не равен "true". В противном случае поиск выполняется с использованием содержимого последнего сообщения.
     3. Если во время поиска возникает исключение, функция логирует ошибку и возвращает исходные сообщения и `None` в качестве источников.

     Поток операций в функции:

     Начало
     ↓
     Проверка наличия параметра web_search_param
     ├───> Параметр отсутствует: Возврат исходных сообщений и None
     │
     └───> Параметр присутствует:
         │
         Попытка выполнения поиска
         │
         ├───> Успешно: Обновление сообщений результатами поиска и получение источников
         │
         └───> Ошибка: Логирование ошибки
         │
         Возврат обновленных сообщений и источников (или None в случае ошибки)
         ↓
         Конец

    Примеры:
    - `perform_web_search(messages, "example query")`
    - `perform_web_search(messages, None)`
    """
    ...
```

### `async_iter_run_tools(provider: ProviderType, model: str, messages: Messages, tool_calls: Optional[List[dict]] = None, **kwargs) -> AsyncIterator`

```python
async def async_iter_run_tools(
    provider: ProviderType, 
    model: str, 
    messages: Messages, 
    tool_calls: Optional[List[dict]] = None, 
    **kwargs
) -> AsyncIterator:
    """Асинхронно запускает инструменты и возвращает результаты.

    Args:
        provider (ProviderType): Провайдер.
        model (str): Модель.
        messages (Messages): Список сообщений.
        tool_calls (Optional[List[dict]], optional): Список вызовов инструментов. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncIterator: Асинхронный итератор результатов.

    Как работает функция:
     1. Функция выполняет поиск в интернете, если передан параметр `web_search`.
     2. Функция загружает API ключ, если это необходимо.
     3. Функция обрабатывает вызовы инструментов, если они переданы.
     4. Функция генерирует ответ с помощью асинхронной функции `create_function` провайдера.
     5. Функция возвращает асинхронный итератор результатов.

    Поток операций в функции:

     Начало
     ↓
     Обработка поиска в интернете (если web_search)
     ↓
     Загрузка API ключа (если необходимо)
     ↓
     Обработка вызовов инструментов (tool_calls)
     ↓
     Генерация ответа с помощью провайдера
     ↓
     Возврат асинхронного итератора результатов
     ↓
     Выдача источников (sources) при наличии
     ↓
     Конец

    Примеры:
    - `async_iter_run_tools(provider, "gpt-3.5-turbo", messages, tool_calls=[...], web_search="example query")`
    - `async_iter_run_tools(provider, "gpt-3.5-turbo", messages)`
    """
    ...
```

### `iter_run_tools(iter_callback: Callable, model: str, messages: Messages, provider: Optional[str] = None, tool_calls: Optional[List[dict]] = None, **kwargs) -> Iterator`

```python
def iter_run_tools(
    iter_callback: Callable,
    model: str,
    messages: Messages,
    provider: Optional[str] = None,
    tool_calls: Optional[List[dict]] = None,
    **kwargs
) -> Iterator:
    """Синхронно запускает инструменты и возвращает результаты.

    Args:
        iter_callback (Callable): Функция обратного вызова для итерации.
        model (str): Модель.
        messages (Messages): Список сообщений.
        provider (Optional[str], optional): Провайдер. По умолчанию `None`.
        tool_calls (Optional[List[dict]], optional): Список вызовов инструментов. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        Iterator: Итератор результатов.

    Как работает функция:
     1. Функция выполняет поиск в интернете, если передан параметр `web_search`. Для этого она использует `asyncio.run` для запуска асинхронной функции `do_search` внутри синхронной функции.
     2. Функция загружает API ключ, если это необходимо.
     3. Функция обрабатывает вызовы инструментов, если они переданы.
     4. Функция обрабатывает чанки ответа с помощью класса `ThinkingProcessor`.
     5. Функция возвращает итератор результатов.

    Поток операций в функции:

     Начало
     ↓
     Обработка поиска в интернете (если web_search)
     ↓
     Загрузка API ключа (если необходимо)
     ↓
     Обработка вызовов инструментов (tool_calls)
     ↓
     Обработка чанков ответа с помощью ThinkingProcessor
     ↓
     Возврат итератора результатов
     ↓
     Выдача источников (sources) при наличии
     ↓
     Конец

    Примеры:
    - `iter_run_tools(iter_callback, "gpt-3.5-turbo", messages, provider="OpenAI", tool_calls=[...], web_search="example query")`
    - `iter_run_tools(iter_callback, "gpt-3.5-turbo", messages)`
    """
    ...