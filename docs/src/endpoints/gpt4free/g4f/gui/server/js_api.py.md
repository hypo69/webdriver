# Документация модуля `js_api.py`

## Обзор

Модуль `js_api.py` является частью проекта `hypotez` и предназначен для обеспечения взаимодействия между JavaScript-интерфейсом (GUI) и серверной частью приложения. Он содержит класс `JsApi`, который наследуется от класса `Api` и предоставляет методы для обработки запросов от GUI, таких как получение данных для разговора, выбор изображений, получение снимков с камеры и другие.

## Подробней

Модуль использует библиотеки `webview`, `platformdirs` и `plyer` для интеграции с веб-интерфейсом, определения путей к файлам и работы с камерой и файловой системой. Класс `JsApi` предоставляет API для выполнения различных операций, таких как получение истории разговоров, выбор изображений из файловой системы или получение снимков с камеры. Эти операции позволяют пользователю взаимодействовать с приложением через графический интерфейс.

## Классы

### `JsApi`

**Описание**: Класс `JsApi` предоставляет API для взаимодействия с графическим интерфейсом на JavaScript. Он наследуется от класса `Api` и расширяет его функциональность, добавляя методы для обработки запросов от GUI, таких как получение данных для разговора, выбор изображений, получение снимков с камеры и другие.

**Наследует**:
- `Api`: Класс `JsApi` наследует функциональность от класса `Api`, который, вероятно, предоставляет общие методы для работы с API.

**Методы**:

- `get_conversation(self, options: dict, message_id: str = None, scroll: bool = None) -> Iterator`: Получает данные для разговора и передает их в JavaScript-интерфейс для отображения.
- `choose_image(self)`: Открывает диалоговое окно выбора изображения для выбора изображения пользователем.
- `take_picture(self)`: Делает снимок с камеры и сохраняет его во временном файле.
- `on_image_selection(self, filename)`: Обрабатывает выбор изображения пользователем.
- `on_camera(self, filename)`: Обрабатывает снимок, сделанный с камеры.
- `set_selected(self, input_id: str = None)`: Устанавливает состояние выбранного элемента в графическом интерфейсе.
- `get_version(self)`: Возвращает версию API.
- `get_models(self)`: Возвращает список доступных моделей.
- `get_providers(self)`: Возвращает список доступных провайдеров.
- `get_provider_models(self, provider: str, **kwargs)`: Возвращает список моделей для указанного провайдера.

## Функции

### `get_conversation`

```python
def get_conversation(self, options: dict, message_id: str = None, scroll: bool = None) -> Iterator:
    """
    Получает данные для разговора и передает их в JavaScript-интерфейс для отображения.

    Args:
        options (dict): Словарь с опциями для разговора.
        message_id (str, optional): Идентификатор сообщения. По умолчанию `None`.
        scroll (bool, optional): Флаг, указывающий, нужно ли прокручивать окно. По умолчанию `None`.

    Returns:
        Iterator: Итератор сообщений.

    Как работает функция:
    1. Проверяет, есть ли изображение для отправки. Если есть, открывает файл изображения в бинарном режиме и добавляет его в `options`.
    2. Создает поток ответов, используя метод `_create_response_stream` класса `JsApi`.
    3. Передает каждое сообщение в JavaScript-интерфейс, используя `window.evaluate_js`. JavaScript код добавляет сообщение в чат.
    4. Проверяет, не была ли остановлена отправка сообщений, используя `is_stopped()`.
    5. Если отправка остановлена, прерывает цикл.
    6. Сбрасывает `self.image` в `None`.
    7. Сбрасывает выбранный элемент, используя `self.set_selected(None)`.
    """
```

**Параметры**:
- `options` (dict): Словарь с опциями для разговора. Может содержать различные параметры, такие как идентификатор разговора, провайдер и изображение.
- `message_id` (str, optional): Идентификатор сообщения, которое нужно отобразить. По умолчанию `None`.
- `scroll` (bool, optional): Флаг, указывающий, нужно ли прокручивать окно после добавления сообщения. По умолчанию `None`.

**Возвращает**:
- `Iterator`: Итератор сообщений, полученных от API.

**Как работает функция**:
1. **Проверка наличия изображения**:
   - Проверяет, было ли выбрано изображение для отправки. Если `self.image` не равно `None`, открывает файл изображения в бинарном режиме (`"rb"`) и добавляет его в словарь `options` под ключом `"image"`.

2. **Создание потока ответов**:
   - Использует метод `_create_response_stream` для создания потока сообщений. Этот метод принимает подготовленные аргументы разговора (`self._prepare_conversation_kwargs(options)`), идентификатор разговора (`options.get("conversation_id")`) и провайдера (`options.get('provider')`).

3. **Передача сообщений в JavaScript-интерфейс**:
   - В цикле перебирает сообщения из потока. Для каждого сообщения выполняет JavaScript-код с помощью `window.evaluate_js`.
   - JavaScript-код выполняет следующие действия:
     - Проверяет, не была ли остановлена отправка сообщений (`is_stopped()`). Если да, возвращает `true`.
     - Добавляет фрагмент сообщения в интерфейс, вызывая функцию `add_message_chunk` с параметрами:
       - JSON-представление сообщения (`json.dumps(message)`).
       - JSON-представление идентификатора сообщения (`json.dumps(message_id)`).
       - JSON-представление провайдера (`json.dumps(options.get('provider'))`).
       - Строковое представление флага прокрутки (`'true'` если `scroll` истина, иначе `'false'`).

4. **Прерывание цикла**:
   - Если JavaScript-код возвращает `true` (т.е. отправка остановлена), цикл прерывается.

5. **Сброс состояния**:
   - После завершения цикла сбрасывает `self.image` в `None`, чтобы убрать выбранное изображение.
   - Сбрасывает выбранный элемент, вызывая `self.set_selected(None)`.

```
A: Проверка наличия изображения
|
B: Создание потока ответов
|
C: Передача сообщений в JavaScript-интерфейс
|
D: Проверка остановки отправки
|
E: Сброс состояния
```

**Примеры**:
```python
# Пример вызова функции get_conversation с различными параметрами
options = {"conversation_id": "123", "provider": "openai", "text": "Hello"}
message_id = "456"
scroll = True
conversation = self.get_conversation(options, message_id, scroll)
for message in conversation:
    print(message)

options = {"conversation_id": "789", "provider": "gemini", "text": "Hi"}
conversation = self.get_conversation(options)
for message in conversation:
    print(message)
```

### `choose_image`

```python
def choose_image(self):
    """
    Открывает диалоговое окно выбора изображения для выбора изображения пользователем.
    """
```

**Как работает функция**:
1. **Открытие диалогового окна выбора файла**:
   - Вызывает функцию `user_select_image`, которая, вероятно, открывает диалоговое окно выбора файла для выбора изображения пользователем. Функция `user_select_image` является частичным применением функции `filechooser.open_file` с предустановленными параметрами, такими как путь к каталогу изображений пользователя (`platformdirs.user_pictures_dir()`) и фильтры для выбора файлов изображений.
   - Функция `on_selection` устанавливается как `self.on_image_selection`, что означает, что после выбора файла будет вызвана функция `on_image_selection` для обработки выбранного изображения.

```
A: Открытие диалогового окна выбора файла
```

**Примеры**:
```python
# Пример вызова функции choose_image
self.choose_image()
```

### `take_picture`

```python
def take_picture(self):
    """
    Делает снимок с камеры и сохраняет его во временном файле.
    """
```

**Как работает функция**:
1. **Определение имени файла**:
   - Создает имя файла для сохранения снимка, используя `os.path.join` для объединения пути к каталогу хранения приложений (`app_storage_path()`) и имени файла, которое генерируется с помощью `f"chat-{uuid4()}.png"`. `uuid4()` генерирует уникальный идентификатор, чтобы избежать конфликтов имен файлов.

2. **Съемка снимка**:
   - Вызывает функцию `camera.take_picture`, передавая имя файла (`filename`) и функцию обратного вызова (`on_complete=self.on_camera`). Функция `camera.take_picture` делает снимок с камеры и сохраняет его по указанному пути. После завершения съемки вызывается функция `on_camera` для обработки снимка.

```
A: Определение имени файла
|
B: Съемка снимка
```

**Примеры**:
```python
# Пример вызова функции take_picture
self.take_picture()
```

### `on_image_selection`

```python
def on_image_selection(self, filename):
    """
    Обрабатывает выбор изображения пользователем.

    Args:
        filename: Имя выбранного файла.
    """
```

**Параметры**:
- `filename`: Имя выбранного файла. Может быть строкой или списком строк.

**Как работает функция**:
1. **Извлечение имени файла**:
   - Проверяет, является ли `filename` списком. Если да, извлекает первый элемент списка. Если список пуст, оставляет `filename` без изменений.

2. **Проверка существования файла**:
   - Проверяет, существует ли файл с помощью `os.path.exists(filename)`.

3. **Установка изображения**:
   - Если файл существует, устанавливает `self.image` равным `filename`. Если файл не существует, устанавливает `self.image` равным `None`.

4. **Установка выбранного элемента**:
   - Вызывает `self.set_selected`, чтобы обновить состояние выбранного элемента в графическом интерфейсе. Если `self.image` не равно `None`, устанавливает выбранный элемент как `"image"`. В противном случае устанавливает выбранный элемент как `None`.

```
A: Извлечение имени файла
|
B: Проверка существования файла
|
C: Установка изображения
|
D: Установка выбранного элемента
```

**Примеры**:
```python
# Пример вызова функции on_image_selection с существующим файлом
self.on_image_selection("path/to/existing/image.png")

# Пример вызова функции on_image_selection с несуществующим файлом
self.on_image_selection("path/to/nonexistent/image.png")

# Пример вызова функции on_image_selection с пустым списком
self.on_image_selection([])
```

### `on_camera`

```python
def on_camera(self, filename):
    """
    Обрабатывает снимок, сделанный с камеры.

    Args:
        filename: Имя файла, в который был сохранен снимок.
    """
```

**Параметры**:
- `filename`: Имя файла, в который был сохранен снимок.

**Как работает функция**:
1. **Проверка существования файла**:
   - Проверяет, существует ли файл с помощью `os.path.exists(filename)`.

2. **Установка изображения**:
   - Если файл существует, устанавливает `self.image` равным `filename`. Если файл не существует, устанавливает `self.image` равным `None`.

3. **Установка выбранного элемента**:
   - Вызывает `self.set_selected`, чтобы обновить состояние выбранного элемента в графическом интерфейсе. Если `self.image` не равно `None`, устанавливает выбранный элемент как `"camera"`. В противном случае устанавливает выбранный элемент как `None`.

```
A: Проверка существования файла
|
B: Установка изображения
|
C: Установка выбранного элемента
```

**Примеры**:
```python
# Пример вызова функции on_camera с существующим файлом
self.on_camera("path/to/existing/camera_image.png")

# Пример вызова функции on_camera с несуществующим файлом
self.on_camera("path/to/nonexistent/camera_image.png")
```

### `set_selected`

```python
def set_selected(self, input_id: str = None):
    """
    Устанавливает состояние выбранного элемента в графическом интерфейсе.

    Args:
        input_id (str, optional): Идентификатор выбранного элемента. По умолчанию `None`.
    """
```

**Параметры**:
- `input_id` (str, optional): Идентификатор выбранного элемента. Может быть `"image"`, `"camera"` или `None`. По умолчанию `None`.

**Как работает функция**:
1. **Получение экземпляра окна**:
   - Получает экземпляр окна `webview` из списка окон `webview.windows[0]`.

2. **Удаление класса `selected` у предыдущего выбранного элемента**:
   - Выполняет JavaScript-код для удаления класса `selected` у предыдущего выбранного элемента. JavaScript-код использует `document.querySelector` для поиска элемента с классом `image-label.selected` и удаляет у него класс `selected`.

3. **Добавление класса `selected` к текущему выбранному элементу**:
   - Если `input_id` не равно `None` и является `"image"` или `"camera"`, выполняет JavaScript-код для добавления класса `selected` к текущему выбранному элементу. JavaScript-код использует `document.querySelector` для поиска элемента `label` с атрибутом `for`, равным `input_id`, и добавляет ему класс `selected`.

```
A: Получение экземпляра окна
|
B: Удаление класса `selected` у предыдущего выбранного элемента
|
C: Добавление класса `selected` к текущему выбранному элементу
```

**Примеры**:
```python
# Пример вызова функции set_selected с идентификатором "image"
self.set_selected("image")

# Пример вызова функции set_selected с идентификатором "camera"
self.set_selected("camera")

# Пример вызова функции set_selected без идентификатора
self.set_selected()
```

### `get_version`

```python
def get_version(self):
    """
    Возвращает версию API.
    """
```

**Как работает функция**:
1. **Вызов метода `get_version` родительского класса**:
   - Вызывает метод `get_version` родительского класса (`super().get_version()`). Этот метод, вероятно, возвращает строку, содержащую версию API.

```
A: Вызов метода `get_version` родительского класса
```

**Примеры**:
```python
# Пример вызова функции get_version
version = self.get_version()
print(f"API Version: {version}")
```

### `get_models`

```python
def get_models(self):
    """
    Возвращает список доступных моделей.
    """
```

**Как работает функция**:
1. **Вызов метода `get_models` родительского класса**:
   - Вызывает метод `get_models` родительского класса (`super().get_models()`). Этот метод, вероятно, возвращает список доступных моделей.

```
A: Вызов метода `get_models` родительского класса
```

**Примеры**:
```python
# Пример вызова функции get_models
models = self.get_models()
print(f"Available Models: {models}")
```

### `get_providers`

```python
def get_providers(self):
    """
    Возвращает список доступных провайдеров.
    """
```

**Как работает функция**:
1. **Вызов метода `get_providers` родительского класса**:
   - Вызывает метод `get_providers` родительского класса (`super().get_providers()`). Этот метод, вероятно, возвращает список доступных провайдеров.

```
A: Вызов метода `get_providers` родительского класса
```

**Примеры**:
```python
# Пример вызова функции get_providers
providers = self.get_providers()
print(f"Available Providers: {providers}")
```

### `get_provider_models`

```python
def get_provider_models(self, provider: str, **kwargs):
    """
    Возвращает список моделей для указанного провайдера.

    Args:
        provider (str): Название провайдера.
        **kwargs: Дополнительные аргументы.
    """
```

**Параметры**:
- `provider` (str): Название провайдера, для которого нужно получить список моделей.
- `**kwargs`: Дополнительные аргументы, которые могут быть переданы в метод родительского класса.

**Как работает функция**:
1. **Вызов метода `get_provider_models` родительского класса**:
   - Вызывает метод `get_provider_models` родительского класса (`super().get_provider_models(provider, **kwargs)`), передавая название провайдера и дополнительные аргументы. Этот метод, вероятно, возвращает список моделей для указанного провайдера.

```
A: Вызов метода `get_provider_models` родительского класса
```

**Примеры**:
```python
# Пример вызова функции get_provider_models
models = self.get_provider_models("openai")
print(f"OpenAI Models: {models}")

models = self.get_provider_models("gemini", param1="value1")
print(f"Gemini Models: {models}")