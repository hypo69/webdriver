# Модуль для поиска свободного порта

## Обзор

Модуль содержит функцию `get_free_port`, которая используется для поиска свободного порта в заданном диапазоне или первого доступного порта, если диапазон не указан. Модуль обрабатывает различные форматы диапазонов портов и проверяет, занят ли порт, с помощью сокетов.

## Подробней

Этот модуль предоставляет удобный способ поиска доступного порта для сетевых приложений, требующих динамического назначения портов. Он особенно полезен в ситуациях, когда необходимо избежать конфликтов портов при запуске нескольких экземпляров одного и того же приложения или при интеграционном тестировании, где сервисам требуются разные порты.

## Функции

### `get_free_port`

```python
def get_free_port(host: str, port_range: Optional[str | List[str]] = None) -> int:
    """
    Finds and returns a free port within the specified range, or the first available port if no range is given.

    Args:
        host (str): The host address to check for available ports.
        port_range (Optional[str | List[str]], optional): A port range specified as a string "min-max" or a list of strings.
               E.g.: "3000-3999", ["3000-3999", "8000-8010"], None. Defaults to `None`.

    Returns:
        int: An available port number.

    Raises:
        ValueError: If no free port can be found within the specified range, or if the port range is invalid.
    """
```

**Назначение**: Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не указан.

**Параметры**:

- `host` (str): Адрес хоста для проверки доступных портов.
- `port_range` (Optional[str | List[str]], optional): Диапазон портов, заданный как строка "min-max" или список строк. Например: "3000-3999", ["3000-3999", "8000-8010"], None. По умолчанию `None`.

**Возвращает**:

- `int`: Доступный номер порта.

**Вызывает исключения**:

- `ValueError`: Если не удается найти свободный порт в указанном диапазоне, или если диапазон портов недействителен.

**Как работает функция**:

1.  **Обработка диапазона портов**: Функция проверяет, был ли предоставлен диапазон портов.
2.  **Если диапазон портов предоставлен**:
    *   Если `port_range` является строкой, функция пытается разобрать его с помощью `_parse_port_range` и итерируется по диапазону, проверяя каждый порт с помощью `_is_port_in_use`.
    *   Если `port_range` является списком, функция итерируется по каждому элементу списка, пытаясь разобрать его как диапазон портов и проверить доступность портов.
    *   Если ни один из портов в указанных диапазонах не является свободным, функция вызывает исключение `ValueError`.
    *   Если `port_range` имеет неверный тип, функция вызывает исключение `ValueError`.
3.  **Если диапазон портов не предоставлен**: Функция начинает поиск с порта 1024 и увеличивает его до тех пор, пока не найдет свободный порт или не достигнет максимального значения порта (65535). Если свободный порт не найден, функция вызывает исключение `ValueError`.

**Внутренние функции**:

#### `_is_port_in_use`

```python
def _is_port_in_use(host: str, port: int) -> bool:
    """
    Checks if a given port is in use on the specified host.

    Args:
        host (str): The host address.
        port (int): The port number to check.

    Returns:
        bool: True if the port is in use, False otherwise.
    """
```

**Назначение**: Проверяет, используется ли данный порт на указанном хосте.

**Параметры**:

- `host` (str): Адрес хоста.
- `port` (int): Номер порта для проверки.

**Возвращает**:

- `bool`: `True`, если порт используется, `False` в противном случае.

**Как работает функция**:

1.  Создает сокет (`socket.socket`).
2.  Пытается привязать сокет к указанному хосту и порту (`sock.bind((host, port))`).
3.  Если привязка прошла успешно, это означает, что порт свободен, и функция возвращает `False`.
4.  Если возникает исключение `OSError`, это означает, что порт занят, и функция возвращает `True`.

#### `_parse_port_range`

```python
def _parse_port_range(port_range_str: str) -> Tuple[int, int]:
    """
    Parses port range string "min-max" into a tuple (min_port, max_port).

    Args:
        port_range_str (str): The port range string.

    Returns:
        Tuple[int, int]: A tuple containing minimum and maximum port numbers.

    Raises:
        ValueError: If the port range string format is invalid.
    """
```

**Назначение**: Разбирает строку диапазона портов "min-max" в кортеж (min\_port, max\_port).

**Параметры**:

- `port_range_str` (str): Строка диапазона портов.

**Возвращает**:

- `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Вызывает исключения**:

- `ValueError`: Если формат строки диапазона портов недействителен.

**Как работает функция**:

1.  Разделяет строку `port_range_str` по символу `-` (`parts = port_range_str.split('-')`).
2.  Проверяет, что строка содержит ровно два элемента (минимальный и максимальный порты). Если нет, вызывает исключение `ValueError`.
3.  Преобразует оба элемента в целые числа (`min_port = int(parts[0])`, `max_port = int(parts[1])`).
4.  Проверяет, что минимальный порт меньше максимального. Если нет, вызывает исключение `ValueError`.
5.  Возвращает кортеж, содержащий минимальный и максимальный порты.

**ASCII flowchart функции `get_free_port`**:

```
Начало
│
├─── port_range is None? ── Да ──► Искать первый доступный порт (начиная с 1024)
│   │                        │
│   └── Нет ───────────────┘
│
├─── port_range is str? ────── Да ──► _parse_port_range(port_range) ──► Итерировать по диапазону
│   │                        │
│   └── Нет ───────────────┘
│
├─── port_range is list? ───── Да ──► Итерировать по элементам списка
│   │                        │
│   └── Нет ───────────────┘
│
└─── port_range is invalid? ── Да ──► Вызвать ValueError
    │
    └── Нет ───────────────► _is_port_in_use(host, port) ── Да ──► Порт занят ──► Продолжить поиск
        │                                                    │
        └── Нет ───────────────────────────────────────────┘
        │
        └── Порт свободен ──► Вернуть port

Конец
```

**Примеры**:

```python
# from src.utils.get_free_port import get_free_port

# Пример 1: Поиск свободного порта в диапазоне 3000-3005
free_port = get_free_port('localhost', '3000-3005')
print(f'Свободный порт в диапазоне 3000-3005: {free_port}')

# Пример 2: Поиск свободного порта в списке диапазонов
free_port = get_free_port('localhost', ['3000-3005', '8000-8010'])
print(f'Свободный порт в диапазонах 3000-3005 и 8000-8010: {free_port}')

# Пример 3: Поиск первого доступного порта
free_port = get_free_port('localhost')
print(f'Первый доступный порт: {free_port}')