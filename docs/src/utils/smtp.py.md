# Модуль для работы с SMTP
=================================================

Модуль предоставляет интерфейс для отправки и получения электронной почты с использованием протоколов SMTP и IMAP.
Он включает функции для отправки писем через SMTP и получения писем через IMAP.

## Обзор

Модуль `smtp.py` предназначен для упрощения работы с электронной почтой, предоставляя функции для отправки и получения сообщений. Он использует библиотеки `smtplib` и `imaplib` для взаимодействия с почтовыми серверами.
В модуле реализованы функции отправки и приема email сообщений.

## Подробнее

Этот модуль предоставляет функциональность для отправки и получения электронных писем с использованием SMTP или IMAP серверов. Он включает функции для отправки электронных писем с использованием SMTP и получения электронных писем с использованием IMAP.

Важно отметить, что учетные данные для подключения к почтовому серверу не должны быть жестко закодированы в файле, а должны передаваться через переменные окружения. Это необходимо для обеспечения безопасности и упрощения управления конфигурацией.

## Функции

### `send`

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Отправляет email сообщение.

    Args:
        subject (str, optional): Тема сообщения. По умолчанию ''.
        body (str, optional): Тело сообщения. По умолчанию ''.
        to (str, optional): Адрес получателя. По умолчанию 'one.last.bit@gmail.com'.

    Returns:
        bool: `True` в случае успешной отправки, `False` в случае ошибки.

    Raises:
        Exception: В случае возникновения ошибки при отправке сообщения.

    Как работает функция:
    1. Функция устанавливает соединение с SMTP-сервером, используя данные из словаря `_connection`.
    2. Выполняет аутентификацию на сервере.
    3. Формирует сообщение с указанными темой, телом и получателем.
    4. Отправляет сообщение и закрывает соединение.
    5. В случае возникновения ошибки, логирует ее и возвращает `False`.

    ASCII flowchart:
    Начало --> Установить соединение с SMTP-сервером --> Аутентификация --> Сформировать сообщение --> Отправить сообщение --> Закрыть соединение --> Конец
       |
       V
       Ошибка - > Запись ошибки в лог -> Конец

    Примеры:
    >>> send(subject='Test Subject', body='Test Body', to='test@example.com')
    True

    >>> send(subject='Important', body='Please review this document.')
    True
    """
    ...
```

**Назначение**: Отправка email сообщения.

**Параметры**:
*   `subject` (str): Тема сообщения.
*   `body` (str): Тело сообщения.
*   `to` (str): Адрес получателя.

**Возвращает**:
*   `bool`: Возвращает `True`, если отправка прошла успешно, иначе `False`.

**Вызывает исключения**:
*   `Exception`: Возникает, если произошла ошибка при отправке сообщения.

**Как работает функция**:

1.  **Установить соединение с SMTP-сервером**: Функция пытается установить соединение с SMTP-сервером, используя параметры, хранящиеся в словаре `_connection`.
2.  **Аутентификация**: Функция пытается пройти аутентификацию на SMTP-сервере, используя имя пользователя и пароль, хранящиеся в словаре `_connection`.
3.  **Сформировать сообщение**: Функция создает MIMEText объект, который содержит тело сообщения. Также устанавливаются заголовки "Subject", "From" и "To".
4.  **Отправить сообщение**: Функция пытается отправить сообщение, используя метод `sendmail` объекта SMTP.
5.  **Закрыть соединение**: Функция закрывает соединение с SMTP-сервером, используя метод `quit`.
6.  **Обработка ошибок**: Если во время выполнения любого из этих шагов возникает исключение, функция перехватывает его, записывает информацию об ошибке в журнал и возвращает `False`.

**ASCII flowchart**:

```
Начало
  ↓
Установить соединение с SMTP-сервером
  ↓
Аутентификация
  ↓
Сформировать сообщение
  ↓
Отправить сообщение
  ↓
Закрыть соединение
  ↓
Конец
  ↓
ОШИБКА: Запись в лог
  ↓
Конец
```

**Примеры**:

```python
send(subject='Test Subject', body='Test Body', to='test@example.com')
# Отправит сообщение на адрес test@example.com с указанной темой и телом.

send(subject='Important', body='Please review this document.')
# Отправит сообщение с темой "Important" и телом "Please review this document." на адрес, указанный в _connection['receiver'].
```

### `receive`

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Получает email сообщения из указанной папки на IMAP сервере.

    Args:
        imap_server (str): Адрес IMAP сервера.
        user (str): Имя пользователя для подключения к IMAP серверу.
        password (str): Пароль для подключения к IMAP серверу.
        folder (str, optional): Название папки для получения сообщений. По умолчанию 'inbox'.

    Returns:
        Optional[List[Dict[str, str]]]: Список словарей с данными каждого сообщения (тема, отправитель, тело) в случае успеха, `None` в случае ошибки.

    Raises:
        Exception: В случае возникновения ошибки при получении сообщений.

    Как работает функция:
    1. Функция устанавливает защищенное соединение с IMAP-сервером.
    2. Выполняет аутентификацию на сервере.
    3. Выбирает указанную папку.
    4. Ищет все сообщения в папке.
    5. Для каждого сообщения извлекает тему, отправителя и тело.
    6. Сохраняет данные каждого сообщения в словарь и добавляет его в список.
    7. Закрывает соединение и выходит из системы.
    8. В случае возникновения ошибки, логирует ее и возвращает `None`.

    ASCII flowchart:
    Начало --> Установить соединение с IMAP-сервером --> Аутентификация --> Выбрать папку --> Поиск сообщений --> Извлечь данные сообщения --> Закрыть соединение --> Выйти --> Конец
       |
       V
       Ошибка --> Запись ошибки в лог --> Конец

    Примеры:
    >>> receive(imap_server='imap.example.com', user='test@example.com', password='password', folder='INBOX')
    [{'subject': 'Test Subject', 'from': 'sender@example.com', 'body': 'Test Body'}]

    >>> receive(imap_server='imap.example.com', user='test@example.com', password='password')
    [{'subject': 'Test Subject', 'from': 'sender@example.com', 'body': 'Test Body'}]
    """
    ...
```

**Назначение**: Получение email сообщений из IMAP-сервера.

**Параметры**:

*   `imap_server` (str): Адрес IMAP-сервера.
*   `user` (str): Имя пользователя для подключения к IMAP-серверу.
*   `password` (str): Пароль для подключения к IMAP-серверу.
*   `folder` (str): Название папки для получения сообщений. По умолчанию 'inbox'.

**Возвращает**:

*   `Optional[List[Dict[str, str]]]`: Список словарей, где каждый словарь представляет собой email сообщение с ключами 'subject', 'from' и 'body'. В случае ошибки возвращает `None`.

**Вызывает исключения**:

*   `Exception`: Возникает при ошибках подключения, аутентификации или получения сообщений.

**Как работает функция**:

1.  **Установить соединение с IMAP-сервером**: Функция создает SSL-соединение с IMAP-сервером, используя предоставленный адрес сервера.
2.  **Аутентификация**: Функция пытается пройти аутентификацию на IMAP-сервере, используя предоставленное имя пользователя и пароль.
3.  **Выбрать папку**: Функция выбирает указанную папку на IMAP-сервере (по умолчанию 'inbox').
4.  **Поиск сообщений**: Функция ищет все сообщения в выбранной папке.
5.  **Извлечь данные сообщения**: Для каждого найденного сообщения функция извлекает тему, отправителя и тело сообщения. Тело сообщения декодируется из байтов в строку, с обработкой возможных ошибок кодировки.
6.  **Сохранить данные и закрыть соединение**: Данные каждого сообщения сохраняются в словарь, который добавляется в список. После обработки всех сообщений функция закрывает соединение с IMAP-сервером и выходит из системы.
7.  **Обработка ошибок**: Если во время выполнения любого из этих шагов возникает исключение, функция перехватывает его, записывает информацию об ошибке в журнал и возвращает `None`.

**ASCII flowchart**:

```
Начало
  ↓
Установить соединение с IMAP-сервером
  ↓
Аутентификация
  ↓
Выбрать папку
  ↓
Поиск сообщений
  ↓
Извлечь данные сообщения
  ↓
Закрыть соединение
  ↓
Выйти
  ↓
Конец
  ↓
ОШИБКА: Запись в лог
  ↓
Конец
```

**Примеры**:

```python
receive(imap_server='imap.example.com', user='test@example.com', password='password', folder='INBOX')
# Возвращает список словарей с данными email сообщений из папки 'INBOX'.

receive(imap_server='imap.example.com', user='test@example.com', password='password')
# Возвращает список словарей с данными email сообщений из папки 'inbox' (по умолчанию).