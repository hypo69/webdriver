# Модуль для работы с Excel и JSON
## Обзор

Модуль `src.utils.xls` предназначен для конвертации данных между форматами Excel (`.xls`) и JSON. Он предоставляет функции для чтения данных из файлов Excel в формат JSON, а также для сохранения данных из JSON в файлы Excel. Модуль разработан для работы на платформах Windows и Unix.

## Подробней

Этот модуль позволяет удобно преобразовывать данные из Excel-файлов в JSON-формат и обратно, что облегчает интеграцию с другими системами и приложениями. Он поддерживает работу с несколькими листами в Excel-файлах и обеспечивает обработку ошибок для обеспечения стабильности работы.

## Функции

### `read_xls_as_dict`

```python
def read_xls_as_dict(
    xls_file: str,
    json_file: str = None,
    sheet_name: Union[str, int] = None
) -> Union[Dict, List[Dict], bool]:
    """
    Читает Excel файл и конвертирует его в JSON. Опционально, конвертирует указанный лист и сохраняет результат в JSON файл.
    Обрабатывает ошибки.
    """
```

**Назначение**: Чтение данных из Excel-файла и преобразование их в формат JSON. Функция позволяет указать конкретный лист для чтения или прочитать все листы файла. Также есть возможность сохранить полученные данные в JSON-файл.

**Параметры**:

-   `xls_file` (str): Путь к Excel-файлу.
-   `json_file` (str, optional): Путь для сохранения JSON-файла. Если не указан, данные не будут сохранены в файл. По умолчанию `None`.
-   `sheet_name` (Union[str, int], optional): Имя или индекс листа в Excel-файле, который нужно прочитать. Если не указан, читаются все листы. По умолчанию `None`.

**Возвращает**:

-   `Union[Dict, List[Dict], bool]`: Если указан `sheet_name`, возвращает словарь, содержащий данные из указанного листа. Если `sheet_name` не указан, возвращает список словарей, где каждый словарь соответствует листу в Excel-файле. Возвращает `False` в случае ошибки.

**Вызывает исключения**:

-   `FileNotFoundError`: Если указанный Excel-файл не найден.
-   `Exception`: В случае других ошибок при обработке файла или листа.

**Как работает функция**:

1.  **Проверка наличия файла**: Функция проверяет, существует ли файл Excel по указанному пути. Если файл не найден, функция логирует ошибку и возвращает `False`.
2.  **Чтение Excel-файла**: Используется библиотека `pandas` для чтения Excel-файла.
3.  **Обработка листов**:

    *   Если `sheet_name` не указан, функция итерируется по всем листам в Excel-файле.
    *   Для каждого листа функция читает данные и преобразует их в словарь, используя метод `to_dict(orient='records')`.
    *   Если при обработке какого-либо листа возникает ошибка, функция логирует ошибку и возвращает `False`.
4.  **Сохранение в JSON (опционально)**: Если указан параметр `json_file`, функция сохраняет полученные данные в JSON-файл с использованием кодировки UTF-8 и отступов для читаемости.
5.  **Возврат данных**: Функция возвращает словарь или список словарей с данными из Excel-файла.

```
A[Проверка наличия файла]
│
├─── Нет: B[Логирование ошибки и возврат False]
│
└─── Да: C[Чтение Excel файла]
    │
    ├─── sheet_name указан: D[Чтение указанного листа]
    │   │   │
    │   └─── Ошибка: E[Логирование ошибки и возврат False]
    │   │   │
    │   └─── Успех: G[Преобразование данных в словарь]
    │   │   │
    │   └─── json_file указан: H[Сохранение в JSON файл]
    │       │
    │       └─── Нет: I[Возврат данных]
    │       │
    │       └─── Да: J[Сохранение в JSON и возврат данных]
    │
    └─── sheet_name не указан: K[Итерация по всем листам]
        │
        └─── L[Чтение данных из каждого листа]
            │
            ├─── Ошибка: M[Логирование ошибки и возврат False]
            │
            └─── Успех: N[Преобразование данных в словарь]
                │
                └─── json_file указан: O[Сохранение в JSON файл]
                    │
                    └─── Нет: P[Возврат данных]
                    │
                    └─── Да: Q[Сохранение в JSON и возврат данных]
```

**Примеры**:

```python
# Чтение Excel-файла и сохранение в JSON
data = read_xls_as_dict('input.xlsx', 'output.json', 'Sheet1')
if data:
    print(data)

# Чтение Excel-файла без сохранения в JSON
data = read_xls_as_dict('input.xlsx', sheet_name='Sheet1')
if data:
    print(data)

# Чтение всех листов Excel-файла
data = read_xls_as_dict('input.xlsx')
if data:
    print(data)
```

### `save_xls_file`

```python
def save_xls_file(data: Dict[str, List[Dict]], file_path: str) -> bool:
    """Сохраняет JSON данные в Excel файл. Обрабатывает ошибки."""
```

**Назначение**: Сохранение данных из JSON-формата в Excel-файл. Функция принимает словарь, где ключи являются именами листов, а значения - списками словарей, представляющих строки данных.

**Параметры**:

-   `data` (Dict[str, List[Dict]]): Словарь, содержащий данные для сохранения в Excel-файл. Ключи словаря - имена листов, значения - списки словарей, где каждый словарь представляет строку данных.
-   `file_path` (str): Путь для сохранения Excel-файла.

**Возвращает**:

-   `bool`: `True`, если данные успешно сохранены в Excel-файл, `False` в случае ошибки.

**Вызывает исключения**:

-   `Exception`: В случае ошибки при сохранении файла.

**Как работает функция**:

1.  **Создание ExcelWriter**: Функция использует `pd.ExcelWriter` для создания Excel-файла по указанному пути. В качестве движка используется `xlsxwriter`.
2.  **Итерация по листам**: Функция итерируется по ключам словаря `data`, где каждый ключ представляет имя листа.
3.  **Создание DataFrame**: Для каждого листа функция создает `pandas.DataFrame` из списка словарей, представляющих строки данных.
4.  **Запись в Excel**: DataFrame записывается в Excel-файл на соответствующий лист с использованием метода `to_excel`. Параметр `index=False` предотвращает запись индексов DataFrame в файл.
5.  **Сохранение файла**: После записи всех листов, Excel-файл сохраняется.
6.  **Обработка ошибок**: Если во время записи или сохранения файла возникает ошибка, функция логирует ошибку и возвращает `False`.

```
A[Создание ExcelWriter]
│
├─── Ошибка: B[Логирование ошибки и возврат False]
│
└─── Успех: C[Итерация по листам данных]
    │
    └─── D[Создание DataFrame для каждого листа]
        │
        └─── E[Запись DataFrame в Excel файл]
            │
            ├─── Ошибка: F[Логирование ошибки и возврат False]
            │
            └─── Успех: G[Сохранение файла и возврат True]
```

**Примеры**:

```python
# Сохранение данных в Excel-файл
data_to_save = {'Sheet1': [{'column1': 'value1', 'column2': 'value2'}]}
success = save_xls_file(data_to_save, 'output.xlsx')
if success:
    print("Successfully saved to output.xlsx")