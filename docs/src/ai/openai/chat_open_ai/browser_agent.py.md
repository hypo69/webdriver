# Модуль для создания AI агента, использующего браузер для поиска и анализа информации.
=================================================================

Модуль предоставляет класс `AIBrowserAgent`, который позволяет быстро настроить и запустить ИИ-агента, способного искать информацию в Google и анализировать веб-страницы.

Статья: [https://github.com/hypo69/1001-python-ru/tree/master/articles/lang_chain_and_browser_use](https://github.com/hypo69/1001-python-ru/tree/master/articles/lang_chain_and_browser_use)

## Обзор

Этот модуль предназначен для создания агентов, использующих браузер для поиска информации и выполнения задач в интернете. Он включает в себя класс `AIBrowserAgent`, который упрощает настройку и запуск таких агентов с использованием OpenAI и различных поисковых систем.

## Подробней

Модуль предоставляет возможность создания агента, который может выполнять задачи, используя браузер для поиска информации в интернете. Он использует библиотеку `langchain_openai` для взаимодействия с моделями OpenAI и `browser_use` для управления браузером. Модуль также включает в себя пример использования класса `AIBrowserAgent` для поиска аналогов продукта и ответа на вопрос.

## Оглавление

- [Классы](#Классы)
    - [AIBrowserAgent](#AIBrowserAgent)
- [Функции](#Функции)
    - [main](#main)

## Классы

### `AIBrowserAgent`

**Описание**: Класс для создания агента, использующего браузер для выполнения задач.

**Принцип работы**:
Класс инициализируется с ключом API OpenAI, названием языковой модели, поисковой системой и опциональным драйвером. Он использует эти параметры для создания агента, который может выполнять задачи, используя браузер для поиска информации в интернете.

**Атрибуты**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str): Название языковой модели OpenAI для использования.
- `search_engine` (str): Поисковая система для использования.
- `llm` (ChatOpenAI): Языковая модель OpenAI.
- `custom_driver` (Optional[object]): Пользовательский драйвер WebDriver.

**Методы**:
- `__init__`: Инициализирует класс BrowserAgent.
- `run_task`: Запускает агента для выполнения заданной задачи.
- `find_product_alternatives`: Ищет в сети аналоги для продукта по заданному URL или SKU.
- `ask`: Синхронная обертка для асинхронного метода ask_async. Не рекомендуется к использованию.
- `ask_async`: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

### `__init__`
```python
def __init__(self, api_key: str, model_name: str = "gpt-4o-mini", search_engine: str = "google", custom_driver: Optional[object] = None):
    """
    Инициализирует класс BrowserAgent.

    Args:
        api_key (str): Ключ API OpenAI (необязательный). Если не указан, будет использован ключ из переменных окружения.
        model_name (str): Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
        search_engine (str): Поисковая система для использования (по умолчанию "google").
        custom_driver (Optional[object], optional): Optionally injected WebDriver instance, defaults to None (browser_use default).
    """
```

**Назначение**: Инициализирует экземпляр класса `AIBrowserAgent` с заданными параметрами.

**Параметры**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str): Название языковой модели OpenAI для использования (по умолчанию: "gpt-4o-mini").
- `search_engine` (str): Поисковая система для использования (по умолчанию: "google").
- `custom_driver` (Optional[object]): Пользовательский драйвер WebDriver (по умолчанию: `None`).

**Как работает функция**:

1.  **Инициализация атрибутов**:
    *   Сохраняет переданные аргументы `api_key`, `model_name`, `search_engine` и `custom_driver` в соответствующие атрибуты экземпляра класса.

2.  **Инициализация LLM**:
    *   Создает экземпляр языковой модели `ChatOpenAI` с использованием указанной модели (`self.model_name`) и ключа API (`self.api_key`).

```
Инициализация атрибутов
↓
Создание экземпляра ChatOpenAI
```

**Примеры**:
```python
agent = AIBrowserAgent(api_key='YOUR_API_KEY', model_name='gpt-4o-mini', search_engine='google')
```

### `run_task`
```python
async def run_task(self, task_prompt: str) -> Optional[str]:
    """
    Запускает агента для выполнения заданной задачи.

    Args:
        task_prompt (str): Текст задачи для агента.

    Returns:
        Optional[str]: Результат выполнения задачи в виде строки, или None в случае ошибки.
    """
```

**Назначение**: Запускает агента для выполнения заданной задачи, используя указанный `task_prompt`.

**Параметры**:
- `task_prompt` (str): Текст задачи для агента.

**Возвращает**:
- `Optional[str]`: Результат выполнения задачи в виде строки, или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Если во время выполнения задачи происходит ошибка.

**Как работает функция**:

1.  **Логирование начала задачи**:
    *   Записывает информационное сообщение в лог о начале выполнения задачи с указанием текста задачи.

2.  **Определение драйвера**:
    *   Определяет, какой драйвер использовать для управления браузером. Если передан `custom_driver`, используется он. В противном случае, `browser_use` создаёт свой драйвер по умолчанию.

3.  **Создание и запуск агента**:
    *   Создает экземпляр класса `Agent` из библиотеки `browser_use`, передавая ему текст задачи (`task_prompt`), языковую модель (`self.llm`) и драйвер.
    *   Запускает агента для выполнения задачи с помощью метода `agent.run()`.
    *   Записывает информационное сообщение в лог о завершении выполнения задачи.

4.  **Закрытие драйвера (если возможно)**:
    *   Пытается закрыть драйвер, если у него есть метод `close`.

5.  **Обработка исключений**:
    *   В случае возникновения ошибки, записывает сообщение об ошибке в лог и возвращает `None`.

```
Логирование начала задачи
↓
Определение драйвера
↓
Создание и запуск агента
↓
Закрытие драйвера (если возможно)
↓
Возврат результата или None в случае ошибки
```

**Примеры**:
```python
result = await agent.run_task("Найди информацию о последних новостях в мире.")
```

### `find_product_alternatives`
```python
async def find_product_alternatives(self, product_url: Optional[str] = None, sku: Optional[str] = None) -> Optional[str]:
    """
    Ищет в сети аналоги для продукта по заданному URL или SKU.

    Args:
        product_url (Optional[str], optional): URL продукта, для которого нужно найти аналоги (опционально). Defaults to None.
        sku (Optional[str], optional): SKU продукта, для которого нужно найти аналоги (опционально). Defaults to None.

    Returns:
        Optional[str]: Строку с описанием найденных аналогов, или None в случае ошибки.
    """
```

**Назначение**: Ищет в интернете аналоги для продукта, используя либо URL продукта, либо его SKU.

**Параметры**:
- `product_url` (Optional[str]): URL продукта, для которого нужно найти аналоги (по умолчанию: `None`).
- `sku` (Optional[str]): SKU продукта, для которого нужно найти аналоги (по умолчанию: `None`).

**Возвращает**:
- `Optional[str]`: Строка с описанием найденных аналогов, или `None` в случае ошибки.

**Как работает функция**:

1.  **Определение поискового запроса**:
    *   Формирует поисковый запрос в зависимости от того, что предоставлено: `product_url` или `sku`. Если ни то, ни другое не указано, возвращает `None` и записывает предупреждение в лог.

2.  **Формирование URL для поиска**:
    *   Кодирует поисковый запрос для использования в URL.
    *   Формирует URL для поиска в зависимости от выбранной поисковой системы (`self.search_engine`).

3.  **Формирование текста задачи**:
    *   Создает текст задачи (`task_prompt`) для агента, указывая ему, какую поисковую систему использовать и по какому URL перейти.

4.  **Запуск задачи**:
    *   Запускает задачу с помощью метода `self.run_task` и возвращает результат.

```
Определение поискового запроса
↓
Формирование URL для поиска
↓
Формирование текста задачи
↓
Запуск задачи
```

**Примеры**:
```python
alternatives = await agent.find_product_alternatives(product_url="https://www.example.com/product")
alternatives = await agent.find_product_alternatives(sku="12345")
```

### `ask`
```python
def ask(self, q: str) -> Optional[str]:
    """
    Синхронная обертка для асинхронного метода ask_async.  Не рекомендуется к использованию.
    """
```

**Назначение**: Предоставляет синхронную обертку для асинхронного метода `ask_async`. Использовать не рекомендуется.

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:

1.  **Формирование текста задачи**:
    *   Создает текст задачи (`task_prompt`), который содержит вопрос, на который нужно ответить, используя поиск в интернете, если это необходимо.

2.  **Запуск задачи**:
    *   Вызывает метод `self.run_task` с сформированным текстом задачи и возвращает результат.

```
Формирование текста задачи
↓
Запуск задачи
```

**Примеры**:
```python
answer = agent.ask("Какая столица Франции?")
```

### `ask_async`
```python
async def ask_async(self, q: str) -> Optional[str]:
    """
    Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

    Args:
        q (str): Вопрос, на который нужно ответить.

    Returns:
        Optional[str]: Ответ на вопрос в виде строки, или None в случае ошибки.
    """
```

**Назначение**: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:

1.  **Формирование текста задачи**:
    *   Создает текст задачи (`task_prompt`), который содержит вопрос, на который нужно ответить, используя поиск в интернете, если это необходимо.

2.  **Запуск задачи**:
    *   Вызывает асинхронный метод `self.run_task` с сформированным текстом задачи и возвращает результат.

```
Формирование текста задачи
↓
Запуск задачи
```

**Примеры**:
```python
answer = await agent.ask_async("Какая столица Франции?")
```

## Функции

### `main`
```python
async def main():
    """
    Пример использования класса BrowserAgent.
    """
```

**Назначение**: Пример использования класса `AIBrowserAgent` для поиска аналогов продукта и ответа на вопрос.

**Как работает функция**:

1.  **Инициализация API ключа и названия модели**:
    *   Инициализирует API ключ и название модели.
    *   Создает экземпляр класса `AIBrowserAgent` с указанными параметрами.

2.  **Поиск аналогов продукта**:
    *   Определяет SKU продукта и URL продукта.
    *   Вызывает метод `find_product_alternatives` для поиска аналогов продукта.
    *   Выводит найденные аналоги или сообщение о неудаче.

3.  **Ответ на вопрос**:
    *   Определяет вопрос.
    *   Вызывает метод `ask_async` для ответа на вопрос.
    *   Выводит ответ на вопрос или сообщение о неудаче.

```
Инициализация API ключа и названия модели
↓
Поиск аналогов продукта
↓
Ответ на вопрос
```

**Примеры**:
```python
asyncio.run(main())