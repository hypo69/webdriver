# Модуль для интеграции с Google Gemini AI
==================================================

Модуль `gemini.py` предоставляет класс `GoogleGenerativeAI` для взаимодействия с моделями Google Generative AI.
Он поддерживает текстовые запросы, анализ изображений и управление историей чата.

Пример использования
----------------------

```python
>>> from src.ai.gemini.gemini import GoogleGenerativeAI
>>> ai = GoogleGenerativeAI(api_key='YOUR_API_KEY')
>>> response = ai.ask("What is the capital of France?")
>>> print(response)
Paris
```

## Оглавление

- [Обзор](#обзор)
- [Классы](#классы)
    - [GoogleGenerativeAI](#googlegenerativeai)
- [Функции](#функции)
    - [main](#main)

## Обзор

Модуль предназначен для упрощения взаимодействия с Google Gemini AI, предоставляя удобный интерфейс для выполнения различных задач, таких как генерация текста, анализ изображений и управление диалогами.
Он включает в себя обработку ошибок, логирование и возможность сохранения и загрузки истории чата.

## Классы

### `GoogleGenerativeAI`

**Описание**: Класс `GoogleGenerativeAI` предназначен для взаимодействия с моделями Google Generative AI.

**Атрибуты**:
- `api_key` (str): Ключ API для доступа к Google Gemini AI.
- `model_name` (str): Имя используемой модели. По умолчанию `"gemini-2.0-flash-exp"`.
- `dialogue_txt_path` (Path): Путь к файлу для логирования диалогов.
- `generation_config` (Dict): Конфигурация генерации ответов. По умолчанию `{"response_mime_type": "text/plain"}`. Разрешенные типы `text/plain`, `application/json`, `application/xml`, `application/yaml` и `text/x.enum`.
- `system_instruction` (Optional[str]): Системные инструкции для модели.
- `history_dir` (Path): Директория для хранения истории чата.
- `history_txt_file` (Path): Путь к текстовому файлу истории чата.
- `history_json_file` (Path): Путь к JSON файлу истории чата.
- `config` (SimpleNamespace): Объект конфигурации, загруженный из `gemini.json`.
- `chat_history` (List[Dict]): Список словарей, содержащих историю чата.
- `model` (Any): Объект модели GenerativeModel от Google.
- `_chat` (Any): Объект чата.
- `MODELS` (List[str]): Список доступных моделей.

**Методы**:
- `__post_init__()`: Инициализирует модель и настраивает параметры.
- `normalize_answer(text: str) -> str`: Очищает вывод модели от лишних элементов (например, ```md, ```python).
- `_start_chat()`: Запускает чат с начальной настройкой.
- `clear_history()`: Очищает историю чата в памяти и удаляет файл истории.
- `_save_chat_history(chat_data_folder: Optional[str | Path])`: Сохраняет историю чата в JSON файл.
- `_load_chat_history(chat_data_folder: Optional[str | Path])`: Загружает историю чата из JSON файла.
- `chat(q: str, chat_data_folder: Optional[str | Path], flag: str = "save_chat") -> Optional[str]`: Обрабатывает чат-запрос с различными режимами управления историей чата.
- `ask(q: str, attempts: int = 15, save_history: bool = False, clean_response: bool = True) -> Optional[str]`: Отправляет текстовый запрос модели и возвращает ответ.
- `ask_async(q: str, attempts: int = 15, save_history: bool = False, clean_response: bool = True) -> Optional[str]`: Асинхронно отправляет текстовый запрос модели и возвращает ответ.
- `describe_image(image: Path | bytes, mime_type: Optional[str] = 'image/jpeg', prompt: Optional[str] = '') -> Optional[str]`: Отправляет изображение в Gemini Pro Vision и возвращает его текстовое описание.
- `upload_file(file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`: Загружает файл в Google Gemini.

### `GoogleGenerativeAI.__post_init__`

**Назначение**: Инициализация модели GoogleGenerativeAI с дополнительными настройками.

**Как работает функция**:
1. Загружает конфигурацию из файла `gemini.json`.
2. Определяет пути для логирования диалогов и истории чата.
3. Инициализирует модель `genai.GenerativeModel` с указанным ключом API, именем модели и системными инструкциями.
4. Запускает чат с помощью метода `_start_chat()`.

### `GoogleGenerativeAI.normalize_answer`

**Назначение**: Очистка вывода от  ``````md, ```python, ```json, ```html, ит.п.

**Параметры**:
- `text` (str): Текст для нормализации.

**Возвращает**:
- `str`: Нормализованный текст.

**Как работает функция**:
1. Вызывает функцию `normalize_answer` из модуля `src.utils.string.ai_string_normalizer` для очистки текста.

### `GoogleGenerativeAI._start_chat`

**Назначение**: Запуск чата с начальной настройкой.

**Возвращает**:
- `Any`: Объект чата.

**Как работает функция**:
1. Проверяет, заданы ли системные инструкции.
2. Если системные инструкции заданы, запускает чат с использованием этих инструкций в качестве начального сообщения.
3. Если системные инструкции не заданы, запускает чат без начальных сообщений.

### `GoogleGenerativeAI.clear_history`

**Назначение**: Очищает историю чата в памяти и удаляет файл истории, если он существует.

**Как работает функция**:
1. Очищает список `chat_history`, обнуляя историю чата в памяти.
2. Проверяет существование файла истории (`history_json_file`).
3. Если файл существует, удаляет его и логирует информацию об удалении.
4. Обрабатывает возможные исключения при удалении файла и логирует ошибки.

### `GoogleGenerativeAI._save_chat_history`

**Назначение**: Сохраняет всю историю чата в JSON файл.

**Параметры**:
- `chat_data_folder` (Optional[str | Path]): Папка для сохранения истории чата.

**Как работает функция**:
1. Если указана папка `chat_data_folder`, формирует путь к файлу истории `history_json_file` в этой папке.
2. Если история чата (`chat_history`) не пуста, сохраняет её в JSON файл с помощью функции `j_dumps`.

### `GoogleGenerativeAI._load_chat_history`

**Назначение**: Загружает историю чата из JSON файла.

**Параметры**:
- `chat_data_folder` (Optional[str | Path]): Папка, содержащая файл истории чата.

**Как работает функция**:
1. Если указана папка `chat_data_folder`, формирует путь к файлу истории `history_json_file` в этой папке.
2. Проверяет существование файла истории (`history_json_file`).
3. Если файл существует, загружает историю чата из файла с помощью функции `j_loads`.
4. После загрузки инициализирует чат с помощью метода `_start_chat()` и добавляет записи из загруженной истории в текущий чат.
5. Логирует информацию о загрузке истории чата.
6. Обрабатывает возможные исключения при загрузке файла и логирует ошибки.

### `GoogleGenerativeAI.chat`

**Назначение**: Обрабатывает чат-запрос с различными режимами управления историей чата.

**Параметры**:
- `q` (str): Вопрос пользователя.
- `chat_data_folder` (Optional[str | Path]): Папка для хранения истории чата.
- `flag` (str): Режим управления историей. Возможные значения: "save_chat", "read_and_clear", "clear", "start_new".

**Возвращает**:
- `Optional[str]`: Ответ модели.

**Как работает функция**:

```ascii
      ┌──────────────────┐
      │  Начало функции  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Обработка флага │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │ Отправка запроса │
      │    модели       │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │Сохранение истории│
      │    и ответа     │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Конец функции   │
      └──────────────────┘
```

1. В зависимости от значения параметра `flag`, выполняет различные действия с историей чата:
   - `"save_chat"`: Загружает историю чата из файла.
   - `"read_and_clear"`: Загружает историю чата из файла и очищает текущую историю.
   - `"read_and_start_new"`: Загружает историю чата, очищает текущую историю и устанавливает флаг в `"start_new"`.
   - `"clear"`: Очищает текущую историю чата.
   - `"start_new"`: Сохраняет текущую историю в архивный файл и начинает новую историю.
2. Отправляет запрос модели с помощью метода `_chat.send_message_async(q)`.
3. Если получен ответ от модели, добавляет запрос и ответ в историю чата и сохраняет историю в файл.
4. Возвращает ответ модели.
5. Обрабатывает возможные исключения и логирует ошибки.

**Примеры**:

```python
# Пример использования с сохранением истории чата
response = await ai.chat("What is the capital of Germany?", chat_data_folder="chat_data", flag="save_chat")

# Пример использования с чтением истории чата и началом нового чата
response = await ai.chat("What is the capital of Germany?", chat_data_folder="chat_data", flag="read_and_clear")

# Пример использования с очисткой истории чата
response = await ai.chat("What is the capital of Germany?", chat_data_folder="chat_data", flag="clear")

# Пример использования с началом нового чата
response = await ai.chat("What is the capital of Germany?", chat_data_folder="chat_data", flag="start_new")
```

### `GoogleGenerativeAI.ask`

**Назначение**: Метод отправляет текстовый запрос модели и возвращает ответ.

**Параметры**:
- `q` (str): Текстовый запрос.
- `attempts` (int): Количество попыток отправки запроса. По умолчанию `15`.
- `save_history` (bool): Флаг, указывающий, нужно ли сохранять диалог. По умолчанию `False`.
- `clean_response` (bool): Флаг, указывающий, нужно ли очищать ответ от лишних элементов. По умолчанию `True`.

**Возвращает**:
- `Optional[str]`: Ответ модели.

**Как работает функция**:

```ascii
      ┌──────────────────┐
      │  Начало функции  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │   Цикл попыток   │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │ Отправка запроса │
      │    модели       │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │Сохранение истории│
      │    и ответа     │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Конец функции   │
      └──────────────────┘
```

1. В цикле выполняет несколько попыток отправки запроса модели.
2. Отправляет запрос модели с помощью метода `self.model.generate_content(q)`.
3. Если получен ответ, проверяет его наличие. Если ответ пустой, логирует информацию и повторяет попытку.
4. Если `save_history` установлен в `True`, сохраняет диалог с помощью метода `_save_dialogue`.
5. Если `clean_response` установлен в `True`, очищает ответ с помощью метода `normalize_answer`.
6. Возвращает ответ модели.
7. Обрабатывает различные исключения (сетевые ошибки, ошибки аутентификации, ошибки API) и логирует ошибки.
8. В случае неудачи после всех попыток возвращает `None`.

**Примеры**:

```python
# Пример использования с сохранением истории диалога
response = ai.ask("What is the capital of Germany?", save_history=True)

# Пример использования без очистки ответа
response = ai.ask("What is the capital of Germany?", clean_response=False)
```

### `GoogleGenerativeAI.ask_async`

**Назначение**: Метод асинхронно отправляет текстовый запрос модели и возвращает ответ.

**Параметры**:
- `q` (str): Текстовый запрос.
- `attempts` (int): Количество попыток отправки запроса. По умолчанию `15`.
- `save_history` (bool): Флаг, указывающий, нужно ли сохранять диалог. По умолчанию `False`.
- `clean_response` (bool): Флаг, указывающий, нужно ли очищать ответ от лишних элементов. По умолчанию `True`.

**Возвращает**:
- `Optional[str]`: Ответ модели.

**Как работает функция**:

```ascii
      ┌──────────────────┐
      │  Начало функции  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │   Цикл попыток   │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │ Отправка запроса │
      │    модели       │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │Сохранение истории│
      │    и ответа     │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Конец функции   │
      └──────────────────┘
```

1. В цикле выполняет несколько попыток отправки запроса модели асинхронно.
2. Отправляет запрос модели с помощью `asyncio.to_thread(self.model.generate_content, q)`.
3. Если получен ответ, проверяет его наличие. Если ответ пустой, логирует информацию и повторяет попытку.
4. Если `save_history` установлен в `True`, сохраняет диалог с помощью метода `_save_dialogue`.
5. Если `clean_response` установлен в `True`, очищает ответ с помощью метода `normalize_answer`.
6. Возвращает ответ модели.
7. Обрабатывает различные исключения (сетевые ошибки, ошибки аутентификации, ошибки API) и логирует ошибки.
8. В случае неудачи после всех попыток возвращает `None`.

**Примеры**:

```python
# Пример использования с сохранением истории диалога
response = await ai.ask_async("What is the capital of Germany?", save_history=True)

# Пример использования без очистки ответа
response = await ai.ask_async("What is the capital of Germany?", clean_response=False)
```

### `GoogleGenerativeAI.describe_image`

**Назначение**: Отправляет изображение в Gemini Pro Vision и возвращает его текстовое описание.

**Параметры**:
- `image` (Path | bytes): Путь к файлу изображения или байты изображения.
- `mime_type` (Optional[str]): MIME-тип изображения. По умолчанию `'image/jpeg'`.
- `prompt` (Optional[str]): Дополнительный текстовый запрос для описания изображения. По умолчанию `''`.

**Возвращает**:
- `Optional[str]`: Текстовое описание изображения.

**Как работает функция**:

```ascii
      ┌──────────────────┐
      │  Начало функции  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │Подготовка контента│
      │   для запроса    │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │ Отправка запроса │
      │    модели       │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Обработка ответа│
      │   и возврат      │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Конец функции   │
      └──────────────────┘
```

1. Подготавливает контент для запроса, преобразуя изображение в байты, если передан путь к файлу.
2. Отправляет запрос модели с помощью метода `self.model.generate_content`.
3. Обрабатывает различные исключения (ошибки аутентификации, ошибки API, ошибки перегрузки модели) и логирует ошибки.
4. Возвращает текстовое описание изображения, полученное от модели.

**Примеры**:

```python
# Пример использования с путем к файлу изображения
description = await ai.describe_image(Path("image.jpg"), prompt="Describe this image")

# Пример использования с байтами изображения
with open("image.jpg", "rb") as f:
    image_bytes = f.read()
description = await ai.describe_image(image_bytes, prompt="Describe this image")
```

### `GoogleGenerativeAI.upload_file`

**Назначение**: Асинхронно загружает файл в Google Gemini.

**Параметры**:
- `file` (str | Path | IOBase): Путь к файлу, объект Path или IOBase.
- `file_name` (Optional[str]): Имя файла.

**Возвращает**:
- `bool`: True в случае успеха, иначе False.

**Как работает функция**:

```ascii
      ┌──────────────────┐
      │  Начало функции  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Загрузка файла  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │Обработка ошибок и│
      │   повторная      │
      │    загрузка      │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Конец функции   │
      └──────────────────┘
```

1. Пытается асинхронно загрузить файл с использованием `genai.upload_file_async`.
2. В случае успеха логирует информацию о загрузке файла и возвращает `True`.
3. Если происходит ошибка, логирует ошибку и пытается удалить файл, а затем повторно загрузить его.
4. Обрабатывает возможные исключения при удалении и повторной загрузке файла и логирует ошибки.

**Примеры**:

```python
# Пример загрузки файла по пути
file_upload = await ai.upload_file("test.txt", "test_file.txt")

# Пример загрузки файла с использованием объекта Path
file_upload = await ai.upload_file(Path("test.txt"), "test_file.txt")
```

## Функции

### `main`

**Назначение**: Функция `main` демонстрирует примеры использования класса `GoogleGenerativeAI` для выполнения различных задач, таких как описание изображений, загрузка файлов и ведение чата.

**Как работает функция**:
1. Создает экземпляр класса `GoogleGenerativeAI` с указанным ключом API и системными инструкциями.
2. Демонстрирует пример вызова метода `describe_image` с промптом для анализа изображения и выдачи ответа в формате JSON.
3. Демонстрирует пример вызова метода `describe_image` без JSON формата.
4. Демонстрирует пример вызова метода `upload_file` для загрузки файла.
5. Демонстрирует пример ведения чата с использованием метода `chat`.

```ascii
      ┌──────────────────┐
      │  Начало функции  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │Создание экземпляра│
      │  GoogleGenerativeAI│
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Примеры вызовов │
      │   разных методов  │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │      Чат        │
      └──────────┬───────┘
               │
      ┌──────────▼───────┐
      │  Конец функции   │
      └──────────────────┘
```

**Примеры**:

```python
# Пример запуска функции main
if __name__ == "__main__":
    asyncio.run(main())
```