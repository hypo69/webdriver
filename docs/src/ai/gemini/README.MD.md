# Модуль интеграции Google Generative AI

## Обзор

Класс `GoogleGenerativeAI` разработан для облегчения взаимодействия с моделями Google Generative AI. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциональностями AI. Он включает надежную обработку ошибок, ведение журналов и параметры конфигурации для обеспечения бесперебойной работы.

## Подробнее

Модуль предоставляет класс `GoogleGenerativeAI`, который упрощает взаимодействие с моделями Google Generative AI. Он обрабатывает запросы, ответы и диалоги, интегрируясь с различными функциями AI. Модуль включает обработку ошибок, ведение журналов и опции конфигурации для обеспечения надежной работы.

## Классы

### `GoogleGenerativeAI`

**Описание**: Класс `GoogleGenerativeAI` предназначен для взаимодействия с моделями Google Generative AI.

**Принцип работы**:
Класс инициализируется с использованием API-ключа, имени модели, конфигурации генерации и системной инструкции. Он предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциональностями AI. Класс также включает обработку ошибок, ведение журналов и параметры конфигурации.

**Аттрибуты**:
- `api_key` (str): API-ключ для доступа к моделям Google Generative AI.
- `model_name` (Optional[str]): Имя используемой модели AI. По умолчанию `None`.
- `generation_config` (Optional[Dict]): Конфигурация генерации для настройки поведения модели. По умолчанию `None`.
- `system_instruction` (Optional[str]): Инструкция для задания контекста и поведения модели. По умолчанию `None`.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `GoogleGenerativeAI`.
- `config`: Получает конфигурацию из файла настроек.
- `_start_chat`: Запускает сессию чата с AI-моделью.
- `_save_dialogue`: Сохраняет диалог в текстовом и JSON-форматах.
- `ask`: Отправляет текстовый запрос AI-модели и получает ответ.
- `chat`: Отправляет сообщение в чат AI-модели и получает ответ.
- `describe_image`: Генерирует текстовое описание изображения.
- `upload_file`: Загружает файл в AI-модель.

## Функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Назначение**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Параметры**:
- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str]): Имя используемой модели AI. По умолчанию `None`.
- `generation_config` (Optional[Dict]): Конфигурация генерации для настройки поведения модели. По умолчанию `None`.
- `system_instruction` (Optional[str]): Инструкция для задания контекста и поведения модели. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы.

**Возвращает**:
- `None`

**Вызывает исключения**:
- Отсутствуют явные исключения, но могут быть исключения, связанные с инициализацией Google Generative AI.

**Как работает функция**:
1. Функция `__init__` инициализирует класс `GoogleGenerativeAI`, устанавливая API-ключ, имя модели, конфигурацию генерации и системную инструкцию.
2. Задаются пути для ведения журналов диалогов и хранения истории.
3. Инициализируется модель Google Generative AI.

```
Начало инициализации
│
├─── Установка API-ключа, имени модели, конфигурации и инструкции
│
├─── Определение путей для журналов и истории
│
└─── Инициализация модели Google Generative AI
│
Конец инициализации
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
```

### `config(self)`

**Назначение**: Извлекает конфигурацию из файла настроек.

**Параметры**:
- `self`: Ссылка на экземпляр класса.

**Возвращает**:
- `dict`: Словарь с конфигурационными параметрами.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл конфигурации не найден.
- `json.JSONDecodeError`: Если файл конфигурации содержит некорректный JSON.

**Как работает функция**:
1. Функция `config` считывает и анализирует файл конфигурации, расположенный по пути `gs.path.src / 'ai' / 'gemini' / 'gemini.json'`.
2. Возвращает словарь с конфигурационными параметрами.

```
Начало
│
├─── Чтение файла конфигурации
│
└─── Анализ JSON-содержимого
│
Конец: Возврат словаря с конфигурацией
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
config = ai.config()
print(config)
```

### `_start_chat(self)`

**Назначение**: Запускает сессию чата с AI-моделью.

**Параметры**:
- `self`: Ссылка на экземпляр класса.

**Возвращает**:
- `None`

**Вызывает исключения**:
- Отсутствуют явные исключения.

**Как работает функция**:
1. Функция `_start_chat` инициализирует сессию чата с пустой историей.

```
Начало
│
└─── Инициализация сессии чата с пустой историей
│
Конец
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
ai._start_chat()
```

### `_save_dialogue(self, dialogue: list)`

**Назначение**: Сохраняет диалог в текстовом и JSON-форматах.

**Параметры**:
- `self`: Ссылка на экземпляр класса.
- `dialogue` (list): Список сообщений в диалоге.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `IOError`: Если возникает ошибка при записи в файл.

**Как работает функция**:
1. Функция `_save_dialogue` добавляет каждое сообщение в диалоге в текстовый файл.
2. Добавляет каждое сообщение в формате JSON в JSON-файл.

```
Начало
│
├─── Добавление каждого сообщения в текстовый файл
│
└─── Добавление каждого сообщения в JSON-файл
│
Конец
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
dialogue = ["Привет!", "Как дела?"]
ai._save_dialogue(dialogue)
```

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Назначение**: Отправляет текстовый запрос AI-модели и получает ответ.

**Параметры**:
- `self`: Ссылка на экземпляр класса.
- `q` (str): Текст запроса.
- `attempts` (int): Максимальное количество попыток в случае ошибок. По умолчанию 15.

**Возвращает**:
- `Optional[str]`: Ответ AI-модели или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае сетевых ошибок или недоступности сервиса.

**Как работает функция**:
1. Функция `ask` отправляет текстовый запрос AI-модели.
2. Обрабатывает несколько попыток в случае сетевых ошибок или недоступности сервиса.
3. Регистрирует ошибки и повторяет попытки с экспоненциальной задержкой.
4. Сохраняет диалог в файлы истории.

```
Начало
│
├─── Отправка текстового запроса AI-модели
│
├─── Обработка попыток и повторных запросов
│
└─── Сохранение диалога в файлы истории
│
Конец: Возврат ответа или None
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
response = ai.ask("Как дела?")
print(response)
```

### `chat(self, q: str) -> str`

**Назначение**: Отправляет сообщение в чат AI-модели и получает ответ.

**Параметры**:
- `self`: Ссылка на экземпляр класса.
- `q` (str): Текст сообщения.

**Возвращает**:
- `str`: Ответ AI-модели.

**Вызывает исключения**:
- `Exception`: В случае ошибок при взаимодействии с AI-моделью.

**Как работает функция**:
1. Функция `chat` использует сессию чата, инициализированную `_start_chat`.
2. Регистрирует ошибки и возвращает текст ответа.

```
Начало
│
├─── Использование сессии чата
│
└─── Отправка сообщения и получение ответа
│
Конец: Возврат ответа
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
ai._start_chat()
response = ai.chat("Привет!")
print(response)
```

### `describe_image(self, image_path: Path) -> Optional[str]`

**Назначение**: Генерирует текстовое описание изображения.

**Параметры**:
- `self`: Ссылка на экземпляр класса.
- `image_path` (Path): Путь к изображению.

**Возвращает**:
- `Optional[str]`: Текстовое описание изображения или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае ошибок при обработке изображения или взаимодействии с AI-моделью.

**Как работает функция**:
1. Функция `describe_image` кодирует изображение в base64 и отправляет его AI-модели.
2. Возвращает сгенерированное описание или регистрирует ошибку, если операция не удалась.

```
Начало
│
├─── Кодирование изображения в base64
│
└─── Отправка изображения AI-модели
│
Конец: Возврат описания или None
```

**Примеры**:

```python
from pathlib import Path

ai = GoogleGenerativeAI(api_key="your_api_key")
image_path = Path("image.jpg")
description = ai.describe_image(image_path)
print(description)
```

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Назначение**: Загружает файл в AI-модель.

**Параметры**:
- `self`: Ссылка на экземпляр класса.
- `file` (str | Path | IOBase): Путь к файлу, объект Path или файловый поток.
- `file_name` (Optional[str]): Имя файла. По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если файл успешно загружен, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: В случае ошибок при загрузке файла.

**Как работает функция**:
1. Функция `upload_file` обрабатывает загрузку файла и регистрирует успех или неудачу.
2. Предоставляет логику повторных попыток в случае ошибок.

```
Начало
│
├─── Обработка загрузки файла
│
└─── Логика повторных попыток
│
Конец: Возврат True или False
```

**Примеры**:

```python
from pathlib import Path

ai = GoogleGenerativeAI(api_key="your_api_key")
file_path = Path("file.txt")
success = ai.upload_file(file_path)
print(success)
```

## Обработка ошибок

Класс включает обработку ошибок для различных сценариев:
- **Сетевые ошибки**: Повторные попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Регистрация ошибок и повторные попытки.
- **Ограничения квоты**: Регистрация и ожидание перед повторной попыткой.
- **Ошибки аутентификации**: Регистрация и прекращение дальнейших попыток.
- **Некорректный ввод**: Регистрация и повторные попытки с таймаутом.
- **Ошибки API**: Регистрация и прекращение дальнейших попыток.

## Ведение журналов и истории

Все взаимодействия с AI-моделями регистрируются, и диалоги сохраняются в текстовом и JSON-форматах для будущего анализа. Это обеспечивает отслеживаемость всех операций и возможность их проверки для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI` и отправляет запрос AI-модели, выводя ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям внутри класса `GoogleGenerativeAI`.